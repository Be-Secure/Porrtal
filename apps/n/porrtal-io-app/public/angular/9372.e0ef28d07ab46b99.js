/*
Copyright 2022 Comcast Cable Communications Management, LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[9372,3542],{65389:(R,O,i)=>{i.d(O,{Z:()=>w});var _=i(62208);class w{constructor(y){this.size=0,this._start=0,this.maxSize=y,this._buffer=new Array(y)}get entries(){return this._buffer}enqueue(y){if(this.size===this.maxSize){const a=this._buffer[this._start];return this._buffer[this._start]=y,this._start=(this._start+1)%this.maxSize,a}return this._buffer[(this._start+this.size++)%this.maxSize]=y,null}dequeue(){if(0===this.size)return null;const y=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,y}peek(){return 0===this.size?null:this._buffer[this._start]}find(y){if(0===this.size)return null;for(const a of this._buffer)if((0,_.pC)(a)&&y(a))return a;return null}clear(y){let a=this.dequeue();for(;(0,_.pC)(a);)y&&y(a),a=this.dequeue()}}},5075:(R,O,i)=>{i.d(O,{Qo:()=>f});var _=i(65389),w=i(21286),v=i(62208);const a="__esri_timestamp__";class f{constructor(o,c,u,h,b=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=u,this._purgeOptions=h,this.store=o,this.objectIdField=c,this.purgeInterval=b,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}add(o){if(this._useGeneratedIds){const h=this._nextId();o.attributes[this.objectIdField]=h,o.objectId=h}else o.objectId=o.attributes[this.objectIdField];if(this._addOrUpdated.set(o.objectId,o),this._maxAge=Math.max(this._maxAge,o.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return(0,v.Wi)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new _.Z(1e5)),void this._trackIdLessObservations.enqueue(o.objectId);const c=o.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(c)){const h=(0,v.pC)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,b=(0,w.uZ)(h,0,1e3);this._trackIdToObservations.set(c,new _.Z(b))}const u=this._trackIdToObservations.get(c).enqueue(o.objectId);(0,v.pC)(u)&&(this._addOrUpdated.has(u)?this._addOrUpdated.delete(u):this._removed.push(u))}checkForUpdates(){const o=this._getToAdd(),c=this._getToRemove(),u=performance.now();u-this._lastPurge>=this.purgeInterval&&(this._purge(u),this._lastPurge=u);const h=[];if((0,v.pC)(c))for(const b of c){const Z=this.store.removeById(b);(0,v.pC)(Z)&&h.push(Z)}if((0,v.pC)(o))for(const b of o)b.attributes[a]=u,this.store.add(b);(o||h?.length)&&this.store.update(o,h)}_getToAdd(){if(!this._addOrUpdated.size)return null;const o=new Array(this._addOrUpdated.size);let c=0;return this._addOrUpdated.forEach(u=>o[c++]=u),this._addOrUpdated.clear(),o}_getToRemove(){const o=this._removed;return this._removed.length?(this._removed=[],o):null}_nextId(){const o=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,o}_purge(o){const c=this._purgeOptions;(0,v.pC)(c)&&(this._purgeSomeByDisplayCount(c),this._purgeByAge(c),this._purgeByAgeReceived(o,c),this._purgeTracks())}_purgeSomeByDisplayCount(o){if(!o.displayCount)return;let c=this.store.size;if(c>o.displayCount){if(this._timeInfo.trackIdField)for(const u of this._trackIdToObservations.values())if(c>o.displayCount&&u.size){const h=(0,v.Wg)(u.dequeue());this._removed.push(h),c--}if((0,v.pC)(this._trackIdLessObservations)){let u=c-o.displayCount;for(;u-- >0;){const h=this._trackIdLessObservations.dequeue();(0,v.pC)(h)&&this._removed.push(h)}}}}_purgeByAge(o){if(!o.age||!this._timeInfo?.startTimeField)return;const u=this._maxAge-60*o.age*1e3;this.store.forEach(h=>{h.attributes[this._timeInfo.startTimeField]<u&&this._removed.push(h.objectId)})}_purgeByAgeReceived(o,c){if(!c.ageReceived)return;const u=o-60*c.ageReceived*1e3;this.store.forEach(h=>{h.attributes[a]<u&&this._removed.push(h.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((o,c)=>{0===o.size&&this._trackIdToObservations.delete(c)})}}},3542:(R,O,i)=>{i.r(O),i.d(O,{createConnection:()=>M});var _=i(15861),w=i(17626),y=(i(29132),i(84792)),a=i(26584),l=i(63290),f=i(62208),F=i(10699),o=i(21726),b=(i(90912),i(85931),i(8314),i(76898)),Z=i(77712),T=i(33696),j=i(61885);let E=class extends j.Z.EventedAccessor{get connectionError(){return this.errorString?new a.Z("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}};(0,w._)([(0,Z.Cb)({readOnly:!0})],E.prototype,"connectionError",null),E=(0,w._)([(0,b.j)("esri.layers.support.StreamConnection")],E);const P=E;var k,e;(e=k||(k={}))[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED";let I=class extends P{constructor(e){super(),this.errorString=null;const{geometryType:t,spatialReference:s,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=(0,T.k)(t,r,s),this._open()}_open(){var e=this;return(0,_.Z)(function*(){yield e._tryCreateWebSocket(),e.destroyed||(yield e._handshake())})()}destroy(){(0,f.pC)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if((0,f.Wi)(this._websocket))return"disconnected";switch(this._websocket.readyState){case k.CONNECTING:case k.OPEN:return"connected";case k.CLOSING:case k.CLOSED:return"disconnected"}}_tryCreateWebSocket(e=this._config.source.path,t=1e3,s=0){var r=this;return(0,_.Z)(function*(){try{if(r.destroyed)return;const n=(0,o.fl)(e,r._config.customParameters);r._websocket=yield r._createWebSocket(n),r.notifyChange("connectionStatus")}catch(n){const d=t/1e3;return r._config.maxReconnectionAttempts&&s>=r._config.maxReconnectionAttempts?(l.Z.getLogger(r.declaredClass).error(new a.Z("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void r.destroy()):(l.Z.getLogger(r.declaredClass).error(new a.Z("websocket-connection",`Failed to connect. Attempting to reconnect in ${d}s`,n)),yield(0,F.e4)(t),r._tryCreateWebSocket(e,Math.min(1.5*t,1e3*r._config.maxReconnectionInterval),s+1))}})()}_createWebSocket(e){return new Promise((t,s)=>{const r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=n=>this._onClose(n),r.onerror=n=>this._onError(n),r.onmessage=n=>this._onMessage(n),t(r)},r.onclose=n=>{r.onopen=r.onclose=null,s(n)}})}_handshake(e=1e4){var t=this;return(0,_.Z)(function*(){const s=t._websocket;if((0,f.Wi)(s))return;const r=(0,F.hh)(),n=s.onmessage,{filter:d,outFields:g,spatialReference:S}=t._config;return r.timeout(e),s.onmessage=C=>{let m=null;try{m=JSON.parse(C.data)}catch{}m&&"object"==typeof m||(l.Z.getLogger(t.declaredClass).error(new a.Z("websocket-connection","Protocol violation. Handshake failed - malformed message",C.data)),r.reject(),t.destroy()),m.spatialReference?.wkid!==S?.wkid&&(l.Z.getLogger(t.declaredClass).error(new a.Z("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${S.wkid}`,C.data)),r.reject(),t.destroy()),"json"!==m.format&&(l.Z.getLogger(t.declaredClass).error(new a.Z("websocket-connection","Protocol violation. Handshake failed - format is not set",C.data)),r.reject(),t.destroy()),d&&m.filter!==d&&l.Z.getLogger(t.declaredClass).error(new a.Z("websocket-connection","Tried to set filter, but server doesn't support it")),g&&m.outFields!==g&&l.Z.getLogger(t.declaredClass).error(new a.Z("websocket-connection","Tried to set outFields, but server doesn't support it")),s.onmessage=n,r.resolve()},s.send(JSON.stringify({filter:d,outFields:g,format:"json",spatialReference:{wkid:S.wkid}})),r.promise})()}_onMessage(e){try{const t=JSON.parse(e.data);if("featureResult"!==t.type)throw new a.Z("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);for(const s of t.features)(0,f.pC)(this._featureZScaler)&&this._featureZScaler(s.geometry),this.onFeature(s)}catch(t){return l.Z.getLogger(this.declaredClass).error(new a.Z("websocket-connection","Failed to parse message",t)),void this.destroy()}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),l.Z.getLogger(this.declaredClass).error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&l.Z.getLogger(this.declaredClass).error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};(0,w._)([(0,Z.Cb)()],I.prototype,"connectionStatus",null),(0,w._)([(0,Z.Cb)()],I.prototype,"errorString",void 0),I=(0,w._)([(0,b.j)("esri.layers.graphics.sources.connections.WebSocketConnection")],I);var L=i(20477),W=i(96854),U=i(91179),A=i(65234);const D={maxQueryDepth:5,maxRecordCountFactor:3};let x=class extends I{constructor(e){super({...D,...e})}_open(){var e=this;return(0,_.Z)(function*(){const t=yield e._fetchServiceDefinition(e._config.source);t.timeInfo.trackIdField||l.Z.getLogger(e.declaredClass).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const s=e._fetchWebSocketUrl(t.streamUrls,e._config.spatialReference);e._buddyServicesQuery||(e._buddyServicesQuery=e._queryBuddyServices()),yield e._buddyServicesQuery,yield e._tryCreateWebSocket(s);const{filter:r,outFields:n}=e._config;e.destroyed||e._setFilter(r,n)})()}_onMessage(e){let t;try{t=this._enrich(JSON.parse(e.data)),(0,f.pC)(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(s){return void l.Z.getLogger(this.declaredClass).error(new a.Z("geoevent-connection","Failed to parse message",s))}this.onFeature(t)}_fetchServiceDefinition(e){var t=this;return(0,_.Z)(function*(){const s={f:"json",...t._config.customParameters},r=(0,y.default)(e.path,{query:s,responseType:"json"}),n=(yield r).data;return t._serviceDefinition=n,n})()}_fetchWebSocketUrl(e,t){const s=e[0],{urls:r,token:n}=s,d=this._inferWebSocketBaseUrl(r);return(0,o.fl)(`${d}/subscribe`,{outSR:""+t.wkid,token:n})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return l.Z.getLogger(this.declaredClass).error(new a.Z("geoevent-connection","Unable to infer WebSocket url",e)),null}_setFilter(e,t){var s=this;return(0,_.Z)(function*(){const r=s._websocket;if((0,f.Wi)(r)||(0,f.Wi)(e)&&(0,f.Wi)(t))return;const n=JSON.stringify({filter:s._serializeFilter(e,t)});let d=!1;const g=(0,F.hh)();return r.onmessage=m=>{const p=JSON.parse(m.data);p.filter&&(p.error&&(l.Z.getLogger(s.declaredClass).error(new a.Z("geoevent-connection","Failed to set service filter",p.error)),s._set("errorString",`Could not set service filter - ${p.error}`),g.reject(p.error)),r.onmessage=s._onMessage.bind(s),d=!0,g.resolve())},r.send(n),setTimeout(()=>{d||(s.destroyed||s._websocket!==r||l.Z.getLogger(s.declaredClass).error(new a.Z("geoevent-connection","Server timed out when setting filter")),g.reject())},1e4),g.promise})()}_serializeFilter(e,t){const s={};if((0,f.Wi)(e)&&(0,f.Wi)(t))return s;if((0,f.pC)(e)&&e.geometry)try{const r=(0,U.im)(e.geometry);if("extent"!==r.type)throw new a.Z(`Expected extent but found type ${r.type}`);s.geometry=JSON.stringify(r.shiftCentralMeridian())}catch(r){l.Z.getLogger(this.declaredClass).error(new a.Z("geoevent-connection","Encountered an error when setting connection geometryDefinition",r))}return(0,f.pC)(e)&&e.where&&"1 = 1"!==e.where&&(s.where=e.where),(0,f.pC)(t)&&(s.outFields=t.join(",")),s}_enrich(e){if(!this._relatedFeatures)return e;const s=e.attributes[this._serviceDefinition.relatedFeatures.joinField];if(!this._relatedFeatures.has(s))return l.Z.getLogger(this.declaredClass).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:r,geometry:n}=this._relatedFeatures.get(s);for(const d in r)e.attributes[d]=r[d];return n&&(e.geometry=n),e.geometry||e.centroid||l.Z.getLogger(this.declaredClass).error(new a.Z("geoevent-connection","Found malformed feature - no geometry found",e)),e}_queryBuddyServices(){var e=this;return(0,_.Z)(function*(){try{const{relatedFeatures:t,keepLatestArchive:s}=e._serviceDefinition,r=e._queryRelatedFeatures(t),n=e._queryArchive(s);yield r;const d=yield n;if(!d)return;for(const g of d.features)e.onFeature(e._enrich(g))}catch(t){l.Z.getLogger(e.declaredClass).error(new a.Z("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}})()}_queryRelatedFeatures(e){var t=this;return(0,_.Z)(function*(){if(!e)return;const s=yield t._queryBuddy(e.featuresUrl);t._addRelatedFeatures(s)})()}_queryArchive(e){var t=this;return(0,_.Z)(function*(){if(e)return t._queryBuddy(e.featuresUrl)})()}_queryBuddy(e){var t=this;return(0,_.Z)(function*(){const s=new((yield Promise.resolve().then(i.bind(i,80415))).default)({url:e}),{capabilities:r}=yield s.load(),n=r.query.supportsMaxRecordCountFactor,d=r.query.supportsPagination,g=r.query.supportsCentroid,S=t._config.maxRecordCountFactor,C=s.capabilities.query.maxRecordCount,m=n?C*S:C,p=new W.Z;if(p.outFields=(0,f.Pt)(t._config.outFields,["*"]),p.where=(0,f.Pt)((0,f.U2)(t._config.filter,"where"),"1=1"),p.returnGeometry=!0,p.returnExceededLimitFeatures=!0,p.outSpatialReference=A.Z.fromJSON(t._config.spatialReference),g&&(p.returnCentroid=!0),n&&(p.maxRecordCountFactor=S),d)return p.num=m,s.destroy(),t._queryPages(e,p);const B=yield(0,L.executeQuery)(e,p,t._config.sourceSpatialReference);return s.destroy(),B.data})()}_queryPages(e,t,s=[],r=0){var n=this;return(0,_.Z)(function*(){t.start=(0,f.pC)(t.num)?r*t.num:null;const{data:d}=yield(0,L.executeQuery)(e,t,n._config.sourceSpatialReference);return d.exceededTransferLimit&&r<n._config.maxQueryDepth?(d.features.forEach(g=>s.push(g)),n._queryPages(e,t,s,r+1)):(s.forEach(g=>d.features.push(g)),d)})()}_addRelatedFeatures(e){const t=new Map,s=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(const n of s)t.set(n.attributes[r],n);this._relatedFeatures=t}};x=(0,w._)([(0,b.j)("esri.layers.graphics.sources.connections.GeoEventConnection")],x);const z=x;function M(e,t,s,r,n,d,g,S){const C=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),m={source:e,sourceSpatialReference:t,spatialReference:s,geometryType:r,filter:n,maxReconnectionAttempts:d,maxReconnectionInterval:g,customParameters:S};return C?new I(m):new z(m)}}}]);