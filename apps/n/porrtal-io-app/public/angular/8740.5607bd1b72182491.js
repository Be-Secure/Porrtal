/*
Copyright 2022 Comcast Cable Communications Management, LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[8740],{78740:(X,P,l)=>{l.r(P),l.d(P,{FeatureServiceSnappingSource:()=>u});var y=l(15861),n=l(17626),O=l(14517),H=l(80542),b=l(54024),o=l(62208),c=l(32917),r=l(77712),I=(l(85931),l(8314),l(90912),l(76898)),U=l(84161),z=l(4794),T=l(41743);function S(e,t){return(0,T.g)(t.extent,k),(0,T.h)(k,(0,U.s)(R,e.x,e.y,0))}const k=(0,T.c)(),R=(0,z.c)();var Z=l(93579);let d=class extends O.Z{constructor(e){super(e),this.pointOfInterest=null}get tiles(){const e=this.tilesCoveringView,t=(0,o.pC)(this.pointOfInterest)?this.pointOfInterest:this.view.center;return e.sort((i,a)=>S(t,i)-S(t,a)),e}_scaleEnabled(){return(0,Z.rs)(this.view.scale,this.layer.minScale||0,this.layer.maxScale||0)}get tilesCoveringView(){if(!this.view.ready||!this.view.featuresTilingScheme||!this.view.state||(0,o.Wi)(this.tileInfo))return[];if(!this._scaleEnabled)return[];const{spans:e,lodInfo:t}=this.view.featuresTilingScheme.getTileCoverage(this.view.state,0),{level:i}=t,a=[];for(const{row:s,colFrom:h,colTo:w}of e)for(let v=h;v<=w;v++){const m={id:null,level:i,row:s,col:t.normalizeCol(v)};this.tileInfo.updateTileInfo(m),a.push(m)}return a}get tileInfo(){return this.view.featuresTilingScheme?.tileInfo??null}get tileSize(){return(0,o.pC)(this.tileInfo)?this.tileInfo.size[0]:256}initialize(){this.own((0,c.YP)(()=>this.view?.state?.viewpoint,()=>this.notifyChange("tilesCoveringView"),c.Z_))}};(0,n._)([(0,r.Cb)({readOnly:!0})],d.prototype,"tiles",null),(0,n._)([(0,r.Cb)({readOnly:!0})],d.prototype,"_scaleEnabled",null),(0,n._)([(0,r.Cb)({readOnly:!0})],d.prototype,"tilesCoveringView",null),(0,n._)([(0,r.Cb)({readOnly:!0})],d.prototype,"tileInfo",null),(0,n._)([(0,r.Cb)({readOnly:!0})],d.prototype,"tileSize",null),(0,n._)([(0,r.Cb)({constructOnly:!0})],d.prototype,"view",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],d.prototype,"layer",void 0),(0,n._)([(0,r.Cb)()],d.prototype,"pointOfInterest",void 0),d=(0,n._)([(0,I.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles2D")],d);var M=l(27351);let p=class extends H.r{constructor(e){super(e),this.pointOfInterest=null}get tiles(){const e=this.tilesCoveringView,t=this.effectivePointOfInterest;if((0,o.pC)(t)){const i=e.map(a=>S(t,a));for(let a=1;a<i.length;a++)if(i[a-1]>i[a])return e.sort((s,h)=>S(t,s)-S(t,h)),e.slice()}return e}get tilesCoveringView(){return this._filterTiles(this.view.featureTiles?.tiles?.toArray()).map(N)}get tileInfo(){return this.view.featureTiles?.tilingScheme.toTileInfo()??null}get tileSize(){return this.view.featureTiles?.tileSize??256}get effectivePointOfInterest(){const e=this.pointOfInterest;return(0,o.pC)(e)?e:this.view.pointsOfInterest?.focus.location}initialize(){this.handles.add((0,c.YP)(()=>this.view.featureTiles,e=>{this.handles.remove(F),e&&this.handles.add(e.addClient(),F)},c.nn))}_filterTiles(e){return(0,o.Wi)(e)?[]:e.filter(t=>Math.abs(t.measures.screenRect[3]-t.measures.screenRect[1])>x&&t.measures.visibility===M.E.VISIBLE_ON_SURFACE)}};function N({lij:[e,t,i],extent:a}){return{id:`${e}/${t}/${i}`,level:e,row:t,col:i,extent:a}}(0,n._)([(0,r.Cb)({readOnly:!0})],p.prototype,"tiles",null),(0,n._)([(0,r.Cb)({readOnly:!0})],p.prototype,"tilesCoveringView",null),(0,n._)([(0,r.Cb)({readOnly:!0})],p.prototype,"tileInfo",null),(0,n._)([(0,r.Cb)({readOnly:!0})],p.prototype,"tileSize",null),(0,n._)([(0,r.Cb)({constructOnly:!0})],p.prototype,"view",void 0),(0,n._)([(0,r.Cb)()],p.prototype,"pointOfInterest",void 0),(0,n._)([(0,r.Cb)()],p.prototype,"effectivePointOfInterest",null),p=(0,n._)([(0,I.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles3D")],p);const x=50,F="feature-tiles";var D=l(9218),j=l(72392),V=l(37118),E=l(65401),J=l(73187);let C=class extends J.q{constructor(e){super(e),this.handles=new j.Z}initialize(){const e=setInterval(()=>this._fetchDebugInfo(),2e3);this.handles.add((0,b.kB)(()=>clearInterval(e)))}destroy(){this.handles.destroy()}getTiles(){if(!this.debugInfo)return[];const e=new Map,t=new Map;this.debugInfo.storedTiles.forEach(s=>{e.set(s.data.id,s.featureCount)}),this.debugInfo.pendingTiles.forEach(s=>{e.set(s.data.id,s.featureCount),t.set(s.data.id,s.state)});const i=s=>{const h=t.get(s),w=e.get(s)??"?";return h?`${h}:${w}\n${s}`:`store:${w}\n${s}`},a=new Map;return this.debugInfo.storedTiles.forEach(s=>{a.set(s.data.id,s.data)}),this.debugInfo.pendingTiles.forEach(s=>{a.set(s.data.id,s.data)}),Array.from(a.values()).map(s=>({lij:[s.level,s.row,s.col],geometry:V.Z.fromExtent((0,E.HH)(s.extent,this.view.spatialReference)),label:i(s.id)}))}_fetchDebugInfo(){this.handle.getDebugInfo(null).then(e=>{this.debugInfo=e,this.update()})}};(0,n._)([(0,r.Cb)({constructOnly:!0})],C.prototype,"handle",void 0),C=(0,n._)([(0,I.j)("esri.views.interactive.snapping.featureSources.WorkerTileTreeDebugger")],C);var W=l(10699),A=l(42930),$=l(71774);let f=class extends H.r{constructor(e){super(e),this.availability=0,this.workerHandleUpdating=!0,this.editId=0}get updating(){return this.updatingHandles.updating||this.workerHandleUpdating}destroy(){this.workerHandle.destroy()}initialize(){this.workerHandle=new L(this.schedule),this.handles.add([this.workerHandle.on("notify-updating",({updating:e})=>this.workerHandleUpdating=e),this.workerHandle.on("notify-availability",({availability:e})=>this._set("availability",e))])}setup(e,t){var i=this;return(0,y.Z)(function*(){const a=i._serviceInfoFromLayer(e.layer);if((0,o.Wi)(a))return;const s={configuration:i._convertConfiguration(e.configuration),serviceInfo:a,spatialReference:e.spatialReference.toJSON()};yield i.updatingHandles.addPromise(i.workerHandle.invokeMethod("setup",s,t)),i.updatingHandles.addPromise(i.workerHandle.invokeMethod("whenNotUpdating",{},t))})()}configure(e,t){var i=this;return(0,y.Z)(function*(){const a=i._convertConfiguration(e);yield i.updatingHandles.addPromise(i.workerHandle.invokeMethod("configure",a,t)),i.updatingHandles.addPromise(i.workerHandle.invokeMethod("whenNotUpdating",{},t))})()}refresh(e){var t=this;return(0,y.Z)(function*(){yield t.updatingHandles.addPromise(t.workerHandle.invokeMethod("refresh",{},e)),t.updatingHandles.addPromise(t.workerHandle.invokeMethod("whenNotUpdating",{},e))})()}fetchCandidates(e,t){var i=this;return(0,y.Z)(function*(){const a={distance:e.distance,point:e.coordinateHelper.vectorToPoint(e.point).toJSON(),types:e.types,filter:(0,o.pC)(e.filter)?e.filter.createQuery().toJSON():null};return i.workerHandle.invoke(a,t)})()}updateTiles(e,t){var i=this;return(0,y.Z)(function*(){const a={tiles:e.tiles,tileInfo:(0,o.pC)(e.tileInfo)?e.tileInfo.toJSON():null,tileSize:e.tileSize};yield i.updatingHandles.addPromise(i.workerHandle.invokeMethod("updateTiles",a,t)),i.updatingHandles.addPromise(i.workerHandle.invokeMethod("whenNotUpdating",{},t))})()}applyEdits(e,t){var i=this;return(0,y.Z)(function*(){const a=i.editId++,s={id:a};yield i.updatingHandles.addPromise(i.workerHandle.invokeMethod("beginApplyEdits",s,t));const h=yield i.updatingHandles.addPromise((0,W.Hl)(e.result,t)),w={id:a,edits:{addedFeatures:h.addedFeatures?.map(({objectId:v})=>v)??[],deletedFeatures:h.deletedFeatures?.map(({objectId:v,globalId:m})=>({objectId:v,globalId:m}))??[],updatedFeatures:h.updatedFeatures?.map(({objectId:v})=>v)??[]}};yield i.updatingHandles.addPromise(i.workerHandle.invokeMethod("endApplyEdits",w,t)),i.updatingHandles.addPromise(i.workerHandle.invokeMethod("whenNotUpdating",{},t))})()}getDebugInfo(e){return this.workerHandle.invokeMethod("getDebugInfo",{},e)}_convertConfiguration(e){return{filter:(0,o.pC)(e.filter)?e.filter.toJSON():null,customParameters:e.customParameters}}_serviceInfoFromLayer(e){return"multipatch"===e.geometryType||"mesh"===e.geometryType?null:{url:e.parsedUrl.path,fields:e.fields.map(t=>t.toJSON()),geometryType:$.Mk.toJSON(e.geometryType),capabilities:e.capabilities,objectIdField:e.objectIdField,globalIdField:e.globalIdField,spatialReference:e.spatialReference.toJSON(),timeInfo:e.timeInfo?.toJSON()}}};(0,n._)([(0,r.Cb)({constructOnly:!0})],f.prototype,"schedule",void 0),(0,n._)([(0,r.Cb)({readOnly:!0})],f.prototype,"updating",null),(0,n._)([(0,r.Cb)({readOnly:!0})],f.prototype,"availability",void 0),(0,n._)([(0,r.Cb)()],f.prototype,"workerHandleUpdating",void 0),f=(0,n._)([(0,I.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorkerHandle")],f);class L extends A.q{constructor(t){super("FeatureServiceSnappingSourceWorker","fetchCandidates",{},t,{strategy:"dedicated"})}}var Y=l(49672),B=l(72258),G=l(2584);let g=class extends O.Z{constructor(e){super(e),this.pointOfInterest=null}get tiles(){return[{id:"0/0/0",level:0,row:0,col:0,extent:(0,E.al)(-1e8,-1e8,1e8,1e8)}]}get tileInfo(){return new G.Z({origin:new Y.Z({x:-1e8,y:1e8,spatialReference:this.layer.spatialReference}),size:[512,512],lods:[new B.Z({level:0,scale:1,resolution:390625})],spatialReference:this.layer.spatialReference})}get tileSize(){return this.tileInfo.size[0]}};(0,n._)([(0,r.Cb)({readOnly:!0})],g.prototype,"tiles",null),(0,n._)([(0,r.Cb)({readOnly:!0})],g.prototype,"tileInfo",null),(0,n._)([(0,r.Cb)({readOnly:!0})],g.prototype,"tileSize",null),(0,n._)([(0,r.Cb)({constructOnly:!0})],g.prototype,"layer",void 0),(0,n._)([(0,r.Cb)()],g.prototype,"pointOfInterest",void 0),g=(0,n._)([(0,I.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTilesSimple")],g);var Q=l(66463);let u=class extends((0,H.p)(O.Z)){constructor(e){super(e)}get updateTilesParameters(){return{tiles:this.tilesOfInterest.tiles,tileInfo:this.tilesOfInterest.tileInfo,tileSize:this.tilesOfInterest.tileSize}}get updating(){return this.workerHandle.updating||this.updatingHandles.updating}get configuration(){return{filter:this.layer.createQuery(),customParameters:this.layer.customParameters}}get availability(){return this.workerHandle.availability}get layer(){return this.layerSource.layer}initialize(){const e=this.view;if((0,o.pC)(e))switch(e.type){case"2d":this.tilesOfInterest=new d({view:e,layer:this.layer}),this.workerHandle=new f;break;case"3d":{const t=e.resourceController;this.tilesOfInterest=new p({view:e}),this.workerHandle=new f({schedule:i=>t.schedule(i)});break}}else this.tilesOfInterest=new g({layer:this.layer}),this.workerHandle=new f;this.handles.add([(0,b.ed)(this.workerHandle)]),this.workerHandle.setup({layer:this.layer,spatialReference:this.spatialReference,configuration:this.configuration},null),this.updatingHandles.add(()=>this.updateTilesParameters,()=>this.workerHandle.updateTiles(this.updateTilesParameters,null),c.nn),this.handles.add([(0,c.YP)(()=>this.configuration,t=>this.workerHandle.configure(t,null),c.Z_)]),(0,o.pC)(e)&&this.handles.add((0,c.YP)(()=>Q.Z.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES,t=>{t&&!this.debug?(this.debug=new C({view:e,handle:this.workerHandle}),this.handles.add((0,b.ed)(this.debug),"debug")):!t&&this.debug&&this.handles.remove("debug")},c.nn)),this.handles.add(this.layerSource.layer.on("apply-edits",t=>{this.workerHandle.applyEdits(t,null)}))}refresh(){this.workerHandle.refresh(null)}fetchCandidates(e,t){var i=this;return(0,y.Z)(function*(){return i.tilesOfInterest.pointOfInterest=e.coordinateHelper.vectorToPoint(e.point),(yield i.workerHandle.fetchCandidates({...e,filter:null},t)).candidates.map(a=>(0,D.X)(a,e.coordinateHelper,e.elevationInfo))})()}getDebugInfo(e){return this.workerHandle.getDebugInfo(e)}};(0,n._)([(0,r.Cb)({constructOnly:!0})],u.prototype,"spatialReference",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],u.prototype,"layerSource",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],u.prototype,"view",void 0),(0,n._)([(0,r.Cb)()],u.prototype,"tilesOfInterest",void 0),(0,n._)([(0,r.Cb)({readOnly:!0})],u.prototype,"updateTilesParameters",null),(0,n._)([(0,r.Cb)({readOnly:!0})],u.prototype,"updating",null),(0,n._)([(0,r.Cb)({readOnly:!0})],u.prototype,"configuration",null),(0,n._)([(0,r.Cb)({readOnly:!0})],u.prototype,"availability",null),u=(0,n._)([(0,I.j)("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],u)}}]);