"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[1955],{81955:(ne,M,r)=>{r.r(M),r.d(M,{default:()=>Ne});var a=r(17626),L=(r(63290),r(90912)),T=(r(85931),r(26584)),J=r(8314),v=r(76898),R=r(69759),I=r(15861),Z=(r(20383),r(88159)),j=r(62208),w=r(10699),A=r(32917),$=r(16730),o=r(77712),D=r(2004),S=r(83137),oe=r(13812),ae=r(14772),H=r(59990),k=r(22264),le=r(84792),ue=r(93555),Q=r(2618),pe=r(95737),q=r(91179),ye=r(13410);const _=l=>l.spatialReference.wkid||JSON.stringify(l.spatialReference);function de(l,n){const{dpi:s,gdbVersion:t,geometry:e,geometryPrecision:u,height:h,layerOption:p,mapExtent:m,maxAllowableOffset:i,returnFieldName:d,returnGeometry:y,returnUnformattedValues:f,returnZ:P,spatialReference:c,timeExtent:E,tolerance:x,width:b}=l.toJSON(),{dynamicLayers:F,layerDefs:N,layerIds:G}=function he(l){const{mapExtent:n,floors:s,width:t,sublayers:e,layerIds:u,layerOption:h,gdbVersion:p}=l,m=e?.find(c=>null!=c.layer)?.layer?.serviceSublayers,i="popup"===h,d={},y=(0,S.yZ)({extent:n,width:t,spatialReference:n?.spatialReference}),f=[],P=c=>{if(c.visible&&(0===y||(0===c.minScale||y<=c.minScale)&&(0===c.maxScale||y>=c.maxScale)))if(c.sublayers)c.sublayers.forEach(P);else{if(!1===u?.includes(c.id)||i&&(!c.popupTemplate||!c.popupEnabled))return;f.unshift(c)}};if(e?.forEach(P),e&&!f.length)d.layerIds=[];else{const c=(0,ye.FN)(f,m,p),E=f.map(x=>{const b=(0,H.f)(s,x);return x.toExportImageJSON(b)});if(c)d.dynamicLayers=JSON.stringify(E);else{if(e){let b=f.map(({id:F})=>F);u&&(b=b.filter(F=>u.includes(F))),d.layerIds=b}else u?.length&&(d.layerIds=u);const x=function fe(l,n){const s=!!l?.length,t=n.filter(e=>null!=e.definitionExpression||s&&null!=e.floorInfo);return t.length?t.map(e=>{const u=(0,H.f)(l,e),h=(0,pe._)(u,e.definitionExpression);return{id:e.id,definitionExpression:h}}):null}(s,f);if((0,j.pC)(x)&&x.length){const b={};for(const F of x)F.definitionExpression&&(b[F.id]=F.definitionExpression);Object.keys(b).length&&(d.layerDefs=JSON.stringify(b))}}}return d}(l),ie=n&&(0,j.pC)(n.geometry)?n.geometry:null,C={geometryPrecision:u,maxAllowableOffset:i,returnFieldName:d,returnGeometry:y,returnUnformattedValues:f,returnZ:P,tolerance:x},U=ie&&ie.toJSON()||e;if(C.imageDisplay=`${b},${h},${s}`,t&&(C.gdbVersion=t),U&&(delete U.spatialReference,C.geometry=JSON.stringify(U),C.geometryType=(0,q.Ji)(U)),c?C.sr=c.wkid||JSON.stringify(c):U&&U.spatialReference?C.sr=_(U):m&&m.spatialReference&&(C.sr=_(m)),C.time=E?[E.start,E.end].join(","):null,m){const{xmin:Ue,ymin:Te,xmax:Ze,ymax:Ge}=m;C.mapExtent=`${Ue},${Te},${Ze},${Ge}`}return N&&(C.layerDefs=N),F&&!N&&(C.dynamicLayers=F),C.layers="popup"===p?"visible":p,G&&!F&&(C.layers+=`:${G.join(",")}`),C}var B,me=r(29132),ce=r(97478),ee=r(86810),ge=r(65234);let g=B=class extends ee.wq{constructor(l){super(l),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(l){return(0,L.TJ)(B,l)}};(0,a._)([(0,o.Cb)({type:Number,json:{write:!0}})],g.prototype,"dpi",void 0),(0,a._)([(0,o.Cb)()],g.prototype,"floors",void 0),(0,a._)([(0,o.Cb)({type:String,json:{write:!0}})],g.prototype,"gdbVersion",void 0),(0,a._)([(0,o.Cb)({types:me.qM,json:{read:q.im,write:!0}})],g.prototype,"geometry",void 0),(0,a._)([(0,o.Cb)({type:Number,json:{write:!0}})],g.prototype,"geometryPrecision",void 0),(0,a._)([(0,o.Cb)({type:Number,json:{write:!0}})],g.prototype,"height",void 0),(0,a._)([(0,o.Cb)({type:[Number],json:{write:!0}})],g.prototype,"layerIds",void 0),(0,a._)([(0,o.Cb)({type:["top","visible","all","popup"],json:{write:!0}})],g.prototype,"layerOption",void 0),(0,a._)([(0,o.Cb)({type:D.Z,json:{write:!0}})],g.prototype,"mapExtent",void 0),(0,a._)([(0,o.Cb)({type:Number,json:{write:!0}})],g.prototype,"maxAllowableOffset",void 0),(0,a._)([(0,o.Cb)({type:Boolean,json:{write:!0}})],g.prototype,"returnFieldName",void 0),(0,a._)([(0,o.Cb)({type:Boolean,json:{write:!0}})],g.prototype,"returnGeometry",void 0),(0,a._)([(0,o.Cb)({type:Boolean,json:{write:!0}})],g.prototype,"returnM",void 0),(0,a._)([(0,o.Cb)({type:Boolean,json:{write:!0}})],g.prototype,"returnUnformattedValues",void 0),(0,a._)([(0,o.Cb)({type:Boolean,json:{write:!0}})],g.prototype,"returnZ",void 0),(0,a._)([(0,o.Cb)({type:ge.Z,json:{write:!0}})],g.prototype,"spatialReference",void 0),(0,a._)([(0,o.Cb)()],g.prototype,"sublayers",void 0),(0,a._)([(0,o.Cb)({type:ce.Z,json:{write:!0}})],g.prototype,"timeExtent",void 0),(0,a._)([(0,o.Cb)({type:Number,json:{write:!0}})],g.prototype,"tolerance",void 0),(0,a._)([(0,o.Cb)({type:Number,json:{write:!0}})],g.prototype,"width",void 0),g=B=(0,a._)([(0,v.j)("esri.rest.support.IdentifyParameters")],g);const te=g;var re=r(88879),ve=r(68653),xe=r(99433),be=r(71774);let O=class extends ee.wq{constructor(l){super(l),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(l,n){return re.Z.fromJSON({attributes:{...n.attributes},geometry:{...n.geometry}})}writeFeature(l,n){if(!l)return;const{attributes:s,geometry:t}=l;s&&(n.attributes={...s}),(0,j.pC)(t)&&(n.geometry=t.toJSON(),n.geometryType=be.P$.toJSON(t.type))}};(0,a._)([(0,o.Cb)({type:String,json:{write:!0}})],O.prototype,"displayFieldName",void 0),(0,a._)([(0,o.Cb)({type:re.Z})],O.prototype,"feature",void 0),(0,a._)([(0,ve.r)("feature",["attributes","geometry"])],O.prototype,"readFeature",null),(0,a._)([(0,xe.c)("feature")],O.prototype,"writeFeature",null),(0,a._)([(0,o.Cb)({type:Number,json:{write:!0}})],O.prototype,"layerId",void 0),(0,a._)([(0,o.Cb)({type:String,json:{write:!0}})],O.prototype,"layerName",void 0),O=(0,a._)([(0,v.j)("esri.rest.support.IdentifyResult")],O);const Ie=O;function z(){return(z=(0,I.Z)(function*(l,n,s){const t=(n=Ce(n)).geometry?[n.geometry]:[],e=(0,Q.en)(l);return e.path+="/identify",(0,ue.aX)(t).then(u=>{const h=de(n,{geometry:u&&u[0]}),p=(0,Q.cv)({...e.query,f:"json",...h}),m=(0,Q.lA)(p,s);return(0,le.default)(e.path,m).then(Ee).then(i=>Fe(i,n.sublayers))})})).apply(this,arguments)}function Ee(l){const n=l.data;return n.results=n.results||[],n.exceededTransferLimit=Boolean(n.exceededTransferLimit),n.results=n.results.map(s=>Ie.fromJSON(s)),n}function Ce(l){return te.from(l)}function Fe(l,n){if(!n?.length)return l;const s=new Map;n.forEach(function t(e){s.set(e.id,e),e.sublayers&&e.sublayers.forEach(t)});for(const e of l.results)e.feature.sourceLayer=s.get(e.layerId);return l}var je=r(46679),Oe=r(51815),se=r(10023),Re=r(57213);let W=null;const we=l=>{let n=class extends l{constructor(){var s;super(...arguments),s=this,this._featuresResolutions=new WeakMap,this.highlightGraphics=new Oe.J,this.updateHighlightedFeatures=(0,w.Ds)(function(){var t=(0,I.Z)(function*(e){s.destroyed||s.updatingHandles.addPromise(s._updateHighlightedFeaturesGeometries(e).catch(()=>{}))});return function(e){return t.apply(this,arguments)}}())}initialize(){this.exportImageParameters=new ae.R({layer:this.layer}),this.handles.add([(0,A.on)(()=>this.highlightGraphics,"change",s=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(s.added).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)})])}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){return this.exportImageParameters?.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}fetchPopupFeatures(s,t){var e=this;return(0,I.Z)(function*(){const{layer:u}=e;if(!s)throw new T.Z("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:u});const h=e.layer.capabilities?.operations?.supportsQuery??!0;if(!((e.layer.capabilities?.operations?.supportsIdentify??1)&&e.layer.version>=10.5||h))throw new T.Z("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:u});return h?e._fetchPopupFeaturesUsingQueries(s,t):e._fetchPopupFeaturesUsingIdentify(s,t)})()}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}_updateHighlightedFeaturesSymbols(s){var t=this;return(0,I.Z)(function*(){for(const e of s){const u="renderer"in e.sourceLayer&&e.sourceLayer.renderer;"geometryType"in e.sourceLayer&&"point"===e.sourceLayer.geometryType&&u&&"getSymbolAsync"in u&&u.getSymbolAsync(e).then(function(){var h=(0,I.Z)(function*(p){let m="width"in p&&"height"in p&&null!=p.width&&null!=p.height?Math.max(p.width,p.height):"size"in p?p.size:null;const i="visualVariables"in u&&u.visualVariables?.find(d=>"size"===d.type);i&&(W||(W=(yield Promise.resolve().then(r.bind(r,81808))).getSize),m=W(i,e,{view:t.view.type,scale:t.view.scale,shape:"simple-marker"===p.type?p.style:null})),t.highlightGraphics.includes(e)&&(e.symbol=new Re.Z({style:"square",size:m,xoffset:"xoffset"in p?p.xoffset:0,yoffset:"yoffset"in p?p.yoffset:0}),e.visible=!0,t.highlightGraphicUpdated(e,"symbol"))});return function(p){return h.apply(this,arguments)}}())}})()}_updateHighlightedFeaturesGeometries(s){var t=this;return(0,I.Z)(function*(){t._highlightGeometriesResolution=s;const e=t.highlightGraphics;if(!e.length||!t.layer.capabilities.operations.supportsQuery)return;const u=t._getTargetResolution(s),h=new Map;for(const i of e)(!t._featuresResolutions.has(i)||t._featuresResolutions.get(i)>u)&&(0,Z.s1)(h,i.sourceLayer,()=>new Map).set(i.getObjectId(),i);const p=Array.from(h,([i,d])=>{const y=i.createQuery();return y.objectIds=[...d.keys()],y.outFields=[i.objectIdField],y.returnGeometry=!0,y.maxAllowableOffset=u,y.outSpatialReference=t.view.spatialReference,i.queryFeatures(y)}),m=yield Promise.all(p);if(!t.destroyed)for(const{features:i}of m)for(const d of i){const f=h.get(d.sourceLayer).get(d.getObjectId());f&&t.highlightGraphics.includes(f)&&(f.geometry=d.geometry,t.highlightGraphicUpdated(f,"geometry"),t._featuresResolutions.set(f,u))}})()}_getTargetResolution(s){const t=s*(0,$.c9)(this.view.spatialReference),e=t/16;return e<=10?0:s/t*e}_fetchPopupFeaturesUsingIdentify(s,t){var e=this;return(0,I.Z)(function*(){const u=yield e._createIdentifyParameters(s,t);if((0,j.Wi)(u))return[];const{results:h}=yield function Pe(l,n,s){return z.apply(this,arguments)}(e.layer.parsedUrl,u);return h.map(p=>p.feature)})()}_createIdentifyParameters(s,t){var e=this;return(0,I.Z)(function*(){const{floors:u,spatialReference:h,scale:p}=e.view,m=(0,j.pC)(t)?t.event:null,i=yield e._collectPopupProviders(e.layer.sublayers,p,t);if(!i.length)return null;yield Promise.all(i.map(({sublayer:E})=>E.load().catch(()=>{})));const d=Math.min((0,J.Z)("mapimagelayer-popup-identify-max-tolerance"),e.layer.allSublayers.reduce((E,x)=>x.renderer?(0,k.k)({renderer:x.renderer,event:m}):E,2)),y=e.createFetchPopupFeaturesQueryGeometry(s,d),f=(0,S.dp)(p,h),P=Math.round(y.width/f),c=new D.Z({xmin:y.center.x-f*P,ymin:y.center.y-f*P,xmax:y.center.x+f*P,ymax:y.center.y+f*P,spatialReference:y.spatialReference});return new te({floors:u,gdbVersion:e.layer.gdbVersion,geometry:s,height:P,layerOption:"popup",mapExtent:c,returnGeometry:!0,spatialReference:h,sublayers:e.layer.sublayers,timeExtent:e.timeExtent,tolerance:d,width:P})})()}_fetchPopupFeaturesUsingQueries(s,t){var e=this;return(0,I.Z)(function*(){const u=yield e._collectPopupProviders(e.layer.sublayers,e.view.scale,t),h=(0,j.pC)(t)?t.event:null,p=u.map(function(){var m=(0,I.Z)(function*({sublayer:i,popupTemplate:d}){yield i.load().catch(()=>{});const y=i.createQuery(),f=(0,k.k)({renderer:i.renderer,event:h}),P=e.createFetchPopupFeaturesQueryGeometry(s,f);if(y.geometry=P,y.outFields=yield(0,se.e)(i,d),y.timeExtent=e.timeExtent,"floors"in e.view){const N=e.view?.floors?.clone(),G=(0,H.f)(N,i);(0,j.pC)(G)&&(y.where=y.where?`(${y.where}) AND (${G})`:G)}const c=e._getTargetResolution(P.width/f),E=yield e._loadArcadeModules(d),x="point"===i.geometryType||E&&E.arcadeUtils.hasGeometryOperations(d);x||(y.maxAllowableOffset=c);const{features:b}=yield i.queryFeatures(y),F=x?0:c;for(const N of b)e._featuresResolutions.set(N,F);return b});return function(i){return m.apply(this,arguments)}}());return(yield(0,w.as)(p)).reverse().reduce((m,i)=>i.value?[...m,...i.value]:m,[]).filter(m=>null!=m)})()}_collectPopupProviders(s,t,e){return(0,I.Z)(function*(){const u=[],h=function(){var m=(0,I.Z)(function*(i){if(i.visible&&(0===i.minScale||t<=i.minScale)&&(0===i.maxScale||t>=i.maxScale))if(i.sublayers)i.sublayers.forEach(h);else if(i.popupEnabled){const f=(0,se.V)(i,{...e,defaultPopupTemplateEnabled:!1});(0,j.pC)(f)&&u.unshift({sublayer:i,popupTemplate:f})}});return function(d){return m.apply(this,arguments)}}(),p=s.toArray().reverse().map(h);return yield Promise.all(p),u})()}_loadArcadeModules(s){if(s.expressionInfos?.length||Array.isArray(s.content)&&s.content.some(t=>"expression"===t.type))return(0,je.LC)()}};return(0,a._)([(0,o.Cb)()],n.prototype,"highlightGraphics",void 0),(0,a._)([(0,o.Cb)()],n.prototype,"exportImageParameters",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],n.prototype,"exportImageVersion",null),(0,a._)([(0,o.Cb)()],n.prototype,"layer",void 0),(0,a._)([(0,o.Cb)()],n.prototype,"suspended",void 0),(0,a._)([(0,o.Cb)(oe.qG)],n.prototype,"timeExtent",void 0),n=(0,a._)([(0,v.j)("esri.views.layers.MapImageLayerView")],n),n};var Se=r(94672);let K=class extends(we(R.Z)){constructor(){super(...arguments),this.type="map-image-3d"}initialize(){this.updatingHandles.add(()=>this.exportImageVersion,()=>this.updatingHandles.addPromise(this.refreshDebounced()))}createFetchPopupFeaturesQueryGeometry(l,n){return(0,Se.K)(l,n,this.view)}highlight(l){return{remove:()=>{}}}highlightGraphicUpdated(l,n){}getFetchOptions(){return{timeExtent:this.timeExtent}}};K=(0,a._)([(0,v.j)("esri.views.3d.layers.MapImageLayerView3D")],K);const Ne=K},10023:(ne,M,r)=>{r.d(M,{V:()=>J,e:()=>X});var a=r(15861),V=r(62208),L=r(36630);function X(v){return T.apply(this,arguments)}function T(){return(T=(0,a.Z)(function*(v,R=v.popupTemplate){if((0,V.Wi)(R))return[];const I=yield R.getRequiredFields(v.fieldsIndex),{lastEditInfoEnabled:Y}=R,{objectIdField:Z,typeIdField:j,globalIdField:w,relationships:A}=v;if(I.includes("*"))return["*"];const $=Y?yield(0,L.CH)(v):[],o=(0,L.Q0)(v.fieldsIndex,[...I,...$]);return j&&o.push(j),o&&Z&&v.fieldsIndex.has(Z)&&!o.includes(Z)&&o.push(Z),o&&w&&v.fieldsIndex.has(w)&&!o.includes(w)&&o.push(w),A&&A.forEach(D=>{const{keyField:S}=D;o&&S&&v.fieldsIndex.has(S)&&!o.includes(S)&&o.push(S)}),o})).apply(this,arguments)}function J(v,R){return v.popupTemplate?v.popupTemplate:(0,V.pC)(R)&&R.defaultPopupTemplateEnabled&&(0,V.pC)(v.defaultPopupTemplate)?v.defaultPopupTemplate:null}}}]);