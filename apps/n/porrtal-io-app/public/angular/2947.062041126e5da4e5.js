"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[2947],{88034:(ie,K,s)=>{s.d(K,{H:()=>B,b:()=>y});var A=s(98071),a=s(49480),V=s(65787),C=s(17625),S=s(22355),h=s(35387);function y(){const M=new S.kG;return M.include(A.k),M.include(a.f),M.fragment.uniforms.add([new h.A("densityMap",g=>g.densityMap),new h.A("tex",g=>g.colorRamp),new V.p("densityNormalizer",g=>1/(g.maxDensity-g.minDensity)),new V.p("minDensity",g=>g.minDensity)]),M.fragment.uniforms.add(new V.p("densityMultiplier",g=>3/(g.searchRadius*g.searchRadius*Math.PI))),M.fragment.code.add(C.H`void main() {
float density = texture2D(densityMap, uv).r * densityMultiplier;
float densityRatio = (density - minDensity) * densityNormalizer;
vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));
discardOrAdjustAlpha(color);
gl_FragColor = color;
}`),M}const B=Object.freeze(Object.defineProperty({__proto__:null,build:y},Symbol.toStringTag,{value:"Module"}))},81768:(ie,K,s)=>{s.d(K,{H:()=>y,b:()=>h});var A=s(2166),a=s(65787),V=s(17625),C=s(22355),S=s(16396);function h(B){const M=new C.kG;(0,A.S)(M,B);const{isAttributeDriven:g}=B;return M.attributes.add(S.T.POSITION,"vec3"),M.attributes.add(S.T.UV0,"vec2"),g&&(M.attributes.add(S.T.FEATUREATTRIBUTE,"float"),M.varyings.add("attributeValue","float")),M.varyings.add("unitCirclePos","vec2"),M.vertex.uniforms.add(new a.p("radius",({resolutionForScale:m,searchRadius:F},{camera:T,screenToWorldRatio:L})=>2*F*(0===m?1:m/L)*T.pixelRatio/T.fullViewport[2])),M.vertex.code.add(V.H`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${S.T.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${g?V.H`attributeValue = ${S.T.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),M.fragment.code.add(V.H`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${g?V.H` * attributeValue`:""};
      gl_FragColor = vec4(density);
    }
  `),M}const y=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}))},23010:(ie,K,s)=>{s.d(K,{g:()=>N});var A=s(15861),a=s(17626),V=s(14517),C=s(59213),S=s(46160),y=(s(8314),s(26584)),B=s(72392),M=s(58817),g=s(63290),m=s(62208),F=s(60330),T=s(10699),L=s(32917),I=s(77712),Y=(s(90912),s(76898)),de=s(17760),ce=s(38305),pe=s(35082),me=s(60776),ve=s(54984),ne=s(88879),z=s(37118),ee=s(9260),oe=s(69852),se=s(89673),re=s(21716),_e=s(23461);const P=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class Fe{constructor(n,v,D){this.loadingGraphics=new Map,this.loadedGraphics=new Map,this.pendingGraphics=new Map,this._enabled=!0,this.tileFetcher=n,this.view=D,this.tilingScheme=new _e.t(v),this.loadedSymbols=P.map(R=>new se.Z(new ee.Z({material:{color:[R[0],R[1],R[2],.6]},outline:{color:"black",size:1}}))),this.loadingSymbols=[new se.Z(new ee.Z({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this.pendingSymbols=[new se.Z(new ee.Z({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this.dataExtentSymbol=new se.Z(new ee.Z({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(n){this._enabled=n,this.update()}update(){this._enabled?(this._synchronizeMaps(this.loadingGraphics,{filter:n=>n.isFetching,symbols:this.loadingSymbols}),this._synchronizeMaps(this.loadedGraphics,{filter:n=>!n.isFetching,symbols:this.loadedSymbols}),this._synchronizeMaps(this.pendingGraphics,{filter:n=>!n.isFetching,symbols:this.pendingSymbols}),this.showDataExtent(this.tileFetcher.filterExtent)):(this.loadingGraphics.forEach(n=>{this.view.graphics.removeMany(n)}),this.loadingGraphics.clear(),this.loadedGraphics.forEach(n=>{this.view.graphics.removeMany(n)}),this.loadedGraphics.clear(),this.pendingGraphics.forEach(n=>{this.view.graphics.removeMany(n)}),this.pendingGraphics.clear(),this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null))}showDataExtent(n){if(this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null),!n)return;const v=z.Z.fromExtent(n);this.dataExtentGraphic=new ne.Z({geometry:v,symbol:this.dataExtentSymbol}),this.view.graphics.add(this.dataExtentGraphic)}_synchronizeMaps(n,v){const D=[];n.forEach((R,_)=>{const H=this.tileFetcher.test.getFeatureTileById(_);H&&v.filter(H)||(this.view.graphics.removeMany(R),D.push(_))}),D.forEach(R=>n.delete(R)),this.tileFetcher.test.forEachFeatureTile(R=>{if(v.filter(R)&&!n.has(R.id)){const[_,H,J]=R.descriptor.lij;this.tilingScheme.ensureMaxLod(_);const e=this.tilingScheme.getExtentGeometry(_,H,J),t=[new ne.Z({geometry:e,symbol:v.symbols[_%v.symbols.length]}),new ne.Z({geometry:e.center,symbol:new oe.Z({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new re.Z({text:`${_}/${H}/${J}`,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];n.set(R.id,t),this.view.graphics.addMany(t)}})}}var fe=s(93605);const le=g.Z.getLogger("esri.layers.graphics.controllers.FeatureTileController3D");let N=class extends((0,F.v)(V.Z)){constructor(l){super(l),this.type="feature-tile-3d",this.watchUpdatingTracking=new de.t,this.serviceDataExtent=null,this.serviceDataCount=X.NO_SERVICE_DATA_COUNT,this.vertexLimitExceeded=!1,this.displayFeatureLimit=null,this.suspended=!1,this.tileFetcher=null,this.handles=new B.Z,this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null,this.lifeCycleAbortController=new AbortController}set extent(l){if(l&&!l.spatialReference.equals(this.layerView.view.spatialReference))return void le.error("#extent=","extent needs to be in the same spatial reference as the view");const n=this._get("extent");if(n===l||n&&l&&n.equals(l))return;const v=l?l.clone():null;this._set("extent",v)}get updating(){return!!((0,m.pC)(this.tileFetcher)&&this.tileFetcher.updating||null!=this.fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}get updatingTotal(){return this.updating&&(0,m.pC)(this.tileFetcher)?this.tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&(0,m.pC)(this.tileFetcher)?this.tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&(0,m.pC)(this.tileFetcher)?this.tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return(0,m.pC)(this.tileFetcher)?this.tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(!(0,m.pC)(this.tileFetcher)||!this.tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return(0,m.pC)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0}set maximumNumberOfFeatures(l){l!==this.maximumNumberOfFeatures&&(null==l?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",l))}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get mode(){const l=this.layerView.layer;if("feature"===l.type&&(0,m.pC)(l.infoFor3D))return"snapshot";if(!1===this.layerView.view.qualitySettings?.graphics3D?.snapshotAvailable||this.serviceDataCount===X.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";const n=this.layerView.view,v=n&&n.featureTiles,D=v&&v.tilingScheme;if(l&&l.minScale&&this.serviceDataExtent&&D){const R=this._approximateExtentSizeAtScale(l.minScale,D);if((this.serviceDataExtent.width/R+this.serviceDataExtent.height/R)/2>X.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const l=this._get("maxTotalSnapshotVertices")||0,n="snapshot"===this.mode&&(0,m.pC)(this.tileFetcher)&&this.tileFetcher.totalVertices||0;return Math.max(l,n)}_approximateExtentSizeAtScale(l,n){const v=this.layerView.view,D=Math.ceil((v.width/n.pixelSize+v.height/n.pixelSize)/2),R=n.levels[0];return D*((R.tileSize[0]/(R.scale/l)+R.tileSize[1]/(R.scale/l))/2)}get tileDescriptors(){return"snapshot"===this.mode?new S.Z([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new S.Z}get test(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}}initialize(){this.watchUpdatingTracking.add(()=>this.vertexLimitInfo,()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal))),this.watchUpdatingTracking.add(()=>this.mode,()=>this._modeChanged(),L.nn),this.addResolvingPromise(Promise.resolve().then(()=>this._verifyCapabilities()).then(()=>this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo())).then(()=>this._initializeTileFetcher()))}_verifyCapabilities(){const l=this.layerView.layer;if(!l.get("capabilities.operations.supportsQuery")&&"ogc-feature"!==l.type)throw new y.Z("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:l})}destroy(){this._cancelFetchServiceDataInfo(),this.tileFetcher=(0,m.SC)(this.tileFetcher),this.handles=(0,m.SC)(this.handles),this.tilesHandle=(0,m.hw)(this.tilesHandle),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}suspend(){this.suspended||(this.suspended=!0,(0,m.pC)(this.tileFetcher)&&this.tileFetcher.suspend())}resume(){this.suspended&&(this.suspended=!1,(0,m.pC)(this.tileFetcher)&&this.tileFetcher.resume())}restart(){const l=()=>{(0,m.pC)(this.tileFetcher)&&this.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(l,l))}refetch(){const l=()=>{(0,m.pC)(this.tileFetcher)&&this.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(l,l))}_initializeTileFetcher(){const l=this.layerView.view;if(!l)return;const n=(0,L.N1)(()=>l.featureTiles?.tilingScheme,this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(n),n.then(()=>{const{layerView:v,tileDescriptors:D}=this,R=v.layer,_=new ve.j({context:this.context,filterExtent:this.extent,tileDescriptors:D,features:this.graphics});this.tileFetcher=_,this.suspended?this.tileFetcher.suspend():this.tileFetcher.resume();const H=this.layerView.view.resourceController;H&&this.handles.add((0,L.YP)(()=>H.memoryController.memoryFactor,i=>_.memoryFactor=i,L.tX));const J="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;J&&this.handles.add((0,L.YP)(()=>this.layerView.view?.qualitySettings?.graphics3D?.[J],i=>_.lodFactor=i||1,L.nn)),"ogc-feature"!==R.type&&this.watchUpdatingTracking.add(()=>R.createQueryVersion,()=>this._dataFilterChanged()),this.watchUpdatingTracking.add(()=>v.availableFields,(i,r)=>this._availableFieldsChanged(r,i)),this.watchUpdatingTracking.add(()=>v.requiredFields,(i,r)=>this._requiredFieldsChanged(r,i)),this.handles.add([R.on("apply-edits",i=>this._applyEdits(i)),(0,L.YP)(()=>this.extent,i=>_.filterExtent=i,L.Z_),(0,L.YP)(()=>this.tileDescriptors,i=>_.tileDescriptors=i,L.Z_),(0,L.YP)(()=>this.maximumNumberOfFeatures,i=>{_.maximumNumberOfFeatures=i,_.useTileCount=this.serviceDataCount>i},L.tX),(0,L.YP)(()=>this.serviceDataCount,i=>_.useTileCount=i>this.maximumNumberOfFeatures,L.tX),(0,L.YP)(()=>fe.Z.FEATURE_TILE_FETCH_SHOW_TILES,i=>{i&&_&&!_.debugger?(_.debugger=new Fe(_,l.featureTiles.tilingScheme.toTileInfo(),l),_.debugger.update()):!i&&this.tileFetcher&&_.debugger&&(_.debugger.destroy(),_.debugger=null)},L.tX)]),this.supportsExceedsLimitQuery||this.watchUpdatingTracking.add(()=>this.maxTotalSnapshotVertices,()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal)))}).catch(()=>{})}_modeChanged(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:le.warn("Unhandled feature layer mode "+this.mode);case"snapshot":(0,m.pC)(this.tilesHandle)&&(this.tilesHandle.remove(),this.tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}_applyEdits(l){(0,m.Wi)(this.tileFetcher)||this.tileFetcher.applyEdits(l).then(n=>{n&&(n.deletedFeatures.length||n.updatedFeatures.length||n.addedFeatures.length)&&this.watchUpdatingTracking.addPromise(this._updateServiceDataExtent(this.lifeCycleAbortController.signal))}).catch(n=>{if(!(0,T.D_)(n))throw n})}_availableFieldsChanged(l,n){(0,m.pC)(this.tileFetcher)&&ye(this.tileFetcher.availableFields,n)&&this.refetch()}_requiredFieldsChanged(l,n){(0,m.pC)(this.tileFetcher)&&ye(this.tileFetcher.availableFields,n)&&this.restart()}_createVertexLimitExceededQuery(l){const n=this.layerView.layer,v=n.createQuery();return v.outStatistics=[new me.Z({statisticType:"exceedslimit",maxVertexCount:l,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],n.capabilities.query.supportsCacheHint&&(v.cacheHint=!0),v}_createDataInfoQuery(){const l=this.layerView.layer,n=l.createQuery();return n.outSpatialReference=this.layerView.view.spatialReference,l.capabilities.query.supportsCacheHint&&(n.cacheHint=!0),n}_fullExtentIsAccurate(){const l=this.layerView.layer;if(l.definitionExpression)return!1;switch(l.type){case"feature":return(0,ce.M8)(l.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}_updateServiceDataExtent(l){var n=this;return(0,A.Z)(function*(){try{yield n._tryUpdateServiceDataExtent(l)}catch(v){(0,T.D_)(v)||n._set("serviceDataExtent",(0,M.d9)(n.layerView.fullExtentInLocalViewSpatialReference))}})()}_tryUpdateServiceDataExtent(l){var n=this;return(0,A.Z)(function*(){const v=n.layerView,D=v.layer,R=D.capabilities.query.supportsExtent,_=(0,M.d9)(v.fullExtentInLocalViewSpatialReference),H=D.fullExtent,J=n._fullExtentIsAccurate();if(R&&n.serviceDataCount<=X.MAX_FEATURE_COUNT_FOR_EXTENT&&(!_||!J)&&"queryExtent"in D){const t=n._createDataInfoQuery(),i=yield D.queryExtent(t,{timeout:X.QUERY_EXTENT_TIMEOUT,signal:l});n._set("serviceDataExtent",i.extent)}else if(_)n._set("serviceDataExtent",_);else if((0,m.pC)(H)){const t="portalItem"in D?D.portalItem:null,i=yield(0,pe.projectGeometry)(H,v.view.spatialReference,t,l);n._set("serviceDataExtent",i)}else n._set("serviceDataExtent",null)})()}_updateServiceDataCount(l){var n=this;return(0,A.Z)(function*(){const v=n.layerView.layer;if(!("queryFeatureCount"in v))return void n._set("serviceDataCount",X.NO_SERVICE_DATA_COUNT);const D=yield(0,C.q6)(v.queryFeatureCount(n._createDataInfoQuery(),{timeout:X.QUERY_STATISTICS_TIMEOUT,signal:l}));if(!0===D.ok)n._set("serviceDataCount",D.value);else{if((0,T.D_)(D.error))throw D.error;n._set("serviceDataCount",X.NO_SERVICE_DATA_COUNT)}})()}get vertexLimitInfo(){if((0,m.Wi)(this.displayFeatureLimit)||(0,m.Wi)(this.displayFeatureLimit.averageSymbolComplexity))return null;const{averageSymbolComplexity:l,maximumTotalNumberOfPrimitives:n}=this.displayFeatureLimit,{primitivesPerCoordinate:v,primitivesPerFeature:D}=l,R=this._get("vertexLimitInfo");return(0,m.Wi)(R)||R.maximumTotalNumberOfPrimitives!==n||R.primitivesPerCoordinate!==v||R.primitivesPerFeature!==D?{primitivesPerCoordinate:v,primitivesPerFeature:D,maximumTotalNumberOfPrimitives:n}:R}get supportsExceedsLimitQuery(){const l=this.layerView.layer;return l.capabilities&&l.capabilities.operations&&l.capabilities.operations.supportsExceedsLimitStatistics}get minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}_updateVertexLimitExceeded(l,n){var v=this;return(0,A.Z)(function*(){const D=v.vertexLimitInfo;if((0,m.Wi)(D))return void v._set("vertexLimitExceeded",!1);const _=v.minimumNumberOfVerticesForGeometry>1;if(!(D.primitivesPerFeature<=0||_))return void v._set("vertexLimitExceeded",!1);const{primitivesPerFeature:H,primitivesPerCoordinate:J,maximumTotalNumberOfPrimitives:e}=D;let t;0!==H&&(0,m.pC)(l)&&(yield l);const i=v.serviceDataCount,r=i!==X.NO_SERVICE_DATA_COUNT;if(t=Math.ceil(r?(e-i*H)/(J||1):e/(J||1)),_&&(t=Math.min(t,Ee)),r&&v.minimumNumberOfVerticesForGeometry*i>t)return void v._set("vertexLimitExceeded",!0);if(!v.supportsExceedsLimitQuery)return void v._set("vertexLimitExceeded",v.maxTotalSnapshotVertices>t);const c=yield(0,C.q6)(v.layerView.layer.queryFeatures(v._createVertexLimitExceededQuery(t),{timeout:X.QUERY_STATISTICS_TIMEOUT,signal:n}));if(!1===c.ok){if((0,T.D_)(c.error))throw c.error;return void v._set("vertexLimitExceeded",!1)}const p=c.value.features[0];v._set("vertexLimitExceeded",!(!p||!p.attributes||!p.attributes.exceedslimit))})()}_fetchServiceDataInfo(){var l=this;return(0,A.Z)(function*(){l._cancelFetchServiceDataInfo();let n=new AbortController;const v=n.signal,D=l._updateServiceDataCount(v),R=(0,T.as)([D,l._updateVertexLimitExceeded(D,v)]),_=R.then(()=>l._updateServiceDataExtent(v)).catch(H=>{(0,T.D_)(H)||le.error("#fetchServiceDataInfo()",H)}).then(()=>{_===l.fetchDataInfoPromise&&(l.fetchDataInfoPromise=null,l.fetchDataInfoAbortController=null),n=null});return n&&(l.fetchDataInfoPromise=_),l.fetchDataInfoAbortController=n,R.then(()=>{},()=>{})})()}_cancelFetchServiceDataInfo(){const l=this.fetchDataInfoAbortController;l&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,l.abort())}get debug(){return{storedFeatures:(0,m.pC)(this.tileFetcher)?this.tileFetcher.storedFeatures:0,totalFeatures:(0,m.pC)(this.tileFetcher)?this.tileFetcher.totalFeatures:0,totalVertices:(0,m.pC)(this.tileFetcher)?this.tileFetcher.totalVertices:0}}};(0,a._)([(0,I.Cb)({readOnly:!0})],N.prototype,"type",void 0),(0,a._)([(0,I.Cb)({constructOnly:!0})],N.prototype,"graphics",void 0),(0,a._)([(0,I.Cb)({constructOnly:!0})],N.prototype,"layerView",void 0),(0,a._)([(0,I.Cb)({constructOnly:!0})],N.prototype,"context",void 0),(0,a._)([(0,I.Cb)()],N.prototype,"extent",null),(0,a._)([(0,I.Cb)()],N.prototype,"updating",null),(0,a._)([(0,I.Cb)({readOnly:!0})],N.prototype,"watchUpdatingTracking",void 0),(0,a._)([(0,I.Cb)()],N.prototype,"updatingTotal",null),(0,a._)([(0,I.Cb)()],N.prototype,"updatingRemaining",null),(0,a._)([(0,I.Cb)()],N.prototype,"expectedFeatureDiff",null),(0,a._)([(0,I.Cb)()],N.prototype,"memoryForUnusedFeatures",null),(0,a._)([(0,I.Cb)()],N.prototype,"maximumNumberOfFeaturesExceeded",null),(0,a._)([(0,I.Cb)({readOnly:!0})],N.prototype,"serviceDataExtent",void 0),(0,a._)([(0,I.Cb)({readOnly:!0})],N.prototype,"serviceDataCount",void 0),(0,a._)([(0,I.Cb)({readOnly:!0})],N.prototype,"vertexLimitExceeded",void 0),(0,a._)([(0,I.Cb)()],N.prototype,"displayFeatureLimit",void 0),(0,a._)([(0,I.Cb)({type:Number})],N.prototype,"maximumNumberOfFeatures",null),(0,a._)([(0,I.Cb)({readOnly:!0})],N.prototype,"mode",null),(0,a._)([(0,I.Cb)({readOnly:!0})],N.prototype,"maxTotalSnapshotVertices",null),(0,a._)([(0,I.Cb)({readOnly:!0,dependsOn:["mode"]})],N.prototype,"tileDescriptors",null),(0,a._)([(0,I.Cb)()],N.prototype,"tileFetcher",void 0),(0,a._)([(0,I.Cb)()],N.prototype,"fetchDataInfoPromise",void 0),(0,a._)([(0,I.Cb)({readOnly:!0})],N.prototype,"vertexLimitInfo",null),N=(0,a._)([(0,Y.j)("esri.layers.graphics.controllers.FeatureTileController3D")],N);const Ee=5e6;function ye(l,n){if(!n)return!1;for(const v of n)if(!l.has(v))return!0;return!1}var X,l;(l=X||(X={})).NO_SERVICE_DATA_COUNT=1/0,l.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,l.reset=function n(){l.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,l.QUERY_STATISTICS_TIMEOUT=12e3,l.QUERY_EXTENT_TIMEOUT=1e4},X.reset()},61256:(ie,K,s)=>{s.d(K,{H:()=>B});var A=s(8314),a=s(36592),V=s(65401);const S={minX:0,minY:0,maxX:0,maxY:0};class B{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new a.Q(9,(0,A.Z)("esri-csp-restrictions")?g=>({minX:g[0],minY:g[1],maxX:g[2],maxY:g[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const g=new Array(this._idByBounds.size);let m=0;this._idByBounds.forEach((F,T)=>{g[m++]=T}),this._indexInvalid=!1,this._index.clear(),this._index.load(g)}else this._boundsToLoad.length&&(this._index.load(this._boundsToLoad.filter(g=>this._idByBounds.has(g))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const g=(0,V.cS)();for(const m of this._boundsById.values())m&&(g[0]=Math.min(m[0],g[0]),g[1]=Math.min(m[1],g[1]),g[2]=Math.max(m[2],g[2]),g[3]=Math.max(m[3],g[3]));return g}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(g){const m=this._boundsById.get(g);this._boundsById.delete(g),m&&(this._idByBounds.delete(m),this._indexInvalid||this._index.remove(m))}forEachInBounds(g,m){this._loadIndex(),function y(M,g,m){(function h(M){S.minX=M[0],S.minY=M[1],S.maxX=M[2],S.maxY=M[3]})(g),M.search(S,m)}(this._index,g,F=>m(this._idByBounds.get(F)))}get(g){return this._boundsById.get(g)}has(g){return this._boundsById.has(g)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(g,m){if(!this._indexInvalid){const F=this._boundsById.get(g);F&&(this._index.remove(F),this._idByBounds.delete(F))}this._boundsById.set(g,m),m&&(this._idByBounds.set(m,g),this._indexInvalid||(this._boundsToLoad.push(m),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},3579:(ie,K,s)=>{s.d(K,{Z:()=>g});var A=s(26584),a=s(61885),V=s(63290),C=s(62208),S=s(5548),h=s(65401),y=s(82054),B=s(61256),M=s(92794);class g{constructor(F){this.geometryInfo=F,this._boundsStore=new B.H,this._featuresById=new Map,this._markedIds=new Set,this.events=new a.Z,this.featureAdapter=M.n}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let F=0;return this._featuresById.forEach(T=>{(0,C.pC)(T.geometry)&&T.geometry.coords&&(F+=T.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:F/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}add(F){this._add(F),this._emitChanged()}addMany(F){for(const T of F)this._add(T);this._emitChanged()}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(F){const T=this._featuresById.get(F);return T?(this._remove(T),this._emitChanged(),T):null}removeManyById(F){this._boundsStore.invalidateIndex();for(const T of F){const L=this._featuresById.get(T);L&&this._remove(L)}this._emitChanged()}forEachBounds(F,T,L){for(const I of F){const W=this._boundsStore.get(I.objectId);W&&T((0,S.JR)(L,W))}}getFeature(F){return this._featuresById.get(F)}has(F){return this._featuresById.has(F)}toArray(){return Array.from(this._featuresById.values())}forEach(F){this._featuresById.forEach(T=>F(T))}forEachInBounds(F,T){this._boundsStore.forEachInBounds(F,L=>{T(this._featuresById.get(L))})}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let F=!1;this._featuresById.forEach((T,L)=>{this._markedIds.has(L)||(F=!0,this._remove(T))}),this._markedIds.clear(),F&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(F){if(!F)return;const T=F.objectId;if(null==T)return void V.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new A.Z("featurestore:invalid-feature","feature id is missing",{feature:F}));const L=this._featuresById.get(T);let I;if(this._markedIds.add(T),L?(F.displayId=L.displayId,I=this._boundsStore.get(T),this._boundsStore.delete(T)):(0,C.pC)(this.onFeatureAdd)&&this.onFeatureAdd(F),(0,C.Wi)(F.geometry)||!F.geometry.coords||!F.geometry.coords.length)return this._boundsStore.set(T,null),void this._featuresById.set(T,F);I=(0,y.$)((0,C.pC)(I)?I:(0,h.Ue)(),F.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),(0,C.pC)(I)&&this._boundsStore.set(T,I),this._featuresById.set(T,F)}_remove(F){return(0,C.pC)(this.onFeatureRemove)&&this.onFeatureRemove(F),this._markedIds.delete(F.objectId),this._boundsStore.delete(F.objectId),this._featuresById.delete(F.objectId),F}}},79216:(ie,K,s)=>{s.d(K,{R:()=>qe});var A=s(15861),a=s(17626),V=s(26584),C=s(62208),S=s(32917),h=s(77712),g=(s(85931),s(8314),s(90912),s(76898)),m=s(84786),F=s(23010),T=s(84952),L=s(79650),I=s(34675),W=s(27306),Y=s(80542),de=s(54024),ce=s(63290),pe=s(23841),me=s(84161),ve=s(28093),ne=s(55915),z=s(83137),ee=s(38114),oe=s(82054),se=s(66385),re=s(88071),_e=s(3579),P=s(36630),Fe=s(36859),fe=s(62600),le=s(64835),N=s(42743),he=s(59617),G=s(87601),ue=s(19597),Ee=s(14411),ye=s(17625),X=s(651),l=s(91056),n=s(39114),v=s(88569),D=s(12407),R=s(88034),_=s(67969),H=s(2078);class J extends ye.K{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class e extends l.A{constructor(f,u){super(f,u,()=>this.destroy())}initializeProgram(f){const u=e.shader.get().build();return new D.$(f.rctx,u,n.i)}initializePipeline(){return(0,H.sm)({blending:v.wu,colorWrite:H.BK,depthTest:null,depthWrite:null})}get primitiveType(){return _.MX.TRIANGLE_STRIP}}e.shader=new X.J(R.H,()=>s.e(4194).then(s.bind(s,74194)));var t=s(85775),i=s(55086),r=s(26906);let c=class extends Ee.S{constructor(o){super(o),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new J}initialize(){const o={colorTarget:_.Lm.TEXTURE,depthStencilTarget:_.OU.NONE,width:0,height:0},{capabilities:f}=this.rctx,{R32F:u}=f.colorBufferFloat,{textureFloatLinear:d}=f.textureFloat,b=null!=u;this._densityMap=new t.X(this.rctx,o,{target:_.No.TEXTURE_2D,pixelFormat:b?_.VI.RED:_.VI.RGBA,internalFormat:b?_.lP.R32F:_.VI.RGBA,dataType:_.Br.FLOAT,samplingMode:d?_.cw.LINEAR:_.cw.NEAREST,wrapMode:_.e8.CLAMP_TO_EDGE,width:0,height:0}),this._quad=(0,ue.ow)(this.rctx);const w=this._colorRampData;this._colorRamp=new i.x(this.rctx,{target:_.No.TEXTURE_2D,pixelFormat:_.VI.RGBA,dataType:_.Br.UNSIGNED_BYTE,samplingMode:_.cw.LINEAR,wrapMode:_.e8.CLAMP_TO_EDGE,width:w.length/4,height:1},w),this._technique=new e({rctx:this.rctx,viewingMode:he.JY.Local},new G.m),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.own((0,S.YP)(()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius],()=>this.rendererContext.notifyContentChanged()))}destroy(){this._technique=(0,C.RY)(this._technique),this._densityMap=(0,C.O3)(this._densityMap),this._quad=(0,C.O3)(this._quad),this._colorRamp=(0,C.O3)(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(o){o!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=o,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(o){o!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=o,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(o){o!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=o,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(o){this._heatmapParameters.fieldTotal=o,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(o){const{colorRamp:f}=this._heatmapParameters;if((0,C.pC)(f)&&o!==this._colorRampData){const d=o.length/4;d!==f.descriptor.width&&f.resize(d,1),f.setData(o)}this._colorRampData=o}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(o){this._heatmapParameters.colorRamp=o}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}render(o,f){const u=this._sortedMaterialRenderers,d=u.length;if(d<1)return;const b=this.rctx.getBoundFramebufferObject(),j=this.rctx.getViewport(),{pixelRatio:w}=this,Q=Math.ceil(j.width*w),ge=Math.ceil(j.height*w);this._densityMap.resize(Q,ge),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,Q,ge),this.rctx.clear(_.lk.COLOR_BUFFER_BIT);let k=!1;for(let te=0;te<d;te++){const be=u.getItemAt(te);be.material.shouldRender(o)&&(k=k||be.materialRenderer.render(o.pass,f))}this.rctx.bindFramebuffer(b),this.rctx.setViewport(j.x,j.y,j.width,j.height),k&&(this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(this._heatmapParameters,o.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,r._V)(this._quad,"geometry")))}};(0,a._)([(0,h.Cb)()],c.prototype,"searchRadius",null),(0,a._)([(0,h.Cb)()],c.prototype,"minDensity",null),(0,a._)([(0,h.Cb)()],c.prototype,"maxDensity",null),(0,a._)([(0,h.Cb)()],c.prototype,"fieldTotal",null),(0,a._)([(0,h.Cb)()],c.prototype,"pixelRatio",void 0),(0,a._)([(0,h.Cb)()],c.prototype,"colorRampData",null),(0,a._)([(0,h.Cb)()],c.prototype,"_colorRampData",void 0),c=(0,a._)([(0,g.j)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],c);var Oe,o,p=s(52107),E=s(54840),O=s(53855),U=s(16396),$=s(67831),Z=s(99770),q=s(75957),ae=s(19625),Ce=s(60881),Te=s(40723),Be=s(91263),Ge=s(5894),Ie=s(42037),He=s(41528),je=s(81768);(o=Oe||(Oe={}))[o.Screen=0]="Screen",o[o.World=1]="World";class We extends Te.Mt{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class xe extends l.A{initializeProgram(f){const u=xe.shader.get().build(this.configuration);return new D.$(f.rctx,u,n.i)}initializePipeline(){return(0,H.sm)({blending:(0,H.if)(_.zi.ONE,_.zi.ONE,_.db.ADD),colorWrite:H.BK,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}xe.shader=new X.J(je.H,()=>s.e(5795).then(s.bind(s,15795)));class we extends He.W{constructor(){super(...arguments),this.isAttributeDriven=!1}}(0,a._)([(0,G.o)()],we.prototype,"isAttributeDriven",void 0);class Ze extends We{constructor(){super(...arguments),this.isAttributeDriven=!1}}class De extends Te.F5{constructor(f){super(f,new Ze),this._techniqueConfig=new we}requiresSlot(f,u){return f===Ge.r.DRAPED_MATERIAL&&u===Be.C.MATERIAL}getConfiguration(){return this._techniqueConfig.isAttributeDriven=this.parameters.isAttributeDriven,this._techniqueConfig}createGLMaterial(f){return new Qe(f)}intersect(f,u,d,b,j,w,Q,ge,k){if((0,C.Wi)(k)||!(0,q.lM)(w))return;const te=f.vertexAttributes.get(U.T.POSITION),{parameters:be}=this,{searchRadius:ke}=be,{screenToWorldRatio:Le}=f,Ne=ke*Le+2*Le,et=Ne*Ne,tt=te.data.length/te.size;for(let Me=0;Me<tt;Me++){const Ve=Me*te.size,it=(0,$.a)(Ye,te.data[Ve],te.data[Ve+1]);(0,$.s)(it,w)<et&&Q(k.dist,k.normal,-1,!1)}}createBufferWriter(){return new Xe(this.parameters.isAttributeDriven?Ke:Ue)}}class Qe extends Ce.Z{beginSlot(f){return this.ensureTechnique(xe,f)}}class Xe{constructor(f){this.vertexBufferLayout=f}allocate(f){return this.vertexBufferLayout.createBuffer(f)}elementCount(f){return f.indices.get(U.T.POSITION).length*Se}write(f,u,d,b){(0,Ie.ho)(u.indices.get(U.T.POSITION),u.vertexAttributes.get(U.T.POSITION).data,f.transformation,d.position,b,Se);const j=u.indices.get(U.T.POSITION).length,w=d.uv0;let Q=b;for(let k=0;k<j;++k)w.setValues(Q++,-1,-1),w.setValues(Q++,1,-1),w.setValues(Q++,1,1),w.setValues(Q++,1,1),w.setValues(Q++,-1,1),w.setValues(Q++,-1,-1);const ge="featureAttribute"in d?d.featureAttribute:null;ge&&(0,Ie.XW)(u.indices.get(U.T.FEATUREATTRIBUTE),u.vertexAttributes.get(U.T.FEATUREATTRIBUTE).data,ge,b,Se)}}const Ue=(0,ae.U$)().vec3f(U.T.POSITION).vec2f(U.T.UV0),Ke=Ue.clone().f32(U.T.FEATUREATTRIBUTE),Se=6,Ye=(0,Z.a)(),Pe=ce.Z.getLogger("esri.views.3d.layers.support.HeatmapFeatureProcessor");let x=class extends Y.r{constructor(o){super(o),this.type="heatmap",this.filterVisibility={filterChanged(){},dirty:!1},this.preferredUpdatePolicy=N.jq.ASYNC,this.dataExtent=null,this.drapeSourceType=fe.L.Features,this._renderGeometries=new Map,this._material=new De({}),this._materialWithField=new De({isAttributeDriven:!0}),this._fieldTotal=0,this._drapeSourceRenderer=null}initialize(){this._featureStore=new _e.Z({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{colorBufferFloat:o,textureFloat:f}=this._renderView.capabilities,{floatBufferBlendWorking:u}=this._renderView.renderingContext.driverTest;if(!f?.textureFloat)throw new V.Z("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float.");if(!o?.textureFloat)throw new V.Z("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL2 extension EXT_color_buffer_float or the WebGL1 extension WEBGL_color_buffer_float.");if(!o?.floatBlend)throw new V.Z("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend.");if(!u)throw new V.Z("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend. This device claims support for it, but does not actually support it.");this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,c,this._rendererParameters),this.updatingHandles.addOnCollectionChange(()=>this._loadedPointGraphics,d=>this._onLoadedFeaturesChange(d),S.nn),this.updatingHandles.addWhen(()=>this._materialParameters,d=>this._forEachMaterial(b=>b.setParameters(d)),S.nn),this.updatingHandles.add(()=>this._rendererParameters,d=>this._drapeSourceRenderer.set(d)),this.updatingHandles.add(()=>this._heatmapRendererField,()=>{this._recreate()},S.Z_),this.updatingHandles.add(()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric}),({fieldName:d,numeric:b})=>{if((0,C.pC)(d)&&b){let j=0;this._featureStore.forEach(w=>j+=w.attributes[d]??0),this._fieldTotal=j}else this._fieldTotal=this._featureStore.numFeatures},S.nn),this.handles.add([(0,S.YP)(()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField}),({fieldName:d,field:b})=>{d&&!b&&Pe.warn(`Heatmap renderer field '${d}' for layer '${this.layer.title??this.layer.id}' not found`)}),(0,S.YP)(()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric}),({field:d,numeric:b})=>{(0,C.pC)(d)&&!b&&Pe.warn(`Heatmap renderer field '${d.name}' for layer '${this.layer.title??this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)}),(0,de.kB)(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))])}destroy(){this._renderGeometries.clear(),this._material=(0,C.O3)(this._material),this._materialWithField=(0,C.O3)(this._materialWithField),this._featureStore.clear(),this._featureStore=null}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this.updatingHandles.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get displayFeatureLimit(){const f=this.owner?.view?.qualitySettings,u=f?Math.ceil(f.heatmap.maxTotalNumberOfFeatures*(this.owner?.view?.resourceController?.memoryController?.memoryFactor??1)):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:u,maximumTotalNumberOfPrimitives:2*u,maximumNumberOfFeatures:u}}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){return!1}get usedMemory(){const o=this.usedMemoryPerFeature*this._featureStore.numFeatures,{R32F:f}=this._renderView?.capabilities?.colorBufferFloat,u=null!=f?1:4,b=Math.ceil(this._overlayRenderer?.overlays[0]?.resolution*this._densityMapPixelRatio)??0;return b*b*u*4+o+((0,C.pC)(this._heatmapRenderer)?(0,pe.F2)(Math.min(this._heatmapRenderer.radius,112)):0)*u*4}get usedMemoryPerFeature(){if(0===this._featureStore.numFeatures)return 0;let o=0;this._featureStore.forEach(d=>o+=(0,W.f2)(d.attributes)),o/=this._featureStore.numFeatures;const f=(0,W.G3)();return 6*(0,W.do)([0,0,0],f)+6*(0,W.do)([0,0],f)+(this._heatmapRendererFieldIsNumeric?6*f:0)+o}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return{core:{visible:this._featureStore.numFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return(0,C.Wg)(this._overlayRenderer.spatialReference)}get _rendererParameters(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}get _materialParameters(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}get _densityParameters(){const o=this._heatmapRenderer;if((0,C.Wi)(o))return null;const{minDensity:f,maxDensity:u}=o;return{minDensity:f,maxDensity:u,fieldTotal:this._fieldTotal}}get _radiusParameter(){return(0,C.yw)(this._heatmapRenderer,({radius:o})=>({searchRadius:(0,pe.F2)(this._clampSearchRadius(o))}))}get _resolutionForScaleParameter(){return(0,C.yw)(this._heatmapRenderer,({referenceScale:o})=>({resolutionForScale:0===o?0:(0,z.dp)(o,this.view.spatialReference)}))}get _colorRampParameter(){return(0,C.yw)(this._heatmapRenderer,o=>({colorRampData:(0,Fe.uI)(o.colorStops)}))}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){return(this.owner?.view?.qualitySettings.heatmap.pixelRatio??1)*Math.sqrt(this.owner?.view?.resourceController?.memoryController?.memoryFactor??1)}get _renderView(){return this.view._stage.renderView}get _featuresArePoints(){return"point"===this.layer.geometryType}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const o=this.layer.renderer;return"heatmap"===o?.type?o:null}get _heatmapRendererFieldName(){return(0,C.yw)(this._heatmapRenderer,o=>o.field)}get _heatmapRendererField(){return(0,C.yw)(this._heatmapRendererFieldName,o=>this.layer.fieldsIndex.get(o))}get _heatmapRendererFieldIsNumeric(){const o=this._heatmapRendererField;return!(0,C.Wi)(o)&&(0,P.H7)(o)}whenGraphicBounds(){return(0,A.Z)(function*(){return null})()}computeAttachmentOrigin(){return null}highlight(){return Ae}maskOccludee(){return Ae}setObjectIdVisibility(){}setup(){return(0,A.Z)(function*(){})()}_onLoadedFeaturesChange(o){if(!this._featuresArePoints)return;const{objectIdField:f}=this.layer;this._featureStore.removeManyById(o.removed.map(w=>(0,ee.MS)(w,f))),this._featureStore.addMany(o.added.map(w=>new se.u_((0,oe.dd)(new re.Z,w.geometry),w.attributes,(0,C.yw)(w.centroid,Q=>(0,oe.dd)(new re.Z,Q)),(0,ee.MS)(w,f))));const u=o.added,d=o.removed;this._fieldTotal+=this._computeFieldTotalChange(u,d);const b=(0,C.e8)(d,({uid:w})=>{const Q=this._renderGeometries.get(w);return this._renderGeometries.delete(w),Q}),j=u.map(w=>{const Q=this._pointGraphicToRenderGeometry(w);return this._renderGeometries.set(w.uid,Q),Q});b.length>0&&this._drapeSourceRenderer.removeGeometries(b,E.$.Geometry.REMOVE),j.length>0&&this._drapeSourceRenderer.addGeometries(j,E.$.Geometry.ADD),(j.length>0||b.length>0)&&this._renderView.requestRender()}_recreate(){if(!this._loadedPointGraphics)return;const o=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:o,removed:o})}_pointGraphicToRenderGeometry(o){const f=this._heatmapRendererFieldName,u=(0,C.pC)(f)?this._materialWithField:this._material,d=(0,ve.c)();(0,ne.KC)(o.geometry,d,this._overlaySpatialReference),d[2]=le.Rn;const b=[[U.T.POSITION,{data:d,size:d.length}]],j=this._heatmapRendererFieldIsNumeric;(0,C.pC)(f)&&b.push([U.T.FEATUREATTRIBUTE,{data:[j?o.attributes[f]??0:0],size:1}]);const w=new O.z(new p.Z(b,null,N.MX.Point),u,{layerUid:this.layer.uid,graphicUid:o.uid});return(0,me.c)(w.boundingSphere,d),w}_forEachMaterial(o){o(this._material),o(this._materialWithField)}_computeFieldTotalChange(o,f){if((0,C.Wi)(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return o.length-f.length;const u=this._heatmapRendererFieldName,d=(b,j)=>b+(j.attributes[u]??0);return o.reduce(d,0)-f.reduce(d,0)}_clampSearchRadius(o){return o>112&&Pe.warnOnce("SceneView supports a maximum radius of 112 pt for HeatmapRenderer."),Math.min(o,112)}};(0,a._)([(0,h.Cb)()],x.prototype,"type",void 0),(0,a._)([(0,h.Cb)({constructOnly:!0})],x.prototype,"owner",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"layer",null),(0,a._)([(0,h.Cb)()],x.prototype,"featureStore",null),(0,a._)([(0,h.Cb)()],x.prototype,"updating",null),(0,a._)([(0,h.Cb)()],x.prototype,"updatingRemaining",null),(0,a._)([(0,h.Cb)()],x.prototype,"suspendInfo",null),(0,a._)([(0,h.Cb)()],x.prototype,"legendEnabled",null),(0,a._)([(0,h.Cb)()],x.prototype,"filterVisibility",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"displayFeatureLimit",null),(0,a._)([(0,h.Cb)()],x.prototype,"preferredUpdatePolicy",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"hasZ",null),(0,a._)([(0,h.Cb)()],x.prototype,"hasM",null),(0,a._)([(0,h.Cb)()],x.prototype,"dataExtent",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"view",null),(0,a._)([(0,h.Cb)()],x.prototype,"fullOpacity",null),(0,a._)([(0,h.Cb)()],x.prototype,"updatePolicy",null),(0,a._)([(0,h.Cb)()],x.prototype,"drapeSourceType",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"_featureStore",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"_overlayRenderer",null),(0,a._)([(0,h.Cb)()],x.prototype,"_overlaySpatialReference",null),(0,a._)([(0,h.Cb)()],x.prototype,"_rendererParameters",null),(0,a._)([(0,h.Cb)()],x.prototype,"_materialParameters",null),(0,a._)([(0,h.Cb)()],x.prototype,"_densityParameters",null),(0,a._)([(0,h.Cb)()],x.prototype,"_radiusParameter",null),(0,a._)([(0,h.Cb)()],x.prototype,"_resolutionForScaleParameter",null),(0,a._)([(0,h.Cb)()],x.prototype,"_colorRampParameter",null),(0,a._)([(0,h.Cb)()],x.prototype,"_pixelRatioParameter",null),(0,a._)([(0,h.Cb)()],x.prototype,"_densityMapPixelRatio",null),(0,a._)([(0,h.Cb)()],x.prototype,"_renderGeometries",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"_material",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"_materialWithField",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"_renderView",null),(0,a._)([(0,h.Cb)()],x.prototype,"_featuresArePoints",null),(0,a._)([(0,h.Cb)()],x.prototype,"_loadedPointGraphics",null),(0,a._)([(0,h.Cb)()],x.prototype,"_heatmapRenderer",null),(0,a._)([(0,h.Cb)()],x.prototype,"_heatmapRendererFieldName",null),(0,a._)([(0,h.Cb)()],x.prototype,"_heatmapRendererField",null),(0,a._)([(0,h.Cb)()],x.prototype,"_heatmapRendererFieldIsNumeric",null),(0,a._)([(0,h.Cb)()],x.prototype,"_fieldTotal",void 0),(0,a._)([(0,h.Cb)()],x.prototype,"_drapeSourceRenderer",void 0),x=(0,a._)([(0,g.j)("esri.views.3d.layers.support.HeatmapFeatureProcessor")],x);const Ae=(0,de.kB)();var $e=s(89765),Je=s(87091);const qe=o=>{let f=class extends o{constructor(){super(...arguments),this.controller=null,this.updatePolicy=N.jq.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.clippingExtent=null,this.supportsHeightUnitConversion=!0,this.pendingController=null,this.queryEngine=null}initialize(){var u=this;const d=this.layer;"isTable"in d&&d.isTable?this.addResolvingPromise(Promise.reject(new V.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:d}))):(this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add(()=>this.layer.renderer,b=>this._recreateProcessor(b),S.nn),this.addResolvingPromise((0,A.Z)(function*(){const b=yield(0,$e.E)(u);u.fullExtentInLocalViewSpatialReference=b,yield u._initializeController()})()),this.updatingHandles.add(()=>this.updatePolicy,b=>this.processor.preferredUpdatePolicy=b),this.queryEngine=new I.q({layerView:this,priority:Je.T8.FEATURE_QUERY_ENGINE}),this.notifyChange("updating"))}destroy(){this._destroyPendingController(),this.controller=(0,C.SC)(this.controller),this._set("processor",(0,C.SC)(this.processor)),this.queryEngine=(0,C.SC)(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this.pendingController=(0,C.SC)(this.pendingController)}get legendEnabled(){return this.canResume()&&this.processor?.legendEnabled}get graphics3DProcessor(){return"graphics-3d"===this.processor?.type?this.processor:null}get heatmapProcessor(){return"heatmap"===this.processor?.type?this.processor:null}getHit(u){let d=null;return this.loadedGraphics?.forEach(b=>{b.uid===u&&(d=(0,m.mW)(b,this.layer))}),d?{type:"graphic",graphic:d,layer:d.layer}:null}whenGraphicBounds(u,d){return this.processor?.whenGraphicBounds(u,d)}computeAttachmentOrigin(u,d){return this.processor?.computeAttachmentOrigin(u,d)}queryFeatures(u,d){return this.queryEngine.executeQuery(this._ensureQuery(u),(0,C.U2)(d,"signal"))}queryObjectIds(u,d){return this.queryEngine.executeQueryForIds(this._ensureQuery(u),(0,C.U2)(d,"signal"))}queryFeatureCount(u,d){return this.queryEngine.executeQueryForCount(this._ensureQuery(u),(0,C.U2)(d,"signal"))}queryExtent(u,d){return this.queryEngine.executeQueryForExtent(this._ensureQuery(u),(0,C.U2)(d,"signal"))}_ensureQuery(u){return(0,C.Wi)(u)?this.createQuery():T.Z.from(u)}highlight(u){return this.processor.highlight(u,this.layer.objectIdField)}maskOccludee(u){return this.processor.maskOccludee(u)}canResume(){return super.canResume()&&!this.processor?.scaleVisibilitySuspended}getSuspendInfo(){const u=super.getSuspendInfo();return this.processor?{...u,...this.processor.suspendInfo}:u}isUpdating(){return!(!this.processor||this.processor.destroyed||this._controllerCreated&&!this.controller?.updating&&this.view?.basemapTerrain?.ready&&!this.processor.updating)}_initializeController(){var u=this;return(0,A.Z)(function*(){const d=u.createController();u.pendingController=d,yield d.when(),u._setControllerWhenInitialized(d)})()}_setControllerWhenInitialized(u){var d=this;return(0,A.Z)(function*(){try{yield d.when()}catch{}d._controllerCreated=!0,d.notifyChange("updating"),d.isResolved()&&!d.destroyed?(yield(0,S.N1)(()=>d.view?.basemapTerrain?.ready),d.beforeSetController(u),d.pendingController=null,d.controller=u,d.loadedGraphics=u.graphics,d.notifyChange("updating")):d._destroyPendingController()})()}_updateClippingExtent(u){if(this.clippingExtent=u,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=u,!0}}_validateGeometryType(){var u=this;return(0,A.Z)(function*(){switch(u.layer.geometryType){case"multipatch":case"multipoint":throw new V.Z("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:u.layer.geometryType})}})()}_recreateProcessor(u){const d="heatmap"===u?.type,j=this.processor;if(j&&d===("heatmap"===this.processor?.type))return;const w=d?new x({owner:this}):new L.Z({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:Q=>this._updateClippingExtent(Q)});this._set("processor",w),j?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(w.setup())}_getResourceInfo(){const u=this.controller instanceof F.g?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:u?.maximumNumberOfFeatures??-1,totalNumberOfFeatures:u?.serviceDataCount??-1,nodes:0,...this.processor.performanceInfo}}get performanceInfo(){return this._getResourceInfo()}};return(0,a._)([(0,h.Cb)()],f.prototype,"loadedGraphics",void 0),(0,a._)([(0,h.Cb)()],f.prototype,"suspended",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],f.prototype,"legendEnabled",null),(0,a._)([(0,h.Cb)()],f.prototype,"updating",void 0),(0,a._)([(0,h.Cb)()],f.prototype,"controller",void 0),(0,a._)([(0,h.Cb)()],f.prototype,"processor",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],f.prototype,"updatePolicy",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],f.prototype,"suspendResumeExtentMode",void 0),(0,a._)([(0,h.Cb)({type:Boolean})],f.prototype,"slicePlaneEnabled",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],f.prototype,"suspendInfo",void 0),(0,a._)([(0,h.Cb)()],f.prototype,"graphics3DProcessor",null),(0,a._)([(0,h.Cb)()],f.prototype,"heatmapProcessor",null),f=(0,a._)([(0,g.j)("esri.views.3d.layers.FeatureLikeLayerView3D")],f),f}},54984:(ie,K,s)=>{s.d(K,{j:()=>G,A:()=>ye});var A=s(15861),a=s(17626),V=s(14517),C=s(72392),S=s(63290),h=s(88159),y=s(62208),B=s(10699),M=s(32917),g=s(50618),m=s(77712),F=s(85931),I=(s(8314),s(90912),s(76898)),W=s(65401),Y=s(38114),de=s(89621),ce=s(84952),pe=s(59617),me=s(53639);class ve{constructor(t,i){this.highestResolutionVersion=null,this.versions=[],this.ref(t,i)}get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}ref(t,i){const r=this.feature;z.oldVersion=r,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0});for(const p of this.versions)if(p.resolution===i){p.refCount++;const E=this.highestResolutionVersion===p&&!(0,me.f)(t,p.feature);return(E||this.highestResolutionVersion!==p)&&(p.feature=t),z.newVersion=E?t:r,z}const c={feature:t,resolution:i,refCount:1};return this.versions.push(c),!this.highestResolutionVersion||i<this.highestResolutionVersion.resolution?(z.newVersion=t,this.highestResolutionVersion=c):z.newVersion=r,z}unref(t){for(let i=0;i<this.versions.length;i++){const r=this.versions[i];if(r.resolution===t)return r.refCount--,z.oldVersion=this.feature,0===r.refCount&&(this.versions[i]=this.versions[this.versions.length-1],this.versions.length--,this.highestResolutionVersion===r&&(this._recalculateHighestResolutionVersion(),z.oldVersion=r.feature)),z.newVersion=this.feature,z}return null}get feature(){return this.highestResolutionVersion?this.highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this.highestResolutionVersion=null);let t=this.versions[0];for(let i=1;i<this.versions.length;i++){const r=this.versions[i];r.resolution<t.resolution&&(t=r)}this.highestResolutionVersion=t}}class ne{constructor(t){this._feature=t,this.refCount=1}get isReferenced(){return 0!==this.refCount}get isSingle(){return 1===this.refCount}ref(t){return++this.refCount,z.oldVersion=this._feature,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0}),(0,me.f)(this._feature,t)||(this._feature=t),z.newVersion=this._feature,z}unref(){return z.oldVersion=this._feature,this.refCount>0&&(this.refCount--,!this.isReferenced)?(z.newVersion=null,z):(z.newVersion=this._feature,z)}get feature(){return this._feature}}const z={oldVersion:null,newVersion:null},oe=new Set;class se{constructor(t){this.descriptor=t,this.fetchStatus=P.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=re,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=oe,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(t){this._displayingFeatures=t,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}get features(){return this._features}get featureLimit(){return this._featureLimit}set featureLimit(t){this._featureLimit!==t&&(this._featureLimit=t,this._estimatedUnusedSizeDirty=!0)}get availableFields(){return this._availableFields}setFeatures(t,i,r){this._availableFields=(0,y.Pt)(r,oe),this._features=t,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,t&&t.length>0?(this._emptyFeatureRatio=i/(t.length+i),this._numVertices=t.reduce((c,p)=>c+(0,Y.R3)(p.geometry),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(t){this._numFeatures=t}get hasPreciseFeatureCount(){return this._numFeatures>re}get needsFeatureCount(){return this._numFeatures===re}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let t=0;t<this._features.length;++t){const i=(0,Y.Xw)(this._features[t]);this._estimatedSize+=i,t>=this.featureLimit&&(this._estimatedUnusedSize+=i)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let t=this.featureLimit;t<this._features.length;++t)this._estimatedUnusedSize+=(0,Y.Xw)(this._features[t]);return!0}return!1}get isFetching(){return this.fetchStatus===P.FETCHING||this.fetchStatus===P.REFETCHING}get isRefetching(){return this.fetchStatus===P.REFETCHING}get needsFetching(){return this.fetchStatus===P.FETCH_NEEDED||this.fetchStatus===P.REFETCH_NEEDED}get needsRefetching(){return this.fetchStatus===P.REFETCH_NEEDED}get isFetched(){return this.fetchStatus===P.DONE||this.fetchStatus===P.FULL}resetFetching(){this.fetchStatus=this.fetchStatus===P.REFETCHING?P.REFETCH_NEEDED:P.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!function Fe(e,t,i){if((0,y.Wi)(t)||(0,y.Wi)(e)||i!==t.length||i>e.length)return!1;for(let r=0;r<i;++r)if(e[r]!==t[r])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(t){return!t||!this.descriptor.extent||((0,W.oJ)(t,fe),(0,W.kK)(this.descriptor.extent,fe))}intersectionIncludingBorrowed(t,i){const r=(0,y.pC)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return t||r?(t?((0,W.oJ)(t,i),(0,W.jV)(i,r,i)):(0,W.JG)(i,r),i):((0,W.JG)(i,W.bd),i)}_shuffle(t){this._features.sort((i,r)=>(0,Y.MS)(i,t)-(0,Y.MS)(r,t)),(0,F.TV)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}reduceFeatures(t,i,r){if(t<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let c=!1;this.featureLimit=Math.ceil(this.numFeatures*t),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===P.DONE&&this._features.length>0&&(this.fetchStatus=P.REFETCH_NEEDED,c=!0)),!this._shuffled&&t<1&&this._shuffle(r);const p=Math.max(this.featureLimit,Math.ceil(i*this.numFeatures));return this._features.length>p&&(this._features.length=p,this.featuresMissing=!0,this.fetchStatus===P.FULL&&(this.fetchStatus=P.DONE)),c}get cache(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(t){this.requestController=null,this._availableFields=t.availableFields,this._features=t.features,this._numFeatures=t.numFeatures,this._emptyFeatureRatio=t.emptyFeatureRatio,this.fetchStatus=t.fetchStatus,this.featuresMissing=t.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const re=-1;var P,e;(e=P||(P={}))[e.FETCH_NEEDED=0]="FETCH_NEEDED",e[e.REFETCH_NEEDED=1]="REFETCH_NEEDED",e[e.FETCHING=2]="FETCHING",e[e.REFETCHING=3]="REFETCHING",e[e.DONE=4]="DONE",e[e.FULL=5]="FULL";const fe=(0,W.Ue)();var le=s(15076),N=s(87091);const he=S.Z.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");let G=class extends V.Z{constructor(e){super(e),this._useTileCount=!1,this.updating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this.maximumNumberOfFeaturesExceededThrottle=1e3,this._fullRatio=1,this._farRatio=1,this.changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this.handles=new C.Z,this._frameTask=N.sq,this._dirty=!1,this.featureTiles=new Map,this.displayingFeatureReferences=new Map,this.numDisplayingFeatureReferences=0,this.suspended=!0,this.pendingEdits=null}set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this.supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&(0,y.pC)(this.context.query.queryFeatureCount)}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get memoryForUnusedFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.estimatedUnusedSize),e}get totalVertices(){let e=0;return this.featureTiles.forEach(t=>e+=t.numVertices),e}get totalFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.numFeatures),e}set filterExtent(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void he.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this._reclip(i,t)}initialize(){this.handles.add((0,M.on)(()=>this.tileDescriptors,"change",()=>this._setDirty(),{onListenerAdd:()=>this._setDirty()})),this.objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?ve:ne;const e=this.context.scheduler;(0,y.pC)(e)&&(this._frameTask=e.registerTask(N.T8.FEATURE_TILE_FETCHER,this)),this._setDirty()}destroy(){this._frameTask.remove(),this.handles=(0,y.SC)(this.handles),this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._removeTile(e)}),this.featureTiles.clear(),this.displayingFeatureReferences.clear(),this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)}get paused(){return this.suspended||!!this.pendingEdits}restart(){this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._clearTile(e),this._resetFetchTile(e)}),(0,y.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._resetFetchTile(e)}),(0,y.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this.suspended||(this.suspended=!0,this._pause(),this._setDirty())}resume(){this.suspended&&(this.suspended=!1,this._unpause())}_pause(){this.paused&&(this.featureTiles.forEach(e=>this._cancelFetchTile(e)),this._updated())}_unpause(){this.paused||(this._setDirty(),this._updated())}get availableFields(){let e=null;return this.featureTiles.forEach(t=>{(0,y.Wi)(t.displayingFeatures)||0===t.displayingFeatures.length||((0,y.Wi)(e)?e=new Set(t.availableFields):e.forEach(i=>{t.availableFields.has(i)||(0,y.Wg)(e).delete(i)}))}),(0,y.pC)(e)?e:new Set}applyEdits(e){this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const t=this.pendingEdits;t.count++;const i=t.edits.then(()=>e.result.catch(r=>{if((0,B.D_)(r))throw r;return null}).then(r=>r&&(this._applyEditsDeleteFeatures(r.deletedFeatures),this._applyEditsAddUpdateFeatures(r.addedFeatures,r.updatedFeatures,t.controller.signal).then(()=>r))).then(r=>(0==--t.count&&(this.pendingEdits===t&&(this.pendingEdits=null),(0,y.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._unpause(),this._updated()),r)));return t.edits=i,this._updated(),i}_applyEditsDeleteFeatures(e){if(0===e.length)return;const t=this.context.globalIdField,i=t&&this.availableFields.has(t),r=new Set,c=this.objectIdField;e.forEach(({objectId:p,globalId:E})=>{if((!p||p<0)&&t){i||he.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`);const O=this.features.find(U=>U.attributes&&U.attributes[t]===E);O&&r.add((0,Y.MS)(O,c))}else r.add(p)}),this.featureTiles.forEach(p=>{if(!p.features)return;const E=p.features.filter(O=>!r.has((0,Y.MS)(O,this.objectIdField)));E.length!==p.features.length&&(p.setFeatures(E,0,p.availableFields),this._invalidateCounts())})}_applyEditsAddUpdateFeatures(e,t,i){var r=this;return(0,A.Z)(function*(){const c=[],p=new Set;if(e.forEach(O=>c.push(O.objectId)),t.forEach(O=>{c.push(O.objectId),p.add(O.objectId)}),0===c.length)return;const E=[];r.featureTiles.forEach(O=>{const U=r._applyEditsAddUpdateTile(O,c,p,i);U&&E.push(U)}),yield(0,B.as)(E)})()}_applyEditsAddUpdateTile(e,t,i,r){var c=this;return(0,A.Z)(function*(){if(!e.features)return;const p=c._createQuery(e);p.resultType=void 0,p.cacheHint=!1,p.objectIds=t;const E=yield c._queryFeatures(p,r);let O=null;if(i.size>0){const U=e.features.filter($=>!i.has((0,Y.MS)($,c.objectIdField)));U.length!==e.features.length&&(O=U)}if(E.features.length>0){O||(O=e.features.slice());for(const U of E.features)O.push(U)}O&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,O.length)),e.setFeatures(O,0,v(e.availableFields,E.fields)),c._invalidateCounts())})()}_queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:H})}_setDirty(){this._dirty=!0,this._updated()}get running(){return this.updating}runTask(e){if(this._frameTask.processQueue(e),!this._dirty||!this.constructed)return;this._dirty=!1;const t=this._getListOfTiles();if(this._markTilesNotAlive(t),!e.run(()=>this._addTiles(t,e))||!e.run(()=>this._filterExtentTiles(t,e))||!e.run(()=>this._removeTiles(t,e))||e.done)return void this._setDirty();const i=this._sortTiles(t);e.run(()=>this._displayTiles(i,e))&&e.run(()=>this._fetchTiles(i,e))&&e.run(()=>this._updateMemoryEstimates(i,e))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(e){for(const t of e)t.alive=!1}_addTiles(e,t){return!this.suspended&&(this.tileDescriptors.forEach(i=>{const r=this.featureTiles.get(i.id);r?r.alive=!0:t.done||(e.push(this._addTile(i)),t.madeProgress())}),t.hasProgressed)}_filterExtentTiles(e,t){for(const i of e){if(t.done)break;i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&(this._clearTile(i),t.madeProgress()))}return t.hasProgressed}_removeTiles(e,t){for(let i=e.length-1;i>=0&&!t.done;i--){const r=e[i];r.alive||(this._removeTile(r),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}_sortTiles(e){return e.sort((t,i)=>t.descriptor.loadPriority-i.descriptor.loadPriority),e}_displayTiles(e,t){const i=this._updateRatio(e),r=c=>{const p=this._fullRatio<1?i(c)*this._farRatio:1;return c.reduceFeatures(p,this.memoryFactor,this.objectIdField)&&this._setDirty(),this._showTile(c)};for(const c of e)if(!t.run(()=>r(c))){this._setDirty();break}return t.hasProgressed}_fetchTiles(e,t){if(this.paused)return!1;let i=!1;for(const r of e){if(!r.needsFetching)continue;const c=(0,y.pC)(this.context.memoryCache)?this.context.memoryCache.pop(r.id):null;if((0,y.pC)(c))r.cache=c,this._setDirty(),this._scheduleUpdated(),t.madeProgress();else{if(this._needsNumFeatures(r)){const p=new AbortController,E=this._fetchTileCount(r,p.signal);this._handleRequest(r,E,p,()=>r.numFeatures=-2),i=!0,t.madeProgress()}if(t.done)return!0}}if(i)return t.hasProgressed;for(const r of e)if(r.needsFetching){const c=new AbortController,p=this._fetchTile(r,c.signal);if(this._handleRequest(r,p,c,E=>{r.setFeatures([],0,null),this._invalidateCounts(),r.featuresMissing=!1,this.context.logFetchError(he,E)}),t.madeProgress(),t.done)return!0}return t.hasProgressed}_updateMemoryEstimates(e,t){return e.some(i=>!t.run(()=>i.updateMemoryEstimates())&&(this._setDirty(),!0)),t.hasProgressed}_reclip(e,t){if(!this.constructed)return;const i=new Array;this.featureTiles.forEach(r=>{(0,y.Wi)(r.displayingFeatures)||0===r.displayingFeatures.length||(r.intersectionIncludingBorrowed(t,R),r.intersectionIncludingBorrowed(e,_),(0,W.fS)(R,_)||i.push(r))}),this._refreshDisplayingFeatures(i),this._updated()}_refreshDisplayingFeatures(e){const t=new Set,i=this.changes.updates;for(const r of e)if(!(0,y.Wi)(r.displayingFeatures))for(const c of r.displayingFeatures){const p=(0,Y.MS)(c,this.objectIdField);if(t.has(p))continue;t.add(p);const{feature:E}=this.displayingFeatureReferences.get(p);i.removes.push(E),i.adds.push(E)}this._applyChanges()}_updated(){let e=0;this.paused||this.featureTiles.forEach(i=>i.isFetching?++e:0);const t=this._dirty||e>0||!!this.pendingEdits;if(this._set("updating",t),t){let i=0,r=0,c=0,p=0,E=0;const O=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach(Z=>{if(++r,Z.isFetching&&Z.hasPreciseFeatureCount){const q=this._maximumFeaturesForTile(Z)*(1-Z.emptyFeatureRatio),ae=(0,y.pC)(Z.displayingFeatures)?Z.displayingFeatures.length*O:0;E+=q-ae}Z.needsFetching?++p:Z.numFeatures>0&&(++c,i+=Z.numFeatures)}),p+=e;let U=0,$=0;i?($=i,U=Math.min(p*i/c,i)):($=r,U=p),E=Math.min(this.maximumNumberOfFeatures-this.features.length,E),this._set("updatingTotal",$),this._set("updatingRemaining",U),this._set("expectedFeatureDiff",E)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const e=(0,h.oE)(this.featureTiles,t=>t.perTileMaximumNumberOfFeaturesExceeded);this._set("maximumNumberOfFeaturesExceeded",e)}_updateRatio(e){const t=function Ee(e){let t=0;for(const i of e)i.features&&i.features.length>0&&i.alive&&(t=Math.max(t,i.descriptor.lij[0]));return t}(e),i=p=>1/(1<<Math.max(0,t-p.descriptor.lij[0]));let r=0,c=0;for(const p of e){const E=p.numFeatures;r+=E,c+=E*i(p)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/r),this._farRatio=this.maximumNumberOfFeatures/c,this._scheduleUpdated(),i}_maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this.featureTiles.forEach(i=>{if(!i.featuresMissing)return;const r=this._maximumFeaturesForTile(i);i.features&&(i.features.length>=r||i.fetchStatus===P.FULL)||(this._cancelFetchTile(i),this._resetFetchTile(i))}),this._setDirty())}_addTile(e){const t=new se(e);return this.featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}_referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.descriptor.resolution;this.featureTiles.forEach(i=>{if(!((0,y.Wi)(i.displayingFeatures)||e===i||e.descriptor.lij&&i.descriptor.lij&&!(0,le.E9)(e.descriptor.lij,i.descriptor.lij))){(0,y.Wi)(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&((0,y.Wi)(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=(0,W.d9)(e.descriptor.extent)),(0,W.jn)(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const r of i.displayingFeatures){e.displayingFeatures.push(r);const c=this.displayingFeatureReferences.get((0,Y.MS)(r,this.objectIdField));c.ref(c.feature,t),this.numDisplayingFeatureReferences++}}}),e.featureLimit=(0,y.pC)(e.displayingFeatures)?e.displayingFeatures.length:0}_removeTile(e){this._clearTile(e),this.featureTiles.delete(e.id)}_resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=P.DONE):e.fetchStatus=P.FETCH_NEEDED}_cancelFetchTile(e){const t=e.requestController;(0,y.pC)(t)&&(e.requestController=null,e.resetFetching(),t.abort())}_fetchTileCount(e,t){var i=this;return(0,A.Z)(function*(){return e.numFeatures=yield i._fetchCount(e,t),i._updateRatio(i._getListOfTiles()),e.fetchStatus===P.REFETCHING?P.REFETCH_NEEDED:P.FETCH_NEEDED})()}_fetchTile(e,t){var i=this;return(0,A.Z)(function*(){const r=i._maximumFeaturesForTile(e);if(r<=0)return function l(e){return e.setFeatures([],0,null),e.featuresMissing=!1,P.DONE}(e);const c=i._getMaxRecordCount(e),p=Math.ceil(r/c);if(ue(e)||!i.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=r&&p>ce.Z.MAX_MAX_RECORD_COUNT_FACTOR)return i._fetchPagedTile(e,t);const E=i._createQuery(e);if(E.maxRecordCountFactor=Math.ceil(r/c),e.isRefetching&&e.features&&e.features.length>0){const q=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/c);E.maxRecordCountFactor=Math.max(q+1,E.maxRecordCountFactor)}const{features:O,exceededTransferLimit:U,fields:$}=yield i._queryFeatures(E,t),Z=U?E.maxRecordCountFactor>=ce.Z.MAX_MAX_RECORD_COUNT_FACTOR?P.FULL:P.DONE:P.FULL;return yield i._frameTask.schedule(()=>{e.featuresMissing=O.length<e.numFeatures||U;const q=i._removeEmptyFeatures(O);e.setFeatures(O,q,n($))},t),(0,B.k_)(t),i._invalidateCounts(),Z})()}_fetchCount(e,t){var i=this;return(0,A.Z)(function*(){return i.context.query.queryFeatureCount(i._createFeatureCountQuery(e),{signal:t})})()}_fetchPagedTile(e,t){var i=this;return(0,A.Z)(function*(){let r,c=0,p=0,E=0,O=i._maximumFeaturesForTile(e)-E;const U=i._getMaxRecordCount(e);let $=null;for(;;){const Z=i._createQuery(e),q=i._setPagingParameters(Z,c,O,U),{features:ae,exceededTransferLimit:Ce,fields:Te}=yield i._queryFeatures(Z,t);if(yield i._frameTask.schedule(()=>{q&&(c+=(0,y.Wg)(Z.num)),E+=ae.length,p+=i._removeEmptyFeatures(ae),e.featuresMissing=c<e.numFeatures||Ce,r=r?r.concat(ae):ae,$=v($,Te),e.setFeatures(r,p,$)},t),(0,B.k_)(t),i._invalidateCounts(),i._setDirty(),O=i._maximumFeaturesForTile(e)-E,!q||!Ce||O<=0)return Ce?P.DONE:P.FULL}})()}_createFeatureCountQuery(e){const t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}_createQuery(e){const t=this.context.createQuery(),i=e.descriptor.extent;return i&&(t.geometry=(0,W.HH)(i,this.context.tilingScheme.spatialReference)),this._setResolutionParams(t,e),this._useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}_setPagingParameters(e,t,i,r){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/r),e.num=Math.min(e.maxRecordCountFactor*r,i)):e.num=Math.min(r),!0)}_getEffectiveTileResolution(e){if(null==e.descriptor.resolution)return null;const t=this.context.viewingMode===pe.JY.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}get supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(e,t){if(!this.supportsResolution)return;const i=this._getEffectiveTileResolution(t);null!=i&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new de.Z({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=i))}_removeEmptyFeatures(e){const t=e.length;for(let i=0;i<e.length;)(0,Y.dF)(e[i].geometry)?++i:(e[i]=e[e.length-1],--e.length);return t-e.length}_needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!ue(e)}_getMaxRecordCount(e){const{tileMaxRecordCount:t,maxRecordCount:i}=this.context;return this._useTileQuery(e)&&(0,y.pC)(t)&&t>0&&this.context.capabilities.supportsResultType?t:(0,y.pC)(i)&&i>0?i:D}_useTileQuery(e){return(!ue(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(e,t,i,r){e.fetchStatus=e.needsRefetching?P.REFETCHING:P.FETCHING,e.requestController=i;let c=!1;t.then(p=>{e.requestController=null,e.fetchStatus=p}).catch(p=>{e.requestController===i&&(e.requestController=null,e.fetchStatus=P.DONE),(0,B.D_)(p)?c=!0:r(p)}).then(()=>{c||this._setDirty(),this._scheduleUpdated()})}_scheduleUpdated(){this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add((0,g.Os)(()=>{this.handles.remove("scheduleUpdated"),this._updated()}),"scheduleUpdated")}_showTile(e){if((0,y.pC)(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;const t=e.features;if(0===e.featureLimit||!t){const E=(0,y.pC)(e.displayingFeatures)&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],E}const i=e.descriptor.resolution,r=this.changes.updates,c=this.changes.adds,p=Math.min(e.featureLimit,t.length);e.featureLimit=p;for(let E=0;E<p;++E){const O=t[E],U=(0,Y.MS)(O,this.objectIdField),$=this.displayingFeatureReferences.get(U);if($){const Z=$.ref(O,i);Z.oldVersion!==Z.newVersion&&(r.removes.push(Z.oldVersion),r.adds.push(Z.newVersion))}else this.displayingFeatureReferences.set(U,new this.FeatureReferenceClass(O,i)),c.push(O);this.numDisplayingFeatureReferences++}return this._hideTileFeatures(e),this._applyChanges(),e.displayingFeatures=t.slice(0,p),!0}_hideTile(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}_hideTileFeatures(e){if((0,y.Wi)(e.displayingFeatures))return;const t=this.changes.updates,i=this.changes.removes;for(const r of e.displayingFeatures){const c=(0,Y.MS)(r,this.objectIdField),p=this.displayingFeatureReferences.get(c);if(!p)continue;const E=p.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,E?E.oldVersion!==E.newVersion&&(null==E.newVersion?(this.displayingFeatureReferences.delete(c),i.push(E.oldVersion)):(t.adds.push(E.newVersion),t.removes.push(E.oldVersion))):console.error("Hiding unreferenced feature")}this._applyChanges(),e.displayingFeatures=null}_applyChanges(){const e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);const t=this.changes.adds,i=this.changes.removes,r=Math.min(t.length,i.length);let c=0;for(;c<r;){const p=Math.min(c+J,r);this.features.addMany(t.slice(c,p)),this.features.removeMany(i.slice(c,p)),c=p}t.length>r&&this.features.addMany(0===c?t:t.slice(c)),i.length>r&&this.features.removeMany(0===c?i:i.slice(c)),t.length=0,i.length=0}_clearTile(e){this._hideTile(e),e.features&&(0,y.pC)(this.context.memoryCache)&&this.context.memoryCache.put(e.id,e.cache,16+e.estimatedSize),e.setFeatures(null,0,null),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this.featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce((e,t)=>e+(t.features?t.features.length:0),0)}_maximumFeaturesForTile(e){const t=e.hasPreciseFeatureCount?e.numFeatures:1/0;return Math.min(Math.ceil((e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures)*(this._fullRatio<1?this._farRatio:1)/(1-e.emptyFeatureRatio)),t)}get test(){return{process:e=>this.runTask(e),getFeatureTileById:e=>this.featureTiles.get(e),forEachFeatureTile:e=>this.featureTiles.forEach(e)}}};function ue(e){return"dummy-tile-full-extent"===e.id}function ye(e){const t=e.capabilities.query;return{supportsMultipleResolutions:X(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function X(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function n(e){return(0,y.Wi)(e)?new Set:new Set(e.map(t=>t.name))}function v(e,t){if((0,y.Wi)(e)||(0,y.Wi)(t))return n(t);const i=new Set;for(const{name:r}of t)e.has(r)&&i.add(r);return i}(0,a._)([(0,m.Cb)({constructOnly:!0})],G.prototype,"features",void 0),(0,a._)([(0,m.Cb)()],G.prototype,"tileDescriptors",void 0),(0,a._)([(0,m.Cb)({value:1/0})],G.prototype,"maximumNumberOfFeatures",null),(0,a._)([(0,m.Cb)({value:1})],G.prototype,"memoryFactor",null),(0,a._)([(0,m.Cb)({value:1})],G.prototype,"lodFactor",null),(0,a._)([(0,m.Cb)()],G.prototype,"useTileCount",null),(0,a._)([(0,m.Cb)({readOnly:!0})],G.prototype,"updating",void 0),(0,a._)([(0,m.Cb)({readOnly:!0})],G.prototype,"updatingTotal",void 0),(0,a._)([(0,m.Cb)({readOnly:!0})],G.prototype,"updatingRemaining",void 0),(0,a._)([(0,m.Cb)({readOnly:!0})],G.prototype,"expectedFeatureDiff",void 0),(0,a._)([(0,m.Cb)({readOnly:!0})],G.prototype,"memoryForUnusedFeatures",null),(0,a._)([(0,m.Cb)({readOnly:!0})],G.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,a._)([(0,m.Cb)({constructOnly:!0})],G.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),(0,a._)([(0,m.Cb)({readOnly:!0})],G.prototype,"totalVertices",null),(0,a._)([(0,m.Cb)({readOnly:!0})],G.prototype,"totalFeatures",null),(0,a._)([(0,m.Cb)()],G.prototype,"filterExtent",null),(0,a._)([(0,m.Cb)({constructOnly:!0})],G.prototype,"context",void 0),G=(0,a._)([(0,I.j)("esri.views.3d.layers.support.FeatureTileFetcher3D")],G);const D=2e3,R=(0,W.Ue)(),_=(0,W.Ue)(),H=6e5,J=200},89765:(ie,K,s)=>{s.d(K,{E:()=>C});var A=s(62208),a=s(46367),V=s(35082);function C(S){const h=S.view.spatialReference,y=S.layer.fullExtent,B=(0,A.pC)(y)&&y.spatialReference;if((0,A.Wi)(y)||!B)return Promise.resolve(null);if(B.equals(h))return Promise.resolve(y.clone());const M=(0,a.iV)(y,h);return(0,A.pC)(M)?Promise.resolve(M):S.view.state.isLocal?(0,V.projectGeometry)(y,h,S.layer.portalItem).then(g=>!S.destroyed&&g?g:void 0).catch(()=>null):Promise.resolve(null)}},36967:(ie,K,s)=>{s.d(K,{g:()=>C});var A=s(61885),a=s(73234),V=s(28862);class C extends A.Z{constructor(){super(...arguments),this._set=new Set}clear(){if(this._set.size>0){const h=this.toArray();this._set.clear(),this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:h})}}get length(){return this._set.size}addMany(h){if(0!==h.length){for(const y of h)this._set.add(y);this.emit("after-changes",{type:a.y.ADD}),this.emit("change",{added:h,removed:[]})}}remove(h){this._set.delete(h)&&(this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:[h]}))}removeMany(h){const y=[];for(const B of h)this._set.delete(B)&&y.push(B);y.length>0&&(this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:y}))}toArray(){return[...this._set]}find(h){let y;return(0,V.f)(this._set,B=>!!h(B)&&(y=B,!0)),y}forEach(h){this._set.forEach(y=>h(y))}}}}]);