"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[5171],{90512:(ee,$,c)=>{c.d($,{Z:()=>z});var p=c(15861);class z{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(x,O,N){this._layerById[O]=N,this._layerByName[x]=N}featureSetByName(x,O=!0,N=["*"]){var M=this;return(0,p.Z)(function*(){return void 0===M._layerByName[x]?null:M._layerByName[x]})()}featureSetById(x,O=!0,N=["*"]){var M=this;return(0,p.Z)(function*(){return void 0===M._layerById[x]?null:M._layerById[x]})()}castToText(x=!1){return"object, FeatureSetCollection"}}},85171:(ee,$,c)=>{c.r($),c.d($,{constructAssociationMetaDataFeatureSetFromUrl:()=>Ze,constructFeatureSet:()=>ne,constructFeatureSetFromPortalItem:()=>Ke,constructFeatureSetFromRelationship:()=>je,constructFeatureSetFromUrl:()=>oe,convertToFeatureSet:()=>Ge,createFeatureSetCollectionFromMap:()=>Me,createFeatureSetCollectionFromService:()=>ke,getPortal:()=>Ue,initialiseMetaDataCache:()=>Ae,lookupUser:()=>We});var p=c(15861),z=c(24263),V=c(84792),x=c(90512),O=c(53997),N=c(88879),M=c(47562),F=c(52724),I=c(95896),T=c(49086),P=c(91510),m=c(57366),d=c(77132),C=c(83947),u=c(45333),_=c(47982),b=c(10410);class h{constructor(){this.field="",this.tofieldname="",this.typeofstat="MIN",this.workingexpr=null}clone(){const e=new h;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,n){const r=new h;r.field=e;const a=b.WhereClause.create(t,n),s=function v(w){if("function"===w.parseTree.type){if(0===w.parseTree.args.value.length)return{name:w.parseTree.name,expr:null};if(w.parseTree.args.value.length>1)throw new _.eS(_.f.MissingStatisticParameters);const e=b.WhereClause.create((0,C.XF)(w.parseTree.args.value[0],d.Bj.Standardised,w.parameters),w.fieldsIndex);return{name:w.parseTree.name,expr:e}}return null}(a);if(null===s)throw new _.eS(_.f.UnsupportedSqlFunction,{function:""});const l=s.name.toUpperCase().trim();if("MIN"===l){if(r.typeofstat="MIN",r.workingexpr=s.expr,null===a)throw new _.eS(_.f.InvalidFunctionParameters,{function:"min"})}else if("MAX"===l){if(r.typeofstat="MAX",r.workingexpr=s.expr,null===a)throw new _.eS(_.f.InvalidFunctionParameters,{function:"max"})}else if("COUNT"===l)r.typeofstat="COUNT",r.workingexpr=s.expr;else if("STDEV"===l){if(r.typeofstat="STDDEV",r.workingexpr=s.expr,null===a)throw new _.eS(_.f.InvalidFunctionParameters,{function:"stdev"})}else if("SUM"===l){if(r.typeofstat="SUM",r.workingexpr=s.expr,null===a)throw new _.eS(_.f.InvalidFunctionParameters,{function:"sum"})}else if("MEAN"===l){if(r.typeofstat="AVG",r.workingexpr=s.expr,null===a)throw new _.eS(_.f.InvalidFunctionParameters,{function:l})}else if("AVG"===l){if(r.typeofstat="AVG",r.workingexpr=s.expr,null===a)throw new _.eS(_.f.InvalidFunctionParameters,{function:"avg"})}else{if("VAR"!==l)throw new _.eS(_.f.UnsupportedSqlFunction,{function:l});if(r.typeofstat="VAR",r.workingexpr=s.expr,null===a)throw new _.eS(_.f.InvalidFunctionParameters,{function:"var"})}return r}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}var o=c(50011),g=c(65234),D=c(36255),E=c(60466);function S(w){if(!w)return"COUNT";switch(w.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class W extends T.Z{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){var t=this;return(0,p.Z)(function*(){if(null===t._wset){const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,t._wset}return t._wset})()}_isInFeatureSet(){return d.dj.InFeatureSet}_nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,n=1;const r=this._parent?this._parent.getFieldsIndex():new E.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let s=!1;for(let l=0;l<this._config.groupbyfields.length;l++)if(this._config.groupbyfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){s=!0;break}if(!1===s)for(let l=0;l<this._config.statsfields.length;l++)if(this._config.statsfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){s=!0;break}!1===s?t=!0:(this.objectIdField="ROW__ID"+n.toString(),n++)}for(const s of this._config.statsfields){const l=new h;l.field=s.name,l.tofieldname=s.name,l.workingexpr=s.expression instanceof b.WhereClause?s.expression:b.WhereClause.create(s.expression,r),l.typeofstat=S(s.statistic),this._decodedStatsfield.push(l)}this._decodedGroupbyfield=[];for(const s of this._config.groupbyfields){const l={name:s.name,singlefield:null,tofieldname:s.name,expression:s.expression instanceof b.WhereClause?s.expression:b.WhereClause.create(s.expression,r)};this._decodedGroupbyfield.push(l)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const s of this._parent.fields)e[s.name.toUpperCase()]=1;this.types=null}else this.geometryType=d.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new g.Z({wkid:4326});this.fields=[];const a=new h;a.field=this._nextUniqueName(e),a.tofieldname=this.objectIdField,a.workingexpr=b.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),a.typeofstat="MIN",this._decodedStatsfield.push(a);for(const s of this._decodedGroupbyfield){const l=new D.Z;if(s.name=this._nextUniqueName(e),l.name=s.tofieldname,l.alias=l.name,(0,C.y5)(s.expression)){const i=this._parent.getField((0,C.zR)(s.expression,d.Bj.Standardised));if(!i)throw new _.EN(_.H9.AggregationFieldNotFound);s.name=i.name,s.singlefield=i.name,this.phsyicalgroupbyfields.push(i.name),l.type=i.type}else{l.type=this._convertToEsriFieldType((0,C.DT)(s.expression,this._parent.fields));const i=new D.Z;i.name=s.name,i.alias=i.name,this.phsyicalgroupbyfields.push(s.name),this._adaptedFields.push(new F.yN(i,s.expression)),this._candosimplegroupby=!1}this.fields.push(l)}if(this._adaptedFields.length>0)for(const s of this._parent.fields)this._adaptedFields.push(new F.$X(s));for(let s=0;s<this._decodedStatsfield.length;s++){const l=new D.Z;let i=null;const f=this._decodedStatsfield[s];f.field=this._nextUniqueName(e),f.tofieldname===this.objectIdField&&(this._internalObjectIdField=f.field),l.name=f.tofieldname,l.alias=l.name;const y=null!==f.workingexpr&&(0,C.y5)(f.workingexpr)?(0,C.zR)(f.workingexpr,d.Bj.Standardised):"";switch(this._decodedStatsfield[s].typeofstat){case"SUM":if(""!==y){if(i=this._parent.getField(y),!i)throw new _.EN(_.H9.AggregationFieldNotFound);l.type=i.type}else l.type="double";break;case"MIN":case"MAX":if(""!==y){if(i=this._parent.getField(y),!i)throw new _.EN(_.H9.AggregationFieldNotFound);l.type=i.type}else l.type="double";break;case"COUNT":l.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==y&&(i=this._parent.getField(y),!i))throw new _.EN(_.H9.AggregationFieldNotFound);l.type="double"}this.fields.push(l)}}_canDoAggregates(){return(0,p.Z)(function*(){return!1})()}_getFeatures(e,t,n,r){var a=this;return(0,p.Z)(function*(){const s=a._maxQuery;return!0===a._checkIfNeedToExpandKnownPage(e,s)?(yield a._expandPagedSet(e,s,0,0,r),a._getFeatures(e,t,n,r)):"success"})()}_getFilteredSet(e,t,n,r,a){var s=this;return(0,p.Z)(function*(){if(""!==e)return new P.Z([],[],!0,null);let l=null;const i={ordered:!1,nowhereclause:!1};if(yield s._ensureLoaded(),null!==n)for(let y=0;y<s._decodedStatsfield.length;y++)if(!0===(0,C.hq)(n,s._decodedStatsfield[y].tofieldname)){i.nowhereclause=!0,n=null;break}if(null!==r){i.ordered=!0;for(let y=0;y<s._decodedStatsfield.length;y++)if(!0===r.scanForField(s._decodedStatsfield[y].tofieldname)){r=null,i.ordered=!1;break}if(null!==r)for(const y of s._decodedGroupbyfield)if(null===y.singlefield&&!0===r.scanForField(y.tofieldname)){r=null,i.ordered=!1;break}}if(!1!==s._candosimplegroupby&&(yield s._parent._canDoAggregates(s.phsyicalgroupbyfields,s._decodedStatsfield,"",null,null))){let y=null;n&&(y=s._reformulateWhereClauseWithoutGroupByFields(n));let R=null;r&&(R=s._reformulateOrderClauseWithoutGroupByFields(r));const j=yield s._parent._getAggregatePagesDataSourceDefinition(s.phsyicalgroupbyfields,s._decodedStatsfield,"",null,y,R,s._internalObjectIdField);return s._checkCancelled(a),l=!0===i.nowhereclause?new P.Z(j._candidates.slice(0).concat(j._known.slice(0)),[],!0===i.ordered&&j._ordered,s._clonePageDefinition(j.pagesDefinition)):new P.Z(j._candidates.slice(0),j._known.slice(0),!0===i.ordered&&j._ordered,s._clonePageDefinition(j.pagesDefinition)),l}let f=s._parent;if(s._adaptedFields.length>0&&(f=new F.Xx({parentfeatureset:s._parent,adaptedFields:s._adaptedFields,extraFilter:null})),!0===i.nowhereclause)l=new P.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:s._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new I.Z({parentfeatureset:f,orderbyclause:new m.Z(s.phsyicalgroupbyfields.join(",")+","+s._parent.objectIdField+" ASC")})}});else{let y=f;if(null!==n){let R=null;n&&(R=s._reformulateWhereClauseWithoutGroupByFields(n)),y=new O.Z({parentfeatureset:y,whereclause:R})}l=new P.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:s._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new I.Z({parentfeatureset:y,orderbyclause:new m.Z(s.phsyicalgroupbyfields.join(",")+","+s._parent.objectIdField+" ASC")})}})}return l})()}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,C.bB)(e,t.tofieldname,(0,C.zR)(t.workingexpr,d.Bj.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,C.bB)(e,t.tofieldname,(0,C.zR)(t.expression,d.Bj.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const n of this._decodedGroupbyfield)n.tofieldname!==n.name&&t.push({field:n.tofieldname,newfield:n.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,n){var r=this;return(0,p.Z)(function*(){return!0===r._checkIfNeedToExpandCandidatePage(e,r._maxQuery)?(yield r._expandPagedSet(e,r._maxQuery,0,0,n),r._refineSetBlock(e,t,n)):(r._checkCancelled(n),r._refineKnowns(e,t),e)})()}_expandPagedSet(e,t,n,r,a){return this._expandPagedSetFeatureSet(e,t,n,r,a)}_getPhysicalPage(e,t,n){var r=this;return(0,p.Z)(function*(){if(!0===e.pagesDefinition.aggregatefeaturesetpagedefinition)return r._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,n,[]);const a=yield r._getAgregagtePhysicalPage(e,t,n);for(const s of a){const l={geometry:s.geometry,attributes:{}};for(const i of r._decodedGroupbyfield)l.attributes[i.tofieldname]=s.attributes[i.name];for(const i of r._decodedStatsfield)l.attributes[i.tofieldname]=s.attributes[i.field];r._featureCache[l.attributes[r.objectIdField]]=new N.Z(l)}return a.length})()}_sequentialGetPhysicalItem(e,t,n,r){return new Promise((a,s)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(n)),!0===e.pagesDefinition.internal.fullyResolved||0===t?a(r.length):this._nextAggregateItem(e,t,n,r,l=>{a(null===l?r.length:this._sequentialGetPhysicalItem(e,t-=1,n,r))},s)})}_nextAggregateItem(e,t,n,r,a,s){try{(0,M.W)(e.pagesDefinition.internal.iterator.next()).then(l=>{if(null===l)if(null!==e.pagesDefinition.internal.workingItem){const i=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(i),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(i.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,a(null)}else e.pagesDefinition.internal.fullyResolved=!0,a(null);else{const i=this._generateAggregateHash(l);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[l],id:i};else{if(i!==e.pagesDefinition.internal.workingItem.id){const f=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return r.push(f),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(f.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[l],id:i},void a(f)}e.pagesDefinition.internal.workingItem.features.push(l)}this._nextAggregateItem(e,t,n,r,a,s)}},s)}catch(l){s(l)}}_calculateFieldStat(e,t,n){const r=[];for(let a=0;a<e.features.length;a++)if(null!==t.workingexpr){const s=t.workingexpr.calculateValue(e.features[a]);null!==s&&r.push(s)}else r.push(null);switch(t.typeofstat){case"MIN":n.attributes[t.tofieldname]=(0,u.tj)("min",r,-1);break;case"MAX":n.attributes[t.tofieldname]=(0,u.tj)("max",r,-1);break;case"SUM":n.attributes[t.tofieldname]=(0,u.tj)("sum",r,-1);break;case"COUNT":n.attributes[t.tofieldname]=r.length;break;case"VAR":n.attributes[t.tofieldname]=(0,u.tj)("var",r,-1);break;case"STDDEV":n.attributes[t.tofieldname]=(0,u.tj)("stddev",r,-1);break;case"AVG":n.attributes[t.tofieldname]=(0,u.tj)("avg",r,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const r of this._decodedGroupbyfield){const a=r.singlefield?e.features[0].attributes[r.singlefield]:r.expression.calculateValue(e.features[0]);t.attributes[r.tofieldname]=a}for(const r of this._decodedStatsfield)this._calculateFieldStat(e,r,t);const n=[];for(let r=0;r<this._decodedStatsfield.length;r++)n.push(this._calculateFieldStat(e,this._decodedStatsfield[r],t));return this._featureCache[t.attributes[this.objectIdField]]=new N.Z({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const n of this._decodedGroupbyfield){const r=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=null==r?":":":"+r.toString()}return(0,o.F)(t,o.M.String)}_stat(){return(0,p.Z)(function*(){return{calculated:!1}})()}getFeatureByObjectId(){return(0,p.Z)(function*(){return null})()}static registerAction(){T.Z._featuresetFunctions.groupby=function(e,t){return new W({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var U=c(3482),Z=c(79429),B=c(22386),A=c(91179),L=c(80415),G=c(82054),Fe=(c(26584),c(8314),c(63290),c(15283),c(2865)),we=(c(59318),c(85931),c(21726),c(16730),c(37053),c(20477)),Ce=c(17253),te=c(96854),De=(c(87183),c(67736),c(90463)),be=(c(29132),c(24865)),Se=c(67010),Re=(c(93555),c(6871),c(98558)),Ie=c(60776),Ee=c(6729);class ie extends T.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return d.tI}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}convertQueryToLruCacheKey(e){const t=(0,d.hd)(e.toJSON());return(0,o.F)(t,o.M.String)}loadImpl(){var e=this;return(0,p.Z)(function*(){return!0===e._layer.loaded?(e._initialiseFeatureSet(),e):(yield e._layer.load(),e._initialiseFeatureSet(),e)})()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const n of this._layer.outFields)if(n.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const n of this.fields)if("oid"===n.type)e.push(n),t.push(n.name);else for(const r of this._overrideFields)if(r.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=d.Bj.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=d.Bj.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=d.Bj.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=d.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types}_isInFeatureSet(){return d.dj.InFeatureSet}_refineSetBlock(e){return(0,p.Z)(function*(){return e})()}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,p.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_runDatabaseProbe(e){var t=this;return(0,p.Z)(function*(){yield t._ensureLoaded();const n=new te.Z;n.where=e.replace("OBJECTID",t._layer.objectIdField);try{return yield t._layer.queryObjectIds(n),!0}catch{return!1}})()}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){const t=this._layer?.capabilities?.query;return!e.outStatistics&&!0===t?.supportsFormatPBF&&!0===t?.supportsQuantizationEditMode}queryPBF(e){var t=this;return(0,p.Z)(function*(){e.quantizationParameters={mode:"edit"};const n=yield(0,we.executeQueryPBF)(t._layer.parsedUrl,e,new Re.J({}));return Ce.default.fromJSON((0,G.cn)(n.data)).unquantize()})()}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const n="execute"===t?Fe.e:"executeForCount"===t?De.P:be.G,r="execute"===t&&this.pbfSupportedForQuery(e);let a=null;if(this.recentlyUsedQueries){const s=this.convertQueryToLruCacheKey(e);a=this.recentlyUsedQueries.getFromCache(s),null===a&&(a=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(s,a),a=a.catch(l=>{throw this.recentlyUsedQueries?.removeFromCache(s),l}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===a&&(a=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e)),a}_getFilteredSet(e,t,n,r,a){var s=this;return(0,p.Z)(function*(){const l=yield s.databaseType();if(s.isTable()&&t&&null!==e&&""!==e)return new P.Z([],[],!0,null);if(s._canUsePagination())return s._getFilteredSetUsingPaging(e,t,n,r,a);let i="",f=!1;null!==r&&s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsOrderBy&&(i=r.constructClause(),f=!0);const y=new te.Z;y.where=null===n?null===t?"1=1":"":(0,C.zR)(n,l),s._requestStandardised&&(y.sqlFormat="standard"),y.spatialRelationship=s._makeRelationshipEnum(e),y.outSpatialReference=s.spatialReference,y.orderByFields=""!==i?i.split(","):null,y.geometry=null===t?null:t,y.relationParameter=s._makeRelationshipParam(e);let R=yield s.executeQuery(y,"executeForIds");return null===R&&(R=[]),s._checkCancelled(a),new P.Z([],R,f,null)})()}_expandPagedSet(e,t,n,r,a){return this._expandPagedSetFeatureSet(e,t,n,r,a)}_getFilteredSetUsingPaging(e,t,n,r,a){var s=this;return(0,p.Z)(function*(){let l="",i=!1;null!==r&&s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsOrderBy&&(l=r.constructClause(),i=!0);const f=yield s.databaseType();let y=null===n?null===t?"1=1":"":(0,C.zR)(n,f);s._layer.definitionExpression&&s._useDefinitionExpression&&(y=""!==y?"(("+s._layer.definitionExpression+") AND ("+y+"))":s._layer.definitionExpression);let R=s._maxQueryRate();const j=s._layer.capabilities?.query.maxRecordCount;void 0!==j&&j<R&&(R=j);let k=null;if(!0===s._pageJustIds)k=new P.Z([],["GETPAGES"],i,{spatialRel:s._makeRelationshipEnum(e),relationParam:s._makeRelationshipParam(e),outFields:s._layer.objectIdField,resultRecordCount:R,resultOffset:0,geometry:null===t?null:t,where:y,orderByFields:l,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let K=!0;!0===s._removeGeometry&&(K=!1);const J=null!==s._overrideFields?s._overrideFields:s._fieldsIncludingObjectId(s._layer.outFields?s._layer.outFields:["*"]);k=new P.Z([],["GETPAGES"],i,{spatialRel:s._makeRelationshipEnum(e),relationParam:s._makeRelationshipParam(e),outFields:J.join(","),resultRecordCount:R,resultOffset:0,geometry:null===t?null:t,where:y,orderByFields:l,returnGeometry:K,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return yield s._expandPagedSet(k,R,0,1,a),k})()}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,p.Z)(function*(){const a=e.pagesDefinition.internal.lastRetrieved,s=a,l=e.pagesDefinition.internal.lastPage,i=new te.Z;r._requestStandardised&&(i.sqlFormat="standard"),i.spatialRelationship=e.pagesDefinition.spatialRel,i.relationParameter=e.pagesDefinition.relationParam,i.outFields=e.pagesDefinition.outFields.split(","),i.num=e.pagesDefinition.resultRecordCount,i.start=e.pagesDefinition.internal.lastPage,i.geometry=e.pagesDefinition.geometry,i.where=e.pagesDefinition.where,i.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,i.returnGeometry=e.pagesDefinition.returnGeometry,i.outSpatialReference=r.spatialReference;const f=yield r.executeQuery(i,"execute");if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==l)return"done";const y=r._layer.objectIdField;for(let R=0;R<f.features.length;R++)e.pagesDefinition.internal.set[s+R]=f.features[R].attributes[y];if(!1===r._pageJustIds)for(let R=0;R<f.features.length;R++)r._featureCache[f.features[R].attributes[y]]=f.features[R];return(void 0===f.exceededTransferLimit&&f.features.length!==e.pagesDefinition.resultRecordCount||!1===f.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+f.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFeatures(e,t,n,r){var a=this;return(0,p.Z)(function*(){const s=[];if(-1!==t&&void 0===a._featureCache[t]&&s.push(t),!0===a._checkIfNeedToExpandKnownPage(e,a._maxProcessingRate()))return yield a._expandPagedSet(e,a._maxProcessingRate(),0,0,r),a._getFeatures(e,t,n,r);let l=0;for(let R=e._lastFetchedIndex;R<e._known.length;R++){if(e._lastFetchedIndex+=1,l++,void 0===a._featureCache[e._known[R]]){let j=!1;if(null!=a._layer._mode){const k=a._layer._mode;if(void 0!==k._featureMap[e._known[R]]){const K=k._featureMap[e._known[R]];null!==K&&(j=!0,a._featureCache[e._known[R]]=K)}}if(!1===j&&(e._known[R]!==t&&s.push(e._known[R]),s.length>=a._maxProcessingRate()-1))break}if(l>=n&&0===s.length)break}if(0===s.length)return"success";const i=new te.Z;a._requestStandardised&&(i.sqlFormat="standard"),i.objectIds=s,i.outFields=null!==a._overrideFields?a._overrideFields:a._fieldsIncludingObjectId(a._layer.outFields?a._layer.outFields:["*"]),i.returnGeometry=!0,!0===a._removeGeometry&&(i.returnGeometry=!1),i.outSpatialReference=a.spatialReference;const f=yield a.executeQuery(i,"execute");if(a._checkCancelled(r),void 0!==f.error)throw new _.EN(_.H9.RequestFailed,{reason:f.error});const y=a._layer.objectIdField;for(let R=0;R<f.features.length;R++)a._featureCache[f.features[R].attributes[y]]=f.features[R];return"success"})()}_getDistinctPages(e,t,n,r,a,s,l,i,f){var y=this;return(0,p.Z)(function*(){yield y._ensureLoaded();const R=yield y.databaseType();let j=n.parseTree.column;const k=y._layer.fields??[];for(let Q=0;Q<k.length;Q++)if(k[Q].name.toLowerCase()===j.toLowerCase()){j=k[Q].name;break}const K=new te.Z;y._requestStandardised&&(K.sqlFormat="standard");let J=null===s?null===a?"1=1":"":(0,C.zR)(s,R);y._layer.definitionExpression&&y._useDefinitionExpression&&(J=""!==J?"(("+y._layer.definitionExpression+") AND ("+J+"))":y._layer.definitionExpression),K.where=J,K.spatialRelationship=y._makeRelationshipEnum(r),K.relationParameter=y._makeRelationshipParam(r),K.geometry=null===a?null:a,K.returnDistinctValues=!0,K.returnGeometry=!1,K.outFields=[j];const H=yield y.executeQuery(K,"execute");if(y._checkCancelled(f),!H.hasOwnProperty("features"))throw new _.EN(_.H9.InvalidStatResponse);let X=!1;for(let Q=0;Q<k.length;Q++)if(k[Q].name===j){"date"===k[Q].type&&(X=!0);break}for(let Q=0;Q<H.features.length;Q++){if(X){const se=H.features[Q].attributes[j];i.push(null!==se?new Date(se):se)}else i.push(H.features[Q].attributes[j]);if(i.length>=l)break}return 0===H.features.length?i:H.features.length===y._layer.capabilities?.query.maxRecordCount&&i.length<l?{calculated:!0,result:yield y._getDistinctPages(e+H.features.length,t,n,r,a,s,l,i,f)}:i})()}_distinctStat(e,t,n,r,a,s,l){var i=this;return(0,p.Z)(function*(){return{calculated:!0,result:yield i._getDistinctPages(0,e,t,n,r,a,s,[],l)}})()}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(e,t,n,r){var a=this;return(0,p.Z)(function*(){const s=yield a.databaseType(),l=new te.Z;if(a._requestStandardised&&(l.sqlFormat="standard"),a.isTable()&&n&&null!==t&&""!==t)return{calculated:!0,result:0};let i=null===r?null===n?"1=1":"":(0,C.zR)(r,s);return a._layer.definitionExpression&&a._useDefinitionExpression&&(i=""!==i?"(("+a._layer.definitionExpression+") AND ("+i+"))":a._layer.definitionExpression),l.where=i,l.where=i,l.spatialRelationship=a._makeRelationshipEnum(t),l.relationParameter=a._makeRelationshipParam(t),l.geometry=null===n?null:n,l.returnGeometry=!1,{calculated:!0,result:yield a.executeQuery(l,"executeForCount")}})()}_stats(e,t,n,r,a,s,l){var i=this;return(0,p.Z)(function*(){yield i._ensureLoaded();const f=i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsSqlExpression,y=i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsStatistics,R=i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsDistinct;if("count"===e)return R?i._countstat(e,n,r,a):{calculated:!1};if(!1===y||!1===(0,C.y5)(t)&&!1===f||!1===t.isStandardized)return""!==n||null!==a?{calculated:!1}:i._manualStat(e,t,s,l);if("distinct"===e)return!1===R?""!==n||null!==a?{calculated:!1}:i._manualStat(e,t,s,l):i._distinctStat(e,t,n,r,a,s,l);const j=yield i.databaseType();if(i.isTable()&&r&&null!==n&&""!==n)return{calculated:!0,result:null};const k=new te.Z;i._requestStandardised&&(k.sqlFormat="standard");let K=null===a?null===r?"1=1":"":(0,C.zR)(a,j);i._layer.definitionExpression&&i._useDefinitionExpression&&(K=""!==K?"(("+i._layer.definitionExpression+") AND ("+K+"))":i._layer.definitionExpression),k.where=K,k.spatialRelationship=i._makeRelationshipEnum(n),k.relationParameter=i._makeRelationshipParam(n),k.geometry=null===r?null:r;const J=new Ie.Z;J.statisticType=(0,u.g3)(e),J.onStatisticField=(0,C.zR)(t,j),J.outStatisticFieldName="ARCADE_STAT_RESULT",k.returnGeometry=!1;let H="ARCADE_STAT_RESULT";k.outStatistics=[J];const X=yield i.executeQuery(k,"execute");if(!X.hasOwnProperty("features")||0===X.features.length)throw new _.EN(_.H9.InvalidStatResponse);let Q=!1;const se=X.fields??[];for(let re=0;re<se.length;re++)if("ARCADE_STAT_RESULT"===se[re].name.toUpperCase()){H=se[re].name,"date"===se[re].type&&(Q=!0);break}if(Q){let re=X.features[0].attributes[H];return null!==re&&(re=new Date(X.features[0].attributes[H])),{calculated:!0,result:re}}return{calculated:!0,result:X.features[0].attributes[H]}})()}_stat(e,t,n,r,a,s,l){return this._stats(e,t,n,r,a,s,l)}_canDoAggregates(e,t){var n=this;return(0,p.Z)(function*(){yield n._ensureLoaded();let r=!1;const a=n._layer.capabilities?.query,s=!0===a?.supportsSqlExpression;if(null!=a&&!0===a.supportsStatistics&&!0===a.supportsOrderBy&&(r=!0),r)for(let l=0;l<t.length-1;l++)(!1===t[l].workingexpr?.isStandardized||!1===(0,C.y5)(t[l].workingexpr)&&!1===s)&&(r=!1);return!1!==r})()}_makeRelationshipEnum(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,n,r,a,s,l){var i=this;return(0,p.Z)(function*(){yield i._ensureLoaded();const f=yield i.databaseType();let y="",R=!1,j=!1;null!==s&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(y=s.constructClause(),j=!0),i._layer.capabilities&&i._layer.capabilities.query&&!1===i._layer.capabilities.query.supportsPagination&&(j=!1,R=!0,y=i._layer.objectIdField);const k=[];for(let X=0;X<t.length;X++){const Q=new Ie.Z;Q.onStatisticField=null!==t[X].workingexpr?(0,C.zR)(t[X].workingexpr,f):"",Q.outStatisticFieldName=t[X].field,Q.statisticType=t[X].toStatisticsName(),k.push(Q)}""===y&&(y=e.join(","));let K=i._maxQueryRate();const J=i._layer.capabilities?.query.maxRecordCount;void 0!==J&&J<K&&(K=J);let H=null===a?null===r?"1=1":"":(0,C.zR)(a,f);return i._layer.definitionExpression&&i._useDefinitionExpression&&(H=""!==H?"(("+i._layer.definitionExpression+") AND ("+H+"))":i._layer.definitionExpression),new P.Z([],["GETPAGES"],j,{groupbypage:!0,spatialRel:i._makeRelationshipEnum(n),relationParam:i._makeRelationshipParam(n),outFields:["*"],useOIDpagination:R,generatedOid:l,resultRecordCount:K,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:k,geometry:null===r?null:r,where:H,orderByFields:y,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})()}_getAgregagtePhysicalPage(e,t,n){var r=this;return(0,p.Z)(function*(){let a=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(a=""!==a?"("+a+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const s=e.pagesDefinition.internal.lastRetrieved,l=s,i=e.pagesDefinition.internal.lastPage,f=new te.Z;if(r._requestStandardised&&(f.sqlFormat="standard"),f.where=a,f.spatialRelationship=e.pagesDefinition.spatialRel,f.relationParameter=e.pagesDefinition.relationParam,f.outFields=e.pagesDefinition.outFields,f.outStatistics=e.pagesDefinition.outStatistics,f.geometry=e.pagesDefinition.geometry,f.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,f.num=e.pagesDefinition.resultRecordCount,f.start=e.pagesDefinition.internal.lastPage,f.returnGeometry=e.pagesDefinition.returnGeometry,f.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,r.isTable()&&f.geometry&&f.spatialRelationship)return[];const y=yield r.executeQuery(f,"execute");if(r._checkCancelled(n),!y.hasOwnProperty("features"))throw new _.EN(_.H9.InvalidStatResponse);const R=[];if(e.pagesDefinition.internal.lastPage!==i)return[];for(let j=0;j<y.features.length;j++)e.pagesDefinition.internal.set[l+j]=y.features[j].attributes[e.pagesDefinition.generatedOid];for(let j=0;j<y.features.length;j++)R.push(new N.Z({attributes:y.features[j].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===y.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=y.features[y.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===y.exceededTransferLimit&&y.features.length!==e.pagesDefinition.resultRecordCount||!1===y.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+y.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,R})()}static create(e,t,n,r,a){const s=new L.default({url:e,outFields:null===t?["*"]:t});return new ie({layer:s,spatialReference:n,lrucache:r,interceptor:a})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,d.US)(this._layer.parsedUrl.path)}queryAttachments(e,t,n,r,a){var s=this;return(0,p.Z)(function*(){const l=s._layer.capabilities;if(l?.data.supportsAttachment&&l?.operations.supportsQueryAttachments){const i={objectIds:[e],returnMetadata:a};(t&&t>0||n&&n>0)&&(i.size=[t&&t>0?t:0,n&&n>0?n:t+1]),r&&r.length>0&&(i.attachmentTypes=r),s.featureSetQueryInterceptor&&s.featureSetQueryInterceptor.preLayerQueryCallback({layer:s._layer,query:i,method:"attachments"});const f=yield s._layer.queryAttachments(i),y=[];return f&&f[e]&&f[e].forEach(R=>{const j=s._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+R.id.toString();let k=null;a&&R.exifInfo&&(k=Ee.Z.convertJsonToArcade(R.exifInfo,!0)),y.push(new B.Z(R.id,R.name,R.contentType,R.size,j,k))}),y}return[]})()}queryRelatedFeatures(e){var t=this;return(0,p.Z)(function*(){const n={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields?.join(","),returnGeometry:e.returnGeometry.toString()};null!=e.resultOffset&&(n.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(n.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),e.objectIds&&e.objectIds.length>0&&(n.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(n.outSR=JSON.stringify(e.outSpatialReference.toJSON())),t.featureSetQueryInterceptor&&t.featureSetQueryInterceptor.preRequestCallback({layer:t._layer,queryPayload:n,method:"relatedrecords",url:t._layer.parsedUrl.path+"/queryRelatedRecords"});const r=yield(0,V.default)(t._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:n});if(r.data){const a={},s=r.data;if(s&&s.relatedRecordGroups){const l=s.spatialReference;for(const i of s.relatedRecordGroups){const f=i.objectId,y=[];for(const R of i.relatedRecords){R.geometry&&(R.geometry.spatialReference=l);const j=new N.Z({geometry:R.geometry?(0,A.im)(R.geometry):null,attributes:R.attributes});y.push(j)}a[f]={features:y,exceededTransferLimit:!0===s.exceededTransferLimit}}}return a}throw new _.EN(_.H9.InvalidRequest)})()}getFeatureByObjectId(e,t){var n=this;return(0,p.Z)(function*(){const r=new te.Z;r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=n.spatialReference,r.where=n.objectIdField+"="+e.toString(),n.featureSetQueryInterceptor&&n.featureSetQueryInterceptor.preLayerQueryCallback({layer:n._layer,query:r,method:"execute"});const a=yield(0,Fe.e)(n._layer.parsedUrl.path,r);return 1===a.features.length?a.features[0]:null})()}getIdentityUser(){var e=this;return(0,p.Z)(function*(){yield e.load();const t=z.id?.findCredential(e._layer.url);return t?t.userId:null})()}getOwningSystemUrl(){var e=this;return(0,p.Z)(function*(){yield e.load();const t=z.id?.findServerInfo(e._layer.url);if(t)return t.owningSystemUrl;let n=e._layer.url;const r=n.toLowerCase().indexOf("/rest/services");if(n=r>-1?n.substring(0,r):n,n){n+="/rest/info";try{const a=yield(0,V.default)(n,{query:{f:"json"}});let s="";return a.data&&a.data.owningSystemUrl&&(s=a.data.owningSystemUrl),s}catch{return""}}return""})()}getDataSourceFeatureSet(){const e=new ie({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});return e._useDefinitionExpression=!1,e}}var Te=c(16776);class xe extends T.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this._relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return d.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var e=this;return(0,p.Z)(function*(){return yield Promise.all([e._layer.load(),e._relatedLayer?.load()]),e._initialiseFeatureSet(),e})()}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],n=[];for(const r of this.fields)if("oid"===r.type)t.push(r),n.push(r.name);else for(const a of this._overrideFields)if(a.toLowerCase()===r.name.toLowerCase()){t.push(r),n.push(r.name);break}this.fields=t,this._overrideFields=n}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types}databaseType(){var e=this;return(0,p.Z)(function*(){return yield e._relatedLayer.databaseType(),e._databaseType=e._relatedLayer._databaseType,e._databaseType})()}isTable(){return this._relatedLayer.isTable()}_isInFeatureSet(){return d.dj.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,p.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_changeFeature(e){const t={};for(const n of this.fields)t[n.name]=e.attributes[n.name];return new N.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,n,r,a){var s=this;return(0,p.Z)(function*(){if(yield s.databaseType(),s.isTable()&&t&&null!==e&&""!==e)return new P.Z([],[],!0,null);const l=s._layer.nativeCapabilities();if(!1===l.canQueryRelated)return new P.Z([],[],!0,null);if(l.capabilities?.queryRelated&&l.capabilities.queryRelated.supportsPagination)return s._getFilteredSetUsingPaging(e,t,n,r,a);let i="",f=!1;null!==r&&l.capabilities&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(i=r.constructClause(),f=!0);const y=new Se.Z;y.objectIds=[s._findObjectId];const R=null!==s._overrideFields?s._overrideFields:s._fieldsIncludingObjectId(s._relatedLayer.fields?s._relatedLayer.fields.map(Q=>Q.name):["*"]);y.outFields=R,y.relationshipId=s.relationship.id,y.where="1=1";let j=!0;!0===s._removeGeometry&&(j=!1),y.returnGeometry=j,s._requestStandardised&&(y.sqlFormat="standard"),y.outSpatialReference=s.spatialReference,y.orderByFields=""!==i?i.split(","):null;const k=yield l.source.queryRelatedFeatures(y);s._checkCancelled(a);const K=k[s._findObjectId]?k[s._findObjectId].features:[],J=[];for(let Q=0;Q<K.length;Q++)s._featureCache[K[Q].attributes[s._relatedLayer.objectIdField]]=K[Q],J.push(K[Q].attributes[s._relatedLayer.objectIdField]);const H=t&&null!==e&&""!==e,X=null!=n;return new P.Z(H||X?J:[],H||X?[]:J,f,null)})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,n,r,a){var s=this;return(0,p.Z)(function*(){let l="",i=!1;const f=s._layer.nativeCapabilities();null!==r&&f&&f.capabilities?.queryRelated&&!0===f.capabilities.queryRelated.supportsOrderBy&&(l=r.constructClause(),i=!0),yield s.databaseType();let R=s._maxQueryRate();const j=f.capabilities?.query.maxRecordCount;void 0!==j&&j<R&&(R=j);const k=t&&null!==e&&""!==e,K=null!=n;let J=null,H=!0;!0===s._removeGeometry&&(H=!1);const X=null!==s._overrideFields?s._overrideFields:s._fieldsIncludingObjectId(s._relatedLayer.fields?s._relatedLayer.fields.map(Q=>Q.name):["*"]);return J=new P.Z(k||K?["GETPAGES"]:[],k||K?[]:["GETPAGES"],i,{outFields:X.join(","),resultRecordCount:R,resultOffset:0,objectIds:[s._findObjectId],where:"1=1",orderByFields:l,returnGeometry:H,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),yield s._expandPagedSet(J,R,0,0,a),J})()}_expandPagedSet(e,t,n,r,a){return this._expandPagedSetFeatureSet(e,t,n,r,a)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,p.Z)(function*(){const a=e.pagesDefinition.internal.lastRetrieved,s=a,l=e.pagesDefinition.internal.lastPage,i=r._layer.nativeCapabilities(),f=new Se.Z;!0===r._requestStandardised&&(f.sqlFormat="standard"),f.relationshipId=r.relationship.id,f.objectIds=e.pagesDefinition.objectIds,f.resultOffset=e.pagesDefinition.internal.lastPage,f.resultRecordCount=e.pagesDefinition.resultRecordCount,f.outFields=e.pagesDefinition.outFields.split(","),f.where=e.pagesDefinition.where,f.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,f.returnGeometry=e.pagesDefinition.returnGeometry,f.outSpatialReference=r.spatialReference;const y=yield i.source.queryRelatedFeatures(f);if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==l)return 0;const R=y[r._findObjectId]?y[r._findObjectId].features:[];for(let k=0;k<R.length;k++)e.pagesDefinition.internal.set[s+k]=R[k].attributes[r._relatedLayer.objectIdField];for(let k=0;k<R.length;k++)r._featureCache[R[k].attributes[r._relatedLayer.objectIdField]]=R[k];return R.length!==e.pagesDefinition.resultRecordCount&&(!y[r._findObjectId]||!1===y[r._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+R.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,R.length})()}_getFeatures(e,t,n,r){var a=this;return(0,p.Z)(function*(){const s=[];-1!==t&&void 0===a._featureCache[t]&&s.push(t);const l=a._maxQueryRate();if(!0===a._checkIfNeedToExpandKnownPage(e,l))return yield a._expandPagedSet(e,l,0,0,r),a._getFeatures(e,t,n,r);let i=0;for(let f=e._lastFetchedIndex;f<e._known.length&&(i++,i<=n&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[f]&&void 0===a._featureCache[e._known[f]]&&(e._known[f]!==t&&s.push(e._known[f]),s.length>n)))&&!(i>=n&&0===s.length);f++);if(0===s.length)return"success";throw new _.EN(_.H9.MissingFeatures)})()}_refineSetBlock(e,t,n){return(0,p.Z)(function*(){return e})()}_stat(e,t,n,r,a,s,l){return(0,p.Z)(function*(){return{calculated:!1}})()}get gdbVersion(){return this._relatedLayer.gdbVersion}_canDoAggregates(e,t,n,r,a){return(0,p.Z)(function*(){return!1})()}relationshipMetaData(){return this._relatedLayer.relationshipMetaData()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(e,t,n,r,a){return this._relatedLayer.queryAttachments(e,t,n,r,a)}getFeatureByObjectId(e,t){return this._relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}}var q=c(53791),Oe=c(84687),Pe=c(55463);function Ae(){null===q.Z.applicationCache&&(q.Z.applicationCache=new q.Z)}function ae(w,e){return le.apply(this,arguments)}function le(){return(le=(0,p.Z)(function*(w,e){if(q.Z.applicationCache){const t=q.Z.applicationCache.getLayerInfo(w);if(t){const a=yield t;return new L.default({url:w,outFields:e,sourceJSON:a})}const n=new L.default({url:w,outFields:e}),r=(0,p.Z)(function*(){return yield n.load(),n.sourceJSON})();if(q.Z.applicationCache){q.Z.applicationCache.setLayerInfo(w,r);try{return yield r,n}catch(a){throw q.Z.applicationCache.clearLayerInfo(w),a}}return yield r,n}return new L.default({url:w,outFields:e})})).apply(this,arguments)}function oe(w,e,t,n,r){return ue.apply(this,arguments)}function ue(){return(ue=(0,p.Z)(function*(w,e,t,n,r,a=null){return ne(yield ae(w,["*"]),e,t,n,r,a)})).apply(this,arguments)}function ne(w,e=null,t=null,n=!0,r=null,a=null){const s={layer:w,spatialReference:e,outFields:t,includeGeometry:n,lrucache:r,interceptor:a};return!0===w._hasMemorySource()?new Te.Z(s):new ie(s)}function Ne(w){return de.apply(this,arguments)}function de(){return(de=(0,p.Z)(function*(w){if(null!==q.Z.applicationCache){const t=q.Z.applicationCache.getLayerInfo(w);if(null!==t)return t}const e=(0,p.Z)(function*(){const t=yield(0,V.default)(w,{responseType:"json",query:{f:"json"}});return t.data?t.data:null})();if(null!==q.Z.applicationCache){q.Z.applicationCache.setLayerInfo(w,e);try{return yield e}catch(t){throw q.Z.applicationCache.clearLayerInfo(w),t}}return e})).apply(this,arguments)}function Le(w,e){return ce.apply(this,arguments)}function ce(){return(ce=(0,p.Z)(function*(w,e){const t="QUERYDATAELEMTS:"+e.toString()+":"+w;if(null!==q.Z.applicationCache){const r=q.Z.applicationCache.getLayerInfo(t);if(null!==r)return r}const n=(0,p.Z)(function*(){const r=yield(0,V.default)(w+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}});if(r.data){const a=r.data;if(a.layerDataElements&&a.layerDataElements[0])return a.layerDataElements[0]}throw new _.EN(_.H9.DataElementsNotFound)})();if(null!==q.Z.applicationCache){q.Z.applicationCache.setLayerInfo(t,n);try{return yield n}catch(r){throw q.Z.applicationCache.clearLayerInfo(t),r}}return n})).apply(this,arguments)}function ve(w){return he.apply(this,arguments)}function he(){return(he=(0,p.Z)(function*(w){if(null!==q.Z.applicationCache){const t=q.Z.applicationCache.getLayerInfo(w);if(null!==t)return t}const e=(0,p.Z)(function*(){const t=yield(0,V.default)(w,{responseType:"json",query:{f:"json"}});if(t.data){const n=t.data;return n.layers||(n.layers=[]),n.tables||(n.tables=[]),n}return{layers:[],tables:[]}})();if(null!==q.Z.applicationCache){q.Z.applicationCache.setLayerInfo(w,e);try{return yield e}catch(t){throw q.Z.applicationCache.clearLayerInfo(w),t}}return e})).apply(this,arguments)}function Ze(w,e){return fe.apply(this,arguments)}function fe(){return(fe=(0,p.Z)(function*(w,e){const t={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},n=yield ve(w);if(t.metadata=n,n.controllerDatasetLayers&&null!=n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const s of n.layers)t.layerNameLkp[s.id]=s.name;if(n.tables)for(const s of n.tables)t.layerNameLkp[s.id]=s.name;const r=n.controllerDatasetLayers.utilityNetworkLayerId;t.networkId=r;const a=yield Le(w,r);if(a){t.queryelem=a,t.queryelem&&t.queryelem.dataElement&&void 0!==t.queryelem.dataElement.schemaGeneration&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const l of t.queryelem.dataElement.domainNetworks){for(const i of l.edgeSources?l.edgeSources:[]){const f={layerId:i.layerId,sourceId:i.sourceId,className:t.layerNameLkp[i.layerId]?t.layerNameLkp[i.layerId]:null};f.className&&(t.lkp[f.className]=f)}for(const i of l.junctionSources?l.junctionSources:[]){const f={layerId:i.layerId,sourceId:i.sourceId,className:t.layerNameLkp[i.layerId]?t.layerNameLkp[i.layerId]:null};f.className&&(t.lkp[f.className]=f)}}if(t.queryelem.dataElement.terminalConfigurations)for(const l of t.queryelem.dataElement.terminalConfigurations)for(const i of l.terminals)t.terminals.push({terminalId:i.terminalId,terminalName:i.terminalName});const s=yield Ne(w+"/"+r);if(s.systemLayers&&null!=s.systemLayers.associationsTableId){const l=[];t.unVersion>=4&&(l.push("STATUS"),l.push("PERCENTALONG"));let i=yield oe(w+"/"+s.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...l],!1,null,null);return yield i.load(),t.unVersion>=4&&(i=i.filter(b.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",i.getFieldsIndex())),yield i.load()),{lkp:t.lkp,associations:i,unVersion:t.unVersion,terminals:t.terminals}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})).apply(this,arguments)}function je(w,e,t){return _e.apply(this,arguments)}function _e(){return(_e=(0,p.Z)(function*(w,e,t,n=null,r=null,a=!0,s=null,l=null){let i=w.serviceUrl();if(!i)return null;i="/"===i.charAt(i.length-1)?i+e.relatedTableId.toString():i+"/"+e.relatedTableId.toString();const f=yield oe(i,n,r,a,s,l);return new xe({layer:w,relatedLayer:f,relationship:e,objectId:t,spatialReference:n,outFields:r,includeGeometry:a,lrucache:s,interceptor:l})})).apply(this,arguments)}O.Z.registerAction(),W.registerAction(),I.Z.registerAction(),U.Z.registerAction(),Z.Z.registerAction();class Be extends x.Z{constructor(e,t=null,n=null,r=null){super(),this._map=e,this._overridespref=t,this._lrucache=n,this._interceptor=r,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,n=null){const r=ne(e,this._overridespref,null===n?["*"]:n,t,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}featureSetByName(e,t=!0,n=null){var r=this;return(0,p.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetByName(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let l=0;l<r._instantLayers.length;l++){const i=r._instantLayers[l];if(i.opitem.title===e&&i.includeGeometry===t&&i.outFields===a)return r._instantLayers[l].featureset}const s=r._map.allLayers.find(l=>l instanceof L.default&&l.title===e);if(s)return r._makeAndAddFeatureSet(s,t,n);if(r._map.tables){const l=r._map.tables.find(i=>!!(i.title&&i.title===e||i.title&&i.title===e));if(l){if(l instanceof L.default)return r._makeAndAddFeatureSet(l,t,n);if(!l._materializedTable){const i=l.outFields?l:{...l,outFields:["*"]};l._materializedTable=new L.default(i)}return yield l._materializedTable.load(),r._makeAndAddFeatureSet(l._materializedTable,t,n)}}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,p.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetById(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let l=0;l<r._instantLayers.length;l++){const i=r._instantLayers[l];if(i.opitem.id===e&&i.includeGeometry===t&&i.outFields===a)return r._instantLayers[l].featureset}const s=r._map.allLayers.find(l=>l instanceof L.default&&l.id===e);if(s)return r._makeAndAddFeatureSet(s,t,n);if(r._map.tables){const l=r._map.tables.find(i=>i.id===e);if(l){if(l instanceof L.default)return r._makeAndAddFeatureSet(l,t,n);if(!l._materializedTable){const i={...l,outFields:["*"]};l._materializedTable=new L.default(i)}return yield l._materializedTable.load(),r._makeAndAddFeatureSet(l._materializedTable,t,n)}}return null})()}}class pe extends x.Z{constructor(e,t=null,n=null,r=null){super(),this._url=e,this._overridespref=t,this._lrucache=n,this._interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,n=null){const r=ne(e,this._overridespref,null===n?["*"]:n,t,this._lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}_loadMetaData(){var e=this;return(0,p.Z)(function*(){const t=yield ve(e._url);return e.metadata=t,t})()}load(){return this._loadMetaData()}clone(){return new pe(this._url,this._overridespref,this._lrucache,this._interceptor)}featureSetByName(e,t=!0,n=null){var r=this;return(0,p.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let i=0;i<r._instantLayers.length;i++){const f=r._instantLayers[i];if(f.opitem.title===e&&f.includeGeometry===t&&f.outFields===a)return r._instantLayers[i].featureset}const s=yield r._loadMetaData();let l=null;for(const i of s.layers?s.layers:[])i.name===e&&(l=i);if(!l)for(const i of s.tables?s.tables:[])i.name===e&&(l=i);if(l){const i=yield ae(r._url+"/"+l.id,["*"]);return r._makeAndAddFeatureSet(i,t,n)}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,p.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);e=null!=e?e.toString():"";for(let i=0;i<r._instantLayers.length;i++){const f=r._instantLayers[i];if(f.opitem.id===e&&f.includeGeometry===t&&f.outFields===a)return r._instantLayers[i].featureset}const s=yield r._loadMetaData();let l=null;for(const i of s.layers?s.layers:[])null!=i.id&&i.id.toString()===e&&(l=i);if(!l)for(const i of s.tables?s.tables:[])null!=i.id&&i.id.toString()===e&&(l=i);if(l){const i=yield ae(r._url+"/"+l.id,["*"]);return r._makeAndAddFeatureSet(i,t,n)}return null})()}}function Me(w,e,t=null,n=null){return new Be(w,e,t,n)}function ke(w,e,t=null,n=null){return new pe(w,e,t,n)}function Ue(w,e){return null===w?e:new Oe.Z({url:w.field("url")})}function We(w,e,t){return ye.apply(this,arguments)}function ye(){return(ye=(0,p.Z)(function*(w,e,t){if(!z.id.findCredential(w.restUrl))return null;if("loaded"===w.loadStatus&&""===e&&w.user&&w.user.sourceJSON&&!1===t)return w.user.sourceJSON;if(""===e){const r=yield(0,V.default)(w.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===t?{}:{returnUserLicenseTypeExtensions:!0}}});if(r.data){const a=r.data;if(a&&a.username)return a}return null}const n=yield(0,V.default)(w.restUrl+"/community/users/"+e,{responseType:"json",query:{f:"json"}});if(n.data){const r=n.data;return r.error?null:r}return null})).apply(this,arguments)}function Ge(w,e,t,n,r){if(null===w)return null;if(w instanceof L.default){switch(e){case"datasource":return ne(w,r,w.outFields,!0,t,n).getDataSourceFeatureSet();case"parent":case"root":return ne(w,r,w.outFields,!0,t,n)}return null}if(w instanceof T.Z)switch(e){case"datasource":return w.getDataSourceFeatureSet();case"parent":return w;case"root":return w.getRootFeatureSet()}return null}function Ke(w,e,t,n,r,a,s){return ge.apply(this,arguments)}function ge(){return(ge=(0,p.Z)(function*(w,e,t,n,r,a,s,l=null){if(q.Z.applicationCache){const f=q.Z.applicationCache.getLayerInfo(w+":"+a.url);if(f){const y=yield f;return ne(new L.default({url:(0,d.US)(y.url)+"/"+e,outFields:["*"]}),t,n,r,s,l)}}const i=new Pe.default({id:w,portal:a}).load();q.Z.applicationCache&&q.Z.applicationCache.setLayerInfo(w+":"+a.url,i);try{const f=yield i;return ne(new L.default({url:(0,d.US)(f.url??"")+"/"+e,outFields:["*"]}),t,n,r,s,l)}catch(f){throw q.Z.applicationCache&&q.Z.applicationCache.clearLayerInfo(w+":"+a.url),f}})).apply(this,arguments)}},52724:(ee,$,c)=>{c.d($,{$X:()=>d,QP:()=>C,TO:()=>u,Xx:()=>b,yN:()=>_});var p=c(15861),z=c(88879),V=c(27187),x=c(47982),O=c(49086),N=c(91510),M=c(77132),F=c(83947),I=c(62208),T=c(10410),P=c(65234);class m{constructor(h){this.field=h,this.sqlRewritable=!1}postInitialization(h,o){}}class d extends m{constructor(h){super(h),this.sqlRewritable=!0}extractValue(h){return h.attributes[this.field.name]}rewriteSql(h){return{rewritten:this.sqlRewritable,where:h}}}class C extends m{constructor(h,o,g){super((0,M.JW)(h)),this.originalField=h,this.sqlRewritable=!0,this.field.name=o,this.field.alias=g}rewriteSql(h,o){return{rewritten:this.sqlRewritable,where:(0,F.bB)(h,this.field.name,this.originalField.name,o.getFieldsIndex())}}extractValue(h){return h.attributes[this.originalField.name]}}let u=(()=>{class v extends m{constructor(o,g,D){super(o),this.codefield=g,this.lkp=D,this.reverseLkp={};for(const E in D)this.reverseLkp[D[E]]=E;this.sqlRewritable=!0}rewriteSql(o,g){const D=this.evaluateNodeToWhereClause(o.parseTree,M.Bj.Standardised,this.field.name,this.codefield instanceof T.WhereClause?(0,F.zR)(this.codefield,M.Bj.Standardised):this.codefield,o.parameters);return D.includes(v.BADNESS)?{rewritten:!1,where:o}:{rewritten:this.sqlRewritable,where:T.WhereClause.create(D,(0,I.s3)(g._parent).getFieldsIndex())}}evaluateNodeToWhereClause(o,g,D=null,E=null,S){let W,U,Z,B;switch(o.type){case"interval":return(0,F.TE)(this.evaluateNodeToWhereClause(o.value,g,D,E,S),o.qualifier,o.op);case"case-expression":{let A=" CASE ";"simple"===o.format&&(A+=this.evaluateNodeToWhereClause(o.operand,g,D,v.BADNESS,S));for(let L=0;L<o.clauses.length;L++)A+=" WHEN "+this.evaluateNodeToWhereClause(o.clauses[L].operand,g,D,v.BADNESS,S)+" THEN "+this.evaluateNodeToWhereClause(o.clauses[L].value,g,D,v.BADNESS,S);return null!==o.else&&(A+=" ELSE "+this.evaluateNodeToWhereClause(o.else,g,D,v.BADNESS,S)),A+=" END ",A}case"parameter":{const A=S[o.value.toLowerCase()];if("string"==typeof A)return"'"+S[o.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(A instanceof Date)return(0,F.oX)(A,g);if(A instanceof Array){const L=[];for(let G=0;G<A.length;G++)"string"==typeof A[G]?L.push("'"+A[G].toString().replace(/'/g,"''")+"'"):A[G]instanceof Date?L.push((0,F.oX)(A[G],g)):L.push(A[G].toString());return L}return A.toString()}case"expression-list":U=[];for(const A of o.value)U.push(this.evaluateNodeToWhereClause(A,g,D,E,S));return U;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(o.expr,g,D,v.BADNESS,S)+" ) ";case"binary-expression":switch(o.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" AND "+this.evaluateNodeToWhereClause(o.right,g,D,E,S)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" OR "+this.evaluateNodeToWhereClause(o.right,g,D,E,S)+") ";case"IS":if("null"!==o.right.type)throw new x.eS(x.f.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" IS NULL )";case"ISNOT":if("null"!==o.right.type)throw new x.eS(x.f.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" IS NOT NULL )";case"IN":if(W=[],"expression-list"===o.right.type){if("column-reference"===o.left.type&&o.left.column.toUpperCase()===this.field.name.toUpperCase()){const A=[];let L=!0;for(const G of o.right.value){if("string"!==G.type){L=!1;break}if(void 0===this.lkp[G.value]){L=!1;break}A.push(this.lkp[G.value].toString())}if(L)return" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" IN ("+A.join(",")+")) "}return W=this.evaluateNodeToWhereClause(o.right,g,D,E,S)," ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" IN ("+W.join(",")+")) "}return B=this.evaluateNodeToWhereClause(o.right,g,D,E,S),B instanceof Array?" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" IN ("+B+")) ";case"NOT IN":if(W=[],"expression-list"===o.right.type){if("column-reference"===o.left.type&&o.left.column.toUpperCase()===this.field.name.toUpperCase()){const A=[];let L=!0;for(const G of o.right.value){if("string"!==G.type){L=!1;break}if(void 0===this.lkp[G.value]){L=!1;break}A.push(this.lkp[G.value].toString())}if(L)return" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" NOT IN ("+A.join(",")+")) "}return W=this.evaluateNodeToWhereClause(o.right,g,D,E,S)," ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" NOT IN ("+W.join(",")+")) "}return B=this.evaluateNodeToWhereClause(o.right,g,D,E,S),B instanceof Array?" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" NOT IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(o.left,g,D,E,S)+" NOT IN ("+B+")) ";case"BETWEEN":return Z=this.evaluateNodeToWhereClause(o.right,g,D,v.BADNESS,S)," ("+this.evaluateNodeToWhereClause(o.left,g,D,v.BADNESS,S)+" BETWEEN "+Z[0]+" AND "+Z[1]+" ) ";case"NOTBETWEEN":return Z=this.evaluateNodeToWhereClause(o.right,g,D,v.BADNESS,S)," ("+this.evaluateNodeToWhereClause(o.left,g,D,v.BADNESS,S)+" NOT BETWEEN "+Z[0]+" AND "+Z[1]+" ) ";case"LIKE":return""!==o.escape?" ("+this.evaluateNodeToWhereClause(o.left,g,D,v.BADNESS,S)+" LIKE "+this.evaluateNodeToWhereClause(o.right,g,D,v.BADNESS,S)+" ESCAPE '"+o.escape+"') ":" ("+this.evaluateNodeToWhereClause(o.left,g,D,v.BADNESS,S)+" LIKE "+this.evaluateNodeToWhereClause(o.right,g,D,v.BADNESS,S)+") ";case"NOT LIKE":return""!==o.escape?" ("+this.evaluateNodeToWhereClause(o.left,g,D,v.BADNESS,S)+" NOT LIKE "+this.evaluateNodeToWhereClause(o.right,g,D,v.BADNESS,S)+" ESCAPE '"+o.escape+"') ":" ("+this.evaluateNodeToWhereClause(o.left,g,D,v.BADNESS,S)+" NOT LIKE "+this.evaluateNodeToWhereClause(o.right,g,D,v.BADNESS,S)+") ";case"<>":case"=":if("column-reference"===o.left.type&&"string"===o.right.type){if(o.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[o.right.value.toString()])return" ("+E+" "+o.operator+" "+this.lkp[o.right.value.toString()].toString()+") "}else if("column-reference"===o.right.type&&"string"===o.left.type&&o.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[o.right.value.toString()].toString()+" "+o.operator+" "+E+") ";return" ("+this.evaluateNodeToWhereClause(o.left,g,D,v.BADNESS,S)+" "+o.operator+" "+this.evaluateNodeToWhereClause(o.right,g,D,v.BADNESS,S)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(o.left,g,D,v.BADNESS,S)+" "+o.operator+" "+this.evaluateNodeToWhereClause(o.right,g,D,v.BADNESS,S)+") "}case"null":return"null";case"boolean":return!0===o.value?"1":"0";case"string":return"'"+o.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,F.oX)(o.value,g);case"number":return o.value.toString();case"current-time":return(0,F.vR)("date"===o.mode,g);case"column-reference":return D&&D.toLowerCase()===o.column.toLowerCase()?"("+E+")":o.column;case"function":{const A=this.evaluateNodeToWhereClause(o.args,g,D,v.BADNESS,S);return(0,F.fz)(o.name,A,g)}}throw new x.eS(x.f.UnsupportedSyntax,{node:o.type})}extractValue(o){return this.codefield instanceof T.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(o)]:this.reverseLkp[o.attributes[this.codefield]]}}return v.BADNESS="_!!!_BAD_LKP_!!!!",v})();class _ extends m{constructor(h,o){super(h),this._sql=o}rewriteSql(h,o){return{rewritten:!0,where:(0,F.bB)(h,this.field.name,(0,F.zR)(this._sql,M.Bj.Standardised),o.getFieldsIndex())}}extractValue(h){return this._sql.calculateValueCompiled(h)}}class b extends O.Z{constructor(h){super(h),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=[],this._extraFilter=null,this._extraFilter=h.extraFilter,this._parent=h.parentfeatureset,this._maxProcessing=30,this.adaptedFields=h.adaptedFields}static findField(h,o){for(const g of h)if(g.name.toLowerCase()===o.toString().toLowerCase())return g;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new P.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=M.Qk.point,this.typeIdField="",this.types=null),this.fields=[];for(const h of this.adaptedFields)h.postInitialization(this,this._parent),this.fields.push(h.field)}_getSet(h){var o=this;return(0,p.Z)(function*(){if(null===o._wset){yield o._ensureLoaded();let g=null;return g=o._extraFilter?yield o._getFilteredSet("",null,null,null,h):yield o._parent?._getSet(h),o._checkCancelled(h),(0,I.O3)(g),o._wset=new N.Z(g._candidates.slice(0),g._known.slice(0),g._ordered,o._clonePageDefinition(g.pagesDefinition)),o._wset}return o._wset})()}_isInFeatureSet(h){return(0,I.s3)(this._parent)._isInFeatureSet(h)}_getFeatures(h,o,g,D){var E=this;return(0,p.Z)(function*(){const S=[];-1!==o&&void 0===E._featureCache[o]&&S.push(o);const W=E._maxQueryRate();if(!0===E._checkIfNeedToExpandKnownPage(h,W))return yield E._expandPagedSet(h,W,0,0,D),E._getFeatures(h,o,g,D);let U=0;for(let A=h._lastFetchedIndex;A<h._known.length&&(U++,U<=g&&(h._lastFetchedIndex+=1),!(void 0===E._featureCache[h._known[A]]&&(h._known[A]!==o&&S.push(h._known[A]),S.length>=W)));A++);if(0===S.length)return"success";h=new N.Z([],S,h._ordered,null);const Z=Math.min(S.length,g);yield E._parent?._getFeatures(h,-1,Z,D),E._checkCancelled(D);const B=[];for(let A=0;A<Z;A++){const L=E._parent?._featureFromCache(S[A]);void 0!==L&&B.push({geometry:L.geometry,attributes:L.attributes,id:S[A]})}for(const A of B){const L=[];for(const G of E.adaptedFields)L[G.field.name]=G.extractValue(A);E._featureCache[A.id]=new z.Z({attributes:L,geometry:(0,V.r1)(A.geometry)})}return"success"})()}_fetchAndRefineFeatures(){return(0,p.Z)(function*(){throw new x.EN(x.H9.NeverReach)})()}_getFilteredSet(h,o,g,D,E){var S=this;return(0,p.Z)(function*(){let W=!1;const U=S._reformulateWithoutAdaptions(g);W=U.cannot,g=U.where;let Z=!1;if(null!==D){Z=!0;const L=[];for(const G of S.adaptedFields)if(!(G instanceof d)&&!0===D.scanForField(G.field.name)){if(!(G instanceof C)){D=null,Z=!1;break}L.push({field:G.field.name,newfield:G.originalField.name})}D&&L.length>0&&(D=D.replaceFields(L))}null!==g?null!==S._extraFilter&&(g=(0,F.$e)(S._extraFilter,g)):g=S._extraFilter,yield S._ensureLoaded();const B=yield(0,I.s3)(S._parent)._getFilteredSet(h,o,g,D,E);let A;return S._checkCancelled(E),A=!0===W?new N.Z(B._candidates.slice(0).concat(B._known.slice(0)),[],!0===Z&&B._ordered,S._clonePageDefinition(B.pagesDefinition)):new N.Z(B._candidates.slice(0),B._known.slice(0),!0===Z&&B._ordered,S._clonePageDefinition(B.pagesDefinition)),A})()}_reformulateWithoutAdaptions(h){const o={cannot:!1,where:h};if(null!==h)for(const g of this.adaptedFields)if(!0===(0,F.hq)(h,g.field.name)){const D=g.rewriteSql(h,this);if(!0!==D.rewritten){o.cannot=!0,o.where=null;break}o.where=D.where}return o}_stat(h,o,g,D,E,S,W){var U=this;return(0,p.Z)(function*(){let Z=!1,B=U._reformulateWithoutAdaptions(o);if(Z=B.cannot,o=B.where,B=U._reformulateWithoutAdaptions(E),Z=Z||B.cannot,null!==(E=B.where)?null!==U._extraFilter&&(E=(0,F.$e)(U._extraFilter,E)):E=U._extraFilter,!0===Z)return null===E&&""===g&&null===D?U._manualStat(h,o,S,W):{calculated:!1};const A=yield(0,I.s3)(U._parent)._stat(h,o,g,D,E,S,W);return!1===A.calculated?null===E&&""===g&&null===D?U._manualStat(h,o,S,W):{calculated:!1}:A})()}_canDoAggregates(h,o,g,D,E){var S=this;return(0,p.Z)(function*(){if(null===S._parent)return!1;for(let Z=0;Z<h.length;Z++)for(const B of S.adaptedFields)if(h[Z].toLowerCase()===B.field.name.toLowerCase()&&!(B instanceof d))return!1;const W=[];for(let Z=0;Z<o.length;Z++){const B=o[Z];if(null!==B.workingexpr){const A=S._reformulateWithoutAdaptions(B.workingexpr);if(A.cannot)return!1;const L=B.clone();L.workingexpr=A.where,W.push(L)}else W.push(B)}const U=S._reformulateWithoutAdaptions(E);return!U.cannot&&(null!==(E=U.where)?null!==S._extraFilter&&(E=(0,F.$e)(S._extraFilter,E)):E=S._extraFilter,S._parent._canDoAggregates(h,W,g,D,E))})()}_getAggregatePagesDataSourceDefinition(h,o,g,D,E,S,W){var U=this;return(0,p.Z)(function*(){if(null===U._parent)throw new x.EN(x.H9.NeverReach);const Z=[];for(let A=0;A<o.length;A++){const L=o[A];if(null!==L.workingexpr){const G=U._reformulateWithoutAdaptions(L.workingexpr);if(G.cannot)throw new x.EN(x.H9.NeverReach);const Y=L.clone();Y.workingexpr=G.where,Z.push(Y)}else Z.push(L)}const B=U._reformulateWithoutAdaptions(E);if(B.cannot)throw new x.EN(x.H9.NeverReach);return null!==(E=B.where)?null!==U._extraFilter&&(E=(0,F.$e)(U._extraFilter,E)):E=U._extraFilter,U._parent._getAggregatePagesDataSourceDefinition(h,Z,g,D,E,S,W)})()}}},53997:(ee,$,c)=>{c.d($,{Z:()=>T});var p=c(15861),z=c(47982),V=c(49086),x=c(91510),O=c(77132),N=c(83947),M=c(10699),F=c(10410),I=c(65234);class T extends V.Z{constructor(m){super(m),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=m.parentfeatureset,m.whereclause instanceof F.WhereClause?(this._whereclause=m.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=m.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new I.Z({wkid:4326}),this.geometryType=O.Qk.point)}_getSet(m){var d=this;return(0,p.Z)(function*(){if(null===d._wset){yield d._ensureLoaded();const C=yield d._parent._getFilteredSet("",null,d._whereclause,null,m);return d._checkCancelled(m),d._wset=null!==d._whereClauseFunction?new x.Z(C._candidates.slice(0).concat(C._known.slice(0)),[],C._ordered,d._clonePageDefinition(C.pagesDefinition)):new x.Z(C._candidates.slice(0),C._known.slice(0),C._ordered,d._clonePageDefinition(C.pagesDefinition)),d._wset}return d._wset})()}_isInFeatureSet(m){let d=this._parent?._isInFeatureSet(m);return d===O.dj.NotInFeatureSet?d:(d=this._idstates[m],void 0===d?O.dj.Unknown:d)}_getFeature(m,d,C){return this._parent._getFeature(m,d,C)}_getFeatures(m,d,C,u){return this._parent._getFeatures(m,d,C,u)}_featureFromCache(m){return this._parent._featureFromCache(m)}executeWhereClause(m){return this._whereclause?.testFeature(m)??!1}executeWhereClauseDeferred(m){var d=this;return(0,p.Z)(function*(){if(null!==d._whereClauseFunction){const C=d._whereClauseFunction(m);return(0,M.y8)(C),C}return d.executeWhereClause(m)})()}_fetchAndRefineFeatures(m,d,C){var u=this;return(0,p.Z)(function*(){const _=new x.Z([],m,!1,null),b=Math.min(d,m.length);if(yield u._parent?._getFeatures(_,-1,b,C),u._checkCancelled(C),null==u._whereClauseFunction){for(let h=0;h<b;h++){const o=u._parent?._featureFromCache(m[h]);u._idstates[m[h]]=!0===u.executeWhereClause(o)?O.dj.InFeatureSet:O.dj.NotInFeatureSet}return"success"}const v=[];for(let h=0;h<b;h++){const o=u._parent?._featureFromCache(m[h]);v.push(yield u.executeWhereClauseDeferred(o))}for(let h=0;h<d;h++)u._idstates[m[h]]=!0===v[h]?O.dj.InFeatureSet:O.dj.NotInFeatureSet;return"success"})()}_getFilteredSet(m,d,C,u,_){var b=this;return(0,p.Z)(function*(){null!==b._whereClauseFunction||(null!==C?null!==b._whereclause&&(C=(0,N.$e)(b._whereclause,C)):C=b._whereclause),yield b._ensureLoaded();const v=yield b._parent._getFilteredSet(m,d,C,u,_);let h;return b._checkCancelled(_),h=null!==b._whereClauseFunction?new x.Z(v._candidates.slice(0).concat(v._known.slice(0)),[],v._ordered,b._clonePageDefinition(v.pagesDefinition)):new x.Z(v._candidates.slice(0),v._known.slice(0),v._ordered,b._clonePageDefinition(v.pagesDefinition)),h})()}_stat(m,d,C,u,_,b,v){var h=this;return(0,p.Z)(function*(){if(null!==h._whereClauseFunction)return null===_&&""===C&&null===u?h._manualStat(m,d,b,v):{calculated:!1};let o=h._whereclause;null!==_&&null!==h._whereclause&&(o=(0,N.$e)(h._whereclause,_));const g=yield h._parent._stat(m,d,C,u,o,b,v);return!1===g.calculated?null===_&&""===C&&null===u?h._manualStat(m,d,b,v):{calculated:!1}:g})()}_canDoAggregates(m,d,C,u,_){var b=this;return(0,p.Z)(function*(){return null===b._whereClauseFunction&&(null!==_?null!==b._whereclause&&(_=(0,N.$e)(b._whereclause,_)):_=b._whereclause,null!==b._parent&&b._parent._canDoAggregates(m,d,C,u,_))})()}_getAggregatePagesDataSourceDefinition(m,d,C,u,_,b,v){var h=this;return(0,p.Z)(function*(){if(null===h._parent)throw new z.EN(z.H9.NeverReach);return null!==_?null!==h._whereclause&&(_=(0,N.$e)(h._whereclause,_)):_=h._whereclause,h._parent._getAggregatePagesDataSourceDefinition(m,d,C,u,_,b,v)})()}static registerAction(){V.Z._featuresetFunctions.filter=function(m){if("function"==typeof m)return new T({parentfeatureset:this,whereclause:m});let d=null;return m instanceof F.WhereClause&&(d=m),new T({parentfeatureset:this,whereclause:d})}}}},95896:(ee,$,c)=>{c.d($,{Z:()=>M});var p=c(15861),z=c(47562),V=c(47982),x=c(49086),O=c(91510),N=c(57366);class M extends x.Z{constructor(I){super(I),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=I.orderbyclause,this._parent=I.parentfeatureset}_getSet(I){var T=this;return(0,p.Z)(function*(){if(null===T._wset){yield T._ensureLoaded();const P=yield T._getFilteredSet("",null,null,T._orderbyclause,I);return T._checkCancelled(I),T._wset=P,T._wset}return T._wset})()}manualOrderSet(I,T){var P=this;return(0,p.Z)(function*(){const m=yield P.getIdColumnDictionary(I,[],-1,T);P._orderbyclause?.order(m);const d=new O.Z([],[],!0,null);for(let C=0;C<m.length;C++)d._known.push(m[C].id);return d})()}getIdColumnDictionary(I,T,P,m){var d=this;return(0,p.Z)(function*(){if(P<I._known.length-1){const C=d._maxQueryRate();if("GETPAGES"===I._known[P+1])return yield(0,z.W)(d._parent._expandPagedSet(I,C,0,0,m)),d.getIdColumnDictionary(I,T,P,m);let u=P+1;const _=[];for(;u<I._known.length&&"GETPAGES"!==I._known[u];)_.push(I._known[u]),u++;P+=_.length;const b=yield(0,z.W)(d._parent._getFeatureBatch(_,m));d._checkCancelled(m);for(const v of b)T.push({id:v.attributes[d.objectIdField],feature:v});return d.getIdColumnDictionary(I,T,P,m)}return I._candidates.length>0?(yield(0,z.W)(d._refineSetBlock(I,d._maxProcessingRate(),m)),d._checkCancelled(m),d.getIdColumnDictionary(I,T,P,m)):T})()}_isInFeatureSet(I){return this._parent._isInFeatureSet(I)}_getFeatures(I,T,P,m){return this._parent._getFeatures(I,T,P,m)}_featureFromCache(I){if(void 0===this._featureCache[I]){const T=this._parent._featureFromCache(I);return void 0===T?void 0:null===T?null:(this._featureCache[I]=T,T)}return this._featureCache[I]}_fetchAndRefineFeatures(){return(0,p.Z)(function*(){throw new V.EN(V.H9.NeverReach)})()}_getFilteredSet(I,T,P,m,d){var C=this;return(0,p.Z)(function*(){yield C._ensureLoaded();const u=yield C._parent._getFilteredSet(I,T,P,null===m?C._orderbyclause:m,d);C._checkCancelled(d);const _=new O.Z(u._candidates.slice(0),u._known.slice(0),u._ordered,C._clonePageDefinition(u.pagesDefinition));let b=!0;if(u._candidates.length>0&&(b=!1),!1===_._ordered){let v=yield C.manualOrderSet(_,d);return!1===b&&(null===T&&null===P||(v=new O.Z(v._candidates.slice(0).concat(v._known.slice(0)),[],v._ordered,C._clonePageDefinition(v.pagesDefinition)))),v}return _})()}static registerAction(){x.Z._featuresetFunctions.orderBy=function(I){return""===I?this:new M({parentfeatureset:this,orderbyclause:new N.Z(I)})}}}},79429:(ee,$,c)=>{c.d($,{Z:()=>N});var p=c(15861),z=c(47982),V=c(49086),x=c(91510),O=c(77132);class N extends V.Z{constructor(F){super(F),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=F.topnum,this._parent=F.parentfeatureset}_getSet(F){var I=this;return(0,p.Z)(function*(){if(null===I._wset){yield I._ensureLoaded();const T=yield I._parent._getSet(F);return I._wset=new x.Z(T._candidates.slice(0),T._known.slice(0),!1,I._clonePageDefinition(T.pagesDefinition)),I._setKnownLength(I._wset)>I._topnum&&(I._wset._known=I._wset._known.slice(0,I._topnum)),I._setKnownLength(I._wset)>=I._topnum&&(I._wset._candidates=[]),I._wset}return I._wset})()}_setKnownLength(F){return F._known.length>0&&"GETPAGES"===F._known[F._known.length-1]?F._known.length-1:F._known.length}_isInFeatureSet(F){const I=this._parent._isInFeatureSet(F);if(I===O.dj.NotInFeatureSet)return I;const T=this._idstates[F];return T===O.dj.InFeatureSet||T===O.dj.NotInFeatureSet?T:I===O.dj.InFeatureSet&&void 0===T?this._countedin<this._topnum?(this._idstates[F]=O.dj.InFeatureSet,this._countedin++,O.dj.InFeatureSet):(this._idstates[F]=O.dj.NotInFeatureSet,O.dj.NotInFeatureSet):O.dj.Unknown}_expandPagedSet(F,I,T,P,m){var d=this;return(0,p.Z)(function*(){if(null===d._parent)throw new z.EN(z.H9.NotImplemented);if(I>d._topnum&&(I=d._topnum),d._countedin>=d._topnum&&F.pagesDefinition.internal.set.length<=F.pagesDefinition.resultOffset){let u=F._known.length;return u>0&&"GETPAGES"===F._known[u-1]&&(F._known.length=u-1),u=F._candidates.length,u>0&&"GETPAGES"===F._candidates[u-1]&&(F._candidates.length=u-1),"success"}const C=yield d._parent._expandPagedSet(F,I,T,P,m);return d._setKnownLength(F)>d._topnum&&(F._known.length=d._topnum),d._setKnownLength(F)>=d._topnum&&(F._candidates.length=0),C})()}_getFeatures(F,I,T,P){var m=this;return(0,p.Z)(function*(){const d=[],C=m._maxQueryRate();if(!0===m._checkIfNeedToExpandKnownPage(F,C))return yield m._expandPagedSet(F,C,0,0,P),m._getFeatures(F,I,T,P);-1!==I&&void 0===m._featureCache[I]&&d.push(I);let u=0;for(let v=F._lastFetchedIndex;v<F._known.length&&(u++,u<=T&&(F._lastFetchedIndex+=1),!(void 0===m._featureCache[F._known[v]]&&(F._known[v]!==I&&d.push(F._known[v]),d.length>C)));v++);if(0===d.length)return"success";const _=new x.Z([],d,!1,null),b=Math.min(d.length,T);yield m._parent._getFeatures(_,-1,b,P);for(let v=0;v<b;v++){const h=m._parent._featureFromCache(d[v]);void 0!==h&&(m._featureCache[d[v]]=h)}return"success"})()}_getFilteredSet(F,I,T,P,m){var d=this;return(0,p.Z)(function*(){yield d._ensureLoaded();const C=yield d._getSet(m);return new x.Z(C._candidates.slice(0).concat(C._known.slice(0)),[],!1,d._clonePageDefinition(C.pagesDefinition))})()}_refineKnowns(F,I){let T=0,P=null;const m=[];for(let d=0;d<F._candidates.length;d++){const C=this._isInFeatureSet(F._candidates[d]);if(C===O.dj.InFeatureSet){if(F._known.push(F._candidates[d]),T+=1,null===P?P={start:d,end:d}:P.end===d-1?P.end=d:(m.push(P),P={start:d,end:d}),F._known.length>=this._topnum)break}else if(C===O.dj.NotInFeatureSet)null===P?P={start:d,end:d}:P.end===d-1?P.end=d:(m.push(P),P={start:d,end:d}),T+=1;else if(C===O.dj.Unknown)break;if(T>=I)break}null!==P&&m.push(P);for(let d=m.length-1;d>=0;d--)F._candidates.splice(m[d].start,m[d].end-m[d].start+1);this._setKnownLength(F)>this._topnum&&(F._known=F._known.slice(0,this._topnum)),this._setKnownLength(F)>=this._topnum&&(F._candidates=[])}_stat(){return(0,p.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,p.Z)(function*(){return!1})()}static registerAction(){V.Z._featuresetFunctions.top=function(F){return new N({parentfeatureset:this,topnum:F})}}}},16776:(ee,$,c)=>{c.d($,{Z:()=>d});var p=c(15861),z=c(88879),V=c(47982),x=c(49086),O=c(91510),N=c(77132),M=c(83947),F=c(21674),I=c(80415),T=c(41638),P=c(36255),m=c(96854);class d extends x.Z{constructor(u){super(u),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,u.spatialReference&&(this.spatialReference=u.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=u.layer,this._wset=null,!0===u.isTable&&(this._forceIsTable=!0),void 0!==u.outFields&&(this._overrideFields=u.outFields),void 0!==u.includeGeometry&&(this._removeGeometry=!1===u.includeGeometry)}_maxQueryRate(){return N.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var u=this;return(0,p.Z)(function*(){return!0===u._layer.loaded?(u._initialiseFeatureSet(),u):(yield u._layer.load(),u._initialiseFeatureSet(),u)})()}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const u=[];for(const _ of this.fields)if("oid"===_.type)u.push(_);else for(const b of this._layer.outFields)if(b.toLowerCase()===_.name.toLowerCase()){u.push(_);break}this.fields=u}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const u=[],_=[];for(const b of this.fields)if("oid"===b.type)u.push(b),_.push(b.name);else for(const v of this._overrideFields)if(v.toLowerCase()===b.name.toLowerCase()){u.push(b),_.push(b.name);break}this.fields=u,this._overrideFields=_}this.objectIdField=this._layer.objectIdField;for(const u of this.fields)"global-id"===u.type&&(this.globalIdField=u.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=N.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return N.dj.InFeatureSet}_candidateIdTransform(u){return u}_getSet(u){var _=this;return(0,p.Z)(function*(){if(null===_._wset){yield _._ensureLoaded();const b=yield _._getFilteredSet("",null,null,null,u);return _._wset=b,b}return _._wset})()}_changeFeature(u){const _={};for(const b of this.fields)_[b.name]=u.attributes[b.name];return new z.Z({geometry:!0===this._removeGeometry?null:u.geometry,attributes:_})}_getFilteredSet(u,_,b,v,h){var o=this;return(0,p.Z)(function*(){let g="",D=!1;if(null!==v&&(g=v.constructClause(),D=!0),o.isTable()&&_&&null!==u&&""!==u)return new O.Z([],[],!0,null);const E=new m.Z;E.where=null===b?null===_?"1=1":"":(0,M.zR)(b,N.Bj.Standardised),E.spatialRelationship=o._makeRelationshipEnum(u),E.outSpatialReference=o.spatialReference,E.orderByFields=""!==g?g.split(","):null,E.geometry=null===_?null:_,E.returnGeometry=!0,E.relationParameter=o._makeRelationshipParam(u);const S=yield o._layer.queryFeatures(E);if(null===S)return new O.Z([],[],D,null);o._checkCancelled(h);const W=[];return S.features.forEach(U=>{const Z=U.attributes[o._layer.objectIdField];W.push(Z),o._featureCache[Z]=o._changeFeature(U)}),new O.Z([],W,D,null)})()}_makeRelationshipEnum(u){if(u.includes("esriSpatialRelRelation"))return"relation";switch(u){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return u}_makeRelationshipParam(u){return u.includes("esriSpatialRelRelation")?u.split(":")[1]:""}_queryAllFeatures(){var u=this;return(0,p.Z)(function*(){if(u._wset)return u._wset;const _=new m.Z;if(_.where="1=1",yield u._ensureLoaded(),u._layer.source&&u._layer.source.items){const h=[];return u._layer.source.items.forEach(o=>{const g=o.attributes[u._layer.objectIdField];h.push(g),u._featureCache[g]=u._changeFeature(o)}),u._wset=new O.Z([],h,!1,null),u._wset}const b=yield u._layer.queryFeatures(_),v=[];return b.features.forEach(h=>{const o=h.attributes[u._layer.objectIdField];v.push(o),u._featureCache[o]=u._changeFeature(h)}),u._wset=new O.Z([],v,!1,null),u._wset})()}_getFeatures(u,_,b){var v=this;return(0,p.Z)(function*(){const h=[];-1!==_&&void 0===v._featureCache[_]&&h.push(_);for(let o=u._lastFetchedIndex;o<u._known.length&&(u._lastFetchedIndex+=1,!(void 0===v._featureCache[u._known[o]]&&(u._known[o]!==_&&h.push(u._known[o]),h.length>b)));o++);if(0===h.length)return"success";throw new V.EN(V.H9.MissingFeatures)})()}_refineSetBlock(u){return(0,p.Z)(function*(){return u})()}_stat(){return(0,p.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,p.Z)(function*(){return!1})()}relationshipMetaData(){return[]}static _cloneAttr(u){const _={};for(const b in u)_[b]=u[b];return _}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(u,_){let b=u.layerDefinition.objectIdField;const v=u.layerDefinition.typeIdField?u.layerDefinition.typeIdField:"",h=[];if(u.layerDefinition.types)for(const Z of u.layerDefinition.types)h.push(T.Z.fromJSON(Z));let o=u.layerDefinition.geometryType;void 0===o&&(o=u.featureSet.geometryType||"");let g=u.featureSet.features;const D=_.toJSON();if(""===b||void 0===b){let Z=!1;for(const B of u.layerDefinition.fields)if("oid"===B.type||"esriFieldTypeOID"===B.type){b=B.name,Z=!0;break}if(!1===Z){let B="FID",A=!0,L=0;for(;A;){let Y=!0;for(const me of u.layerDefinition.fields)if(me.name===B){Y=!1;break}!0===Y?A=!1:(L++,B="FID"+L.toString())}u.layerDefinition.fields.push({type:"esriFieldTypeOID",name:B,alias:B});const G=[];for(let Y=0;Y<g.length;Y++)G.push({geometry:u.featureSet.features[Y].geometry,attributes:u.featureSet.features[Y].attributes?this._cloneAttr(u.featureSet.features[Y].attributes):{}}),G[Y].attributes[B]=Y;g=G,b=B}}const E=[];for(const Z of u.layerDefinition.fields)E.push(Z instanceof P.Z?Z:P.Z.fromJSON(Z));let S=o;switch(S){case"esriGeometryPoint":S="point";break;case"esriGeometryPolyline":S="polyline";break;case"esriGeometryPolygon":S="polygon";break;case"esriGeometryExtent":S="extent";break;case"esriGeometryMultipoint":S="multipoint"}for(const Z of g)Z.geometry&&!(Z.geometry instanceof F.Z)&&(Z.geometry.type=S,void 0===Z.geometry.spatialReference&&(Z.geometry.spatialReference=D));const W={outFields:["*"],source:g,fields:E,types:h,typeIdField:v,objectIdField:b,spatialReference:_};W.geometryType=S||"point";const U=new I.default(W);return new d({layer:U,spatialReference:_,isTable:null===S||""===S})}queryAttachments(){return(0,p.Z)(function*(){return[]})()}getFeatureByObjectId(u){var _=this;return(0,p.Z)(function*(){const b=new m.Z;b.where=_.objectIdField+"="+u.toString();const v=yield _._layer.queryFeatures(b);return 1===v.features.length?v.features[0]:null})()}getOwningSystemUrl(){return(0,p.Z)(function*(){return""})()}getIdentityUser(){return(0,p.Z)(function*(){return""})()}}},57366:(ee,$,c)=>{function p(V,x){return V===x?0:null===V?-1:null===x?1:V<x?-1:1}c.d($,{Z:()=>z});class z{constructor(x){const O=x.split(",");this._fields=[],this._directions=[];for(let N=0;N<O.length;N++){const M=O[N].match(/\S+/g);this._fields.push(M[0]),2===M.length?"asc"===M[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let x="";for(let O=0;O<this._fields.length;O++)0!==O&&(x+=","),x+=this._fields[O],x+=1===this._directions[O]?" ASC":" DESC";return x}order(x){x.sort((O,N)=>{for(let M=0;M<this._fields.length;M++){const F=this.featureValue(O.feature,this._fields[M],M),I=this.featureValue(N.feature,this._fields[M],M);let T=0;if(T=1===this._directions[M]?p(F,I):-1*p(F,I),0!==T)return T}return 0})}scanForField(x){for(let O=0;O<this._fields.length;O++)if(this._fields[O].toLowerCase().trim()===x.toLowerCase().trim())return!0;return!1}replaceFields(x){let O="";for(let N=0;N<this._fields.length;N++){0!==N&&(O+=",");let M=this._fields[N];for(const F of x)if(M.toLowerCase()===F.field.toLowerCase()){M=F.newfield;break}O+=M,O+=1===this._directions[N]?" ASC":" DESC"}return new z(O)}featureValue(x,O,N){const M=x.attributes[O];if(void 0!==M)return M;for(const F in x.attributes)if(O.toLowerCase()===F.toLowerCase())return this._fields[N]=F,x.attributes[F];return null}}},90463:(ee,$,c)=>{c.d($,{P:()=>O});var p=c(15861),z=c(2618),V=c(20477),x=c(96854);function O(M,F,I){return N.apply(this,arguments)}function N(){return(N=(0,p.Z)(function*(M,F,I){const T=(0,z.en)(M);return(0,V.executeQueryForCount)(T,x.Z.from(F),{...I}).then(P=>P.data.count)})).apply(this,arguments)}},24865:(ee,$,c)=>{c.d($,{G:()=>O});var p=c(15861),z=c(2618),V=c(20477),x=c(96854);function O(M,F,I){return N.apply(this,arguments)}function N(){return(N=(0,p.Z)(function*(M,F,I){const T=(0,z.en)(M);return(0,V.executeQueryForIds)(T,x.Z.from(F),{...I}).then(P=>P.data.objectIds)})).apply(this,arguments)}}}]);