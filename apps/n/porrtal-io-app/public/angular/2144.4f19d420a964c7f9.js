"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[2144,6446],{66607:(le,Z,l)=>{l.d(Z,{Z:()=>ut});var D=l(17626),E=l(14517),y=l(72392),b=l(8314),w=l(63290),a=l(62208),O=l(77029),W=l(60330),m=l(10699),R=l(32917),g=l(77712),Q=l(85931),re=(l(90912),l(76898)),q=l(55915),ne=l(65401),te=l(38114),ae=l(41291),he=l(59617),ue=l(87091);class ce{constructor(e){this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=e.registerTask(ue.T8.I3S_CONTROLLER,this)}destroy(){this.handle=(0,a.hw)(this.handle)}get running(){for(const e of this.callbacks)if(e.needsUpdate())return!0;return!1}runTask(e){this._sort();const t=this.callbacks,s={numIndexLoading:0,numNodesLoading:0};for(let r=0;r<t.length&&!e.done;++r)t[r].priority=t[r].update(e,s),this.runIndex=r}_sort(){const e=this.callbacks;let t=e.length;for(let s=this.runIndex;s>0;s--){const r=e[s-1];let n=s;for(;n<e.length&&r.priority<=e[n].priority&&(n!==t||r.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=r,t=n-1}this.runIndex=0}add(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e)}remove(e){(0,Q.e$)(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort()}}const oe=new Map;function ye(i,e){let t=oe.get(i);return null==t&&(t=new ce(i),oe.set(i,t)),t.add(e),{remove:()=>{null!=t&&(t.remove(e),t.callbacks.length>0||(oe.delete(i),t.destroy()),t=null)}}}var L=l(84161),me=l(4794),u=l(52565),f=l(42964),V=l(93394);class c{constructor(e,t,s,r,n){this.childOffset=e,this.childCount=t,this.visibilityCache=s,this.ref=r,this.node=n,this.useAsHole=0,this.filterImpact=u.U_.NotChecked}}class h{constructor(e,t,s,r,n,d,o,p,M,j,v,I,$,x){this._streamDataController=s,this._viewportQueries=r,this._logger=n,this.holeFilling=d,this._isLoaded=o,this._isReloading=p,this._isSelected=M,this._enable=j,this._needsUpdate=v,this._canRequest=I,this._computeVisibilityObb=$,this._computeNodeFiltering=x,this._dirty=!0,this._nodePages=[],this._nodeCount=0,this._nodesPerPage=0,this._rootIndex=0,this._lodMetric=u.w5.None,this._lodConversion=z=>z,this._urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=F(0),this._visibilityCacheVersion=F(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new O.Z({deallocator:null}),this._prefetch=new O.Z({deallocator:null}),this._updates=new N(this._missing),this._imModificationUncategorized=new O.Z({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=[],this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._logLayer=e,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this._lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(t)}_init(e){if("page"===e.type){switch(this._urlPrefix=e.urlPrefix,this._nodesPerPage=e.pageSize,this._rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this._lodMetric=u.w5.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=u.w5.MaxScreenThreshold,this._lodConversion=ge}this._addPage(G(this._rootIndex,this._nodesPerPage),e.rootPage),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this._makeRefNode(new u.$i(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this._addNode(t,0)}}_loadPage(e){this._loading.add(e),this._streamDataController.request(this._urlPrefix+e,"json").then(s=>{this._pageQueue.push({pageIndex:e,page:s})}).catch(s=>{this._loading.delete(e),(0,m.D_)(s)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._logLayer,`Error when loading page ${e}`,s))})}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:s}=this._pageQueue.shift();this._addPage(t,s),this._loading.delete(t),e.madeProgress()}this._updateParentsAndLevel()}_addPage(e,t){for(let d=this._nodePages.length;d<e;d++)this._nodePages[d]=null;const s=[],r=[],n=t.nodes.map((d,o)=>{const p=s.length,M=d.children?d.children.length:0;r.push(-1);for(let H=0;H<M;H++)s.push(d.children[H]);const j=`${d.index}`,v=(0,V.d9)(d.obb),I=(0,me.b)([v.center[0],v.center[1],v.center[2],(0,L.l)(v.halfSize)]),$=d.mesh&&d.mesh.attribute,x=d.mesh&&d.mesh.geometry,z=d.mesh&&d.mesh.material,T=new u.NB(j,e*this._nodesPerPage+o,I,M,0,{hasSharedResource:!1,hasFeatureData:!!x,attributes:$&&null!=$.resource?`${$.resource}`:null,geometry:x&&null!=x.resource?`${x.resource}`:null,texture:z&&null!=z.resource?`${z.resource}`:null,geometryDefinition:x?x.definition:-1,materialDefinition:z?z.definition:-1},this._lastUpdate,this._lodMetric,this._lodConversion(d.lodThreshold),x?x.featureCount:null);return T.serviceObb=v,T.visibilityObb=this._computeVisibilityObb(T),T.vertexCount=x?x.vertexCount:0,new c(p,M,P(this._visibilityCacheVersion),null,T)});this._nodePages[e]={nodes:n,children:s,parents:r},this._nodeCount+=n.length}_updateParentsAndLevel(){const e=new Array,t=(s,r,n)=>{const d=this._getPage(s);if((0,a.pC)(d)){const o=S(s,this._nodesPerPage);d.parents[o]=r;const p=d.nodes[o].node;(0,a.pC)(p)&&(p.level=n,e.push(s))}};for(t(this._rootIndex,-1,0);e.length;){const s=e.pop(),r=this.getNode(s);if((0,a.pC)(r))for(let n=0;n<r.childCount;n++)t(this.getChildIndex(r.index,n),s,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}_getPage(e){return this._nodePages[G(e,this._nodesPerPage)]}_getNodeInternal(e){const t=this._getPage(e);return(0,a.Wi)(t)?null:t.nodes[S(e,this._nodesPerPage)]}_addNode(e,t){null!=e.children&&this.populateChildren(t,e.children);const s=this.getParent(t),r=(0,a.pC)(s)?s.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);const{lodMetric:n,maxError:d}=function Y(i){if(i)for(let e=0;e<i.length;e++)for(const t of k)if(t[0]===i[e].metricType)return{lodMetric:t[1],maxError:i[e].maxError};return{lodMetric:u.w5.None,maxError:0}}(e.lodSelection),o=(0,a.Wg)(this._getNodeInternal(t));return o.node=new u.NB(e.id,t,(0,me.b)(e.mbs),o.childCount,r,e.resources,e.version,n,d,e.numFeatures),e.obb&&(o.node.serviceObb=(0,V.d9)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),(0,a.pC)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}_makeRefNode(e,t){const s=this._nodePages[0],r=s.nodes.length;return s.nodes.push(new c(0,0,P(this._visibilityCacheVersion),e,null)),this._nodeCount++,s.parents.push(t),(0,f.WD)(e.renderMbs),(0,f.VL)(e.serviceObbInRenderSR),r}populateChildren(e,t){const s=(0,a.Wg)(this._getNodeInternal(e)),r=(0,a.Wg)(this._getPage(e));s.childOffset=r.children.length,s.childCount=t.length;for(let n=0;n<t.length;n++){const d=this._makeRefNode(t[n],e);r.children.push(d)}}getNode(e){const t=this._getNodeInternal(e);return(0,a.pC)(t)?t.node:null}getIndexById(e){let t;return this._forAllNodes((s,r)=>{((0,a.pC)(s.node)&&s.node.id===e||(0,a.pC)(s.ref)&&s.ref.id===e)&&(t=r)}),t}getNodeById(e){const t=this.getIndexById(e);return t>=0?this.getNode(t):null}getChildIndex(e,t){const s=this._getPage(e);if((0,a.Wi)(s))return-1;const r=s.nodes[S(e,this._nodesPerPage)];return s.children[r.childOffset+t]}getParentIndex(e){const t=this._getPage(e);return(0,a.pC)(t)?t.parents[S(e,this._nodesPerPage)]:-1}getParent(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}isLeaf(e){const t=this._getNodeInternal(e);return(0,a.pC)(t)&&0===t.childCount}get rootNode(){return this.getNode(this._rootIndex)}get size(){return this._nodeCount}removeAllGeometryObbs(){this._forAllNodes(e=>{(0,a.pC)(e.node)&&(e.node.geometryObb=null)})}invalidateVisibilityCache(){this._visibilityCacheVersion=F(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(e){const t=this._getNodeInternal(e);(0,a.pC)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=P(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(e){const t=this._getNodeInternal(e);(0,a.pC)(t)&&(C(t),this.invalidateNodeVisibilityCacheInternal(t))}updateElevationChanged(e){const t=this._getNodeInternal(e);if((0,a.Wi)(t))return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(e);const s=(0,a.pC)(t.node)?t.node:t.ref;if((0,a.Wi)(s))return;const r=s.elevationRange;(0,a.Wi)(r)||(r.valid=!1)}invalidateGeometryVisibility(e){const t=this._getNodeInternal(e);(0,a.pC)(t)&&(0,a.pC)(t.node)&&(t.node.geometryObb=null,(0,f.WD)(t.node.renderMbs),(0,f.VL)(t.node.serviceObbInRenderSR))}invalidateVisibilityObbs(){(0,a.Wi)(this.rootNode)||this.traverse(this.rootNode,e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0))}_updateElevationRange(e){const t=this._getNodeInternal(e);if((0,a.Wi)(t))return null;const s=(0,a.pC)(t.node)?t.node:t.ref;if((0,a.Wi)(s))return null;const r=s.elevationRange;if((0,a.pC)(r)&&r.valid)return r;const n=new u.rw;let d=!1;for(let o=0;o<t.childCount;o++){const p=this._updateElevationRange(this.getChildIndex(e,o));(0,a.Wi)(p)?d=!0:(n.min=Math.min(n.min,p.min),n.max=Math.max(n.max,p.max))}if(0===t.childCount||d&&(0,a.pC)(t.node)&&t.node.resources.geometry){const o=this._viewportQueries.getElevationRange(s);(0,a.pC)(o)&&(n.min=Math.min(n.min,o.min),n.max=Math.max(n.max,o.max))}return(0,a.pC)(r)&&r.min===n.min&&r.max===n.max?(r.valid=!0,r):(n.valid=!0,s.elevationRange=n,this.invalidateBoundingVolumeCache(e),n)}isNodeVisible(e){const t=this._getNodeInternal(e);if((0,a.Wi)(t)||(0,a.pC)(t.ref)&&!t.ref.mbs)return!0;if(this.needNodeElevationRange&&this._updateElevationRange(e),!U(t.visibilityCache,this._visibilityCacheVersion)){const s=t.node,r=(0,a.pC)(s)&&((0,a.Wi)(t.ref)||(0,a.pC)(s.visibilityObb))?s:(0,a.pC)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&((0,a.pC)(s)||(0,a.pC)(t.ref))&&t.filterImpact===u.U_.NotChecked){const o=(0,a.pC)(s)?s.mbs:(0,a.pC)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=o?this._computeNodeFiltering(o):u.U_.Unmodified}const n=(0,a.pC)(s)&&t.filterImpact===u.U_.Culled,d=!((0,a.pC)(s)&&s.imModificationImpact===u.O4.Culled)&&(!r||this._viewportQueries.isNodeVisible(r))&&!n;return t.visibilityCache=A(d,this._visibilityCacheVersion),d}return B(t.visibilityCache)}isGeometryVisible(e){if(!this.isNodeVisible(e))return!1;const t=this._getNodeInternal(e);return!((0,a.pC)(t)&&(0,a.pC)(t.node)&&(0,a.pC)(t.node.geometryObb)&&(!this.layerHasModifications||t.node.imModificationImpact!==u.O4.NotChecked))||this._viewportQueries.isGeometryVisible(t.node)}_traverseCoverage(e,t,s,r,n){const d=this._getPage(e);if((0,a.Wi)(d)||0===t.childCount)return;const o=t.childOffset+t.childCount,p=new Array;for(let M=t.childOffset;M<o;++M){const j=d.children[M],v=this._getNodeInternal(j);(0,a.pC)(v)&&(0,a.pC)(v.node)&&this.isGeometryVisible(j)&&p.push(v)}r/=p.length;for(const M of p){const j=(0,a.Wg)(M.node).index;this._isLoaded(j)||this._isReloading(j)?(n.delta=Math.max(n.delta,s),n.coverage+=r):this._traverseCoverage(j,M,s+1,r,n)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if((0,a.Wi)(t))return!1;if("always"===this.holeFilling)return!0;if(U(t.useAsHole,this._version))return B(t.useAsHole);const s={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,s);const r=s.delta*s.coverage<=.5;return t.useAsHole=A(r,this._version),r}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=F(this._version)}imModificationsChanged(e){this.layerHasModifications=e,this._forAllNodes(({node:t})=>{(0,a.pC)(t)&&(t.imModificationImpact=u.O4.NotChecked,t.visibilityObb=this._computeVisibilityObb(t),t.hasModifications&&this.invalidateGeometryVisibility(t.index))}),this.invalidateVisibilityCache()}layerFilterChanged(e){this._layerHasFilter=e,this._forAllNodes(t=>{if((0,a.pC)(t)){t.filterImpact=u.U_.NotChecked;const s=t.node;(0,a.pC)(s)&&this.invalidateNodeVisibilityCache(s.index)}}),this.invalidateVisibilityCache()}update(e,t,s){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e),_.clear();let r=!0;const n=new X,d=new X,o=this._imModificationUncategorized;o.clear();const p=new Set;this.traverseVisible((v,I,$)=>{if((0,a.Wi)(I)){let T=this._entryPriority(v);T===1/0&&(T=this._entryPriority($));const H=G(v,this._nodesPerPage);return _.set(H,Math.max(T,_.get(H)||0)),this._loading.has(H)||this._failedPages.has(H)||this._missing.push(H),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,T))}const x=I.node;if(this._updateNodeFeatureEstimate(x,d),(0,a.Wi)(x)){const T=this._entryPriority(v);return this._loading.has(v)||this._failedNodes.has(v)||(this._missing.push(v),_.set(v,T)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,T))}const z=(0,a.Wg)(this._getPage(v));if(0===this._missing.length&&0===this._nodesPerPage)for(let T=0;T<I.childCount;T++){const H=z.children[I.childOffset+T],se=this._getNodeInternal(H);!(0,a.pC)(se)||se.node||this._loading.has(H)||this._failedNodes.has(H)||(_.set(H,this._entryPriority(H)),this._prefetch.push(H))}if(x.failed||!x.resources.hasFeatureData)return void(r&&I.childCount>0&&this._isSelected(x)&&(r=!1));if(p.add(x.id),this._isLoaded(v)){if(n.known+=x.memory,++n.knownNodes,this._isSelected(x)?I.childCount>0&&(r=!1):(n.unremoved+=x.memory,r=!1),this._needsUpdate(x)){const T=this._entryPriority(v);_.set(v,T),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,T),this._updates.update.push(v)}return}if(x.memory&&(n.known+=x.memory,++n.knownNodes),!this._isSelected(x))return void(this._isReloading(v)&&this._updates.remove.push(v));if(I.childCount>0&&(r=!1),x.memory?(n.missing+=x.memory,n.known+=x.memory,++n.knownNodes):++n.missingNodes,e.includes(x.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(v)),void(this._updates.cancel=this._updates.cancel.filter(T=>T!==x.index));if(!t.done&&this._enable(x))return void t.madeProgress();const J=this._entryPriority(v);_.set(v,J),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,J),this._updates.add.push(v),this.layerHasModifications&&s&&(0,a.pC)(x)&&x.imModificationImpact===u.O4.NotChecked&&o.push(v)});const j=this._updates.add;j.length>0&&this.layerHasModifications&&(o.length>0&&s(o),j.filterInPlace(v=>{const I=this._getNodeInternal(v),$=(0,a.Wi)(I)||(0,a.Wi)(I.node)||I.node.imModificationImpact!==u.O4.Culled;return $||this.invalidateNodeVisibilityCache(v),$})),this._unloadedMemoryEstimate=n.missing-n.unremoved,n.knownNodes>3&&n.missingNodes>0&&(this._unloadedMemoryEstimate+=n.known/n.knownNodes*n.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(d),this._featureEstimate.leavesReached=r,this._missing.sort((v,I)=>v-I),this._missing.filterInPlace((v,I)=>I<1||this._missing.data[I-1]!==v),this._missing.sort((v,I)=>_.get(v)-_.get(I)),this._missing.length>0&&(this._maxUnloadedPrio=_.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace(v=>_.get(v)>=this._maxUnloadedPrio).sort((v,I)=>_.get(v)-_.get(I)),this._updates.update.sort((v,I)=>_.get(v)-_.get(I)),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,_.clear()}checkFeatureTarget(e,t){const s=this._viewportQueries.updateScreenSpaceErrorBias(t);let r=t,n=t,d=s,o=10;for(;o--;){const p=new X;if(this._updateFeatureEstimate(r,p),this._computeFeatureEstimate(p)<=e){if(r>=t||p.missingNodes>0||0===o)break;d=r,r=.5*(r+n)}else n=r,r=.5*(r+d)}return this._version=F(this._version),this._viewportQueries.updateScreenSpaceErrorBias(s),Math.min(t,r)}_updateFeatureEstimate(e,t){this._version=F(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((s,r)=>this._updateNodeFeatureEstimate((0,a.pC)(r)&&r.node,t))}_updateNodeFeatureEstimate(e,t){if(!((0,a.Wi)(e)||e.failed||(0,a.Wi)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&((0,a.pC)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missing)}prefetch(){return this._prefetch.sort((e,t)=>_.get(e)-_.get(t)),this._load(this._prefetch)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this._nodesPerPage?this._loadNode(e.pop()):this._loadPage(e.pop());return!0}get isLoading(){return this._indexMissing>0}get isPrefetching(){return this._prefetch.length>0}get indexLoading(){return this._loading.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(e){if((0,a.Wi)(e))return null;let t=this._nodeTraversalState.get(e.index);if(t&&U(t.version,this._version))return t;const s=this._viewportQueries.getLodLevel(e),r=this._viewportQueries.hasLOD(e);let n=!0;if(r){const d=this.getParentIndex(e.index);if(d>=0){const o=this._nodeTraversalState.get(d);n=o&&s>o.lodLevel}else n=s>0}else n=0===e.childCount;return t?(t.lodLevel=s,t.isChosen=n,t.version=A(!0,this._version),t):(t=new u.oQ(r,n,s,A(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}_loadNode(e){this._loading.add(e);const t=(0,a.Wg)(this._getNodeInternal(e)).ref;if((0,a.Wi)(t))return void this._failedNodes.add(e);const s=t.id,r=this._urlPrefix+s,n=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this._streamDataController.request(r,"json").then(d=>{n();const o=this._validateNode(s,d);if(null==o)return;o.obb&&this.invalidateNodeVisibilityCache(e);const p=this._addNode(o,e);this.nodeTraversalState(p)},d=>{n(),(0,m.D_)(d)||(this._logger.error("#loadNode()",this._logLayer,"Error loading node: "+r),this._failedNodes.add(e))})}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._logLayer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._logLayer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._logLayer,`Invalid shared resource href on node "${e}"`),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this._logger.warn("#validateNode()",this._logLayer,`Invalid geometry data on node "${e}"`),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((o,p)=>o.href!==`./attributes/f_${p}/0`)||this._logger.warn("#validateNode()",this._logLayer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._logLayer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const s=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,r=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,d=Array.isArray(t.children)?t.children.map(o=>{if(null==o)return null;const p=v=>this._logger.error("#validateNode()",this._logLayer,`Invalid node reference on node ${e}: ${v}`);if("number"==typeof o.id)p(`id ${o.id} is a number instead of a string.`);else if("string"!=typeof o.id||!Array.isArray(o.mbs))return p("Missing or invalid id."),null;if(!Array.isArray(o.mbs))return p(`Invalid bounding volume on reference ${o.id}.`),null;o.href&&o.href!=="../"+o.id&&this._logger.error("#validateNode()",this._logLayer,`Invalid node href on node "${e}"`);const M=o.hasOwnProperty("obb")&&!this.ignoreServiceObb?o.obb:null,j=new u.$i(`${o.id}`,o.mbs);return j.serviceObb=M,j.visibilityObb=this._computeVisibilityObb(j),j}).filter(o=>null!=o):null;return{id:e,mbs:t.mbs,obb:s,children:d,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:r}}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes(e=>{(0,a.pC)(e.node)&&(e.node.failed=!1)})}_entryPriority(e){const t=this._getNodeInternal(e),s=this.getParentIndex(e);if((0,a.Wi)(t)||s<0&&null==t.node)return s<0?1/0:this._entryPriority(s);let r=0;if(t.node&&s>=0){const o=this._nodeTraversalState.get(s);null!=o&&(r=o.lodLevel)}let n=this.progressiveLoadPenalty;for(let o=e;o>=0;o=this.getParentIndex(o))if(this._isLoaded(o)){n=0;break}const d=(0,a.pC)(t.ref)?this._viewportQueries.distToPOI(t.ref):(0,a.pC)(t.node)?this._viewportQueries.distToPOI(t.node):0;return-d-r*(d+this.progressiveLoadPenalty)+n}traverseVisible(e){const t=this._getNodeInternal(this._rootIndex);(0,a.Wi)(t)?e(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,-1,t,e)}_traverseVisible(e,t,s,r){if(s.node&&0===s.childCount)return void(this.isGeometryVisible(e)&&r(e,s,t));if(!this.isNodeVisible(e)||(r(e,s,t),null==s.node))return;const n=this.nodeTraversalState(s.node);if(n.nodeHasLOD&&n.lodLevel===this._maxLodLevel)return;const d=(0,a.Wg)(this._getPage(e));for(let o=0;o<s.childCount;o++){const p=d.children[s.childOffset+o],M=this._getNodeInternal(p);(0,a.pC)(M)?this._traverseVisible(p,e,M,r):r(p,null,e)}}traverse(e,t){t(e)&&this.traverseChildren(e,t)}traverseChildren(e,t){const s=e.index,r=this._getNodeInternal(s);(0,a.pC)(r)&&this._traverseChildren(s,r,t)}_traverseChildren(e,t,s){const r=this._getPage(e);if((0,a.Wi)(r))return;const n=t.childOffset+t.childCount;for(let d=t.childOffset;d<n;++d){const o=r.children[d],p=this._getNodeInternal(o);(0,a.pC)(p)&&(0,a.pC)(p.node)&&s(p.node)&&this._traverseChildren(o,p,s)}}updateChildrenLoaded(e,t){let s=this.getNode(e);for(;(0,a.pC)(s);)s.childrenLoaded+=t,s=this.getParent(s.index)}checkChildrenLoadedInvariant(){if((0,a.Wi)(this.rootNode))return!0;const e=[],t=s=>{let r=this._isLoaded(s.index)||this._isReloading(s.index)?1:0;return this.traverseChildren(s,n=>(r+=t(n),!1)),s.childrenLoaded!==r&&e.push(s.index),r};return t(this.rootNode),e.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+e.join(",")),e.length>0}updateStats(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||0),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}updateElevationInfo(e,t){this.needNodeElevationRange=t&&e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes(e=>{C(e),(0,a.pC)(e.node)&&(e.node.elevationRange=null),(0,a.pC)(e.ref)&&(e.ref.elevationRange=null)})}_forAllNodes(e){for(let t=0;t<this._nodePages.length;t++){const s=this._nodePages[t];if(s){const r=t*this._nodesPerPage;for(let n=0;n<s.nodes.length;n++)e(s.nodes[n],r+n)}}}get test(){return{addNode:(e,t)=>this._addNode(e,t)}}}const _=new Map;class N{constructor(e){this.missing=e,this.update=new O.Z({deallocator:null}),this.add=new O.Z({deallocator:null}),this.remove=new O.Z({deallocator:null}),this.cancel=[]}reset(e){this.add.clear(),this.update.clear(),this.cancel=e}}function C(i){(0,a.pC)(i.node)&&((0,f.WD)(i.node.renderMbs),(0,f.VL)(i.node.serviceObbInRenderSR)),(0,a.pC)(i.ref)&&((0,f.WD)(i.ref.renderMbs),(0,f.VL)(i.ref.serviceObbInRenderSR))}function P(i){return(0,f.HV)(i,-2)}function F(i){return(0,f.HV)(i,2)}function A(i,e){return e+(i?1:0)}function U(i,e){return(-2&i)===e}function B(i){return 1==(1&i)}function G(i,e){return 0===e?0:i/e|0}function S(i,e){return 0===e?i:i%e}const k=[["maxScreenThreshold",u.w5.MaxScreenThreshold],["screenSpaceRelative",u.w5.ScreenSpaceRelative],["removedFeatureDiameter",u.w5.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",u.w5.DistanceRangeFromDefaultCamera]];class X{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function ge(i){return Math.sqrt(i*(4/Math.PI))}var _e=l(73683);class ke{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,t,s,r){this._maxLodLevel=r.maxLodLevel,this._index=s,this._isNodeInScaleBounds=e,this._removeNodes=t}shouldLoadNode(e){if((0,a.Wi)(e))return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const s=Math.max(0,Math.floor(10*(this._layerView.view.resourceController.memoryController.usedMemory-1)));de.clear(),this._lodGlobalHandling(this._index.rootNode,s,!1,this._layerView.nodeCrossfadingEnabled);const r=de.length;this._removeNodes(de,e);const n=de.length<r;return 0!==de.length&&(this._lodGlobalDirty=!0),de.clear(),n}_lodGlobalHandling(e,t,s,r){if((0,a.Wi)(e))return!1;const n=e.index,d=this._index,o=this._layerView,p=d.nodeTraversalState(e),M=this._isChosenMaxLOD(p);if(M&&!e.resources.hasFeatureData)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const v=o.isNodeLoaded(n);if(r&&v&&M){const T=!s&&this.hasNoVisibleChildren(e);o.fadeNode(n,_e.B.FadeIn,!T)}const I=v&&(!o.isNodeFullyFadedIn||o.isNodeFullyFadedIn(n));if(v&&(o.updateNodeState(n,M?u.FE.Leaf:u.FE.Hole),M))return I&&this._removeChildrenRecursive(e),I;const $=e.childCount>0;let x=$;if($)for(let T=0;T<e.childCount;T++){const H=d.getChildIndex(n,T),se=d.getNode(H);(0,a.pC)(se)?d.isGeometryVisible(H)&&!this._lodGlobalHandling(se,t,s||I,r)&&this._isNodeInScaleBounds(se)&&(x=!1):d.isNodeVisible(H)&&(x=!1)}const z=v&&!M&&(x||de.length<t);return z&&de.push(n),!r||z||!v||s||x||o.fadeNode(n,_e.B.FadeIn,!1),x||I&&!z||!e.resources.hasFeatureData}_removeChildrenRecursive(e){this._index.traverseChildren(e,t=>((this._layerView.isNodeLoaded(t.index)||this._layerView.isNodeReloading(t.index))&&de.push(t.index),t.childrenLoaded>0))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseChildren(e,s=>!(!t||!this._index.isNodeVisible(s.index))&&(this._layerView.isNodeLoaded(s.index)?(t=!1,!1):s.childrenLoaded>0)),t}_childrenRequireLoading(e){let t=!1,s=!0;return this._index.traverseChildren(e,r=>{if(!s||!this._index.isNodeVisible(r.index))return!1;const n=this._index.nodeTraversalState(r);return this._isChosenMaxLOD(n)&&this._index.isGeometryVisible(r.index)&&(t=!0),this._layerView.isNodeLoaded(r.index)?(s=!1,!1):r.childrenLoaded>0}),s&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const de=new O.Z({deallocator:null});var ze=l(15861),pe=l(59213),Ze=l(58817),Ae=l(21726),De=l(81937),Fe=l(92852),Ne=l(42767);class Ce{constructor(e,t,s,r,n,d){if(this._streamDataController=t,this._logger=s,this._defaultGeometrySchema=r,this._requiredAttributes=n,this._options=d,this._logLayer=e,this._layerUrl=e.parsedUrl.path,this._geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const o=e.textureSetDefinitions;this._materialAndTextures=e.materialDefinitions.map(p=>(0,Ne.R0)(o,p))}}_load(e,t,s){return this._streamDataController.request(e,t,s)}_loadAttribute(e,t,s){return this._load(`${this._layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`,"binary",s).then(n=>(0,Fe.qM)(t,n))}loadAttributes(e,t,s){return(0,m.as)(t.map(r=>this._loadAttribute(e,r.attributeStorageInfo,s))).then(r=>{const n={};for(let d=0;d<t.length;++d){const o=r[d].value;if(o)n[t[d].name]=o;else{if((0,m.D_)(r[d].error))throw r[d].error;this._logger.error("#loadAttributes",this._logLayer,`Failed to load attributeData for '${t[d].name}' on node '${e.id}'`,r[d].error)}}return n})}loadNodeData(e,t){var s=this;return(0,ze.Z)(function*(){const r=null!=s._requiredAttributes&&e.resources.attributes?(0,pe.q6)(s.loadAttributes(e,s._requiredAttributes,t)):null,{bufferDefinition:n,bufferIndex:d}=function et(i,e){const t={bufferDefinition:null,bufferIndex:0};if(null==i||e.resources.geometryDefinition<0)return t;const s=e.resources.geometryDefinition>=0?i[e.resources.geometryDefinition].geometryBuffers:null;if(null==s)return t;for(let r=0;r<s.length;r++){const n=s[r];if(null==n.compressedAttributes)t.bufferIndex=r,t.bufferDefinition=s[r];else if("draco"===n.compressedAttributes.encoding&&!(0,b.Z)("disable-feature:i3s-draco"))return t.bufferIndex=r,t.bufferDefinition=n,t}return t}(s._geometryDefinitions,e),o=!!e.resources.geometry,p=o?(0,pe.q6)(s._loadGeometry(e.resources.geometry,d,t)):null,M=e.resources.hasSharedResource?yield s._loadShared(e,t):null,j=s._materialAndTextures&&e.resources.materialDefinition>=0?s._materialAndTextures[e.resources.materialDefinition]:null!=M?(0,Ne.Pg)(M):null,v=j&&j.material,I=j&&j.textures,$=`${e.id}`,x=!o&&s._options.loadFeatureData,z=x?yield s._loadFeatureData($,t):null,J=x?function Xe(i){for(const e of i.featureData){const t=e.geometries;if(null!=t)for(const s of t)return{featureIds:[e.id],featureDataPosition:e.position,geometries:[s]}}return null}(z):function Ye(i){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:i}}],featureDataPosition:[0,0,0]}}(v),T=(0,a.Wi)(J)&&function Je(i){const e=new Array;for(const t of i.featureData)null!=t.position&&e.push({featureIds:[t.id],featureDataPosition:t.position,geometries:null});return e}(z),H=null!=I&&I.length>0?(0,pe.q6)(s.loadTextures(e,I,t)):null;let se=null,we=null;if(p){se=(0,pe.w6)(yield p);const ct=function qe(i,e){if(!i||!e||!e.materialDefinitions)return i;const t=Object.keys(e.materialDefinitions)[0];return!e.materialDefinitions[t].params.vertexRegions&&i.vertexAttributes.region&&delete(i=(0,Ze.d9)(i)).vertexAttributes.region,i}(s._defaultGeometrySchema,M);we=(0,Fe.Es)(n,ct)}const Qe=H?(0,pe.w6)(yield H):null,$e=r?(0,pe.w6)(yield r):{},Ke=$e?{attributeData:$e,loadedAttributes:s._requiredAttributes}:null;if((0,a.pC)(J))return{geometryData:J,attributeDataInfo:Ke,geometryBuffer:se,geometryDescriptor:we,requiredTextures:I,textureData:Qe};if((0,a.pC)(T))return{pointData:T,attributeDataInfo:Ke,geometryBuffer:se,geometryDescriptor:we,requiredTextures:I,textureData:Qe};throw new Error})()}static _addAbsoluteHrefTexture(e,t){const s=e.textureDefinitions;if(null!=s)for(const r of Object.keys(s))for(const n of s[r].images)n.hrefConcat=Array.isArray(n.href)?n.href.map(d=>(0,Ae.hF)(d,t)):(0,Ae.hF)(n.href,t)}static _fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const s in t){const r=t[s];if(Array.isArray(r.encoding))for(let n=0;n<r.encoding.length;n++){const d=r.encoding[n];"data:"===d.substring(0,5)&&(r.encoding[n]=d.substring(5))}else{const n=r.encoding;"data:"===n.substring(0,5)&&(r.encoding=n.substring(5))}}}_loadShared(e,t){const s=`${this._layerUrl}/nodes/${e.resources.geometry}/shared`;return this._load(s,"json",t).then(r=>(Ce._fixTextureEncodings(r),Ce._addAbsoluteHrefTexture(r,s),r))}_loadTexture(e,t,s,r,n,d){let o=!1;return n===De.j.DDS_S3TC||n===De.j.KTX2||n===De.j.Basis?this._load(e,"binary",d).then(p=>({id:t,usage:s,data:p,encoding:n,downsampled:o})):this._load(e,"image",d).then(p=>{let M=p;if(r&&p.width*p.height>=4096){const I=Math.ceil(p.width/2),$=Math.ceil(p.height/2),x=document.createElement("canvas");x.width=I,x.height=$,x.getContext("2d").drawImage(p,0,0,I,$),M=x,o=!0}return{id:t,usage:s,data:M,encoding:n,downsampled:o}})}loadTextures(e,t,s){const r=this._options.uncompressedTextureDownsamplingEnabled,n=this._options.textureUsageMask;return Promise.all(t.map(d=>{if(0==(d.usage&n))return null;const o=(0,Ne.nn)(d.encodings,this._options.textureEncodings);return null==o?(this._logger.error("#loadTextures",this._logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject()):this._loadTexture(`${this._layerUrl}/nodes/${e.resources.texture||e.id}/textures/${o.name}`,d.id,d.usage,r,o.encoding,s)}))}_loadFeatureData(e,t){return this._load(`${this._layerUrl}/nodes/${e}/features/0`,"json",t)}_loadGeometry(e,t,s){return this._load(`${this._layerUrl}/nodes/${e}/geometries/${t}`,"binary",s)}}class Te{constructor(e,t){this._requester=e,this._apiKey=t,this._activeRequests=new Set}get busy(){return this._requester.busy}request(e,t,s){const r=new AbortController,n=(0,m.$F)(s,()=>r.abort()),o=this._requester.request(e,t,{signal:r.signal,query:{token:this._apiKey}}),p={response:o,abortController:r,abortHandle:n};return this._activeRequests.add(p),(0,m.Bx)(o,()=>{p.abortController=null,p.abortHandle?.remove(),p.abortHandle=null,this._activeRequests.delete(p)}),o}cancelAll(){this._activeRequests.forEach(e=>{e.abortController?.abort(),e.abortController=null,e.abortHandle?.remove()}),this._activeRequests.clear()}}var be=l(28093),tt=l(993),Re=l(12080),Pe=l(8834),it=l(37053),st=l(97126),Ve=l(81468),rt=l(79112),Ue=l(74746);class nt{constructor(e,t,s,r,n,d,o,p,M={}){this._indexSR=e,this._renderCoordsHelper=t,this._clippingArea=n,this._elevationProvider=d,this._viewingMode=o,this._options=M,this._frustum=(0,Pe.Ue)(),this._useFrustumCulling=!1,this._poi=(0,be.c)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=(0,V.Ue)(),this._tmp1=(0,be.c)(),this._tmp2=(0,be.c)(),this._tmp3=(0,be.c)(),this._tmp0=(0,be.c)(),this._screenspaceErrorBias=M.screenspaceErrorBias||1,this._progressiveLoadFactor=M.progressiveLoadFactor||1,this.updateCamera(s,r),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(p),this._tmpPoint=(0,te.Tx)(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(this.engineSR.isWebMercator||(0,it.QM)(this.engineSR)),this._indexSREllipsoidRadius=(0,Re.Iu)(this._indexSR).radius}updateElevationInfo(e){null!=e?(this._elevationContext=rt.o.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext((0,Ue.bw)((0,Ue.WI)(e,!1)))):this._elevationContext=null}updateCamera(e,t){this._useFrustumCulling=t,t&&(0,Pe.q_)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this._clippingArea=e}getElevationRange(e){if((0,a.Wi)(this._elevationContext))return null;const t=e.mbs[0],s=e.mbs[1],r=e.mbs[2],d="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds)return this._elevationProvider.getSphereElevationBounds(t,s,r,e.mbs[3],this._indexSR,d);const o=this._elevationProvider.getElevation(t,s,r,this._indexSR,d);return(0,a.pC)(o)?{min:o,max:o}:null}getRenderMbs(e){const t=e.renderMbs;return(0,f.c$)(t)||((0,tt.c)(t,e.mbs),this._elevationContext&&t[3]<1e5&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=(0,Ve.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)),(0,q.st)(t,this._indexSR,t,this.engineSR)),t}getVisibilityObb(e){if((0,a.pC)(e.visibilityObb))return e.visibilityObb;const t=e.serviceObb,s=.01*this._indexSREllipsoidRadius;return(0,a.Wi)(t)||!(0,f.vH)(t)||this._isECEFOBBInLocalMode&&t.halfSize.some(r=>r>s)?null:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3],e.elevationRange),e.serviceObbInRenderSR)}_computeRenderObb(e,t,s,r){if((0,a.Wi)(t))t=(0,V.Ue)();else if((0,f.vH)(t))return t;let n=0,d=0;if(this._elevationContext&&(0,a.pC)(r)&&Number.isFinite(r.min))switch(this._elevationContext.mode){case"relative-to-ground":n=this._elevationContext.geometryZWithOffset(e.center[2],this._renderCoordsHelper)+r.min-e.center[2],d=r.max-r.min;break;case"on-the-ground":n=r.min-e.center[2],d=r.max-r.min}else this._elevationContext&&s<1e5&&(this._tmpPoint.x=e.center[0],this._tmpPoint.y=e.center[1],this._tmpPoint.z=e.center[2],n=(0,Ve.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]);return d>0?((0,f.jv)(e,this._indexSR,this._tmpObb,this.engineSR,n),(0,f.gI)(this._tmpObb,0,d,this._viewingMode,t)):(0,f.jv)(e,this._indexSR,t,this.engineSR,n),t}isNodeVisible(e){const t=this.getRenderMbs(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;const s=this.getVisibilityObb(e);return(0,a.pC)(s)?(0,V.pn)(s,this._frustum):(0,Pe.hr)(this._frustum,(0,st.w)(t))}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const t=e.geometryObb;return(0,a.pC)(t)?(0,V.pn)(t,this._frustum):this.isNodeVisible(e)}_isMBSinClippingArea(e){return!!(0,a.Wi)(this._clippingArea)||(0,f.cr)(this._clippingArea,e)!==f.pD.OUTSIDE}_screenSpaceDiameterMbs(e,t){const s=this.getRenderMbs(e),r=Math.sqrt((0,L.d)(s,this._camPos)),n=r-s[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}calcCameraDistanceToCenter(e){const t=this.getRenderMbs(e),s=(0,L.i)(t,this._camPos);return this._updateMinMaxDistance(s),s}calcAngleDependentLoD(e){const t=this.getRenderMbs(e),s=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,L.l)(t)+s)/(0,L.i)(t,this._camPos);return Math.min(1,r)}hasLOD(e){return e.lodMetric!==u.w5.None}_getDistancePlanarMode(e,t){const s=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],d=s*s+r*r,o=t[3];if(d<=o*o)return Math.abs(n);const p=Math.sqrt(d)-o;return Math.sqrt(n*n+p*p)}_getDistanceGlobeMode(e,t){const s=(0,L.l)(t),r=(0,L.l)(e)-s;(0,L.g)(this._tmp0,e,(0,L.e)(e,t)/(0,L.p)(e));const n=(0,L.d)(t,this._tmp0),d=t[3];if(n<=d*d)return Math.abs(r);{const o=(0,L.g)(this._tmp0,t,1/s),j=(0,L.g)(this._tmp1,o,s-d*d/2/s),v=e,I=(0,L.b)(this._tmp2,v,j),$=(0,L.b)(this._tmp2,I,(0,L.g)(this._tmp3,o,(0,L.e)(o,I))),x=(0,L.a)(this._tmp2,j,(0,L.g)(this._tmp2,$,d/(0,L.l)($)));let z=(0,L.i)(v,x);if(r>=2e5){const J=(0,L.b)(this._tmp1,v,x);let T=(0,L.e)(J,o)/(0,L.l)(J);T<.08&&(T=1e-4),z/=T}return z}}_getDistance(e,t){return this.engineSR===(0,Re.rS)(this.engineSR)?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(e.lodMetric===u.w5.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const s=this._screenspaceErrorBias;return this.evaluateLODmetric(e,this._progressiveLoadFactor*this._screenspaceErrorBias)?this.evaluateLODmetric(e,s)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case u.w5.ScreenSpaceRelative:{const s=this.getRenderMbs(e),r=this._getDistance(this._camPos,s),n=2*r/this._screenSizeFactor;return this._updateMinMaxDistance(r+s[3]),e.maxError*t<=n}case u.w5.MaxScreenThreshold:{let s=this._screenSpaceDiameterMbs(e,e.mbs[3]*t);return this._options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError}case u.w5.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case u.w5.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(e){const t=this.getRenderMbs(e);return(0,L.i)(t,this._poi)-t[3]}distCameraToPOI(){return(0,L.i)(this._camPos,this._poi)}}var at=l(55745),Ie=l(39135),Le=l(93579);const Be="esri.layers.graphics.controllers.I3SOnDemandController",fe=w.Z.getLogger(Be),Oe=1e-4;let K=class extends((0,W.v)(E.Z)){constructor(i){super(i),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._newLoadingNodes=new O.Z({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new O.Z,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._handles=new y.Z,this._idleQueue=new ae.b,this._elevationUpdateNodes=new O.Z({deallocator:null}),this._errorCount=0}get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&((0,a.Wi)(this.layer.priority)||"High"===this.layer.priority)}get indexStreamController(){const i=this.layerView.view.resourceController.createStreamDataRequester(Ie.Bh.I3S_INDEX);return new Te(i,this.layer.apiKey)}get dataStreamController(){const i=this.layerView.view.resourceController.createStreamDataRequester(Ie.Bh.I3S_DATA);return new Te(i,this.layer.apiKey)}get crsVertex(){return(0,f.T2)(this.layer)}get crsIndex(){return(0,f.tp)(this.layer)}get layer(){return this.layerView.i3slayer}get rootNodeVisible(){if((0,a.pC)(this._index)){const i=this._index.rootNode;if((0,a.pC)(i))return this._updateViewData(),this._index.isNodeVisible(i.index)}return!0}get index(){return this._index}initialize(){const{layerView:i,layer:e}=this;this._disableMemCache=!i.loadCachedGPUData||!i.addCachedGPUData,this._lodHandling=new ke(i),this._defaultGeometrySchema=e.store.defaultGeometrySchema,this.disableIDBCache=(0,b.Z)("disable-feature:idb-cache"),"fields"in e&&(this._fields=e.fields,this._attributeStorageInfo=e.attributeStorageInfo),this.addResolvingPromise(Promise.all([e.indexInfo,e.when(),i.when()]).then(([t])=>{if(this.destroyed||!i||i.destroyed)return;const{view:s}=i,{resourceController:r}=s;this._setClippingArea(s.clippingArea),this.addHandles([(0,R.YP)(()=>s?.pointsOfInterest?.focus?.renderLocation,n=>this._pointOfInterestChanged(n),R.nn),(0,R.YP)(()=>r.memoryController.memoryFactor,()=>this._setCameraDirty(),R.Z_),(0,R.YP)(()=>i.suspended,n=>{const d=n?()=>this._updateViewData():()=>this._updateIdleState(!0),o=n?()=>{}:()=>this._updateIdleState(!1);!n&&(0,a.pC)(this._index)&&this._index.invalidateAllElevationRanges(),this._idleStateCallbacks?(n&&this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=d,this._idleStateCallbacks.idleEnd=o):this._idleStateCallbacks=r.scheduler.registerIdleStateCallbacks(d,o)},R.nn),ye(i.view.resourceController.scheduler,{update:(n,d)=>this._frame(n,d),needsUpdate:()=>this.updating}),(0,R.YP)(()=>i.uncompressedTextureDownsamplingEnabled,()=>this.restartNodeLoading()),(0,R.YP)(()=>[this.featureTarget,this.fixedFeatureTarget],()=>{this._setCameraDirty(),this._stableFeatureLOD=!1}),(0,R.YP)(()=>s.state?.contentCamera,()=>this._setCameraDirty()),(0,R.YP)(()=>e.elevationInfo,n=>this._elevationInfoChanged(n)),(0,R.YP)(()=>e.effectiveScaleRange,()=>this._scaleBoundsChanged()),(0,R.YP)(()=>i.lodFactor,()=>this._setCameraDirty()),(0,R.YP)(()=>i.availableFields,()=>this._requiredFieldsChange()),(0,R.YP)(()=>i.holeFilling,n=>(0,a.pC)(this._index)&&(this._index.holeFilling=n))]),this._updateScaleHandles(),this._viewportQueries=new nt(this.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?s.basemapTerrain:s.elevationProvider,(0,he.wg)(s.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:this._lod<.5}),this._index=new h(e,t,this.indexStreamController,this._viewportQueries,fe,i.holeFilling,n=>i.isNodeLoaded(n),n=>i.isNodeReloading(n),n=>this._shouldLoadNode(n),n=>this._enableFromGPUCache(n,u.FE.Leaf),n=>this._needsUpdate(n),()=>!this.indexStreamController.busy,n=>i.computeVisibilityObb?i.computeVisibilityObb(n):null,i?.computeNodeFiltering?n=>i.computeNodeFiltering(n):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid),this._index.imModificationsChanged(!!i.hasModifications),this._startNodeLoading()})),this._tmpPoint=(0,te.Tx)(0,0,0,this.crsIndex)}updateNodeModificationStatus(i){const e=this._index,t=this.layerView;(0,a.pC)(e)&&t?.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),i.forAll(s=>{const r=e.getNode(s);(0,a.pC)(r)&&this._modificationsNodeFilteringArray.push(r)}),t.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,ie.prune(),(0,a.pC)(Me)&&(Me.hide(),Me=null)}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const i=this._attributeStorageInfo,e=this._fields,t=this.layer.objectIdField;return this.layerView.availableFields.map(s=>{const r=Ee(i,s),n=Ee(e,s);return r>=0&&n>=0?{index:r,name:e[n].name,field:e[n],attributeStorageInfo:i[r]}:null}).filter(s=>null!=s&&s.name!==t)}_requiredFieldsChange(){const i=this._getRequiredAttributes();Se(this._requiredAttributes,i)||(this._requiredAttributes=i,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(i){const e=(0,ne.Ue)();this._clippingArea=(0,at.G)(i,e,this.layerView.view.renderSpatialReference)?e:null}_pointOfInterestChanged(i){(0,a.pC)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(i),(0,a.pC)(this._index)&&(this._index.progressiveLoadPenalty=He.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(i){this._setClippingArea(i),(0,a.pC)(this._viewportQueries)&&(0,a.pC)(this._index)&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateElevationChanged(i,e){const t=this._index;if((0,a.Wi)(t)||(0,a.Wi)(t.rootNode)||(0,a.Wi)(e))return null;this.crsIndex.equals(e)||((0,q.dH)(i,e,xe,this.crsIndex),i=xe);const s=this._elevationUpdateNodes;return s.clear(),(0,f.tS)(i,t.rootNode,t,r=>s.push(r.index)),s.length&&(s.forAll(r=>t.updateElevationChanged(r)),this._setCameraDirty()),s}getParentIndex(i){return(0,a.pC)(this._index)&&this._index.getParentIndex(i)}removeAllGeometryObbs(){(0,a.pC)(this._index)&&this._index.removeAllGeometryObbs()}getRenderMbs(i){return(0,a.pC)(this._viewportQueries)?this._viewportQueries.getRenderMbs(i):null}_elevationInfoChanged(i){(0,a.Wi)(this._index)||(this._index.updateElevationInfo(i,this.isMeshPyramid),this._setCameraDirty())}_updateScaleHandles(){const i="scale-bounds";this._handles.remove(i),this._areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",e=>this._scaleUpdateHandler(e)),i)}_scaleBoundsChanged(){this._areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(i){this._updateScaleInBoundingRect(i.extent,i.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(i,e){const t=this._index;(0,a.Wi)(t)||!(0,a.Wi)(t.rootNode)&&(0,q.dH)(i,e,xe,this.crsIndex)&&this._loadedNodeScales.forEach((r,n)=>{const d=t.getNode(n);(0,a.pC)(d)&&(0,ne.hr)(xe,d.mbs)&&this._loadedNodeScales.set(n,this._computeScale(d))})}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(i,e){return this._idleQueue.push(i,e)}reschedule(i,e){return this._idleQueue.unshift(i,e)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get _areScaleBoundsActive(){const{minScale:i,maxScale:e}=(0,Le.lu)(this.layer);return this.scaleVisibilityEnabled&&(i>0||e>0)}get unloadedMemoryEstimate(){return(0,a.Wi)(this._index)||this.layerView.suspended?0:this._index.unloadedMemoryEstimate*this._lodDropFactor}get indexDepth(){return(0,a.pC)(this._index)?this._index.maxLevel:0}set disableMemCache(i){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=i}_frame(i,e){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||(0,a.Wi)(this._index)?-1/0:(this._processWithErrorLogging(i,e),this._index.maxPriority)}_processWithErrorLogging(i,e){try{this._process(i,e)}catch(t){this._errorCount<50?fe.error("Error during processing: "+t):50===this._errorCount&&fe.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(i,e){this._restartNodeLoading&&this._startNodeLoading(),null==this._nodeLoader||(0,a.Wi)(this._index)||(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(i)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(i.enabled=!1),i.run(()=>this._processIndex(i)),this._updateFeatureLOD(),i.run(()=>this._processCache(i)),this._isIntegratedMesh&&(i.enabled=!0),i.run(()=>this._processNodes(i,e)),this._idleQueue.runTask(i),i.run(()=>this._prefetchIndex()),e.numIndexLoading+=this._index.indexLoading,e.numNodesLoading+=this._downloadingCount,i.run(()=>this._lodHandling.lodGlobalHandling(i)),this._evaluateUpdating())}_processIndex(i){if((0,a.Wi)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),i,t=>this.updateNodeModificationStatus(t)),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const e=this._index.featureEstimate.leavesReached;this._index.isLoading||e===this._get("leavesReached")||this._set("leavesReached",e)}return this._index.load()}_prefetchIndex(){return!((0,a.Wi)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||(0,a.Wi)(this._index)||(0,a.Wi)(this._viewportQueries))return;const i=!this._index.isLoading,e=this.featureTarget*this._baseLOD,t=this._index.featureEstimate;if(t.estimate=t.estimate||e/2,this._index.indexMissing>500){if(this._featureLOD<=Oe)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(i&&t.estimate<e){if(t.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const s=Math.min(10,Math.max(e/t.estimate,1.001));this._featureLOD*=s;const r=this._lod,n=this._index.checkFeatureTarget(e,r);n!==r&&(this._featureLOD=n/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(t.estimate>1.2*e||i&&t.estimate>e)||this._featureLOD<=Oe)return;this._featureLOD/=1+.25*(t.estimate/e-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Oe,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}_processCache(i){const e=this._index;if((0,a.Wi)(e))return!1;for(;this._newLoadingNodes.length>0&&!i.done;){const t=this._newLoadingNodes.pop();for(let s=e.getParent(t);(0,a.pC)(s)&&!this.layerView.isNodeLoaded(s.index)&&this._isNodeInScaleBounds(s);s=e.getParent(s.index))if(this._enableFromGPUCache(s,u.FE.Hole)){i.madeProgress();break}}return i.hasProgressed}_processNodes(i,e){if((0,a.Wi)(this._index))return!1;let t=(this._isIdle?100:2)-this._loadingNodes.size;const s=this._index.updates;for(s.cancel.forEach(this._cancelNode,this),s.cancel=[];s.remove.length>0&&!i.done;)this.layerView.removeNode(s.remove.pop()),i.madeProgress();for(;s.update.length>0&&!i.done;){const r=this._index.getNode(s.update.pop());(0,a.pC)(r)&&(this._updateLoadedNode(r),i.madeProgress())}for(;s.add.length>0&&!i.done&&t>0;){--t;const r=this._index.getNode(s.add.back());if((0,a.Wi)(r)||r.cacheState!==u.Hw.Cached&&!this._hasNodeLoadToken(e))break;s.add.pop(),this._loadNode(r),i.madeProgress()}return i.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach(i=>i.abort()),this._loadingNodes.clear(),this._updatingNodes.forEach(i=>i.abort()),this._updatingNodes.clear()}_cancelNode(i){const e=this._loadingNodes.get(i);e&&(e.abort(),this._loadingNodes.delete(i))}_hasNodeLoadToken(i){return!(!this._isIdle&&i.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<Ie.NT&&!this.dataStreamController.busy}_evaluateUpdating(){let i=!1,e=0;if(this.layerView.suspended)i=this._cameraDirty,e=i?0:1;else{const t=((0,a.pC)(this._index)?this._index.indexMissing:0)+3*((0,a.pC)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;i=!!(t>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||(0,a.pC)(this._index)&&this._index.isPrefetching),0===t&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(t,this._progressMaxNumNodes),e=1-t/this._progressMaxNumNodes}this.updating=i,this.updatingProgress=e}_updateViewData(){if(!this._cameraDirty||(0,a.Wi)(this._index)||(0,a.Wi)(this._viewportQueries))return;const i=this.layerView.view,{contentCamera:e,fixedContentCamera:t}=i.state;this.screenSizeFactor=1/(e.perScreenPixelRatio/2),this._viewportQueries.updateCamera(e,!t||this.isGraphics3D),this._viewportQueries.setPointOfInterest(i.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=He.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const i=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(i>0?i:1)*this.layerView.view.resourceController.memoryController.memoryFactor}get _lodDropFactor(){if(this.fixedFeatureTarget)return 1;const i=this.layerView.view.resourceController.memoryController;return(Math.min(i.memoryFactor,.5)-i.minQuality)/(.5-i.minQuality)}isGeometryVisible(i){return(0,a.pC)(this._index)&&this._index.isGeometryVisible(i.index)}updateVisibility(i){(0,a.pC)(this._index)&&this._index.invalidateNodeVisibilityCache(i)}invalidateGeometryVisibility(i){(0,a.pC)(this._index)&&this._index.invalidateGeometryVisibility(i)}invalidateVisibilityObbs(){(0,a.pC)(this._index)&&this._index.invalidateVisibilityObbs()}modificationsChanged(){(0,a.pC)(this._index)&&this._index.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(i){return!(!this._lodHandling.shouldLoadNode(i)||this._shouldDropNode(i))&&!((0,a.Wi)(this._index)||!this._index.isGeometryVisible(i.index))&&this._isNodeInScaleBounds(i)}_shouldDropNode(i){if((0,a.Wi)(this._viewportQueries))return!1;const e=this._lodDropFactor;return!(e>=1||!this._lodHandling.hasNoVisibleChildren(i))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(i))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*e}_startNodeLoading(){this._restartNodeLoading=!1;const i=this._index;this._updatesDisabled||(0,a.Wi)(i)||(0,a.Wi)(this._viewportQueries)||(this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1),this._nodeLoader=new Ce(this.layer,this.dataStreamController,fe,this._defaultGeometrySchema,this._requiredAttributes,{textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures}),i.requestUpdate(),this._lodHandling.startNodeLoading(t=>this._isNodeInScaleBounds(t),(t,s)=>this._removeNodes(t,s,ve.fadeout),i,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating())}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(i){const e=this._index;if((0,a.Wi)(e)||(0,a.Wi)(this._viewportQueries))return!1;ie.clear(),this.layerView.getLoadedNodeIndices(ie);const t=0===this._viewportQueries.maxDistance,s=t?()=>!1:r=>this._shouldDropNode(r);return ie.filterInPlace(r=>{const n=e.getNode(r);return(0,a.Wi)(n)||!e.isGeometryVisible(r)||s(n)||!this._isNodeInScaleBounds(n)}),ie.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(ie,i,ve.pop),!(t&&this._lodDropFactor<1||0!==ie.length&&(ie.clear(),1))}markNodeToRemove(i){ie.push(i)}removeMarkedNodes(){this._removeNodes(ie,ue.G5,ve.pop)}_removeNodes(i,e,t){const s=i.length;if(0!==s&&!e.done){for((0,a.pC)(this._index)&&this._index.requestUpdate();i.length>0&&!e.done;){const r=i.pop(),n=this._index;t===ve.fadeout&&this.layerView.nodeFadeoutEnabled&&(0,a.pC)(n)&&n.isGeometryVisible(r)?this.layerView.fadeNode(r,_e.B.FadeOut,!0):this.layerView.removeNode(r),e.madeProgress()}if(this._loadedNodeScales.size>0)for(let r=i.length;r<s;r++)this._loadedNodeScales.delete(i.data[r])}}_needsUpdate(i){if(!i.resources.hasFeatureData||this._updatingNodes.has(i.index))return!1;const e=this.layerView.getLoadedAttributes(i.index);return null!=e&&e!==this._requiredAttributes}_updateLoadedNode(i){const e=new AbortController;this._updatingNodes.set(i.index,e),(Se(this.layerView.getLoadedAttributes(i.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(i.index)):this._nodeLoader.loadAttributes(i,this._requiredAttributes,e.signal)).then(t=>this.schedule(()=>this.layerView.updateAttributes(i.index,{loadedAttributes:this._requiredAttributes,attributeData:t},e.signal),e.signal)).catch(t=>{if(!(0,m.D_)(t))return this.layerView.updateAttributes(i.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},e.signal)}).catch(()=>{}).then(()=>{this._updatingNodes.delete(i.index),this._evaluateUpdating()}),this._evaluateUpdating()}_loadNode(i){if(this._loadingNodes.has(i.index))return void fe.error("already loading node "+i.index);const e=new AbortController;this._loadingNodes.set(i.index,e),this._evaluateUpdating(),this._loadAndAddNode(i,e.signal).then(t=>{t&&(0,a.pC)(this._index)&&this._loadingNodes.get(i.index)===e&&(this._loadingNodes.delete(i.index),this._index.requestUpdate())}).catch(t=>{if(!(0,m.D_)(t))throw t}).finally(()=>{this._loadingNodes.get(i.index)===e&&this._loadingNodes.delete(i.index),this._evaluateUpdating()})}_loadAndAddNode(i,e){return i.cacheState===u.Hw.Uncached?this._loadUncached(i,e).then(()=>!1):this._loadCached(i,e).then(t=>!t&&(i.cacheState=u.Hw.Uncached,!0)).catch(t=>!(0,m.D_)(t)&&(i.cacheState=u.Hw.Uncached,!0))}_enableFromGPUCache(i,e){if(this._disableMemCache||(0,a.Wi)(this._index))return!1;if(e===u.FE.Hole&&!this._index.useNodeAsHole(i.index))return!0;const t=this._loadCachedGPUData(i);return!!t&&(this.layerView.addCachedGPUData(i,t,e),this._nodeAdded(),!0)}_loadCachedGPUData(i){const e=this.layerView.loadCachedGPUData(i);return(0,a.pC)(e)&&(0,a.pC)(e.attributeInfo)&&Se(e.attributeInfo.loadedAttributes,this._requiredAttributes)?e:(this.layerView.deleteCachedGPUData(e),null)}_nodeAdded(){(0,a.pC)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateLoadStatus(i,e){const t=this._index;(0,a.pC)(t)&&t.updateChildrenLoaded(i,e?1:-1)}_loadCached(i,e){if(this._enableFromGPUCache(i,u.FE.Leaf))return Promise.resolve(!0);const t=this.layerView;return!this.disableIDBCache&&t.loadCachedNodeData&&t.addCachedNodeData?this.schedule(()=>t.loadCachedNodeData(i,e,(s,r)=>this._nodeLoader.loadTextures(i,s,r)),e).then(s=>{if((0,a.Wi)(s))return!1;const r=this._requiredAttributes;return this.reschedule(()=>this._nodeLoader.loadAttributes(i,r,e),e).then(n=>this.reschedule(()=>t.addCachedNodeData(i,s,{loadedAttributes:r,attributeData:n},e),e)).then(()=>(this._nodeAdded(),!0))}):Promise.resolve(!1)}_loadUncached(i,e){return this._downloadingCount++,this._nodeLoader.loadNodeData(i,e).catch(t=>{throw this._downloadingCount--,t}).then(t=>(this._downloadingCount--,this.schedule(()=>this.layerView.addNode(i,t,e),e))).then(()=>{this._nodeAdded(),i.cacheState=u.Hw.Cached}).catch(t=>{if(!(0,m.D_)(t))throw fe.error("#loadNodeData()",this.layer,`Failed to load node '${i.id}'`,t),i.failed=!0,(0,a.pC)(this._index)&&this._index.requestUpdate(),t})}_updateIdleState(i){i!==this._isIdle&&(this._isIdle=i,this._evaluateUpdating(),i&&this._index&&(0,a.pC)(this._index)&&this._index.resetFailedNodes())}_getScale(i){if(this._loadedNodeScales.has(i.index))return this._loadedNodeScales.get(i.index);const e=this._computeScale(i);return this.layerView.isNodeLoaded(i.index)&&this._loadedNodeScales.set(i.index,e),e}_computeScale(i){return this._tmpPoint.x=i.mbs[0],this._tmpPoint.y=i.mbs[1],this._tmpPoint.z=i.mbs[2],this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,i.mbs[3])}_isNodeInScaleBounds(i){if(!this._areScaleBoundsActive)return!0;const e=this._getScale(i),{minScale:t,maxScale:s}=(0,Le.lu)(this.layer);return(0,Le.rs)(e,t,s)}updateStats(i){i.index=(0,a.pC)(this._index)?this._index.size:0,this.isGraphics3D&&(i.detail=this._featureLOD,i.target=this.featureTarget*this._baseLOD),(0,a.pC)(this._index)&&this._index.updateStats(i)}get test(){const i=this;return{index:this._index,set disableUpdates(e){i._updatesDisabled=e,e?i.cancelNodeLoading():i.requestUpdate()},set disableIDBCache(e){i.disableIDBCache=e},set ignoreServiceObb(e){(0,a.pC)(i._index)&&(i._index.ignoreServiceObb=e)},shouldLoadNode:e=>i._shouldLoadNode(e)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),(0,a.pC)(this._index)&&this._index.requestUpdate()}geometryFilterChanged(i){const e=this._index;(0,a.pC)(e)&&e.layerFilterChanged(i),this._setCameraDirty()}};(0,D._)([(0,g.Cb)({readOnly:!0})],K.prototype,"isMeshPyramid",null),(0,D._)([(0,g.Cb)({readOnly:!0})],K.prototype,"isGraphics3D",null),(0,D._)([(0,g.Cb)({readOnly:!0})],K.prototype,"useMaximumNumberOfFeatures",null),(0,D._)([(0,g.Cb)({readOnly:!0})],K.prototype,"indexStreamController",null),(0,D._)([(0,g.Cb)({readOnly:!0})],K.prototype,"dataStreamController",null),(0,D._)([(0,g.Cb)({readOnly:!0})],K.prototype,"crsVertex",null),(0,D._)([(0,g.Cb)({readOnly:!0})],K.prototype,"crsIndex",null),(0,D._)([(0,g.Cb)()],K.prototype,"screenSizeFactor",void 0),(0,D._)([(0,g.Cb)()],K.prototype,"featureTarget",void 0),(0,D._)([(0,g.Cb)()],K.prototype,"fixedFeatureTarget",void 0),(0,D._)([(0,g.Cb)()],K.prototype,"layerView",void 0),(0,D._)([(0,g.Cb)()],K.prototype,"layer",null),(0,D._)([(0,g.Cb)({})],K.prototype,"updating",void 0),(0,D._)([(0,g.Cb)({})],K.prototype,"updatingProgress",void 0),(0,D._)([(0,g.Cb)({readOnly:!0})],K.prototype,"leavesReached",void 0),(0,D._)([(0,g.Cb)({constructOnly:!0})],K.prototype,"scaleVisibilityEnabled",void 0),(0,D._)([(0,g.Cb)({readOnly:!0,dependsOn:[]})],K.prototype,"rootNodeVisible",null),K=(0,D._)([(0,re.j)(Be)],K);const ie=new O.Z({deallocator:null});let Me;function Se(i,e){return(0,a.pC)(i)&&i.length===e.length&&i.every(t=>Ee(e,t.name)>=0)}function Ee(i,e){const t=e.toLowerCase();for(let s=0;s<i.length;s++)if(i[s].name.toLowerCase()===t)return s;return-1}const He={factorIM:.2,factor3dObject:.05,distancePenalty:10},xe=(0,ne.Ue)();var ve,i;(i=ve||(ve={}))[i.pop=0]="pop",i[i.fadeout=1]="fadeout";const ut=K},16446:(le,Z,l)=>{l.r(Z),l.d(Z,{default:()=>Q});var D=l(17626),E=l(26584),y=l(62208),b=l(77712),O=(l(85931),l(90912),l(76898)),W=l(55915),m=l(35560),R=l(50126);let g=class extends R.Z{constructor(){super(...arguments),this.type="feature-3d",this.direct3DObjectFeatureLayerDisplayEnabled=(0,m.hq)()}initialize(){"capabilities"in this.layer&&this.layer.capabilities.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new E.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:this.layer}))),(0,y.pC)(this.layer.infoFor3D)&&(this.direct3DObjectFeatureLayerDisplayEnabled?this._set("suspendResumeExtentMode","computed"):this.addResolvingPromise(Promise.reject(new E.Z("featurelayerview3d:unsupported-geometry-type",`Unsupported geometry type ${this.layer.geometryType}`)))),"mesh"!==this.layer.geometryType||(0,W.Up)(this.layer.spatialReference,this.view.spatialReference)||this.addResolvingPromise(Promise.reject(new E.Z("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}get featureSpatialReference(){return this.view.featureTiles?.tilingScheme?.spatialReference}};(0,D._)([(0,b.Cb)({constructOnly:!0})],g.prototype,"direct3DObjectFeatureLayerDisplayEnabled",void 0),(0,D._)([(0,b.Cb)()],g.prototype,"layer",void 0),g=(0,D._)([(0,O.j)("esri.views.3d.layers.FeatureLayerView3D")],g);const Q=g},42767:(le,Z,l)=>{l.d(Z,{K0:()=>oe,Pg:()=>ne,R0:()=>Q,RE:()=>ce,cU:()=>ae,dY:()=>te,nn:()=>ye});var D=l(8314),E=l(21286),y=l(62208),b=l(81937),w=l(52051),a=l(92724),O=l(67022),W=l(22799),m=l(42743),R=l(81695),g=l(67969);function Q(u,f){const V=new Map,c=(S,k)=>{if((0,y.Wi)(S))return-1;if(V.has(S.id)){const X=V.get(S.id);return X.usage|=k,X.id}const Y=V.size;return V.set(S.id,{id:Y,usage:k}),Y},h=f.pbrMetallicRoughness,_=h&&h.baseColorFactor,N=f.emissiveFactor,C=null==f.normalTexture&&null==f.emissiveTexture&&null==f.occlusionTexture&&(!h||null==h.metallicRoughnessTexture&&1===h.roughnessFactor&&(1===h.metallicFactor||0===h.metallicFactor)),P=C?a.Fw[0]:h?h.metallicFactor:1,F=C?a.Fw[1]:h?h.roughnessFactor:1,U={baseColorFactor:_?[_[0],_[1],_[2],_[3]]:[1,1,1,1],baseColorTextureId:c(h&&h.baseColorTexture,"mask"===f.alphaMode?b.v.Color|b.v.AlphaMask:b.v.Color),metallicRoughnessTextureId:c(h&&h.metallicRoughnessTexture,b.v.MetallicRoughness),metallicFactor:P,roughnessFactor:F},B={alphaMode:f.alphaMode,alphaCutoff:f.alphaCutoff,doubleSided:f.doubleSided,cullFace:"none"===f.cullFace?m.Vr.None:"back"===f.cullFace?m.Vr.Back:"front"===f.cullFace?m.Vr.Front:void 0,normalTextureId:c(f.normalTexture,b.v.Normal),emissiveTextureId:c(f.emissiveTexture,b.v.Emissive),occlusionTextureId:c(f.occlusionTexture,b.v.Occlusion),emissiveFactor:N?[N[0],N[1],N[2]]:[0,0,0],metallicRoughness:U,wrapTextures:!1,hasParametersFromSource:C},G=[];return V.forEach(({usage:S},k)=>{const Y=(0,y.pC)(u)&&u[k]&&u[k].formats,X=Y?ee(Y.map(({name:ge,format:_e})=>({name:ge,encoding:re[_e]}))):[];G.push({id:k,usage:S,encodings:X})}),{material:B,textures:G}}function ee(u){return u.sort((f,V)=>f.encoding-V.encoding)}const re={ktx2:b.j.KTX2,basis:b.j.Basis,dds:b.j.DDS_S3TC,png:b.j.PNG,jpg:b.j.JPG,"ktx-etc2":b.j.KTX_ETC2},q={[R.x.KTX2_ENCODING]:b.j.Basis,[R.x.BASIS_ENCODING]:b.j.Basis,[R.x.DDS_ENCODING]:b.j.DDS_S3TC,"image/png":b.j.PNG,"image/jpg":b.j.JPG,"image/jpeg":b.j.JPG,"image/ktx":b.j.KTX_ETC2};function ne(u){const f=u&&u.materialDefinitions?Object.keys(u.materialDefinitions)[0]:null,V=u&&u.textureDefinitions?Object.keys(u.textureDefinitions)[0]:null,c=f&&u.materialDefinitions[f],h=V&&u.textureDefinitions[V],_=te();if(null!=c){const C=c.params;C.diffuse&&(_.metallicRoughness.baseColorFactor=[C.diffuse[0],C.diffuse[1],C.diffuse[2],1]),null!=C.doubleSided&&(_.doubleSided=C.doubleSided,_.cullFace=C.doubleSided?m.Vr.None:m.Vr.Back),"none"!==C.cullFace&&"front"!==C.cullFace&&"back"!==C.cullFace||(_.cullFace="none"===C.cullFace?m.Vr.None:"back"===C.cullFace?m.Vr.Back:m.Vr.Front),C.transparency&&(_.metallicRoughness.baseColorFactor[3]=(0,E.uZ)(1-C.transparency,0,1)),(C.useVertexColorAlpha||_.metallicRoughness.baseColorFactor[3]<1)&&(_.alphaMode="blend")}const N=[];if(null!=h){!h.wrap||"repeat"!==h.wrap[0]&&"repeat"!==h.wrap[1]||(_.wrapTextures=!0);let P=b.v.Color;"rgba"===h.channels&&(_.alphaMode="blend",P|=b.v.AlphaMask);const A=h.images[h.images.length-1],U=G=>G&&G.split("/").pop(),B=Array.isArray(h.encoding)?ee(h.encoding.map((G,S)=>({name:U(A.href[S]),encoding:q[G]||0}))):[{name:U(A.href),encoding:q[h.encoding]||0}];N.push({id:0,usage:P,encodings:B}),_.metallicRoughness.baseColorTextureId=0}return{material:_,textures:N}}const te=()=>({alphaMode:"opaque",alphaCutoff:O.F,doubleSided:!0,cullFace:m.Vr.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});function ae(u,f,V,c){if((0,y.Wi)(u)||null==u.data)return null;const h=u.data,_=!(h instanceof HTMLImageElement)||(0,E.wt)(h.width)&&(0,E.wt)(h.height),C=V&&!c.capabilities.shaderTextureLOD?1:c.renderingContext.parameters.maxMaxAnisotropy,P=_&&!u.downsampled&&C>1,F=V||!f.wrapTextures?he:ue,A=function me(u){switch(u){case b.j.KTX2:return R.x.KTX2_ENCODING;case b.j.Basis:return R.x.BASIS_ENCODING;case b.j.DDS_S3TC:return R.x.DDS_ENCODING;case b.j.PNG:return"image/png";case b.j.JPG:return"image/jpeg";case b.j.KTX_ETC2:return"image/ktx";default:return""}}(u.encoding);return new R.x(h,{mipmap:P,maxAnisotropy:C,encoding:A,wrap:F,components:u.usage&b.v.Color?"opaque"===f.alphaMode?3:4:3,noUnpackFlip:!0})}const he={s:g.e8.CLAMP_TO_EDGE,t:g.e8.CLAMP_TO_EDGE},ue={s:g.e8.REPEAT,t:g.e8.REPEAT};function ce(u,f,V,c,h,_){const N=_.rendererTextureUsage,C=Y=>function L(u,f,V){if((0,y.Wi)(u)||V===b.v.None)return null;for(let c=0;c<u.length;c++){const h=u[c];if((0,y.pC)(h)&&0!=(h.usage&V)){const _=f[c];return(0,y.pC)(_)?_.id:null}}return null}(c,V,Y&N),P=f.metallicRoughness.baseColorFactor,F=(0,E.uZ)(f.metallicRoughness.baseColorFactor[3],0,1);u.baseColor=[P[0],P[1],P[2],F],u.hasParametersFromSource=!!f.hasParametersFromSource,u.usePBR=_.usePBR,u.mrrFactors=[f.metallicRoughness.metallicFactor,f.metallicRoughness.roughnessFactor,f.hasParametersFromSource?.2:.5],u.emissiveFactor=f.emissiveFactor,u.isIntegratedMesh=_.isIntegratedMesh,u.textureAlphaCutoff="mask"===f.alphaMode?f.alphaCutoff:O.F,u.alphaDiscardMode="opaque"===f.alphaMode?m.JJ.Opaque:"mask"===f.alphaMode?m.JJ.Mask:m.JJ.MaskBlend;const A=[],U=C(b.v.Color|b.v.AlphaMask);(0,y.pC)(U)&&(u.baseColorTexture=new w.T(h,U),A.push(u.baseColorTexture.loadPromise));const B=C(b.v.MetallicRoughness);(0,y.pC)(B)&&(u.metallicRoughnessTexture=new w.T(h,B),A.push(u.metallicRoughnessTexture.loadPromise));const G=C(b.v.Emissive);(0,y.pC)(G)&&(u.emissionTexture=new w.T(h,G),A.push(u.emissionTexture.loadPromise));const S=C(b.v.Occlusion);(0,y.pC)(S)&&(u.occlusionTexture=new w.T(h,S),A.push(u.occlusionTexture.loadPromise));const k=C(b.v.Normal);return(0,y.pC)(k)&&(u.normalTexture=new w.T(h,k),A.push(u.normalTexture.loadPromise)),u.commonMaterialParameters.hasSlicePlane=_.slicePlaneEnabled,u.commonMaterialParameters.doubleSided=f.doubleSided,u.commonMaterialParameters.cullFace=f.cullFace,u.ellipsoidMode=(0,W.j)(_.viewSpatialReference),Promise.all(A)}function oe(u){const f=!!u.compressedTextureS3TC,V=!!u.compressedTextureETC,c=(0,D.Z)("disable-feature:i3s-basis")?0:b.j.Basis|b.j.KTX2;return b.j.JPG|b.j.PNG|(f?c|b.j.DDS_S3TC:0)|(V?c:0)}function ye(u,f){return u.find(V=>0!=(V.encoding&f))}},52565:(le,Z,l)=>{l.d(Z,{$i:()=>E,FE:()=>W,Hw:()=>a,NB:()=>m,O4:()=>w,U_:()=>b,oQ:()=>R,rw:()=>y,w5:()=>O});var b,w,a,O,W,g,D=l(97126);class E{constructor(Q,ee){this.id=Q,this.mbs=ee,this.renderMbs=(0,D.f)(0,0,0,-1),this.elevationRange=null}}class y{constructor(){this.min=1/0,this.max=-1/0,this.valid=!1}}(g=b||(b={}))[g.Unmodified=0]="Unmodified",g[g.Culled=1]="Culled",g[g.NotChecked=2]="NotChecked",function(g){g[g.Unmodified=0]="Unmodified",g[g.PotentiallyModified=1]="PotentiallyModified",g[g.Culled=2]="Culled",g[g.Unknown=3]="Unknown",g[g.NotChecked=4]="NotChecked"}(w||(w={}));class m extends E{constructor(Q,ee,re,q,ne,te,ae,he,ue,ce){super(Q,re),this.index=ee,this.childCount=q,this.level=ne,this.resources=te,this.version=ae,this.lodMetric=he,this.maxError=ue,this.numFeatures=ce,this.failed=!1,this.cacheState=a.Unknown,this.vertexCount=0,this.memory=0,this.childrenLoaded=0,this.hasModifications=!1,this.imModificationImpact=w.NotChecked}}(function(g){g[g.Unknown=0]="Unknown",g[g.Uncached=1]="Uncached",g[g.Cached=2]="Cached"})(a||(a={})),function(g){g[g.None=0]="None",g[g.MaxScreenThreshold=1]="MaxScreenThreshold",g[g.ScreenSpaceRelative=2]="ScreenSpaceRelative",g[g.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",g[g.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(O||(O={})),function(g){g[g.Hole=0]="Hole",g[g.Leaf=1]="Leaf"}(W||(W={}));class R{constructor(Q,ee,re,q){this.nodeHasLOD=Q,this.isChosen=ee,this.lodLevel=re,this.version=q}}},86152:(le,Z,l)=>{l.d(Z,{v:()=>L});var D=l(15861),E=l(17626),y=l(84792),b=l(14517),w=l(85931),a=l(59213),O=l(27306),W=l(63290),m=l(62208),R=l(10699),g=l(32917),Q=l(77712),re=(l(90912),l(76898)),q=l(15348),ne=l(96854);function te(c,h,_){return ae.apply(this,arguments)}function ae(){return(ae=(0,D.Z)(function*(c,h,_){h=h.clone(),c.capabilities.query.supportsMaxRecordCountFactor&&(h.maxRecordCountFactor=ce(c));const N=he(c),C=c.capabilities.query.supportsPagination;h.start=0,h.num=N;let P=null;for(;;){const F=yield c.source.queryFeaturesJSON(h,_);if((0,m.Wi)(P)?P=F:P.features=P.features.concat(F.features),P.exceededTransferLimit=F.exceededTransferLimit,!C||!F.exceededTransferLimit)break;h.start+=N}return P})).apply(this,arguments)}function he(c){return ce(c)*function ue(c){return c.capabilities.query.maxRecordCount||2e3}(c)}function ce(c){return c.capabilities.query.supportsMaxRecordCountFactor?ne.Z.MAX_MAX_RECORD_COUNT_FACTOR:1}var oe=l(35560),ye=l(16446);let L=class extends b.Z{constructor(c){super(c),this._warnMaximumChangedObjectsExceeded=!1,this._pendingFetchAbortController=new AbortController,this._interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=V,this._original3DOFLDefinitionExpression=null,this._associatedLayerView=null,this._changedObjectIds=new Set}initialize(){this._memCache=this.memoryController.newCache(`${this.layer.uid}-attribute-overrides`),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController.signal),this._pendingFetchChangedObjectIds.then(()=>this._pendingFetchAbortController=null),(0,oe.Rx)()&&(0,m.pC)(this._associatedLayer)&&(0,m.pC)(this._associatedLayer.infoFor3D)&&this._associatedLayer.load().then(c=>{this.destroyed||(this._original3DOFLDefinitionExpression=c.definitionExpression,this.addHandles((0,g.YP)(()=>this._definitionExpression,h=>c.definitionExpression=h,g.nn)),this._associatedLayerView=new ye.default({layer:this._associatedLayer,view:this.view}))})}destroy(){(0,oe.Rx)()&&(0,m.pC)(this._associatedLayer)&&(0,m.pC)(this._associatedLayer.infoFor3D)&&(0,m.pC)(this._associatedLayerView)&&(this._associatedLayer.definitionExpression=(0,m.Wg)(this._original3DOFLDefinitionExpression)),this._set("layer",null),this._memCache.destroy(),this._memCache=null,this._pendingFetchAbortController&&(this._pendingFetchAbortController.abort(),this._pendingFetchAbortController=null),this._pendingFetchChangedObjectIds=null}get geometryChangedObjectIds(){return[...this._changedObjectIds]}get _associatedLayer(){return this.layer.associatedLayer}get _definitionExpression(){const c=this.geometryChangedObjectIds;return 0===c.length?"1 = 0":`OBJECTID IN (${c.join(",")})`}get updating(){return!!((0,oe.Rx)()&&(0,m.pC)(this._associatedLayer)&&(0,m.pC)(this._associatedLayer.infoFor3D))&&(!(0,m.pC)(this._associatedLayerView)||(0,m.pC)(this._associatedLayerView)&&this._associatedLayerView.updating)}createInteractiveEditSession(c){this._changedObjectIds.add(c),this.notifyChange("_changedObjectIds"),(0,m.Wi)(this._interactiveEditingSessions)&&(this._interactiveEditingSessions=[]);const h=this._interactiveEditingSessions,_=new me(c,{rollback:()=>{(0,w.Od)(h,_),0===h.length&&(this._interactiveEditingSessions=null)},commit:N=>{for(const[C,P]of N)this.updateAttributeValue(c,C,P)}});return h.unshift(_),_}apply(c,h,_){var N=this;return(0,D.Z)(function*(){if((0,m.Wi)(h))return;const{loadedAttributes:C,attributeData:P}=h;if((0,m.Wi)(C)||0===C.length||(0,m.Wi)(P)||(yield(0,R.Hl)(N._pendingFetchChangedObjectIds,_),0===N._changedObjectIds.size))return;const F={loadedAttributes:C,attributeData:P},A=N._getOverridesFromCache(c,F,N._changedObjectIds),{objectIds:U,fieldNames:B}=A,G=yield N._queryOverridesFromAssociatedLayer(U,B,_);(0,m.Wi)(G)||N._processOverridesFromAssociatedLayer(c,G,B,F)})()}updateGeometry(c){this._changedObjectIds.add(c),this.notifyChange("_changedObjectIds")}updateAttributeValue(c,h,_){this._changedObjectIds.add(c),this._cacheAttributeValue(c,h,_),this.notifyChange("_changedObjectIds")}_cacheAttributeValue(c,h,_){this._memCache.put(this._getAttributeCacheKey(c,h),_,this._memCacheAttributeValueSize(_))}_getOverridesFromCache(c,{loadedAttributes:h,attributeData:_},N){const C=new Set,P=new Array;for(const A of h)P[A.index]=_[A.name];const F=new Set;for(let A=0;A<c.length;A++){const U=c[A];if(N.has(U))for(const B of h){const G=this._fromCache(U,B.index);void 0===G?(C.add(U),F.add(B.name)):P[B.index][A]=G}}return{objectIds:Array.from(C),fieldNames:Array.from(F)}}_fromCache(c,h){const _=this._fromInteractiveEditingSession(c,h);if(void 0!==_)return _;const N=this._getAttributeCacheKey(c,h);return this._memCache.get(N)}_fromInteractiveEditingSession(c,h){if(!(0,m.Wi)(this._interactiveEditingSessions))for(const _ of this._interactiveEditingSessions){if(_.objectId!==c)continue;const N=_.get(h);if(void 0!==N)return N}}_getAttributeCacheKey(c,h){return`${c}-${h}`}_queryOverridesFromAssociatedLayer(c,h,_){var N=this;return(0,D.Z)(function*(){if(0===c.length||0===h.length)return null;c=c.sort((U,B)=>U-B),N._warnMaximumChangedObjectsExceeded&&(N._warnMaximumChangedObjectsExceeded=!1,N._logMaximumObjectsExceededWarning());const C=N.layer.associatedLayer;if((0,m.Wi)(C))return null;const P=C.createQuery();P.where="1=1",P.returnGeometry=!1,P.outFields=[C.objectIdField,...h],P.cacheHint=!0,P.objectIds=c;const F=he(C),A=c.length>F?(0,w.vr)(c,F).map(U=>{const B=P.clone();return B.objectIds=U,(0,a.mt)(te(C,B,{signal:_}))}):[(0,a.mt)(te(C,P,{signal:_}))];return(yield Promise.all(A)).reduce((U,B)=>U.concat(B.ok?B.value.features:[]),[])})()}_logMaximumObjectsExceededWarning(){let c=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${(0,q.uf)(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const h=this.layer.portalItem;c+=h&&h.loaded?` (${h.portal.url}/home/item.html?id=${h.id}#settings)`:` (${this.layer.parsedUrl.path})`,W.Z.getLogger("esri.views.3d.layers.i3s.I3SOverrides").warn("#queryOverrides()",this.layer.title,`${c}.`)}_processOverridesFromAssociatedLayer(c,h,_,{loadedAttributes:N,attributeData:C}){const P=this.layer.associatedLayer;if((0,m.Wi)(P))return;const F=P.objectIdField,A=_.map(S=>C[S]),U=new Map(N.map(S=>[S.name,S.index])),B=_.map(S=>U.get(S)),G=new Map(Array.from(c,(S,k)=>[S,k]));for(const S of h){const k=S.attributes[F];for(let Y=0;Y<_.length;Y++){const X=B[Y],ge=G.get(k),_e=S.attributes[_[Y]];A[Y][ge]=_e,this._cacheAttributeValue(k,X,_e)}}}_memCacheAttributeValueSize(c){return"string"==typeof c?(0,O.hH)(c):(0,O.G3)()}_fetchChangedObjectIds(c){var h=this;return(0,D.Z)(function*(){const _=h.layer;if(yield _.load({signal:c}),h._changedObjectIds.clear(),(0,m.Wi)(_.associatedLayer)||!_.associatedLayer.capabilities?.operations?.supportsChangeTracking)return;const N=h._getFetchChangedObjectIdsServerGen();if((0,m.Wi)(N))return null;const C=_.associatedLayer.layerId,P=(0,m.pC)(_.associatedLayer.infoFor3D),F=yield(0,a.q6)((0,y.default)(`${_.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`[${C}]`,returnUpdates:!0,returnDeletes:P,returnInserts:P,layerServerGens:JSON.stringify([{id:C,serverGen:N}])},timeout:f,signal:c}));if(F.ok&&F.value.data?.edits&&1===F.value.data.edits.length){const A=F.value.data.edits[0],U=(0,m.U2)(A,"objectIds","adds"),B=(0,m.U2)(A,"objectIds","updates"),G=(0,m.U2)(A,"objectIds","deletes");let S=[];(0,m.pC)(U)&&(S=S.concat(U)),(0,m.pC)(B)&&(S=S.concat(B)),(0,m.pC)(G)&&(S=S.concat(G));const k=Math.min(h._maximumNumberOfEditOVerrides,S.length);k<S.length&&(h._warnMaximumChangedObjectsExceeded=!0);const Y=S.sort((X,ge)=>X-ge);for(let X=0;X<k;X++)h._changedObjectIds.add(Y[X])}h.notifyChange("_changedObjectIds")})()}_getFetchChangedObjectIdsServerGen(){const c=this.layer;if((0,m.pC)(c.serviceUpdateTimeStamp)&&(0,m.pC)(c.serviceUpdateTimeStamp.lastUpdate))return c.serviceUpdateTimeStamp.lastUpdate;const h=c.associatedLayer;return(0,m.pC)(h)&&(0,m.pC)(h.serverGens)&&(0,m.pC)(h.serverGens.minServerGen)?h.serverGens.minServerGen:null}get test(){const c=Array.from(this._changedObjectIds),_=this;return{changedObjectIds:c,pendingFetchChangedObjectIds:this._pendingFetchChangedObjectIds,get maximumNumberOfEditOVerrides(){return _._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(N){_._maximumNumberOfEditOVerrides=N}}}};(0,E._)([(0,Q.Cb)({constructOnly:!0})],L.prototype,"view",void 0),(0,E._)([(0,Q.Cb)({constructOnly:!0})],L.prototype,"layer",void 0),(0,E._)([(0,Q.Cb)({readOnly:!0})],L.prototype,"geometryChangedObjectIds",null),(0,E._)([(0,Q.Cb)()],L.prototype,"_associatedLayer",null),(0,E._)([(0,Q.Cb)()],L.prototype,"_associatedLayerView",void 0),(0,E._)([(0,Q.Cb)({constructOnly:!0})],L.prototype,"memoryController",void 0),(0,E._)([(0,Q.Cb)()],L.prototype,"_changedObjectIds",void 0),(0,E._)([(0,Q.Cb)()],L.prototype,"_definitionExpression",null),(0,E._)([(0,Q.Cb)()],L.prototype,"updating",null),L=(0,E._)([(0,re.j)("esri.views.3d.layers.i3s.I3SOverrides")],L);class me{constructor(h,_){this.objectId=h,this._options=_,this._updates=new Map,this._state=u.ACTIVE}get(h){return this._updates.get(h)}set(h,_){this._isActive&&this._updates.set(h,_)}rollback(){this._isActive&&(this._state=u.ROLLED_BACK,this._options.rollback())}commit(){this._isActive&&(this._state=u.COMMITTED,this._options.commit(this._updates),this._updates.clear())}get _isActive(){return this._state===u.ACTIVE}}var u,c;(c=u||(u={}))[c.ACTIVE=0]="ACTIVE",c[c.COMMITTED=1]="COMMITTED",c[c.ROLLED_BACK=2]="ROLLED_BACK";const f=1e4,V=5e4},81937:(le,Z,l)=>{var D,E,y;l.d(Z,{j:()=>D,v:()=>E}),(y=D||(D={}))[y.KTX2=1]="KTX2",y[y.Basis=2]="Basis",y[y.DDS_S3TC=4]="DDS_S3TC",y[y.PNG=8]="PNG",y[y.JPG=16]="JPG",y[y.KTX_ETC2=32]="KTX_ETC2",function(y){y[y.None=0]="None",y[y.Color=1]="Color",y[y.MetallicRoughness=2]="MetallicRoughness",y[y.Normal=4]="Normal",y[y.Occlusion=8]="Occlusion",y[y.Emissive=16]="Emissive",y[y.AlphaMask=32]="AlphaMask",y[y.ColorTextures=19]="ColorTextures",y[y.GeometryTextures=36]="GeometryTextures",y[y.GeometryTexturesPBR=44]="GeometryTexturesPBR",y[y.AllTextures=37]="AllTextures",y[y.AllTexturesPBR=63]="AllTexturesPBR"}(E||(E={}))},73683:(le,Z,l)=>{var D,E;l.d(Z,{B:()=>D}),(E=D||(D={}))[E.FadeIn=0]="FadeIn",E[E.FadeOut=1]="FadeOut"},44554:(le,Z,l)=>{l.d(Z,{f:()=>y});var D=l(61885),E=l(88159);class y extends D.Z{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const w=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:w})}}get length(){return this._map.size}get(w){return this._map.get(w)}addMany(w){if(0===w.length)return;const a=new Set;for(let W=0;W<w.length;W++){const m=w[W],R=m.objectId,g=this._map.get(R);g?(a.add(R),m!==g&&(w[W]=g),++g.refCount):(m.refCount=1,this._map.set(R,m))}const O=a.size>0?w.filter(W=>!a.has(W.objectId)):w;O.length>0&&this.emit("change",{added:O,removed:[]})}removeMany(w){const a=[];for(const O of w){const W=O.objectId,m=this._map.get(W);null!=m&&--m.refCount<=0&&(this._map.delete(W),a.push(O))}a.length>0&&this.emit("change",{added:[],removed:a})}removeManyByObjectId(w){const a=[];for(const O of w){const W=this._map.get(O);null!=W&&--W.refCount<=0&&(this._map.delete(O),a.push(W))}a.length>0&&this.emit("change",{added:[],removed:a})}toArray(){return[...this._map.values()]}find(w){let a;return(0,E.oE)(this._map,O=>!!w(O)&&(a=O,!0)),a}forEach(w){this._map.forEach(a=>w(a))}}},52051:(le,Z,l)=>{l.d(Z,{T:()=>y});var D=l(62208),E=l(10699);class y{constructor(w,a){this._textureRep=w,this._disposed=!1;const O=this._textureRep.acquire(a);(0,E.y8)(O)?(O.then(W=>{this._disposed?(0,D.RY)(W):this._textureRef=W}),this.loadPromise=O):this._textureRef=O}dispose(){this._textureRef=(0,D.RY)(this._textureRef),this._disposed=!0}get glTexture(){return(0,D.pC)(this._textureRef)?this._textureRef.glTexture:null}}}}]);