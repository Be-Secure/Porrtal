"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[1288],{76279:(Ne,xe,O)=>{O.d(xe,{r:()=>ae});var Z=O(14259);function ae(A,E){if(!(this instanceof ae))return new ae(A,E);this._maxEntries=Math.max(4,A||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),E&&("function"==typeof E?this.toBBox=E:this._initFormat(E)),this.clear()}function X(A,E,N){if(!N)return E.indexOf(A);for(var z=0;z<E.length;z++)if(N(A,E[z]))return z;return-1}function R(A,E){q(A,0,A.children.length,E,A)}function q(A,E,N,z,H){H||(H=P(null)),H.minX=1/0,H.minY=1/0,H.maxX=-1/0,H.maxY=-1/0;for(var re,L=E;L<N;L++)re=A.children[L],$(H,A.leaf?z(re):re);return H}function $(A,E){return A.minX=Math.min(A.minX,E.minX),A.minY=Math.min(A.minY,E.minY),A.maxX=Math.max(A.maxX,E.maxX),A.maxY=Math.max(A.maxY,E.maxY),A}function Ie(A,E){return A.minX-E.minX}function Y(A,E){return A.minY-E.minY}function se(A){return(A.maxX-A.minX)*(A.maxY-A.minY)}function ce(A){return A.maxX-A.minX+(A.maxY-A.minY)}function V(A,E){return(Math.max(E.maxX,A.maxX)-Math.min(E.minX,A.minX))*(Math.max(E.maxY,A.maxY)-Math.min(E.minY,A.minY))}function k(A,E){var N=Math.max(A.minX,E.minX),z=Math.max(A.minY,E.minY),H=Math.min(A.maxX,E.maxX),re=Math.min(A.maxY,E.maxY);return Math.max(0,H-N)*Math.max(0,re-z)}function w(A,E){return A.minX<=E.minX&&A.minY<=E.minY&&E.maxX<=A.maxX&&E.maxY<=A.maxY}function j(A,E){return E.minX<=A.maxX&&E.minY<=A.maxY&&E.maxX>=A.minX&&E.maxY>=A.minY}function P(A){return{children:A,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function W(A,E,N,z,H){for(var re,L=[E,N];L.length;)(N=L.pop())-(E=L.pop())<=z||(re=E+Math.ceil((N-E)/z/2)*z,(0,Z.q)(A,re,E,N,H),L.push(E,re,re,N))}ae.prototype={all:function(){return this._all(this.data,[])},search:function(A){var E=this.data,N=[],z=this.toBBox;if(!j(A,E))return N;for(var H,re,L,J,te=[];E;){for(H=0,re=E.children.length;H<re;H++)L=E.children[H],j(A,J=E.leaf?z(L):L)&&(E.leaf?N.push(L):w(A,J)?this._all(L,N):te.push(L));E=te.pop()}return N},collides:function(A){var E=this.data,N=this.toBBox;if(!j(A,E))return!1;for(var z,H,re,L,J=[];E;){for(z=0,H=E.children.length;z<H;z++)if(re=E.children[z],j(A,L=E.leaf?N(re):re)){if(E.leaf||w(A,L))return!0;J.push(re)}E=J.pop()}return!1},load:function(A){if(!A||!A.length)return this;if(A.length<this._minEntries){for(var E=0,N=A.length;E<N;E++)this.insert(A[E]);return this}var z=this._build(A.slice(),0,A.length-1,0);if(this.data.children.length)if(this.data.height===z.height)this._splitRoot(this.data,z);else{if(this.data.height<z.height){var H=this.data;this.data=z,z=H}this._insert(z,this.data.height-z.height-1,!0)}else this.data=z;return this},insert:function(A){return A&&this._insert(A,this.data.height-1),this},clear:function(){return this.data=P([]),this},remove:function(A,E){if(!A)return this;for(var N,z,H,re,L=this.data,J=this.toBBox(A),te=[],ue=[];L||te.length;){if(L||(L=te.pop(),z=te[te.length-1],N=ue.pop(),re=!0),L.leaf&&-1!==(H=X(A,L.children,E)))return L.children.splice(H,1),te.push(L),this._condense(te),this;re||L.leaf||!w(L,J)?z?(N++,L=z.children[N],re=!1):L=null:(te.push(L),ue.push(N),N=0,z=L,L=L.children[0])}return this},toBBox:function(A){return A},compareMinX:Ie,compareMinY:Y,toJSON:function(){return this.data},fromJSON:function(A){return this.data=A,this},_all:function(A,E){for(var N=[];A;)A.leaf?E.push.apply(E,A.children):N.push.apply(N,A.children),A=N.pop();return E},_build:function(A,E,N,z){var H,re=N-E+1,L=this._maxEntries;if(re<=L)return R(H=P(A.slice(E,N+1)),this.toBBox),H;z||(z=Math.ceil(Math.log(re)/Math.log(L)),L=Math.ceil(re/Math.pow(L,z-1))),(H=P([])).leaf=!1,H.height=z;var J,te,ue,he,Ce=Math.ceil(re/L),Ge=Ce*Math.ceil(Math.sqrt(L));for(W(A,E,N,Ge,this.compareMinX),J=E;J<=N;J+=Ge)for(W(A,J,ue=Math.min(J+Ge-1,N),Ce,this.compareMinY),te=J;te<=ue;te+=Ce)he=Math.min(te+Ce-1,ue),H.children.push(this._build(A,te,he,z-1));return R(H,this.toBBox),H},_chooseSubtree:function(A,E,N,z){for(var H,re,L,J,te,ue,he,Ce;z.push(E),!E.leaf&&z.length-1!==N;){for(he=Ce=1/0,H=0,re=E.children.length;H<re;H++)te=se(L=E.children[H]),(ue=V(A,L)-te)<Ce?(Ce=ue,he=te<he?te:he,J=L):ue===Ce&&te<he&&(he=te,J=L);E=J||E.children[0]}return E},_insert:function(A,E,N){var H=N?A:(0,this.toBBox)(A),re=[],L=this._chooseSubtree(H,this.data,E,re);for(L.children.push(A),$(L,H);E>=0&&re[E].children.length>this._maxEntries;)this._split(re,E),E--;this._adjustParentBBoxes(H,re,E)},_split:function(A,E){var N=A[E],z=N.children.length,H=this._minEntries;this._chooseSplitAxis(N,H,z);var re=this._chooseSplitIndex(N,H,z),L=P(N.children.splice(re,N.children.length-re));L.height=N.height,L.leaf=N.leaf,R(N,this.toBBox),R(L,this.toBBox),E?A[E-1].children.push(L):this._splitRoot(N,L)},_splitRoot:function(A,E){this.data=P([A,E]),this.data.height=A.height+1,this.data.leaf=!1,R(this.data,this.toBBox)},_chooseSplitIndex:function(A,E,N){var z,H,re,L,J,te,ue,he;for(te=ue=1/0,z=E;z<=N-E;z++)L=k(H=q(A,0,z,this.toBBox),re=q(A,z,N,this.toBBox)),J=se(H)+se(re),L<te?(te=L,he=z,ue=J<ue?J:ue):L===te&&J<ue&&(ue=J,he=z);return he},_chooseSplitAxis:function(A,E,N){var z=A.leaf?this.compareMinX:Ie,H=A.leaf?this.compareMinY:Y;this._allDistMargin(A,E,N,z)<this._allDistMargin(A,E,N,H)&&A.children.sort(z)},_allDistMargin:function(A,E,N,z){A.children.sort(z);var H,re,L=this.toBBox,J=q(A,0,E,L),te=q(A,N-E,N,L),ue=ce(J)+ce(te);for(H=E;H<N-E;H++)re=A.children[H],$(J,A.leaf?L(re):re),ue+=ce(J);for(H=N-E-1;H>=E;H--)re=A.children[H],$(te,A.leaf?L(re):re),ue+=ce(te);return ue},_adjustParentBBoxes:function(A,E,N){for(var z=N;z>=0;z--)$(E[z],A)},_condense:function(A){for(var E,N=A.length-1;N>=0;N--)0===A[N].children.length?N>0?(E=A[N-1].children).splice(E.indexOf(A[N]),1):this.clear():R(A[N],this.toBBox)},_initFormat:function(A){var E=["return a"," - b",";"];this.compareMinX=new Function("a","b",E.join(A[0])),this.compareMinY=new Function("a","b",E.join(A[1])),this.toBBox=new Function("a","return {minX: a"+A[0]+", minY: a"+A[1]+", maxX: a"+A[2]+", maxY: a"+A[3]+"};")}}},7547:(Ne,xe,O)=>{var Z,ae,X,R,q,$,Ie,Y,se,ce,V,k,w,j,P,W,A,E,N,z,H,re,L,J,te,ue,he,Ce,Ge,Te,Et,we,dt,rt,Mt,ct,gt,wt,Dt,He,ft,pt,We,Rt,qe,it,Ut,Bt,kt,nt,at,Je,Lt,_t,jt,ot,Qe,mt,yt,ut,Ot,S;O.d(xe,{$y:()=>re,AH:()=>ae,CS:()=>Ut,DD:()=>Y,Dd:()=>Ge,Em:()=>H,JS:()=>qe,Ky:()=>se,Lh:()=>Bt,Qb:()=>Qe,RL:()=>Z,RS:()=>yt,TF:()=>z,Tx:()=>q,UR:()=>A,UX:()=>ot,bj:()=>it,eZ:()=>Ie,id:()=>te,kP:()=>ct,r4:()=>He,sj:()=>gt,v2:()=>X,zQ:()=>Ce,zV:()=>W}),(S=Z||(Z={}))[S.BUTT=0]="BUTT",S[S.ROUND=1]="ROUND",S[S.SQUARE=2]="SQUARE",S[S.UNKNOWN=4]="UNKNOWN",function(S){S[S.BEVEL=0]="BEVEL",S[S.ROUND=1]="ROUND",S[S.MITER=2]="MITER",S[S.UNKNOWN=4]="UNKNOWN"}(ae||(ae={})),function(S){S[S.SCREEN=0]="SCREEN",S[S.MAP=1]="MAP"}(X||(X={})),function(S){S[S.Tint=0]="Tint",S[S.Ignore=1]="Ignore",S[S.Multiply=99]="Multiply"}(R||(R={})),function(S){S.Both="Both",S.JustBegin="JustBegin",S.JustEnd="JustEnd",S.None="None"}(q||(q={})),function(S){S[S.Mosaic=0]="Mosaic",S[S.Centered=1]="Centered"}($||($={})),function(S){S[S.Normal=0]="Normal",S[S.Superscript=1]="Superscript",S[S.Subscript=2]="Subscript"}(Ie||(Ie={})),function(S){S[S.MSSymbol=0]="MSSymbol",S[S.Unicode=1]="Unicode"}(Y||(Y={})),function(S){S[S.Unspecified=0]="Unspecified",S[S.TrueType=1]="TrueType",S[S.PSOpenType=2]="PSOpenType",S[S.TTOpenType=3]="TTOpenType",S[S.Type1=4]="Type1"}(se||(se={})),function(S){S[S.Display=0]="Display",S[S.Map=1]="Map"}(ce||(ce={})),function(S){S.None="None",S.Loop="Loop",S.Oscillate="Oscillate"}(V||(V={})),function(S){S[S.Z=0]="Z",S[S.X=1]="X",S[S.Y=2]="Y"}(k||(k={})),function(S){S[S.XYZ=0]="XYZ",S[S.ZXY=1]="ZXY",S[S.YXZ=2]="YXZ"}(w||(w={})),function(S){S[S.Rectangle=0]="Rectangle",S[S.RoundedRectangle=1]="RoundedRectangle",S[S.Oval=2]="Oval"}(j||(j={})),function(S){S[S.None=0]="None",S[S.Alpha=1]="Alpha",S[S.Screen=2]="Screen",S[S.Multiply=3]="Multiply",S[S.Add=4]="Add"}(P||(P={})),function(S){S[S.TTB=0]="TTB",S[S.RTL=1]="RTL",S[S.BTT=2]="BTT"}(W||(W={})),function(S){S[S.None=0]="None",S[S.SignPost=1]="SignPost",S[S.FaceNearPlane=2]="FaceNearPlane"}(A||(A={})),function(S){S[S.Float=0]="Float",S[S.String=1]="String",S[S.Boolean=2]="Boolean"}(E||(E={})),function(S){S[S.Intersect=0]="Intersect",S[S.Subtract=1]="Subtract"}(N||(N={})),function(S){S.OpenEnded="OpenEnded",S.Block="Block",S.Crossed="Crossed"}(z||(z={})),function(S){S.FullGeometry="FullGeometry",S.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",S.ReversedFirstSegment="ReversedFirstSegment",S.PerpendicularToSecondSegment="PerpendicularToSecondSegment",S.SecondSegmentWithTicks="SecondSegmentWithTicks",S.DoublePerpendicular="DoublePerpendicular",S.OppositeToFirstSegment="OppositeToFirstSegment",S.TriplePerpendicular="TriplePerpendicular",S.HalfCircleFirstSegment="HalfCircleFirstSegment",S.HalfCircleSecondSegment="HalfCircleSecondSegment",S.HalfCircleExtended="HalfCircleExtended",S.OpenCircle="OpenCircle",S.CoverageEdgesWithTicks="CoverageEdgesWithTicks",S.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",S.GapExtentMidline="GapExtentMidline",S.Chevron="Chevron",S.PerpendicularWithArc="PerpendicularWithArc",S.ClosedHalfCircle="ClosedHalfCircle",S.TripleParallelExtended="TripleParallelExtended",S.ParallelWithTicks="ParallelWithTicks",S.Parallel="Parallel",S.PerpendicularToFirstSegment="PerpendicularToFirstSegment",S.ParallelOffset="ParallelOffset",S.OffsetOpposite="OffsetOpposite",S.OffsetSame="OffsetSame",S.CircleWithArc="CircleWithArc",S.DoubleJog="DoubleJog",S.PerpendicularOffset="PerpendicularOffset",S.LineExcludingLastSegment="LineExcludingLastSegment",S.MultivertexArrow="MultivertexArrow",S.CrossedArrow="CrossedArrow",S.ChevronArrow="ChevronArrow",S.ChevronArrowOffset="ChevronArrowOffset",S.PartialFirstSegment="PartialFirstSegment",S.Arch="Arch",S.CurvedParallelTicks="CurvedParallelTicks",S.Arc90Degrees="Arc90Degrees"}(H||(H={})),function(S){S.Mitered="Mitered",S.Bevelled="Bevelled",S.Rounded="Rounded",S.Square="Square",S.TrueBuffer="TrueBuffer"}(re||(re={})),function(S){S.ClosePath="ClosePath",S.ConvexHull="ConvexHull",S.RectangularBox="RectangularBox"}(L||(L={})),function(S){S.BeginningOfLine="BeginningOfLine",S.EndOfLine="EndOfLine"}(J||(J={})),function(S){S.Mitered="Mitered",S.Bevelled="Bevelled",S.Rounded="Rounded",S.Square="Square"}(te||(te={})),function(S){S.Fast="Fast",S.Accurate="Accurate"}(ue||(ue={})),function(S){S.BeginningOfLine="BeginningOfLine",S.EndOfLine="EndOfLine"}(he||(he={})),function(S){S.Sinus="Sinus",S.Square="Square",S.Triangle="Triangle",S.Random="Random"}(Ce||(Ce={})),function(S){S[S.None=0]="None",S[S.Default=1]="Default",S[S.Force=2]="Force"}(Ge||(Ge={})),function(S){S[S.Buffered=0]="Buffered",S[S.Left=1]="Left",S[S.Right=2]="Right",S[S.AlongLine=3]="AlongLine"}(Te||(Te={})),function(S){S[S.Linear=0]="Linear",S[S.Rectangular=1]="Rectangular",S[S.Circular=2]="Circular",S[S.Buffered=3]="Buffered"}(Et||(Et={})),function(S){S[S.Discrete=0]="Discrete",S[S.Continuous=1]="Continuous"}(we||(we={})),function(S){S[S.AcrossLine=0]="AcrossLine",S[S.AloneLine=1]="AloneLine"}(dt||(dt={})),function(S){S[S.Left=0]="Left",S[S.Right=1]="Right",S[S.Center=2]="Center",S[S.Justify=3]="Justify"}(rt||(rt={})),function(S){S[S.Base=0]="Base",S[S.MidPoint=1]="MidPoint",S[S.ThreePoint=2]="ThreePoint",S[S.FourPoint=3]="FourPoint",S[S.Underline=4]="Underline",S[S.CircularCW=5]="CircularCW",S[S.CircularCCW=6]="CircularCCW"}(Mt||(Mt={})),function(S){S.Butt="Butt",S.Round="Round",S.Square="Square"}(ct||(ct={})),function(S){S.NoConstraint="NoConstraint",S.HalfPattern="HalfPattern",S.HalfGap="HalfGap",S.FullPattern="FullPattern",S.FullGap="FullGap",S.Custom="Custom"}(gt||(gt={})),function(S){S[S.None=-1]="None",S[S.Custom=0]="Custom",S[S.Circle=1]="Circle",S[S.OpenArrow=2]="OpenArrow",S[S.ClosedArrow=3]="ClosedArrow",S[S.Diamond=4]="Diamond"}(wt||(wt={})),function(S){S[S.ExtraLeading=0]="ExtraLeading",S[S.Multiple=1]="Multiple",S[S.Exact=2]="Exact"}(Dt||(Dt={})),function(S){S.Bevel="Bevel",S.Round="Round",S.Miter="Miter"}(He||(He={})),function(S){S[S.Default=0]="Default",S[S.String=1]="String",S[S.Numeric=2]="Numeric"}(ft||(ft={})),function(S){S[S.InsidePolygon=0]="InsidePolygon",S[S.PolygonCenter=1]="PolygonCenter",S[S.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(pt||(pt={})),function(S){S[S.Tint=0]="Tint",S[S.Replace=1]="Replace",S[S.Multiply=2]="Multiply"}(We||(We={})),function(S){S[S.ClipAtBoundary=0]="ClipAtBoundary",S[S.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",S[S.DoNotTouchBoundary=2]="DoNotTouchBoundary",S[S.DoNotClip=3]="DoNotClip"}(Rt||(Rt={})),function(S){S.NoConstraint="NoConstraint",S.WithMarkers="WithMarkers",S.WithFullGap="WithFullGap",S.WithHalfGap="WithHalfGap",S.Custom="Custom"}(qe||(qe={})),function(S){S.Fixed="Fixed",S.Random="Random",S.RandomFixedQuantity="RandomFixedQuantity"}(it||(it={})),function(S){S.LineMiddle="LineMiddle",S.LineBeginning="LineBeginning",S.LineEnd="LineEnd",S.SegmentMidpoint="SegmentMidpoint"}(Ut||(Ut={})),function(S){S.OnPolygon="OnPolygon",S.CenterOfMass="CenterOfMass",S.BoundingBoxCenter="BoundingBoxCenter"}(Bt||(Bt={})),function(S){S[S.Low=0]="Low",S[S.Medium=1]="Medium",S[S.High=2]="High"}(kt||(kt={})),function(S){S[S.MarkerCenter=0]="MarkerCenter",S[S.MarkerBounds=1]="MarkerBounds"}(nt||(nt={})),function(S){S[S.None=0]="None",S[S.PropUniform=1]="PropUniform",S[S.PropNonuniform=2]="PropNonuniform",S[S.DifUniform=3]="DifUniform",S[S.DifNonuniform=4]="DifNonuniform"}(at||(at={})),function(S){S.Tube="Tube",S.Strip="Strip",S.Wall="Wall"}(Je||(Je={})),function(S){S[S.Random=0]="Random",S[S.Increasing=1]="Increasing",S[S.Decreasing=2]="Decreasing",S[S.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(Lt||(Lt={})),function(S){S[S.Relative=0]="Relative",S[S.Absolute=1]="Absolute"}(_t||(_t={})),function(S){S[S.Normal=0]="Normal",S[S.LowerCase=1]="LowerCase",S[S.Allcaps=2]="Allcaps"}(jt||(jt={})),function(S){S[S.LTR=0]="LTR",S[S.RTL=1]="RTL"}(ot||(ot={})),function(S){S.Draft="Draft",S.Picture="Picture",S.Text="Text"}(Qe||(Qe={})),function(S){S[S.Top=0]="Top",S[S.Center=1]="Center",S[S.Baseline=2]="Baseline",S[S.Bottom=3]="Bottom"}(mt||(mt={})),function(S){S[S.Right=0]="Right",S[S.Upright=1]="Upright"}(yt||(yt={})),function(S){S[S.Small=0]="Small",S[S.Medium=1]="Medium",S[S.Large=2]="Large"}(ut||(ut={})),function(S){S[S.Calm=0]="Calm",S[S.Rippled=1]="Rippled",S[S.Slight=2]="Slight",S[S.Moderate=3]="Moderate"}(Ot||(Ot={}))},99666:(Ne,xe,O)=>{O.d(xe,{KS:()=>se,PX:()=>q,QS:()=>V,_I:()=>Z,jL:()=>Y,nE:()=>ce,vs:()=>Ie,xp:()=>$});const Z=8388607,q=0,$=1,Ie=k=>(8388608&k)>>>23,Y=k=>k&Z,se=k=>Ie(k)===$?254:255;function ce(k){return Ie(k)===$}function V(k,w){return((w?8388608:0)|k)>>>0}},64288:(Ne,xe,O)=>{O.d(xe,{ws:()=>qe,xV:()=>it,UK:()=>ot,$_:()=>we});var Z=O(26584),ae=O(63290),R=(O(21286),O(7547)),$=(O(81295),O(39406)),Ie=O(27899);class Y{constructor(){this.color=[0,0,0,0],this.haloColor=[0,0,0,0],this.haloSize=0,this.size=12,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}acquire(fe,ye,be,Le,De,Ke,$t,ke,It){this.color=fe,this.haloColor=ye,this.haloSize=be,this.size=Le,this.angle=De,this.offsetX=Ke,this.offsetY=$t,this.hAnchor=ke,this.vAnchor=It}release(){this.color[0]=this.color[1]=this.color[2]=this.color[3]=0,this.haloColor[0]=this.haloColor[1]=this.haloColor[2]=this.haloColor[3]=0,this.haloSize=0,this.size=0,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}}Y.pool=new Ie.Z(Y);var se=O(67969);O(55086);const V=ae.Z.getLogger("esri.views.2d.engine.webgl.Utils"),k="geometry",W=[{name:k,strideInBytes:12}],A=[{name:k,strideInBytes:36}],E=[{name:k,strideInBytes:24}],N=[{name:k,strideInBytes:12}],z=[{name:k,strideInBytes:40}],H=[{name:k,strideInBytes:36}],re=[{name:k,strideInBytes:36}];function L(B){const fe={};for(const ye of B)fe[ye.name]=ye.strideInBytes;return fe}const J=L([{name:k,strideInBytes:36}]),te=L(W),ue=L(A),he=L(E),Ce=L(N),Ge=L(z),Te=L(H),Et=L(re);function we(B,fe){switch(B){case $.LW.MARKER:return fe===$.mD.HEATMAP?te:J;case $.LW.FILL:switch(fe){case $.mD.DOT_DENSITY:return Ce;case $.mD.SIMPLE:case $.mD.OUTLINE_FILL_SIMPLE:return he;default:return ue}case $.LW.LINE:return Ge;case $.LW.TEXT:return Te;case $.LW.LABEL:return Et}}function qe(B){switch(B){case"butt":return R.RL.BUTT;case"round":return R.RL.ROUND;case"square":return R.RL.SQUARE;default:return V.error(new Z.Z("mapview-invalid-type",`Cap type ${B} is not a valid option. Defaulting to round`)),R.RL.ROUND}}function it(B){switch(B){case"miter":return R.AH.MITER;case"bevel":return R.AH.BEVEL;case"round":return R.AH.ROUND;default:return V.error(new Z.Z("mapview-invalid-type",`Join type ${B} is not a valid option. Defaulting to round`)),R.AH.ROUND}}function ot(B){switch(B){case se.Br.UNSIGNED_BYTE:return Uint8Array;case se.Br.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case se.Br.FLOAT:return Float32Array;default:return void V.error(new Z.Z("webgl-utils",`Unable to handle type ${B}`))}}},81295:(Ne,xe,O)=>{O.d(xe,{aH:()=>se,t2:()=>Y});var Z=O(5254);function Y(V){if(!V)return 0;const{r:k,g:w,b:j,a:P}=V;return(0,Z.Jz)(k*P,w*P,j*P,255*P)}function se(V){if(!V)return 0;const[k,w,j,P]=V;return(0,Z.Jz)(k*(P/255),w*(P/255),j*(P/255),P)}},39351:(Ne,xe,O)=>{O.d(xe,{AI:()=>X,C1:()=>S,CQ:()=>ze,CU:()=>Lt,Ex:()=>H,I_:()=>$,Ip:()=>mt,Iv:()=>Wt,Iw:()=>re,MI:()=>Ot,SD:()=>Jt,Tz:()=>rs,Uh:()=>Pt,V4:()=>Je,XJ:()=>Qe,_6:()=>is,a:()=>_t,aK:()=>pt,e0:()=>Me,fL:()=>ot,jk:()=>Qt,m4:()=>qe,oK:()=>Nt,pU:()=>ft,ru:()=>q,tQ:()=>nt,uG:()=>it,xl:()=>He,xm:()=>w});const X=1e-30,q=4294967295,$=512,w=29,H=24,re=8,He=1,ft=2,pt=3,qe=2,it=1,nt=1.05,Je=5,Lt=6,_t=1.15,ot=2,Qe=8,mt=500,Ot=10,S=1024,Pt=2,ze=0,rs=1,Nt=4,Me=8,Wt=16,is=4,Jt=1,Qt=4},5254:(Ne,xe,O)=>{O.d(xe,{Au:()=>k,Jz:()=>P,UJ:()=>j});const Z=new Float32Array(1);function k(E){return[255&E,(65280&E)>>>8,(16711680&E)>>>16,(4278190080&E)>>>24]}function j(E,N){return 65535&E|N<<16}function P(E,N,z,H){return 255&E|(255&N)<<8|(255&z)<<16|H<<24}new Uint32Array(Z.buffer)},55746:(Ne,xe,O)=>{O.d(xe,{k:()=>k,p:()=>w});var Z=O(65389),ae=O(61885),R=(O(8314),O(62208)),q=O(76279),$=O(5548),Ie=O(16669),Y=O(52397);function se(j,P){return j<<16|P}function ce(j){return(4294901760&j)>>>16}function V(j){return 65535&j}const k={getObjectId:j=>j.getObjectId(),getAttributes:j=>j.readAttributes(),getAttribute:(j,P)=>j.readAttribute(P),cloneWithGeometry:(j,P)=>j,getGeometry:j=>j.readHydratedGeometry(),getCentroid:(j,P)=>j.readCentroid()};class w extends Ie.J{constructor(P,W,A){super(P,W),this.featureAdapter=k,this.events=new ae.Z,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new Z.Z(50),this._index=(0,q.r)(9,E=>({minX:this._storage.getXMin(E),minY:this._storage.getYMin(E),maxX:this._storage.getXMax(E),maxY:this._storage.getYMax(E)})),this.mode=A}get storeStatistics(){let P=0,W=0,A=0;return this.forEach(E=>{const N=E.readGeometry();N&&(W+=N.isPoint?1:N.lengths.reduce((z,H)=>z+H,0),A+=N.isPoint?1:N.lengths.length,P+=1)}),{featureCount:P,vertexCount:W,ringCount:A}}hasInstance(P){return this._featureSetsByInstance.has(P)}onTileData(P,W){if((0,R.Wi)(W.addOrUpdate))return W;if(W.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const E=W.addOrUpdate.getCursor();for(;E.next();){const N=E.getDisplayId();this.setComputedAttributes(this._storage,E,N,P.scale)}return W}this._featureSetsByInstance.set(W.addOrUpdate.instance,W.addOrUpdate);const A=W.addOrUpdate.getCursor();for(;A.next();)this._insertFeature(A,P.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),W}search(P){this._rebuildIndex();const W=P.id,A=this._indexSearchCache.find(H=>H.tileId===W);if((0,R.pC)(A))return A.readers;const E=new Map,N=this._searchIndex(P.bounds),z=[];for(const H of N){const re=this._storage.getInstanceId(H),L=ce(re),J=V(re);E.has(L)||E.set(L,[]),E.get(L).push(J)}return E.forEach((H,re)=>{const L=this._featureSetsByInstance.get(re);z.push(Y.t.from(L,H))}),this._indexSearchCache.enqueue({tileId:W,readers:z}),z}insert(P){const W=P.getCursor(),A=this._storage;for(;W.next();){const E=se(W.instance,W.getIndex()),N=W.getObjectId(),z=this._objectIdToDisplayId.get(N)??this._storage.createDisplayId();W.setDisplayId(z),A.setInstanceId(z,E),this._objectIdToDisplayId.set(N,z)}this._featureSetsByInstance.set(P.instance,P),this._spatialIndexInvalid=!0}remove(P){const W=this._objectIdToDisplayId.get(P);if(!W)return;const A=this._storage.getInstanceId(W),E=V(A),N=ce(A),z=this._featureSetsByInstance.get(N);this._objectIdToDisplayId.delete(P),this._storage.releaseDisplayId(W),z.removeAtIndex(E),z.isEmpty&&this._featureSetsByInstance.delete(N),this._spatialIndexInvalid=!0}toArray(){const P=new Array;return this.forEach(W=>P.push(W)),P}forEach(P){this._objectIdToDisplayId.forEach(W=>{const A=this._storage.getInstanceId(W),E=this._lookupFeature(A);P(E)})}forEachUnsafe(P){this._objectIdToDisplayId.forEach(W=>{const A=this._storage.getInstanceId(W),E=ce(A),N=V(A),z=this._getFeatureSet(E);z.setIndex(N),P(z)})}forEachInBounds(P,W){const A=this._searchIndex(P);for(const E of A){const N=this.lookupFeatureByDisplayId(E,this._storage);W((0,R.Wg)(N))}}forEachBounds(P,W,A){this._rebuildIndex();const E=[0,0,0,0];for(const N of P){if(!N.readGeometry())continue;const z=N.getDisplayId();E[0]=this._storage.getXMin(z),E[1]=this._storage.getYMin(z),E[2]=this._storage.getXMax(z),E[3]=this._storage.getYMax(z),W((0,$.JR)(A,E))}}sweepFeatures(P,W,A){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach((E,N)=>{P.has(E)||(W.releaseDisplayId(E),A&&A.unsetAttributeData(E),this._objectIdToDisplayId.delete(N))}),this.events.emit("changed")}sweepFeatureSets(P){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach((W,A)=>{P.has(A)||this._featureSetsByInstance.delete(A)})}lookupObjectId(P,W){const A=this.lookupFeatureByDisplayId(P,W);return(0,R.Wi)(A)?null:A.getObjectId()}lookupDisplayId(P){return this._objectIdToDisplayId.get(P)}lookupFeatureByDisplayId(P,W){const A=W.getInstanceId(P);return this._lookupFeature(A)}lookupByDisplayIdUnsafe(P){const W=this._storage.getInstanceId(P),A=ce(W),E=V(W),N=this._getFeatureSet(A);return N?(N.setIndex(E),N):null}_insertFeature(P,W){const A=this._storage,E=P.getObjectId(),N=se(P.instance,P.getIndex());A.getInstanceId(P.getDisplayId());let z=this._objectIdToDisplayId.get(E);z||(z=A.createDisplayId(),this._objectIdToDisplayId.set(E,z),this._spatialIndexInvalid=!0),P.setDisplayId(z),A.setInstanceId(z,N),this.setComputedAttributes(A,P,z,W)}_searchIndex(P){return this._rebuildIndex(),this._index.search({minX:P[0],minY:P[1],maxX:P[2],maxY:P[3]})}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const P=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach(W=>{const A=W.getCursor();for(;A.next();){const E=A.getDisplayId();this._storage.setBounds(E,A)&&P.push(E)}}):this._objectIdToDisplayId.forEach(W=>{const A=this._storage.getInstanceId(W);this._storage.setBounds(W,this._lookupFeature(A))&&P.push(W)}),this._index.clear(),this._index.load(P),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(P){const W=ce(P),A=this._getFeatureSet(W);if(!A)return null;const E=A.getCursor(),N=V(P);return E.setIndex(N),E}_getFeatureSet(P){return this._featureSetsByInstance.get(P)}}},11288:(Ne,xe,O)=>{O.r(xe),O.d(xe,{default:()=>Rr});var Z=O(15861),ae=O(17626),X=O(80542),R=O(8314),q=O(32917),$=O(77712),se=(O(85931),O(90912),O(76898)),ce=O(37053),V=O(2584),w=O(62208),j=O(10699),P=O(82054),W=O(58175),A=O(60466),E=O(55746),N=O(38305),z=O(84792),H=O(26584),re=O(63290),L=O(93662),J=O(7848),te=O(89628),ue=O(20477),he=O(66385),Ce=O(25208);class Te extends Ce.s{constructor(a,c,_){super(a,_),this._exceededTransferLimit=!1,this._featureIndex=-1,this._dateFields=new Set,this._geometryType=_?.geometryType,this._features=c}static fromFeatures(a,c){const{objectIdField:_,geometryType:m}=c,x=(0,P.Yn)([],a,m,!1,!1,_);for(let b=0;b<x.length;b++)x[b].displayId=a[b].displayId;return Te.fromOptimizedFeatures(x,c)}static fromFeatureSet(a,c){const _=(0,P.h_)(a,c.objectIdField);return Te.fromOptimizedFeatureSet(_,c)}static fromOptimizedFeatureSet(a,c){const{features:_}=a,m=Te.fromOptimizedFeatures(_,c);m._exceededTransferLimit=a.exceededTransferLimit,m._transform=a.transform;for(const x of a.fields)"esriFieldTypeDate"===x.type&&m._dateFields.add(x.name);return m}static fromOptimizedFeatures(a,c,_){const m=Ce.s.createInstance(),x=new Te(m,a,c);return x._transform=_,x}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(a){const c=new Set(a);this._features=this._features.filter(_=>!(_.objectId&&c.has(_.objectId)))}append(a){for(const c of a)this._features.push(c)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let a="";for(const c in this._current.attributes)a+=this._current.attributes[c];return a}getIndex(){return this._featureIndex}setIndex(a){this._featureIndex=a}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(a){this._current.displayId=a}getGroupId(){return this._current.groupId}setGroupId(a){this._current.groupId=a}copy(){const a=new Te(this.instance,this._features,this.fullSchema());return this.copyInto(a),a}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return(0,P.EI)(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const a=this.readGeometry();return(0,P.di)(a,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const a=this.readCentroid();return(0,w.Wi)(a)?null:{x:a.coords[0]*this._sx+this._tx,y:a.coords[1]*this._sy+this._ty}}readGeometryArea(){return(0,he.S6)(this._current)?(0,P.lz)(this._current.geometry,2):0}readUnquantizedGeometry(){const a=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!a)return a;const c=a.clone();return function Ge({coords:v,lengths:a}){let c=0;for(const _ of a){for(let m=1;m<_;m++)v[2*(c+m)]+=v[2*(c+m)-2],v[2*(c+m)+1]+=v[2*(c+m)-1];c+=_}}(c),c}readHydratedGeometry(){const a=this._current.geometry;if((0,w.Wi)(a))return null;const c=a.clone();return(0,w.pC)(this._transform)&&(0,P.$g)(c,c,this.hasZ,this.hasM,this._transform),c}getXHydrated(){if(!(0,he.S6)(this._current))return 0;const a=this._current.geometry.coords[0],c=this.getQuantizationTransform();return(0,w.Wi)(c)?a:a*c.scale[0]+c.translate[0]}getYHydrated(){if(!(0,he.S6)(this._current))return 0;const a=this._current.geometry.coords[1],c=this.getQuantizationTransform();return(0,w.Wi)(c)?a:c.translate[1]-a*c.scale[1]}getX(){return(0,he.S6)(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return(0,he.S6)(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!(0,he.S6)(this._current)){if((0,w.pC)(this._current.centroid)){const[_,m]=this._current.centroid.coords;return this.createQuantizedExtrudedQuad(_,m)}return null}const a=this._current.geometry.clone();if(a.isPoint)return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sy+this._ty,a;let c=0;for(const _ of a.lengths)a.coords[2*c]=a.coords[2*c]*this._sx+this._tx,a.coords[2*c+1]=a.coords[2*c+1]*this._sy+this._ty,c+=_;return a}readCentroid(){return(0,he.S6)(this._current)?this._computeCentroid():this._current.centroid}hasField(a){return a in this._current.attributes||this.getFieldNames().map(c=>c.toLowerCase()).includes(a.toLowerCase())}getFieldNames(){return Object.keys(this._current.attributes)}_readAttribute(a,c){const _=this._current.attributes[a];if(void 0!==_)return null!=_&&c&&this._dateFields.has(a)?new Date(_):_;const m=this.readAttributes(),x=a.toLocaleLowerCase().trim();for(const b in m)if(b.toLocaleLowerCase().trim()===x){const C=this._current.attributes[b];return null!=C&&c&&this._dateFields.has(b)?new Date(C):C}}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._transform=this._transform,a._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}}var Et=O(24192),we=O(88071),dt=O(71260);const rt=268435455;class Mt{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(a){return this.fieldMap.has(a)}isDateField(a){return this.fieldMap.get(a)?.isDate??!1}getFieldIndex(a){return this.fieldMap.get(a)?.index}}function ct(v){const _=v.asUnsafe(),m=_.getLength(),x=_.pos()+m,b={name:"",isDate:!1};for(;_.pos()<x&&_.next();)switch(_.tag()){case 1:b.name=_.getString();break;case 2:"esriFieldTypeDate"===(0,dt.O7)(_.getEnum())&&(b.isDate=!0);break;default:_.skip()}return b}function gt(v){return v.toLowerCase().trim()}const He=268435455,We={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function Rt(v){return v<=We.small.delta.length?We.small:(v<=We.large.delta.length||(We.large.delta=new Int32Array(Math.round(1.25*v)),We.large.decoded=new Int32Array(Math.round(1.25*v))),We.large)}function qe(v){return v.toLowerCase().trim()}function Ut(v){for(;v.next();){if(1===v.tag())return v.getMessage();v.skip()}return null}function kt(v,a,c,_,m,x){return.5*Math.abs(v*_+c*x+m*a-v*x-c*a-m*_)}function nt(v,a,c,_){return v*_-c*a==0&&v*c+a*_>0}class at extends Ce.s{constructor(a,c,_,m){super(a,m),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=m.geometryType,this._reader=c,this._header=_,this._hasNext=_.hasFeatures,this._isPoints="esriGeometryPoint"===m.geometryType}static fromBuffer(a,c,_=!1){const m=c.geometryType,x=function it(v){try{const c=new Et.Z(new Uint8Array(v),new DataView(v));for(;c.next();){if(2===c.tag())return Ut(c.getMessage());c.skip()}}catch(a){const c=new H.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:a});re.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(c)}return null}(a),b=function wt(v,a,c=!1){const F=v.asUnsafe(),U=F.pos(),D=new Mt;let G=0,Q=0,ne=null,de=null,oe=null,ge=!1;for(;F.next();)switch(F.tag()){case 1:ne=F.getString();break;case 3:de=F.getString();break;case 12:oe=F.processMessage(dt.G$);break;case 9:if(D.exceededTransferLimit=F.getBool(),D.exceededTransferLimit){D.offsets.geometry=c?new Float64Array(8e3):new Int32Array(8e3),D.centroid=c?new Float64Array(16e3):new Int32Array(16e3);for(let pe=0;pe<D.centroid.length;pe++)D.centroid[pe]=rt}break;case 13:{const pe=ct(v),Ae=pe.name,Ee=gt(pe.name),_e={fieldName:Ae,index:G++,isDate:pe.isDate};D.fields.push(_e),D.fieldMap.set(pe.name,_e),D.fieldMap.set(Ee,_e);break}case 15:{const pe=F.getLength(),Ae=F.pos()+pe;if(!D.exceededTransferLimit){const Se=D.centroid;D.offsets.geometry.push(0),Se.push(rt),Se.push(rt)}!ge&&D.exceededTransferLimit&&(ge=!0,D.offsets.attributes=c?new Float64Array(8e3*G):new Uint32Array(8e3*G));let Ee=Q*G;for(;F.pos()<Ae&&F.next();)switch(F.tag()){case 1:{ge?D.offsets.attributes[Ee++]=F.pos():D.offsets.attributes.push(F.pos());const _e=F.getLength();F.skipLen(_e);break}case 2:if(a){const _e=F.getLength(),Se=F.pos()+_e;for(;F.pos()<Se&&F.next();)switch(F.tag()){case 3:{F.getUInt32();const Fe=F.getSInt64(),Ue=F.getSInt64();D.centroid[2*Q]=Fe,D.centroid[2*Q+1]=Ue;break}default:F.skip()}}else{D.offsets.geometry[Q]=F.pos();const _e=F.getLength();D.vertexCount+=_e,F.skipLen(_e)}break;case 4:{const _e=F.getLength(),Se=F.pos()+_e;for(;F.pos()<Se&&F.next();)switch(F.tag()){case 3:{F.getUInt32();const Fe=F.getSInt64(),Ue=F.getSInt64();D.centroid[2*Q]=Fe,D.centroid[2*Q+1]=Ue;break}default:F.skip()}break}default:F.skip()}Q++,D.hasFeatures=!0;break}default:F.skip()}const me=ne||de;if(!me)throw new H.Z("FeatureSet has no objectId or globalId field name");return D.featureCount=Q,D.fieldCount=G,D.objectIdFieldIndex=D.getFieldIndex(me),D.transform=oe,D.displayIds=new Uint32Array(D.featureCount),D.groupIds=new Uint16Array(D.featureCount),F.move(U),D}(x,"esriGeometryPoint"===m,_),C=Ce.s.createInstance();return new at(C,x,b,c)}get geometryType(){return this._geometryType}get _size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}hasField(a){return this._header.hasField(a)||this._header.hasField(qe(a))}getFieldNames(){return this._header.fields.map(a=>a.fieldName)}getSize(){return this._size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(a){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=a}getAttributeHash(){let a="";return this._header.fields.forEach(({index:c})=>{a+=this._readAttributeAtIndex(c)+"."}),a}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(a){this._header.displayIds[this._featureIndex]=a}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(a){this._header.groupIds[this._featureIndex]=a}readLegacyFeature(){if(void 0===this._cache.legacyFeature){const a=this.readCentroid(),c={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:(a&&{x:a.coords[0],y:a.coords[1]})??null};return this._cache.legacyFeature=c,c}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const a=new he.u_(this.readGeometry(),this.readAttributes(),this.readCentroid());return a.objectId=this.getObjectId(),a.displayId=this.getDisplayId(),this._cache.optFeature=a,a}return this._cache.optFeature}getXHydrated(){const a=this._header.centroid[2*this._featureIndex],c=this.getQuantizationTransform();return(0,w.Wi)(c)?a:a*c.scale[0]+c.translate[0]}getYHydrated(){const a=this._header.centroid[2*this._featureIndex+1],c=this.getQuantizationTransform();return(0,w.Wi)(c)?a:c.translate[1]-a*c.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(a){const c=this.readGeometry(a);return(0,P.di)(c,this.geometryType,!1,!1)}readLegacyCentroid(){const a=this.readCentroid();if(!a)return null;const[c,_]=a.coords;return{x:c,y:_}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(a=!1){if(void 0===this._cache.unquantGeometry){const c=this.readGeometry(a);if(!c)return this._cache.unquantGeometry=void 0,null;const _=Rt(c.coords.length).decoded,m=c.clone(_),x=m.coords;let b=0;for(const C of m.lengths){for(let M=1;M<C;M++){const F=2*(b+M),U=2*(b+M-1);x[F]+=x[U],x[F+1]+=x[U+1]}b+=C}return this._cache.unquantGeometry=m,m}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===He)return null;const m=this.getXHydrated(),x=this.getYHydrated();return new we.Z([],[m,x])}const a=this.readGeometry();if(!a)return null;const c=a.clone(),_=this.getQuantizationTransform();return(0,w.pC)(_)&&(0,P.$g)(c,c,this.hasZ,this.hasM,_),c}readGeometry(a=!1){if(void 0===this._cache.geometry){let c=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===He)return null;const _=this.getX(),m=this.getY();c=new we.Z([],[_,m])}else{const _=this._header.offsets.geometry[this._featureIndex],m=this._reader;if(0===_){const x=this._readServerCentroid();if(!x)return null;const[b,C]=x.coords;return this.createQuantizedExtrudedQuad(b,C)}m.move(_);try{if(c=a?this._parseGeometryForDisplay(m):this._parseGeometry(m),null===c){const x=this._readServerCentroid();if(!x)return null;const[b,C]=x.coords;return this.createQuantizedExtrudedQuad(b,C)}}catch(x){return console.error("Failed to parse geometry!",x),null}}return this._cache.geometry=c,c}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let a;return a=this._computeCentroid(),a||(a=this._readServerCentroid()),this._cache.centroid=a??void 0,a??null}return this._cache.centroid}copy(){const a=this._reader.clone(),c=new at(this.instance,a,this._header,this.fullSchema());return this.copyInto(c),c}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readAttribute(a,c){const _=this._header.hasField(a)?a:qe(a),m=this._header.getFieldIndex(_);if(null==m)return;const x=this._readAttributeAtIndex(m);return c&&null!=x&&this._header.isDateField(_)?new Date(x):x}_readAttributes(){const a={};return this._header.fields.forEach(({fieldName:c,index:_})=>{a[c]=this._readAttributeAtIndex(_)}),a}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._featureOffset=this._featureOffset,a._hasNext=this._hasNext}_readAttributeAtIndex(a){const _=this._reader;return _.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]),function Bt(v){const U=v.getLength(),D=v.pos()+U;for(;v.pos()<D&&v.next();)switch(v.tag()){case 1:return v.getString();case 2:return v.getFloat();case 3:return v.getDouble();case 4:return v.getSInt32();case 5:return v.getUInt32();case 6:return v.getInt64();case 7:return v.getUInt64();case 8:return v.getSInt64();case 9:return v.getBool();default:return v.skip(),null}return null}(_)}_readServerCentroid(){const a=this._header.centroid[2*this._featureIndex]+this._tx;return a===He?null:new we.Z([],[a,this._header.centroid[2*this._featureIndex+1]+this._ty])}_parseGeometry(a){const m=a.asUnsafe(),x=m.getLength(),b=m.pos()+x,C=[],M=[];for(;m.pos()<b&&m.next();)switch(m.tag()){case 2:{const F=m.getUInt32(),U=m.pos()+F;for(;m.pos()<U;)M.push(m.getUInt32());break}case 3:{const F=m.getUInt32(),U=m.pos()+F;for(C.push(m.getSInt32()+this._tx),C.push(m.getSInt32()+this._ty),this.hasZ&&m.getSInt32(),this.hasM&&m.getSInt32();m.pos()<U;)C.push(m.getSInt32()),C.push(m.getSInt32()),this.hasZ&&m.getSInt32(),this.hasM&&m.getSInt32();break}default:m.skip()}return new we.Z(M,C)}_parseGeometryForDisplay(a){const m=a.asUnsafe(),x=m.getLength(),b=m.pos()+x,C=[],M=[];let F=0,U=0,D=null,G=0;const Q="esriGeometryPolygon"===this.geometryType;for(;m.pos()<b&&m.next();)switch(m.tag()){case 2:{const ee=m.getUInt32(),K=m.pos()+ee;for(;m.pos()<K;){const ie=m.getUInt32();C.push(ie),F+=ie}D=Rt(2*F).delta;break}case 3:{m.getUInt32();const ee=2+(this.hasZ?1:0)+(this.hasM?1:0);(0,w.O3)(D);for(const K of C)if(U+ee*K>D.length)for(let ie=0;ie<K;ie++)m.getSInt32(),m.getSInt32(),this.hasZ&&m.getSInt32(),this.hasM&&m.getSInt32();else if(Q){const ie=this.getAreaSimplificationThreshold(K,this._header.vertexCount);let le=2,ne=1;const de=!1;let oe=m.getSInt32(),ge=m.getSInt32();D[U++]=oe,D[U++]=ge,this.hasZ&&m.getSInt32(),this.hasM&&m.getSInt32();let me=m.getSInt32(),pe=m.getSInt32();for(this.hasZ&&m.getSInt32(),this.hasM&&m.getSInt32();le<K;){let Ae=m.getSInt32(),Ee=m.getSInt32();this.hasZ&&m.getSInt32(),this.hasM&&m.getSInt32();const _e=oe+me,Se=ge+pe;kt(oe,ge,_e,Se,_e+Ae,Se+Ee)>=ie?(G+=-.5*(_e-oe)*(Se+ge),ne>1&&nt(D[U-2],D[U-1],me,pe)?(D[U-2]+=me,D[U-1]+=pe):(D[U++]=me,D[U++]=pe,ne++),oe=_e,ge=Se):(Ae+=me,Ee+=pe),me=Ae,pe=Ee,le++}ne<3||de?U-=2*ne:(G+=-.5*(oe+me-oe)*(ge+pe+ge),nt(D[U-2],D[U-1],me,pe)?(D[U-2]+=me,D[U-1]+=pe,M.push(ne)):(D[U++]=me,D[U++]=pe,M.push(++ne)))}else{let ie=0,le=m.getSInt32(),ne=m.getSInt32();this.hasZ&&m.getSInt32(),this.hasM&&m.getSInt32(),D[U++]=le,D[U++]=ne,ie+=1;for(let de=1;de<K;de++){const oe=m.getSInt32(),ge=m.getSInt32(),me=le+oe,pe=ne+ge;G+=-.5*(me-le)*(pe+ne),this.hasZ&&m.getSInt32(),this.hasM&&m.getSInt32(),de>2&&nt(D[U-2],D[U-1],oe,ge)?(D[U-2]+=oe,D[U-1]+=ge):(D[U++]=oe,D[U++]=ge,ie+=1),le=me,ne=pe}M.push(ie)}break}default:m.skip()}if(this._cache.area=G,!M.length)return null;if(this._tx||this._ty){let ee=0;(0,w.O3)(D);for(const K of M)D[2*ee]+=this._tx,D[2*ee+1]+=this._ty,ee+=K}return new we.Z(M,D)}}class Je{constructor(a){this.service=a}destroy(){}}function Qe(){return(Qe=(0,Z.Z)(function*(v){const a=new L.Z;return yield a.open(v,{}),a})).apply(this,arguments)}class mt extends Je{constructor(a){super(a),this._portsOpen=function ot(v){return Qe.apply(this,arguments)}(a.source).then(c=>this.client=c)}destroy(){this.client.close(),this.client=null}executeQuery(a,c){var _=this;return(0,Z.Z)(function*(){yield _._portsOpen;const m=yield _.client.invoke("queryFeatures",a.toJSON(),c);return Te.fromFeatureSet(m,_.service)})()}}class yt extends Je{executeQuery(a,c){var _=this;return(0,Z.Z)(function*(){const{data:m}=yield(0,ue.executeQueryPBFBuffer)(_.service.source,a,c);return at.fromBuffer(m,_.service,!a.quantizationParameters)})()}}class ut extends Je{executeQuery(a,c){var _=this;return(0,Z.Z)(function*(){const{source:m,capabilities:x,spatialReference:b,objectIdField:C,geometryType:M}=_.service;if((0,w.pC)(a.quantizationParameters)&&!x.query.supportsQuantization){const U=a.clone(),D=(0,J.vY)((0,w.Wg)(U.quantizationParameters));U.quantizationParameters=null;const{data:G}=yield(0,ue.executeQuery)(m,U,b,c),Q=(0,P.h_)(G,C);return(0,P.RZ)(D,Q),Te.fromOptimizedFeatureSet(Q,_.service)}const{data:F}=yield(0,ue.executeQuery)(m,a,_.service.spatialReference,c);return"esriGeometryPoint"===M&&(F.features=F.features?.filter(U=>{if((0,w.pC)(U.geometry)){const D=U.geometry;return Number.isFinite(D.x)&&Number.isFinite(D.y)}return!0})),Te.fromFeatureSet(F,_.service)})()}}class Ot extends Je{executeQuery(a,c){var _=this;return(0,Z.Z)(function*(){const{capabilities:m}=_.service;if(a.quantizationParameters&&!m.query.supportsQuantization){const b=a.clone(),C=(0,J.vY)((0,w.Wg)(b.quantizationParameters));b.quantizationParameters=null;const M=yield(0,te.WW)(_.service.source,a,c);return(0,P.RZ)(C,M),Te.fromOptimizedFeatureSet(M,_.service)}const x=yield(0,te.WW)(_.service.source,a,c);return Te.fromOptimizedFeatureSet(x,_.service)})()}}var S=O(97478),Pt=O(61885),ze=O(84682),rs=O(96854),Nt=O(65389);class Me{constructor(){this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(a){const c=new Me;for(const _ in a){const m=a[_];if("object"==typeof m)for(const x in m)c[_][x]=m[x];c[_]=m}return c}static empty(){return Me.create({})}static all(){return Me.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(a){this.version=a.version,a.source&&(this.source=!1),a.targets.feature&&(this.targets.feature=!1),a.targets.aggregate&&(this.targets.aggregate=!1),a.storage.filters&&(this.storage.filters=!1),a.storage.data&&(this.storage.data=!1),a.mesh&&(this.mesh=!1),a.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let a=0,c="";if(this.mesh){a+=20,c+="-> (20) Mesh needs update\n";for(const m of this.why.mesh)c+=`    + ${m}\n`}if(this.source){a+=10,c+="-> (10) The source needs update\n";for(const m of this.why.source)c+=`    + ${m}\n`}this.targets.feature&&(a+=5,c+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(a+=5,c+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(a+=4,c+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(a+=1,c+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${a<5?"Fastest":a<10?"Fast":a<15?"Moderate":a<20?"Slow":"Very Slow"} update of cost ${a}/45 `),console.debug(c)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}class Wt{constructor(a,c){this.requests={done:new Array,stream:new Nt.Z(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._done=!1,this.didSend=!1,this.tile=a,this._version=c}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(a){this.requests.done.forEach(c=>c.message.status.unset(a)),this._version=a.version,(0,w.pC)(this._edits)&&this._edits.status.unset(a)}add(a){a.message.status=a.message.status??Me.empty(),a.message.status.version=this._version,(0,R.Z)("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),a.message.end&&this.requests.done.forEach(c=>{(0,w.pC)(c.message)&&c.message.end&&(c.message.end=!1)}),this.requests.done.push(a)}edit(a,c){const _=a.getQuantizationTransform(),m=a.fullSchema(),x=Array.from(a.features()),b=[...c,...x.map(C=>C.objectId)];this.removeIds(b),this._invalidate(),(0,w.Wi)(this._edits)?this._edits={type:"append",addOrUpdate:Te.fromOptimizedFeatures(x,m,(0,w.Wg)(_)),id:this.tile.id,status:Me.empty(),end:!0}:(this.requests.done.forEach(C=>C.message.end=!1),(0,w.Wg)(this._edits.addOrUpdate).append(a.features()))}*readers(){for(const{message:a}of this.requests.done)(0,w.pC)(a.addOrUpdate)&&(yield a.addOrUpdate);(0,w.pC)(this._edits)&&(0,w.pC)(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const a of this.requests.done)a.message.status=Me.empty();(0,w.pC)(this._edits)&&(this._edits.status=Me.empty())}removeIds(a){this._invalidate();for(const{message:c}of this.requests.done){const _=c.addOrUpdate;(0,w.pC)(_)&&(_.removeIds(a),_.isEmpty&&(c.addOrUpdate=null))}(0,w.pC)(this._edits)&&(0,w.pC)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(a),this.requests.done=this.requests.done.filter(c=>c.message.addOrUpdate||c.message.end)}abort(){this._abortController.abort()}}class Jt{constructor(a){this.events=new Pt.Z,this._resolver=(0,j.hh)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=a.outSR,this._serviceInfo=a.serviceInfo,this._onTileUpdateMessage=a.onMessage}destroy(){}_onMessage(a){var c=this;return(0,Z.Z)(function*(){const _=c._subscriptions.get(a.id);if(!_)return;const m={...a,remove:a.remove??[],status:a.status??Me.empty()};return(0,j.R8)(c._onTileUpdateMessage(m,_.options))})()}update(a,c){const _=c.fields.length;c.outFields=function is(v,a){const c=new Set;return v&&v.forEach(_=>c.add(_)),a&&a.forEach(_=>c.add(_)),c.has("*")?["*"]:Array.from(c)}(this._schema?.outFields,c.outFields),c.outFields=c.outFields.length>=.75*_?["*"]:c.outFields,c.outFields.sort();const m=(0,ze.Hg)(this._schema,c);if(!m)return;(0,R.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",m);const b={returnCentroid:"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:c.outFields,outSpatialReference:this._outSR,orderByFields:["orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC"],where:c.definitionExpression||"1=1",gdbVersion:c.gdbVersion,historicMoment:c.historicMoment,timeExtent:S.Z.fromJSON(c.timeExtent)},C=this._schema&&(0,ze.uD)(m,"outFields");this._schema&&(0,ze.V7)(m,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(a.why.mesh.push("Layer filter and/or custom parameters changed"),a.why.source.push("Layer filter and/or custom parameters changed"),a.mesh=!0,a.source=!0,a.queryFilter=!0),C&&(a.why.source.push("Layer required fields changed"),a.source=!0),(0,ze.Hg)(b,this._queryInfo)&&(this._queryInfo=b),this._schema=c,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}applyUpdate(a){var c=this;return(0,Z.Z)(function*(){if(a.queryFilter||a.source&&c._didEdit)return c.refresh(a.version),void(c._didEdit=!1);c._subscriptions.forEach(_=>_.applyUpdate(a)),yield c.resend()})()}refresh(a,c){for(const _ of this._tiles())this.unsubscribe(_),this.subscribe(_,a)}subscribe(a,c){const _=new Wt(a,c);this._subscriptions.set(a.id,_)}unsubscribe(a){const c=this.get(a.id);(0,w.pC)(c)&&c.abort(),this._subscriptions.delete(a.id)}createQuery(a={}){const c=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new rs.Z({...this._queryInfo,historicMoment:c,...a})}get(a){return this._subscriptions.has(a)?this._subscriptions.get(a):null}queryLastEditDate(){return(0,Z.Z)(function*(){throw new Error("Service does not support query type")})()}query(a){return(0,Z.Z)(function*(){throw new Error("Service does not support query")})()}*_tiles(){const a=Array.from(this._subscriptions.values());for(const c of a)yield c.tile}edit(a,c){var _=this;return(0,Z.Z)(function*(){const m=Array.from(_._subscriptions.values()),x=m.map(({tile:b})=>b);for(const b of m)b.removeIds(c);if(a.length){const b=x.map(M=>{const F=_.createTileQuery(M);return F.objectIds=a,{tile:M,query:F}}).map(function(){var M=(0,Z.Z)(function*({tile:F,query:U}){return{tile:F,result:yield _.query(U),query:U}});return function(F){return M.apply(this,arguments)}}()),C=(yield(0,j.WW)(b)).map(function(){var M=(0,Z.Z)(function*({tile:F,result:U}){if(!U.hasFeatures&&!c.length&&!a.length)return;const D=_._subscriptions.get(F.key.id);D&&D.edit(U,a)});return function(F){return M.apply(this,arguments)}}());yield(0,j.as)(C)}_._didEdit=!0})()}}var Qt=O(71251);class Kt extends Jt{constructor(a){var c,_;super(a),c=this,this.type="feature",this.mode="on-demand",this._adapter=function jt(v){const{capabilities:a}=v;return function _t(v){return"ogc-source"===v?.type}(v.source)?new Ot(v):function Lt(v){return Array.isArray(v.source)}(v)?new mt(v):a.query.supportsFormatPBF&&(0,R.Z)("featurelayer-pbf")?new yt(v):new ut(v)}(a.serviceInfo),this._queue=new Qt.e({concurrency:8,process:(_=(0,Z.Z)(function*(m){if((0,j.k_)(m),(0,w.pC)(m.tile)){const x=m.tile.key.id,{signal:b}=m,C=(0,R.Z)("esri-tiles-debug")?{tile:x.replace(/\//g,"."),depth:m.depth}:void 0,M=yield c._adapter.executeQuery(m.query,{signal:b,query:{...C,...c._schema.customParameters}});return M.level=m.tile.key.level,M}return c._adapter.executeQuery(m.query,{...m,query:c._schema.customParameters})}),function(x){return _.apply(this,arguments)})}),this._patchQueue=new Qt.e({concurrency:8,process:function(){var _=(0,Z.Z)(function*(m){if((0,j.k_)(m),(0,w.pC)(m.tile)){const x=m.tile.key.id,{signal:b}=m,C=(0,R.Z)("esri-tiles-debug")?{tile:x.replace(/\//g,"."),depth:m.depth}:void 0,M=yield c._adapter.executeQuery(m.query,{signal:b,query:{...C,...c._schema.customParameters}});return M.level=m.tile.key.level,M}return c._adapter.executeQuery(m.query,{...m,query:c._schema.customParameters})});return function(x){return _.apply(this,arguments)}}()})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(a=>!a.done)}get maxRecordCountFactor(){const{query:a}=this._serviceInfo.capabilities;return a.supportsMaxRecordCountFactor?4:null}get maxPageSize(){const{query:a}=this._serviceInfo.capabilities;return(a.maxRecordCount??8e3)*(0,w.Pt)(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(a,c){}subscribe(a,c){super.subscribe(a,c);const _=this._subscriptions.get(a.id);this._fetchDataTile(a).catch(m=>{(0,j.D_)(m)||re.Z.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource").error(new H.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:m}))}).then(()=>_.end())}unsubscribe(a){super.unsubscribe(a)}readers(a){return this._subscriptions.get(a).readers()}query(a){var c=this;return(0,Z.Z)(function*(){return c._adapter.executeQuery(a,{query:c._schema.customParameters})})()}queryLastEditDate(){var a=this;return(0,Z.Z)(function*(){const c=a._serviceInfo.source,_={...c.query,f:"json"};return(yield(0,z.default)(c.path,{query:_,responseType:"json"})).data.editingInfo.lastEditDate})()}createTileQuery(a,c={}){const _=this._serviceInfo.geometryType,m=this.createQuery(c);m.quantizationParameters=c.quantizationParameters??a.getQuantizationParameters(),m.resultType="tile",m.geometry=a.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===_&&(m.maxAllowableOffset=a.resolution*(0,R.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==_&&"esriGeometryPolygon"!==_||(m.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===_&&(m.maxAllowableOffset*=(0,R.Z)("feature-polyline-generalization-factor")));const x=this._serviceInfo.capabilities.query;return m.defaultSpatialReferenceEnabled=x.supportsDefaultSpatialReference,m.compactGeometryEnabled=x.supportsCompactGeometry,m}_executePatchQuery(a,c,_,m){var x=this;return(0,Z.Z)(function*(){const b=c.clone();b.outFields=[x._serviceInfo.objectIdField,..._],b.returnCentroid=!1,b.returnGeometry=!1;const C=(0,w.pC)(b.start)?b.start/8e3:0;return x._patchQueue.push({tile:a,query:b,signal:m.signal,depth:C})})()}_resend(a,c){var _=this;return(0,Z.Z)(function*(){const{query:m,message:x}=a,b=(0,w.pC)(m.outFields)?m.outFields:[],C=_._queryInfo.outFields,M=C.filter(F=>!b.includes(F));if((0,w.Wi)(x.addOrUpdate))_._onMessage({...x,type:"append"});else if(M.length)try{const F=_._subscriptions.get(x.id).tile,U=yield _._executePatchQuery(F,m,M,c);(0,j.k_)(c),m.outFields=C,x.addOrUpdate.joinAttributes(U),_._onMessage({...x,end:x.end,type:"append"})}catch{}else _._onMessage({...x,type:"append"})})()}_resendSubscription(a){var c=this;return(0,Z.Z)(function*(){if((0,R.Z)("esri-2d-update-debug")&&console.debug(a.tile.id,"Resend Subscription"),a.empty)return c._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const _=a.signal;for(const m of a.requests.done)yield c._resend(m,{signal:_});return(0,w.pC)(a.edits)?c._onMessage(a.edits):void 0})()}resend(){var a=this;return(0,Z.Z)(function*(){const c=Array.from(a._subscriptions.values());yield Promise.all(c.map(_=>a._resendSubscription(_)))})()}}const ns=(0,R.Z)("esri-mobile"),fs={maxDrillLevel:ns?1:4,maxRecordCountFactor:ns?1:3};class ps extends Kt{constructor(a){super(a)}_fetchDataTile(a){var c=this;return(0,Z.Z)(function*(){const _=c._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,m=c._subscriptions.get(a.key.id),x=m.signal,b=a.getQuantizationParameters();let C=0;const M=function(){var F=(0,Z.Z)(function*(U,D){const G=c._queryInfo,Q=c.createTileQuery(U,{maxRecordCountFactor:_?fs.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:b});C++;try{const ee=yield c._queue.push({tile:a,query:Q,signal:x,depth:D});if(C--,(0,j.k_)(x),!ee)return;if(G!==c._queryInfo)return void M(U,D);if(ee.exceededTransferLimit&&D<fs.maxDrillLevel){for(const ie of U.createChildTiles())M(ie,D+1);return}const K={id:a.id,addOrUpdate:ee,end:0===C,type:"append"};m.add({query:Q,message:K}),c._onMessage(K)}catch(ee){(0,j.D_)(ee)||c._onMessage({id:a.id,addOrUpdate:null,end:!0,type:"append"})}});return function(D,G){return F.apply(this,arguments)}}();M(a,0)})()}}var as=O(76279),B=O(5075),fe=O(3542);function be(v,a){const c=v.weakClone();if((0,w.pC)(v.geometry)){const _=(0,P.Jd)(a,v.geometry.coords[0]),m=(0,P.IN)(a,v.geometry.coords[1]);c.geometry=new we.Z([],[_,m])}return c}class ke{constructor(a,c){this.onUpdate=a,this._geometryType=c,this._objectIdToFeature=new Map}get _features(){const a=[];return this._objectIdToFeature.forEach(c=>a.push(c)),a}add(a){this._objectIdToFeature.set(a.objectId,a),this._index=null}get(a){return this._objectIdToFeature.has(a)?this._objectIdToFeature.get(a):null}forEach(a){this._objectIdToFeature.forEach(a)}search(a){return this._index||(this._index=function Ke(v,a){const c=(0,as.r)(9,function De(v){return"esriGeometryPoint"===v?a=>(0,w.pC)(a.geometry)?{minX:a.geometry.coords[0],minY:a.geometry.coords[1],maxX:a.geometry.coords[0],maxY:a.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:a=>{let c=1/0,_=1/0,m=-1/0,x=-1/0;return(0,w.pC)(a.geometry)&&a.geometry.forEachVertex((b,C)=>{c=Math.min(c,b),_=Math.min(_,C),m=Math.max(m,b),x=Math.max(x,C)}),{minX:c,minY:_,maxX:m,maxY:x}}}(a));return c.load(v),c}(this._features,this._geometryType)),function $t(v,a){return v.search({minX:a.bounds[0],minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]})}(this._index,a)}removeById(a){const c=this._objectIdToFeature.get(a);return c?(this._objectIdToFeature.delete(a),this._index=null,c):null}update(a,c){this.onUpdate(a,c)}get size(){return this._objectIdToFeature.size}}class It extends Jt{constructor(a){super(a),this.type="geoevent",this._dataReceiveEventEnabled=!1,this._level=0,this._updateInfo={websocket:0,client:0},this._inUpdate=!1;const{outSR:c}=a,{geometryType:_,objectIdField:m,timeInfo:x,purgeOptions:b,source:C,spatialReference:M,serviceFilter:F,maxReconnectionAttempts:U,maxReconnectionInterval:D,updateInterval:G,enableDataReceived:Q,customParameters:ee}=a.serviceInfo,K=new ke(this._onUpdate.bind(this),_),ie=new B.Qo(K,m,x,b),le=(0,fe.createConnection)(C,M,c,_,F,U,D,ee);this._store=K,this._manager=ie,this._connection=le,this._quantize=function Le(v){return"esriGeometryPoint"===v?be:(a,c)=>{const _=a.weakClone(),m=new we.Z,C=(0,P.Nh)(m,a.geometry,!1,!1,v,c,!1,!1);return _.geometry=C,_}}(_),this._dataReceiveEventEnabled=Q,this._handles=[this._connection.on("data-received",ne=>this._onFeature(ne)),(0,q.YP)(()=>le.connectionStatus,ne=>this.events.emit("connectionStatus",ne)),(0,q.YP)(()=>le.errorString,ne=>this.events.emit("errorString",ne))],this._initUpdateInterval=()=>{let ne=performance.now();this._updateIntervalId=setInterval(()=>{const de=performance.now(),oe=de-ne;if(oe>2500){ne=de;const ge=Math.round(this._updateInfo.client/(oe/1e3)),me=Math.round(this._updateInfo.websocket/(oe/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:ge,websocket:me})}a.canAcceptRequest()&&!this._inUpdate&&this._manager.checkForUpdates()},G)},this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._handles.forEach(a=>a.remove()),this._connection.destroy()}_fetchDataTile(){}pauseStream(){this._clearUpdateInterval()}resumeStream(){this._initUpdateInterval()}enableEvent(a,c){"data-received"===a&&(this._dataReceiveEventEnabled=c)}get updating(){return!1}subscribe(a,c){super.subscribe(a,c);const _=this._subscriptions.get(a.id);this._level=a.level;const m=this._getTileFeatures(a);this._onMessage({type:"append",id:a.key.id,addOrUpdate:m,end:!0}),_.didSend=!0}unsubscribe(a){super.unsubscribe(a)}*readers(a){const c=this._subscriptions.get(a),{tile:_}=c;yield this._getTileFeatures(_);for(const m of c.requests.stream.entries)(0,w.pC)(m)&&(0,w.pC)(m.addOrUpdate)&&(yield m.addOrUpdate)}createTileQuery(a){throw new Error("Service does not support tile  queries")}resend(){var a=this;return(0,Z.Z)(function*(){a._subscriptions.forEach(c=>{const{tile:_}=c,m={type:"append",id:_.id,addOrUpdate:a._getTileFeatures(_),end:!0};a._onMessage(m)})})()}_getTileFeatures(a){const c=this._store.search(a).map(_=>this._quantize(_,a.transform));return Te.fromOptimizedFeatures(c,this._serviceInfo,a.transform)}_onFeature(a){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("data-received",a);const c=(0,P.XA)(a,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(c)}catch{}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(a,c){var _=this;return(0,Z.Z)(function*(){_._inUpdate=!0;try{(0,w.pC)(a)&&(_._updateInfo.client+=a.length),_._subscriptions.forEach((x,b)=>{x.didSend&&x.tile.level===_._level&&_._onMessage({type:"append",id:b,addOrUpdate:null,clear:!0,end:!1})});const m=[];_._subscriptions.forEach((x,b)=>{if(!x.didSend||x.tile.level!==_._level)return;const M={type:"append",id:b,addOrUpdate:_._getTileFeatures(x.tile),remove:[],end:!1,status:Me.empty()};x.requests.stream.enqueue(M),m.push(_._onMessage(M))}),yield Promise.all(m),_._subscriptions.forEach((x,b)=>{x.didSend&&x.tile.level===_._level&&_._onMessage({type:"append",id:b,addOrUpdate:null,end:!0})})}catch{}_._inUpdate=!1})()}}class es extends Kt{constructor(a){super(a)}_fetchDataTile(a){var c=this;return(0,Z.Z)(function*(){const x=c._subscriptions.get(a.key.id);let b=!1,C=0,M=0;const F=(G,Q)=>{M--,(0,j.k_)(x);const ee=a.id,K=G.reader,ie=G.query;if(!K.exceededTransferLimit){if(b=!0,0!==Q&&!K.hasFeatures){const de={id:ee,addOrUpdate:K,end:0===M,type:"append"};return x.add({message:de,query:ie}),void c._onMessage(de)}const ne={id:ee,addOrUpdate:K,end:0===M,type:"append"};return x.add({message:ne,query:ie}),void c._onMessage(ne)}const le={id:ee,addOrUpdate:K,end:b&&0===M,type:"append"};x.add({message:le,query:ie}),c._onMessage(le)};let U=0,D=0;for(;!b&&D++<20;){let G;for(let Q=0;Q<U+1;Q++){const ee=C++;M++,G=c._fetchDataTilePage(a,ee,x).then(K=>K&&F(K,ee)).catch(K=>{b=!0,(0,j.D_)(K)||(re.Z.getLogger("esri.views.2d.layers.features.sources.PagedFeatureSource").error(new H.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:K})),c._onMessage({id:a.id,addOrUpdate:null,end:b,type:"append"}))})}yield G,(0,j.k_)(x),U=Math.min(U+2,6)}})()}_fetchDataTilePage(a,c,_){var m=this;return(0,Z.Z)(function*(){(0,j.k_)(_);const x=m._queryInfo,b={start:m.pageSize*c,num:m.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:a.getQuantizationParameters()};(0,w.pC)(m.maxRecordCountFactor)&&(b.maxRecordCountFactor=m.maxRecordCountFactor);const C=m.createTileQuery(a,b);try{const M=_.signal,F=yield m._queue.push({tile:a,query:C,signal:M,depth:c});return(0,j.k_)(_),F?x!==m._queryInfo?m._fetchDataTilePage(a,c,_):{reader:F,query:C}:null}catch(M){return(0,j.H9)(M),null}})()}}var _s=O(4619),ms=O(52397);function ys(v,a,c){const _=v.getXHydrated(),m=v.getYHydrated(),x=a.getColumnForX(_),b=Math.floor(a.normalizeCol(x));return`${c}/${Math.floor(a.getRowForY(m))}/${b}`}function ts(v,a){if((0,w.Wi)(v))return null;const c=a.transform,_=v.getQuantizationTransform();if((0,w.Wi)(_)){const[ie,le]=c.scale,[ne,de]=c.translate;return v.transform(-ne/ie,de/le,1/ie,1/-le)}const[m,x]=_.scale,[b,C]=_.translate,[M,F]=c.scale,[U,D]=c.translate;return v.transform((b-U)/M,(-C+D)/F,m/M,x/F)}class Is extends Kt{constructor(a){super(a),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new _s.Z(1e3),this._store=a.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(a,c){super.update(a,c),null==this._featureCount&&(this._featureCount=c.initialFeatureCount),(0,w.pC)(c.changedFeatureCount)&&(this._featureCount=c.changedFeatureCount),this._hasAggregates=a.targets.aggregate}resend(a=!1){var c=this;return(0,Z.Z)(function*(){if(yield c._downloadPromise,c._invalidated||a){const m=(0,w.s3)(c._featureCount,"Expected featureCount to be defined");return c._invalidated=!1,c._subscriptions.forEach(x=>x.clear()),c._downloadPromise=c._download(m),void(yield c._downloadPromise)}const _=c._queries.map(({query:m,reader:x})=>c._sendPatchQuery(m,x));yield Promise.all(_),c._subscriptions.forEach(m=>{m.requests.done.forEach(x=>c._onMessage(x.message))})})()}refresh(a,c){var _=this;return(0,Z.Z)(function*(){c&&(_._featureCount=c.featureCount),yield _.resend(!0)})()}_sendPatchQuery(a,c){var _=this;return(0,Z.Z)(function*(){const m=(0,w.pC)(a.outFields)?a.outFields:[],x=_._queryInfo.outFields,b=x.filter(U=>!m.includes(U));if(!b.length)return;const C=a.clone(),M=_._signal;C.returnGeometry=!1,C.returnCentroid=!1,C.outFields=b,a.outFields=x;const F=yield _._queue.push({query:C,depth:0,signal:M});(0,j.k_)({signal:M}),c.joinAttributes(F)})()}_fetchDataTile(a){var c=this;return(0,Z.Z)(function*(){if(!c._downloadPromise){const F=(0,w.s3)(c._featureCount,"Expected featureCount to be defined");c._downloadPromise=c._download(F)}const _=c._store.search(a),m=c._subscriptions.get(a.key.id),x=_.length-1;for(let F=0;F<x;F++){const U=ts(_[F],a),D={type:"append",id:a.id,addOrUpdate:U,end:!1,status:Me.empty()};m.add({query:null,message:D}),c._hasAggregates||(yield(0,j.e4)(1)),c._onMessage(D)}const b=ts(x>=0?_[x]:null,a),M={type:"append",id:a.id,addOrUpdate:b,end:c._didSendEnd,status:Me.empty()};m.add({query:null,message:M}),c._onMessage(M)})()}_download(a){var c=this;return(0,Z.Z)(function*(){try{yield c.whenInitialized();const _=c._store.storage.getBitset(c._markedIdsBufId),m=new Set;_.clear();const x=Math.ceil(a/c.pageSize),b=Array.from({length:x},(C,M)=>M).sort((C,M)=>c._random.getInt()-c._random.getInt()).map(C=>c._downloadPage(C,_,m));yield Promise.all(b),c._store.sweepFeatures(_,c._store.storage),c._store.sweepFeatureSets(m)}catch(_){re.Z.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",_)}c._sendEnd(),c._loading=!1})()}_downloadPage(a,c,_){var m=this;return(0,Z.Z)(function*(){const x=m.pageSize,b={start:a*x,num:x,cacheHint:!0};(0,w.pC)(m.maxRecordCountFactor)&&(b.maxRecordCountFactor=m.maxRecordCountFactor);const C=m.createQuery(b),M=m._signal,F=yield m._queue.push({query:C,depth:a,signal:M});(0,j.k_)({signal:M}),m._queries.push({query:C,reader:F}),m._store.insert(F),_.add(F.instance);const U=F.getCursor();for(;U.next();)c.set(U.getDisplayId());m._send(F)})()}_send(a){if(!this._subscriptions.size)return;let c=null;const _=new Map,m=new Set,x=new Map;this._subscriptions.forEach(b=>{const C=b.tile;_.set(C.key.id,null),c=C.tileInfoView,m.add(C.level);const{row:M,col:F}=C.key,U=`${C.level}/${M}/${F}`,D=x.get(U)??[];D.push(b),x.set(U,D)});for(const b of m){const C=c.getLODInfoAt(b),M=a.getCursor();for(;M.next();){const F=ys(M,C,b),U=M.getIndex();if(x.has(F))for(const D of x.get(F)){const G=D.tile.id;let Q=_.get(G);(0,w.Wi)(Q)&&(Q=[],_.set(G,Q)),Q.push(U)}}}_.forEach((b,C)=>{if((0,w.pC)(b)){const M=this._subscriptions.get(C),F={type:"append",id:C,addOrUpdate:ts(ms.t.from(a,b),M.tile),end:!1,status:Me.empty()};M.add({query:null,message:F}),this._onMessage(F)}})}_sendEnd(){this._subscriptions.forEach(a=>{const c={type:"append",id:a.tile.id,addOrUpdate:null,end:!0,status:Me.empty()};a.add({query:null,message:c}),this._onMessage(c)}),this._didSendEnd=!0}}var Js=O(21286),Re=O(39351),ve=O(99666),Ks=O(64288);O(81295),O(39406);var Zt=O(67969);const Xt=re.Z.getLogger("esri.views.layers.2d.features.support.AttributeStore"),os=(Xt,()=>null),ss={sharedArrayBuffer:(0,R.Z)("esri-shared-array-buffer"),atomics:(0,R.Z)("esri-atomics")};function ws(v,a){return c=>a(v(c))}class nr{constructor(a,c,_,m){this.size=0,this.texelSize=4;const{pixelType:x,layout:b,textureOnly:C}=m;this.textureOnly=C||!1,this.pixelType=x,this._ctype=c,this.layout=b,this._resetRange(),this._shared=a,this.size=_,C||(this.data=this._initData(x,_,a,c))}get buffer(){return(0,w.yw)(this.data,a=>a.buffer)}unsetComponentAllTexels(a,c){const _=(0,w.Wg)(this.data);for(let m=0;m<this.size*this.size;m++)_[m*this.texelSize+a]&=~c;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(a,c){const _=(0,w.Wg)(this.data);for(let m=0;m<this.size*this.size;m++)_[m*this.texelSize+a]|=255&c;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(a,c,_){const m=(0,w.Wg)(this.data);for(const x of _)m[x*this.texelSize+a]|=c,this.dirtyStart=Math.min(this.dirtyStart,x),this.dirtyEnd=Math.max(this.dirtyEnd,x)}setComponentTexel(a,c,_){(0,w.Wg)(this.data)[_*this.texelSize+a]|=c,this.dirtyStart=Math.min(this.dirtyStart,_),this.dirtyEnd=Math.max(this.dirtyEnd,_)}unsetComponentTexel(a,c,_){(0,w.Wg)(this.data)[_*this.texelSize+a]&=~c,this.dirtyStart=Math.min(this.dirtyStart,_),this.dirtyEnd=Math.max(this.dirtyEnd,_)}getData(a,c){const _=(0,ve.jL)(a);return(0,w.Wg)(this.data)[_*this.texelSize+c]}setData(a,c,_){const m=(0,ve.jL)(a);0!=(this.layout&1<<c)?(this.data[m*this.texelSize+c]=_,this.dirtyStart=Math.min(this.dirtyStart,m),this.dirtyEnd=Math.max(this.dirtyEnd,m)):Xt.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){this.pixelType===Zt.Br.UNSIGNED_BYTE&&this._shared&&ss.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){this.pixelType===Zt.Br.UNSIGNED_BYTE&&this._shared&&ss.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(a){if(this.size=a,!this.textureOnly){const c=this._initData(this.pixelType,a,this._shared,this._ctype),_=(0,w.Wg)(this.data);c.set(_),this.data=c}}toMessage(){const a=this.dirtyStart,c=this.dirtyEnd,_=this.texelSize;if(a>c)return null;this._resetRange();const m=!(this._shared||"local"===this._ctype),x=this.pixelType,b=this.layout,C=(0,w.Wg)(this.data);return{start:a,end:c,data:m&&C.slice(a*_,(c+1)*_)||null,pixelType:x,layout:b}}_initData(a,c,_,m){const x=_&&"local"!==m?SharedArrayBuffer:ArrayBuffer,b=(0,Ks.UK)(a),C=new b(new x(c*c*4*b.BYTES_PER_ELEMENT));for(let M=0;M<C.length;M+=4)C[M+1]=255;return C}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class ar{constructor(a,c,_=(()=>{})){this._client=a,this.config=c,this._notifyChange=_,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(Re.m4),this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const m=c.supportsTextureFloat?Zt.Br.FLOAT:Zt.Br.UNSIGNED_BYTE;os(`Creating AttributeStore ${ss.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:Zt.Br.UNSIGNED_BYTE,layout:1},{pixelType:Zt.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:Zt.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:m,layout:15},{pixelType:m,layout:15},{pixelType:m,layout:15},{pixelType:m,layout:15}],this._blocks=this._blockDescriptors.map(()=>null)}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}get hasHighlight(){return this._idsToHighlight.size>0}isUpdating(){return!!this._currUpdate||!!this._nextUpdate}update(a,c){this.config=c;const _=c.schema.processors[0].storage,m=(0,ze.Hg)(this._schema,_);if((a.targets.feature||a.targets.aggregate)&&(a.storage.data=!0),m&&((0,R.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",m),a.storage.data=!0,this._schema=_,this._attributeComputeMap.clear(),!(0,w.Wi)(_))){switch(_.target){case"feature":this._targetType=ve.PX;break;case"aggregate":this._targetType=ve.xp}if("subtype"===_.type)for(const x in _.mapping){const b=_.mapping[x];if((0,w.pC)(b)&&(0,w.pC)(b.vvMapping))for(const C of b.vvMapping)this._bindAttribute(C)}else{if((0,w.pC)(_.vvMapping))for(const x of _.vvMapping)this._bindAttribute(x);if((0,w.pC)(_.attributeMapping))for(const x of _.attributeMapping)this._bindAttribute(x)}}}onTileData(a,c){if((0,w.Wi)(c.addOrUpdate))return;const _=c.addOrUpdate.getCursor();for(;_.next();){const m=_.getDisplayId();this.setAttributeData(m,_)}}setHighlight(a,c){var _=this;return(0,Z.Z)(function*(){const x=_._getBlock(0),b=c.map(C=>(0,ve.jL)(C));x.lock(),x.unsetComponentAllTexels(0,1),x.setComponent(0,1,b),x.unlock(),_._idsToHighlight.clear();for(const C of a)_._idsToHighlight.add(C);yield _.sendUpdates()})()}updateFilters(a,c,_){var m=this;return(0,Z.Z)(function*(){const{service:x,spatialReference:b}=_,{filters:C}=c,M=C.map((F,U)=>m._updateFilter(F,U,x,b));(yield Promise.all(M)).some(F=>F)&&(a.storage.filters=!0,(0,R.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))})()}setData(a,c,_,m){const x=(0,ve.jL)(a);this._ensureSizeForTexel(x),this._getBlock(c).setData(a,_,m)}getData(a,c,_){return this._getBlock(c).getData(a,_)}getHighlightFlag(a){return this._idsToHighlight.has(a)?Re.uG:0}unsetAttributeData(a){const c=(0,ve.jL)(a);this._getBlock(0).setData(c,0,0)}setAttributeData(a,c){const _=(0,ve.jL)(a);if(this._ensureSizeForTexel(_),this._getBlock(0).setData(_,0,this.getFilterFlags(c)),this._targetType!==(0,ve.vs)(a))return;const m=this._attributeComputeMap,x=this.config.supportsTextureFloat?1:2;m.size&&m.forEach((C,M)=>{const F=M*x%4,U=Math.floor(M*x/4),D=this._getBlock(U+Re.aK),G=C(c);if(this.config.supportsTextureFloat)D.setData(_,F,G);else if(G===Re.AI)D.setData(_,F,255),D.setData(_,F+1,255);else{const Q=(0,Js.uZ)(Math.round(G),-32767,32766)+32768,K=(65280&Q)>>8;D.setData(_,F,255&Q),D.setData(_,F+1,K)}})}sendUpdates(){if((0,R.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate"),this._notifyChange(),this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=(0,j.hh)(),this._nextUpdate.promise;const a={blocks:this._blocks.map(c=>(0,w.pC)(c)?c.toMessage():null)};return this._currUpdate=this._createResources().then(()=>{const c=()=>{if(this._currUpdate=null,this._nextUpdate){const m=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then(()=>m.resolve())}else(0,R.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::No additional updates queued");this._notifyChange()};(0,R.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::client.update");const _=this._client.update(a,this._signal).then(c).catch(c);return this._client.render(this._signal),_}).catch(c=>{if((0,j.D_)(c))return this._createResourcesPromise=null,this._createResources();this._notifyChange(),Xt.error(new H.Z("mapview-attribute-store","Encountered an error during client update",c))}),this._currUpdate}_ensureSizeForTexel(a){for(;a>=this._size*this._size;)if(this._expand())return}_bindAttribute(a){let m;if(null!=a.fieldIndex)m=function _(){return a.normalizationField&&Xt.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),b=>b.getComputedNumericAtIndex(a.fieldIndex)}();else{if(!a.field)return;m=function c(){return a.normalizationField?b=>{const C=b.readAttribute(a.normalizationField);return C?b.readAttribute(a.field)/C:null}:b=>b.readAttribute(a.field)}()}a.valueRepresentation&&(m=ws(m,b=>function tr(v,a){if(!v||!a)return v;switch(a){case"radius":case"distance":return 2*v;case"diameter":case"width":return v;case"area":return Math.sqrt(v)}return v}(b,a.valueRepresentation))),this._attributeComputeMap.set(a.binding,ws(m,b=>null===b||isNaN(b)||b===1/0||b===-1/0?Re.AI:b))}_createResources(){if((0,w.pC)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(Re.xl),this._getBlock(Re.pU),os("Initializing AttributeStore");const a={shared:ss.sharedArrayBuffer&&"local"!==this._client.type,size:this._size,blocks:(0,w.Fd)(this._blocks,_=>({textureOnly:_.textureOnly,buffer:_.buffer,pixelType:_.pixelType}))},c=this._client.initialize(a,this._signal).catch(_=>{(0,j.D_)(_)?this._createResourcesPromise=null:Xt.error(new H.Z("mapview-attribute-store","Encountered an error during client initialization",_))});return this._createResourcesPromise=c,c.then(()=>(0,w.Wi)(this._createResourcesPromise)?this._createResources():void 0),c}_getBlock(a){const c=this._blocks[a];if((0,w.pC)(c))return c;os(`Initializing AttributeBlock at index ${a}`);const x=new nr(ss.sharedArrayBuffer,this._client.type,this._size,this._blockDescriptors[a]);return this._blocks[a]=x,this._createResourcesPromise=null,x}_expand(){if(this._size<this.config.maxTextureSize){const a=this._size<<=1;return os("Expanding block size to",a,this._blocks),(0,w.JR)(this._blocks,c=>c.expand(a)),this._createResourcesPromise=null,this._size=a,0}return Xt.error(new H.Z("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}_updateFilter(a,c,_,m){var x=this;return(0,Z.Z)(function*(){const b=x._filters[c],C=(0,w.pC)(b)&&b.hash;if(!b&&!a||C===JSON.stringify(a))return!1;if((0,w.Wi)(a)){if(!b)return!1;const F=1<<c+1,U=x._getBlock(0);return x._filters[c]=null,U.setComponentAllTexels(0,F),x.sendUpdates(),!0}return yield(yield x._getFilter(c,_)).update(a,m),!0})()}_getFilter(a,c){var _=this;return(0,Z.Z)(function*(){const m=_._filters[a];if((0,w.pC)(m))return m;const{default:x}=yield O.e(8967).then(O.bind(O,8967)),b=new x({geometryType:c.geometryType,hasM:!1,hasZ:!1,timeInfo:c.timeInfo,fieldsIndex:new A.Z(c.fields)});return _._filters[a]=b,b})()}isVisible(a){return!!(2&this._getBlock(0).getData(a,0))}getFilterFlags(a){let c=0;const _=(0,ve.KS)(a.getDisplayId());for(let x=0;x<this._filters.length;x++){const C=this._filters[x];c|=(_&1<<x&&!(0,w.Wi)(C)&&!C.check(a)?0:1)<<x}let m=0;if(this._idsToHighlight.size){const x=a.getObjectId();m=this.getHighlightFlag(x)}return c<<1|m}}function ls(v,a,c,_){_%2&&(_+=1);let m=0,x=0,b=-90,C=90,M=-180,F=180;for(let U=0;U<_/2;U++){for(let D=0;D<5;D++){const G=(M+F)/2,Q=c>G?1:0;m|=Q<<29-(D+5*U),M=(1-Q)*M+Q*G,F=(1-Q)*G+Q*F}for(let D=0;D<5;D++){const G=(b+C)/2,Q=a>G?1:0;x|=Q<<29-(D+5*U),b=(1-Q)*b+Q*G,C=(1-Q)*G+Q*C}}v.geohashX=m,v.geohashY=x}function ds(v,a,c,_,m){m%2&&(m+=1);let x=0,b=0,C=-90,M=90,F=-180,U=180;for(let D=0;D<m/2;D++){for(let G=0;G<5;G++){const Q=(F+U)/2,ee=_>Q?1:0;x|=ee<<29-(G+5*D),F=(1-ee)*F+ee*Q,U=(1-ee)*Q+ee*U}for(let G=0;G<5;G++){const Q=(C+M)/2,ee=c>Q?1:0;b|=ee<<29-(G+5*D),C=(1-ee)*C+ee*Q,M=(1-ee)*Q+ee*M}}v[2*a]=x,v[2*a+1]=b}O(29132),new Float64Array(2),new Float64Array(2);var xt=O(65234),St=O(82959);class Ns{constructor(a=[],c,_=8096){this.onRelease=m=>{},this._nodes=0,this._root=new Ss(this,0,0,0),this._statisticFields=a,this._pool=_?new Nt.Z(8096):null,this._serviceInfo=c}destroy(){this.clear()}_acquire(a,c,_){this._nodes++;let m=null;return(0,w.pC)(this._pool)&&(m=this._pool.dequeue()),(0,w.pC)(m)?m.realloc(a,c,_):m=new Ss(this,a,c,_),m}_release(a){this.onRelease(a),this._nodes--,(0,w.pC)(this._pool)&&this._pool.enqueue(a)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return(0,w.R2)(this._pool,0,a=>a.size)}get depth(){let a=0;return this.forEach(c=>a=Math.max(a,c.depth)),a}dropLevels(a){this.forEach(c=>{if(c.depth>=a)for(let _=0;_<c.children.length;_++){const m=c.children[_];m&&this._release(m)}}),this.forEach(c=>{if(c.depth>=a)for(let _=0;_<c.children.length;_++)c.children[_]=null})}clear(){this.forEach(a=>this._release(a)),this._root=new Ss(this,0,0,0)}insert(a,c,_=0){const m=Te.fromOptimizedFeatures([a],this._serviceInfo).getCursor();m.next();const x=m.readGeometry();if(!x)return;const[b,C]=x.coords;this.insertCursor(m,a.displayId,b,C,a.geohashX,a.geohashY,c,_)}insertCursor(a,c,_,m,x,b,C,M=0){let F=this._root,U=0,D=0,G=0;for(;null!==F;){if(F.depth>=M&&(F.count+=1,F.xTotal+=_,F.yTotal+=m,F.xGeohashTotal+=x,F.yGeohashTotal+=b,F.referenceId=c,this._updateStatisticsCursor(a,F,1)),U>=C)return void F.add(c);const Q=Math.ceil((U+1)/2),ee=Math.floor((U+1)/2),K=1-U%2,ie=30-(3*Q+2*ee),le=30-(2*Q+3*ee),ne=(x&7*K+3*(1-K)<<ie)>>ie,de=(b&3*K+7*(1-K)<<le)>>le,oe=ne+de*(8*K+4*(1-K));D=D<<3*K+2*(1-K)|ne,G=G<<2*K+3*(1-K)|de,null==F.children[oe]&&(F.children[oe]=this._acquire(D,G,U+1)),U+=1,F=F.children[oe]}}remove(a,c){const _=Te.fromOptimizedFeatures([a],this._serviceInfo).getCursor();_.next();const m=_.readGeometry();if(!m)return;const[x,b]=m.coords;this.removeCursor(_,x,b,a.geohashX,a.geohashY,c)}removeCursor(a,c,_,m,x,b){let C=this._root,M=0;for(;null!==C;){if(C.count-=1,C.xTotal-=c,C.yTotal-=_,C.xGeohashTotal-=m,C.yGeohashTotal-=x,this._updateStatisticsCursor(a,C,-1),M>=b)return void C.remove(a.getDisplayId());const F=Math.ceil((M+1)/2),U=Math.floor((M+1)/2),D=1-M%2,G=30-(3*F+2*U),Q=30-(2*F+3*U),ee=((m&7*D+3*(1-D)<<G)>>G)+((x&3*D+7*(1-D)<<Q)>>Q)*(8*D+4*(1-D)),K=C.children[ee];1===K?.count&&(this._release(K),C.children[ee]=null),M+=1,C=K}}forEach(a){let c=this._root;for(;null!==c;){const _=this._linkChildren(c)||c.next;a(c),c=_}}find(a,c,_){return this._root.find(a,c,_,0,0,0)}findIf(a){let c=null;return this.forEach(_=>{a(_)&&(c=_)}),c}findAllIf(a){const c=[];return this.forEach(_=>{a(_)&&c.push(_)}),c}findSingleOccupancyNode(a,c,_,m,x){let b=this._root;for(;null!==b;){const C=b.depth,M=b.xNode,F=b.yNode,U=1-C%2,D=b.xGeohashTotal/b.count,G=b.yGeohashTotal/b.count;if(1===b.count&&a<D&&D<=_&&c<G&&G<=m)return b;if(C>=x){b=b.next;continue}const Q=Math.ceil((C+1)/2),ee=Math.floor((C+1)/2),K=30-(3*Q+2*ee),ie=30-(2*Q+3*ee),le=~((1<<K)-1),ne=~((1<<ie)-1),oe=(c&ne)>>ie,ge=(_&le)>>K,me=(m&ne)>>ie,pe=M<<3*U+2*(1-U),Ae=F<<2*U+3*(1-U),Ee=pe+8*U+4*(1-U),_e=Ae+4*U+8*(1-U),Se=Math.max(pe,(a&le)>>K),Fe=Math.max(Ae,oe),Ue=Math.min(Ee,ge),Ze=Math.min(_e,me);let je=null,ht=null;for(let Be=Fe;Be<=Ze;Be++)for(let st=Se;st<=Ue;st++){const Oe=b.children[st-pe+(Be-Ae)*(8*U+4*(1-U))];Oe&&(je||(je=Oe,je.next=b.next),ht&&(ht.next=Oe),ht=Oe,Oe.next=b.next)}b=je||b.next}return null}getRegionDisplayIds(a){let c=this._root;const{bounds:_,geohashBounds:m,level:x}=a,[b,C,M,F]=_,U=[];for(;null!==c;){const D=c.depth,G=c.xNode,Q=c.yNode;if(D>=x){const Ve=c.xTotal/c.count,Oe=c.yTotal/c.count;Ve>=b&&Ve<=M&&Oe>=C&&Oe<=F&&c.displayIds.forEach(Tt=>U.push(Tt)),c=c.next;continue}const ee=Math.ceil((D+1)/2),K=Math.floor((D+1)/2),ie=1-D%2,le=30-(3*ee+2*K),ne=30-(2*ee+3*K),de=~((1<<le)-1),oe=~((1<<ne)-1),me=(m.yLL&oe)>>ne,pe=(m.xTR&de)>>le,Ae=(m.yTR&oe)>>ne,Ee=G<<3*ie+2*(1-ie),_e=Q<<2*ie+3*(1-ie),Se=Ee+8*ie+4*(1-ie),Fe=_e+4*ie+8*(1-ie),Ue=Math.max(Ee,(m.xLL&de)>>le),Ze=Math.max(_e,me),je=Math.min(Se,pe),ht=Math.min(Fe,Ae);let Be=null,st=null;for(let Ve=Ze;Ve<=ht;Ve++)for(let Oe=Ue;Oe<=je;Oe++){const lt=c.children[Oe-Ee+(Ve-_e)*(8*ie+4*(1-ie))];lt&&(Be||(Be=lt,Be.next=c.next),st&&(st.next=lt),st=lt,lt.next=c.next)}c=Be||c.next}return U}getRegionStatistics(a){let c=this._root,_=0,m=0,x=0;const b={},{bounds:C,geohashBounds:M,level:F}=a,[U,D,G,Q]=C;let ee=0;for(;null!==c;){const K=c.depth,ie=c.xNode,le=c.yNode;if(K>=F){const Ft=c.xTotal/c.count,At=c.yTotal/c.count;Ft>U&&Ft<=G&&At>D&&At<=Q&&(_+=c.count,m+=c.xTotal,x+=c.yTotal,1===c.count&&(ee=c.referenceId),this._aggregateStatistics(b,c.statistics)),c=c.next;continue}const ne=Math.ceil((K+1)/2),de=Math.floor((K+1)/2),oe=1-K%2,ge=30-(3*ne+2*de),me=30-(2*ne+3*de),pe=~((1<<ge)-1),Ae=~((1<<me)-1),_e=(M.yLL&Ae)>>me,Se=(M.xTR&pe)>>ge,Fe=(M.yTR&Ae)>>me,Ue=ie<<3*oe+2*(1-oe),Ze=le<<2*oe+3*(1-oe),je=Ue+8*oe+4*(1-oe),ht=Ze+4*oe+8*(1-oe),Be=Math.max(Ue,(M.xLL&pe)>>ge),st=Math.max(Ze,_e),Ve=Math.min(je,Se),Oe=Math.min(ht,Fe);let Tt=null,lt=null;for(let Ft=st;Ft<=Oe;Ft++)for(let At=Be;At<=Ve;At++){const Pe=c.children[At-Ue+(Ft-Ze)*(8*oe+4*(1-oe))];if(Pe){if(Ft!==st&&Ft!==Oe&&At!==Be&&At!==Ve){const Vs=Pe.xTotal/Pe.count,Hs=Pe.yTotal/Pe.count;Vs>U&&Vs<=G&&Hs>D&&Hs<=Q&&(_+=Pe.count,m+=Pe.xTotal,x+=Pe.yTotal,1===Pe.count&&(ee=Pe.referenceId),this._aggregateStatistics(b,Pe.statistics));continue}Tt||(Tt=Pe,Tt.next=c.next),lt&&(lt.next=Pe),lt=Pe,Pe.next=c.next}}c=Tt||c.next}return{count:_,attributes:this.normalizeStatistics(b,_),xTotal:m,yTotal:x,referenceId:ee}}getBins(a){const c=[],{geohashBounds:_,level:m}=a;let x=this._root;for(;null!==x;){const b=x.depth,C=x.xNode,M=x.yNode;if(b>=m){c.push(x),x=x.next;continue}const F=Math.ceil((b+1)/2),U=Math.floor((b+1)/2),D=1-b%2,G=30-(3*F+2*U),Q=30-(2*F+3*U),ee=~((1<<G)-1),K=~((1<<Q)-1),le=(_.yLL&K)>>Q,ne=(_.xTR&ee)>>G,de=(_.yTR&K)>>Q,oe=C<<3*D+2*(1-D),ge=M<<2*D+3*(1-D),me=oe+8*D+4*(1-D),pe=ge+4*D+8*(1-D),Ae=Math.max(oe,(_.xLL&ee)>>G),Ee=Math.max(ge,le),_e=Math.min(me,ne),Se=Math.min(pe,de);let Fe=null,Ue=null;for(let Ze=Ee;Ze<=Se;Ze++)for(let je=Ae;je<=_e;je++){const Be=x.children[je-oe+(Ze-ge)*(8*D+4*(1-D))];Be&&(Fe||(Fe=Be,Fe.next=x.next),Ue&&(Ue.next=Be),Ue=Be,Be.next=x.next)}x=Fe||x.next}return c}_linkChildren(a){let c=null,_=null;for(let m=0;m<=a.children.length;m++){const x=a.children[m];x&&(c||(c=x,c.next=a.next),_&&(_.next=x),_=x,x.next=a.next)}return c}_updateStatisticsCursor(a,c,_){for(const m of this._statisticFields){const x=m.name,b=m.inField?a.readAttribute(m.inField):a.getComputedNumericAtIndex(m.inFieldIndex);switch(m.statisticType){case"min":if(isNaN(b))break;if(!c.statistics[x]){c.statistics[x]={value:b};break}c.statistics[x].value=Math.min(c.statistics[x].value,b);break;case"max":if(isNaN(b))break;if(!c.statistics[x]){c.statistics[x]={value:b};break}c.statistics[x].value=Math.max(c.statistics[x].value,b);break;case"count":break;case"sum":case"avg":{c.statistics[x]||(c.statistics[x]={value:0,nanCount:0});const C=c.statistics[x].value,M=c.statistics[x].nanCount??0;null==b||isNaN(b)?c.statistics[x].nanCount=M+_:c.statistics[x].value=C+_*b;break}case"avg_angle":{c.statistics[x]||(c.statistics[x]={x:0,y:0,nanCount:0});const C=c.statistics[x].x,M=c.statistics[x].y,F=c.statistics[x].nanCount??0,U=Math.PI/180;null==b||isNaN(b)?c.statistics[x].nanCount=F+_:(c.statistics[x].x=C+_*Math.cos(b*U),c.statistics[x].y=M+_*Math.sin(b*U));break}case"mode":c.statistics[x]||(c.statistics[x]={}),c.statistics[x][b]=(c.statistics[x][b]||0)+_}}}_aggregateStatistics(a,c){for(const _ of this._statisticFields){const m=_.name;switch(_.statisticType){case"min":if(!a[m]){a[m]={value:c[m].value};break}a[m].value=Math.min(a[m].value,c[m].value);break;case"max":if(!a[m]){a[m]={value:c[m].value};break}a[m].value=Math.max(a[m].value,c[m].value);break;case"count":break;case"sum":case"avg":case"avg_angle":case"mode":a[m]||(a[m]={});for(const x in c[m])a[m][x]=(a[m][x]||0)+c[m][x]}}}normalizeStatistics(a,c){const _={};for(const m of this._statisticFields){const x=m.name;switch(m.statisticType){case"min":case"max":{const b=a[x];if(!c||!b)break;_[x]=b.value;break}case"count":if(!c)break;_[x]=c;break;case"sum":{if(!c)break;const{value:b,nanCount:C}=a[x];if(!(c-C))break;_[x]=b;break}case"avg":{if(!c)break;const{value:b,nanCount:C}=a[x];if(!(c-C))break;_[x]=b/(c-C);break}case"avg_angle":{if(!c)break;const{x:b,y:C,nanCount:M}=a[x];if(!(c-M))break;const D=180/Math.PI,G=Math.atan2(C/(c-M),b/(c-M))*D;_[x]=G;break}case"mode":{const b=a[x];let C=0,M=0,F=null;for(const U in b){const D=b[U];D===C?M+=1:D>C&&(C=D,M=1,F=U)}_[x]="null"===F||M>1?null:F;break}}}return _}}class Ss{constructor(a,c,_,m){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=a,this.children=new Array(32);for(let x=0;x<this.children.length;x++)this.children[x]=null;this.xNode=c,this.yNode=_,this.depth=m}realloc(a,c,_){for(let m=0;m<this.children.length;m++)this.children[m]=null;return this.xNode=a,this.yNode=c,this.depth=_,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}get id(){return`${this.xNode}.${this.yNode}`}add(a){this.displayIds.add(a)}remove(a){this.displayIds.delete(a)}getAttributes(){const a=this._tree.normalizeStatistics(this.statistics,this.count);return a.referenceId=null,a.aggregateId=this.id,a.aggregateCount=this.count,a}getGeometry(a,c){const _=this.getLngLatBounds(),[m,x,b,C]=_,M=(0,St.iV)({rings:[[[m,x],[m,C],[b,C],[b,x],[m,x]]]},xt.Z.WGS84,a),F=(0,P.Uy)(new we.Z,M,!1,!1);return(0,w.pC)(c)?(0,P.Nh)(new we.Z,F,!1,!1,"esriGeometryPolygon",c,!1,!1):F}getGeometryCentroid(a,c){const _=this.getLngLatBounds(),[m,x,b,C]=_,M=(0,St.iV)({x:(m+b)/2,y:(x+C)/2},xt.Z.WGS84,a),F=(0,P.dd)(new we.Z,M);return(0,w.pC)(c)?(0,P.Nh)(new we.Z,F,!1,!1,"esriGeometryPoint",c,!1,!1):F}getLngLatBounds(){const a=this.depth,c=Math.ceil(a/2),_=Math.floor(a/2);return function ur(v,a){let c=-90,_=90,m=-180,x=180;for(let b=0;b<a;b++){const C=Math.ceil((b+1)/2),M=Math.floor((b+1)/2),F=1-b%2,U=30-(3*C+2*M),D=30-(2*C+3*M),Q=2*F+3*(1-F),K=(7*F+3*(1-F)<<U&v.geohashX)>>U,ie=(3*F+7*(1-F)<<D&v.geohashY)>>D;for(let le=3*F+2*(1-F)-1;le>=0;le--){const ne=(m+x)/2,de=K&1<<le?1:0;m=(1-de)*m+de*ne,x=(1-de)*ne+de*x}for(let le=Q-1;le>=0;le--){const ne=(c+_)/2,de=ie&1<<le?1:0;c=(1-de)*c+de*ne,_=(1-de)*ne+de*_}}return[m,c,x,_]}({geohashX:this.xNode<<30-(3*c+2*_),geohashY:this.yNode<<30-(2*c+3*_)},this.depth)}find(a,c,_,m,x,b){if(m>=_)return this;const C=1-m%2,M=3*C+2*(1-C),F=2*C+3*(1-C),U=30-x-M,D=30-b-F,Q=this.children[((a&7*C+3*(1-C)<<U)>>U)+((c&3*C+7*(1-C)<<D)>>D)*(8*C+4*(1-C))];return null==Q?null:Q.find(a,c,_,m+1,x+M,b+F)}}var Zs=O(5548),bt=O(94425),zs=O(16669),Gs=O(37118),ks=O(2004);const bs=re.Z.getLogger("esri.view.2d.layers.features.support.BinStore");function Ws(v){return 57.29577951308232*v}class pr extends zs.J{constructor(a,c,_,m){super(a,_),this.type="bin",this.events=new Pt.Z,this.objectIdField="aggregateId",this.featureAdapter=E.k,this._geohashLevel=5,this._geohashBuf=[],this._serviceInfo=m,this.geometryInfo=a.geometryInfo,this._spatialReference=c,this._projectionSupportCheck=(0,St._W)(c,xt.Z.WGS84),this._bitsets.geohash=_.getBitset(_.createBitset()),this._bitsets.inserted=_.getBitset(_.createBitset())}destroy(){this._tree&&this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(a,c){var _=()=>super.updateSchema,m=this;return(0,Z.Z)(function*(){const x=m._schema;try{yield _().call(m,a,c),yield m._projectionSupportCheck}catch{}m._fields=m._schema.params.fields;const b=(0,ze.Hg)(x,c);c&&(!(0,w.Wi)(b)||a.source||a.storage.filters)?(((0,ze.uD)(b,"params.fields")||(0,ze.uD)(b,"params")||!m._tree||a.source)&&(m._tree&&m._tree.destroy(),m._tree=new Ns(m._statisticFields,m._serviceInfo),m._tree.onRelease=C=>C.displayId&&m._storage.releaseDisplayId(C.displayId),m._geohashLevel=m._schema.params.fixedBinLevel,m._rebuildTree(),(0,R.Z)("esri-2d-update-debug")&&bs.info("Aggregate mesh needs update due to tree changing")),(0,R.Z)("esri-2d-update-debug")&&bs.info("Aggregate mesh needs update due to tree changing"),a.targets[c.name]=!0,a.mesh=!1):x&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,c){this._bitsets.inserted.forEachSet(_=>{if(!a.has(_)){const m=c.lookupByDisplayIdUnsafe(_);this._remove(m)}})}sweepAggregates(a,c,_){}onTileData(a,c,_,m,x=!0){if(!this._schema||(0,w.Wi)(c.addOrUpdate))return c;this.events.emit("changed");const b=this._getTransforms(a,this._spatialReference);{const M=c.addOrUpdate.getCursor();for(;M.next();)this._update(M,m)}if(c.status.mesh||!x)return c;const C=new Array;this._getBinsForTile(C,a,b,_),c.addOrUpdate=Te.fromOptimizedFeatures(C,{...this._serviceInfo,geometryType:"esriGeometryPolygon"}),c.addOrUpdate.attachStorage(_),c.end=!0,c.isRepush||(c.clear=!0);{const M=c.addOrUpdate.getCursor();for(;M.next();){const F=M.getDisplayId();this._bitsets.computed.unset(F),this.setComputedAttributes(_,M,F,a.scale)}}return c}forEachBin(a){this._tree.forEach(a)}forEach(a){this._tree.forEach(c=>{if(c.depth!==this._geohashLevel)return;const _=this._toFeatureJSON(c),m=Te.fromFeatures([_],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();m.next(),a(m)})}forEachInBounds(a,c){}forEachBounds(a,c,_){const{hasM:m,hasZ:x}=this.geometryInfo;for(const b of a){const C=(0,P.$)([0,0,0,0],b.readGeometry(),x,m);(0,w.Wi)(C)||c((0,Zs.JR)(_,C))}}toArray(){const a=[];return this.forEach(c=>a.push(c)),a}onTileUpdate(a){}getAggregate(a){const c=(0,ve.QS)(a,!0),_=this._tree.findIf(m=>m.displayId===c);return(0,w.yw)(_,m=>this._toFeatureJSON(m))}getAggregates(){return this._tree.findAllIf(a=>a.depth===this._geohashLevel).map(this._toFeatureJSON.bind(this))}getDisplayId(a){const c=this._tree.findIf(_=>_.id===a);return(0,w.yw)(c,_=>_.displayId)}getFeatureDisplayIdsForAggregate(a){const c=this._tree.findIf(_=>_.id===a);return(0,w.R2)(c,[],_=>Array.from(_.displayIds))}getDisplayIdForReferenceId(a){const c=this._tree.findIf(_=>1===_.displayIds.size&&_.displayIds.has(a));return(0,w.yw)(c,_=>_.displayId)}_toFeatureJSON(a){const c=this._spatialReference;return{displayId:a.displayId,attributes:a.getAttributes(),geometry:(0,P.di)(a.getGeometry(c),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const c=a.getDisplayId(),_=a.getXHydrated(),m=a.getYHydrated(),x=this._geohashBuf[2*c],b=this._geohashBuf[2*c+1];this._bitsets.inserted.has(c)&&(this._bitsets.inserted.unset(c),this._tree.removeCursor(a,_,m,x,b,this._geohashLevel))}_update(a,c){const _=a.getDisplayId(),m=this._bitsets.inserted,x=c.isVisible(_);if(x===m.has(_))return;if(!x)return void this._remove(a);const b=a.getXHydrated(),C=a.getYHydrated();this._setGeohash(_,b,C)&&(this._tree.insertCursor(a,_,b,C,this._geohashBuf[2*_],this._geohashBuf[2*_+1],this._geohashLevel),m.set(_))}_setGeohash(a,c,_){if(this._bitsets.geohash.has(a))return!0;const m=this._geohashBuf;if(this._spatialReference.isWebMercator){const x=Ws(c/bt.sv.radius),b=x-360*Math.floor((x+180)/360);ds(m,a,Ws(Math.PI/2-2*Math.atan(Math.exp(-_/bt.sv.radius))),b,12)}else{const x=(0,St.iV)({x:c,y:_},this._spatialReference,xt.Z.WGS84);if(!x)return!1;ds(m,a,x.y,x.x,12)}return this._bitsets.geohash.set(a),!0}_getBinsForTile(a,c,_,m){try{const x=this._getGeohashBounds(c),b=this._tree.getBins(x);for(const C of b){C.displayId||(C.displayId=m.createDisplayId(!0));let M=null;const F=C.getGeometry(this._spatialReference,_.tile);F||(M=C.getGeometryCentroid(this._spatialReference,_.tile));const U=new he.u_(F,C.getAttributes(),M);U.objectId=C.id,U.displayId=C.displayId,a.push(U)}}catch{return void bs.error("Unable to get bins for tile",c.key.id)}}_getGeohash(a,c,_){const m={geohashX:0,geohashY:0};return ls(m,c,a,_),m}_getGeohashBounds(a){const c=this._getGeohashLevel(a.key.level),_=[a.extent.xmin,a.extent.ymin,a.extent.xmax,a.extent.ymax],m=Gs.Z.fromExtent(ks.Z.fromBounds(_,this._spatialReference)),x=(0,St.iV)(m,this._spatialReference,xt.Z.WGS84,{densificationStep:64*a.resolution}),b=(0,P.Uy)(new we.Z,x,!1,!1),C=b.coords.filter((K,ie)=>!(ie%2)),M=b.coords.filter((K,ie)=>ie%2),F=Math.min(...C),U=Math.min(...M),D=Math.max(...C),G=Math.max(...M),Q=this._getGeohash(F,U,c),ee=this._getGeohash(D,G,c);return{bounds:_,geohashBounds:{xLL:Q.geohashX,yLL:Q.geohashY,xTR:ee.geohashX,yTR:ee.geohashY},level:c}}_getGeohashLevel(a){return this._schema.params.fixedBinLevel}_getTransforms(a,c){const _={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},m=(0,ce.C5)(c);if(!m)return{tile:_,left:null,right:null};const[x,b]=m.valid;return{tile:_,left:{..._,translate:[b,a.bounds[3]]},right:{..._,translate:[x-b+a.bounds[0],a.bounds[3]]}}}}class Ts extends he.nd{constructor(a,c,_,m,x){super(new we.Z([],[c,_]),m,null,a),this.geohashBoundsInfo=x}get count(){return this.attributes.cluster_count}static create(a,c,_,m,x,b,C,M){const F=new Ts(c,_,m,b,C);return F.displayId=a.createDisplayId(!0),F.referenceId=M,F.tileLevel=x,F}update(a,c,_,m,x,b){return this.geometry.coords[0]=a,this.geometry.coords[1]=c,this.tileLevel=_,this.attributes=m,this.geohashBoundsInfo=x,this.referenceId=null,this.referenceId=b,this}toJSON(){return{attributes:{...this.attributes,aggregateId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function qt(v){return 57.29577951308232*v}class mr extends zs.J{constructor(a,c,_,m){super(a,_),this.type="cluster",this.events=new Pt.Z,this.objectIdField="aggregateId",this.featureAdapter=E.k,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this._serviceInfo=m,this.geometryInfo=a.geometryInfo,this._spatialReference=c,this._projectionSupportCheck=(0,St._W)(c,xt.Z.WGS84),this._bitsets.geohash=_.getBitset(_.createBitset()),this._bitsets.inserted=_.getBitset(_.createBitset())}destroy(){this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(a,c){var _=()=>super.updateSchema,m=this;return(0,Z.Z)(function*(){const x=m._schema;try{yield _().call(m,a,c),yield m._projectionSupportCheck}catch{}m._fields=m._schema.params.fields;const b=(0,ze.Hg)(x,c);c&&(!(0,w.Wi)(b)||a.source||a.storage.filters)?(((0,ze.uD)(b,"params.fields")||!m._tree||a.source)&&(m._tree&&m._tree.destroy(),m._tree=new Ns(m._statisticFields,m._serviceInfo),m._rebuildTree(),(0,R.Z)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,R.Z)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",b),a.targets[c.name]=!0,a.mesh=!1,m._aggregateValueRanges={}):x&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,c){this._bitsets.inserted.forEachSet(_=>{if(!a.has(_)){const m=c.lookupByDisplayIdUnsafe(_);this._remove(m)}})}sweepAggregates(a,c,_){this._clusters.forEach((m,x)=>{m&&m.tileLevel!==_&&(a.releaseDisplayId(m.displayId),c.unsetAttributeData(m.displayId),this._clusters.delete(x))})}onTileData(a,c,_,m,x=!0){if(!this._schema||(0,w.Wi)(c.addOrUpdate))return c;this.events.emit("changed");const b=this._getTransforms(a,this._spatialReference);{const F=c.addOrUpdate.getCursor();for(;F.next();)this._update(F,m)}if(c.status.mesh||!x)return c;const C=new Array;this._getClustersForTile(C,a,this._schema.params.clusterRadius,_,b),c.addOrUpdate=Te.fromOptimizedFeatures(C,this._serviceInfo),c.addOrUpdate.attachStorage(_),c.clear=!0,c.end=!0;{const F=c.addOrUpdate.getCursor();for(;F.next();){const U=F.getDisplayId();this._bitsets.computed.unset(U),this.setComputedAttributes(_,F,U,a.scale)}}return this._aggregateValueRangesChanged&&c.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),c}onTileUpdate({added:a,removed:c}){if(a.length){const m=a[0].level;this._tileLevel=m,this._setGeohashLevel(m)}if(!this._schema)return;const _=this._schema.params.clusterRadius;c.forEach(m=>{this._tiles.delete(m.key.id),this._markTileClustersForDeletion(m,_)})}getAggregate(a){for(const c of this._clusters.values())if((c?.displayId&ve._I)==(a&ve._I))return c.toJSON();return null}getAggregates(){const a=[];for(const c of this._clusters.values())c?.tileLevel===this._tileLevel&&a.push(c.toJSON());return a}getDisplayId(a){const c=this._clusters.get(a);return c?c.displayId:null}getFeatureDisplayIdsForAggregate(a){const c=this._clusters.get(a);return c?this._tree.getRegionDisplayIds(c.geohashBoundsInfo):[]}getDisplayIdForReferenceId(a){for(const c of this._clusters.values())if(c?.referenceId===a)return c.displayId;return null}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(a){this._clusters.forEach(c=>{if(!c)return;const _=c.toJSON(),m=Te.fromFeatures([_],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();m.next(),a(m)})}forEachInBounds(a,c){}forEachBounds(a,c,_){const{hasM:m,hasZ:x}=this.geometryInfo;for(const b of a){const C=(0,P.$)([0,0,0,0],b.readGeometry(),x,m);(0,w.Wi)(C)||c((0,Zs.JR)(_,C))}}toArray(){const a=[];return this.forEach(c=>a.push(c)),a}size(){let a=0;return this.forEach(c=>a++),a}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const c=a.getDisplayId(),_=a.getXHydrated(),m=a.getYHydrated(),x=this._geohashBuf[2*c],b=this._geohashBuf[2*c+1];this._bitsets.inserted.has(c)&&(this._bitsets.inserted.unset(c),this._tree.removeCursor(a,_,m,x,b,this._geohashLevel))}_update(a,c){const _=a.getDisplayId(),m=this._bitsets.inserted,x=c.isVisible(_);if(x===m.has(_))return;if(!x)return void this._remove(a);const b=a.getXHydrated(),C=a.getYHydrated();this._setGeohash(_,b,C)&&(this._tree.insertCursor(a,_,b,C,this._geohashBuf[2*_],this._geohashBuf[2*_+1],this._geohashLevel),m.set(_))}_setGeohash(a,c,_){if(this._bitsets.geohash.has(a))return!0;const m=this._geohashBuf;if(this._spatialReference.isWebMercator){const x=qt(c/bt.sv.radius),b=x-360*Math.floor((x+180)/360);ds(m,a,qt(Math.PI/2-2*Math.atan(Math.exp(-_/bt.sv.radius))),b,12)}else{const x=(0,St.iV)({x:c,y:_},this._spatialReference,xt.Z.WGS84);if(!x)return!1;ds(m,a,x.y,x.x,12)}return this._bitsets.geohash.set(a),!0}_getClustersForTile(a,c,_,m,x,b=!0){const C=this._schema.params.clusterPixelBuffer,M=2*_,F=Math.ceil(2**c.key.level*Re.I_/M)+1,U=Math.ceil(C/M)+0,D=Math.ceil(Re.I_/M),{row:G,col:Q}=c.key,K=G*Re.I_,ie=Math.floor(Q*Re.I_/M)-U,le=Math.floor(K/M)-U,ne=ie+D+2*U,de=le+D+2*U,oe=c.tileInfoView.getLODInfoAt(c.key.level);for(let ge=ie;ge<=ne;ge++)for(let me=le;me<=de;me++){let pe=ge;oe.wrap&&(pe=ge<0?ge+F:ge%F);const Ae=oe.wrap&&ge<0,Ee=oe.wrap&&ge%F!==ge,_e=this._lookupCluster(m,oe,c.key.level,pe,me,c);if((0,w.pC)(_e)){const Se=(0,w.yw)(x,Fe=>Ae?Fe.left:Ee?Fe.right:Fe.tile);if(b&&(0,w.Wi)(Se)||!_e.count)continue;if((0,w.pC)(Se)&&b){const Fe=_e.geometry.clone();let Ue=_e.attributes;Fe.coords[0]=(0,P.Jd)(Se,Fe.coords[0]),Fe.coords[1]=(0,P.IN)(Se,Fe.coords[1]),1===_e.count&&(0,w.pC)(_e.referenceId)&&(Ue={..._e.attributes,referenceId:_e.referenceId});const Ze=new he.u_(Fe,Ue);Ze.displayId=_e.displayId,a.push(Ze)}}}}_getGeohashLevel(a){return Math.min(Math.ceil(a/2+2),12)}_setGeohashLevel(a){const c=this._getGeohashLevel(a),_=1*(Math.floor(c/1)+1)-1;if(this._geohashLevel!==_)return this._geohashLevel=_,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(a,c){const _={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},m=(0,ce.C5)(c);if(!m)return{tile:_,left:null,right:null};const[x,b]=m.valid;return{tile:_,left:{..._,translate:[b,a.bounds[3]]},right:{..._,translate:[x-b+a.bounds[0],a.bounds[3]]}}}_getClusterId(a,c,_){return(15&a)<<28|(16383&c)<<14|16383&_}_markForDeletion(a,c,_){const m=this._getClusterId(a,c,_);this._clusters.delete(m)}_getClusterBounds(a,c,_){const m=this._schema.params.clusterRadius,x=2*m;let b=_%2?c*x:c*x-m;const C=_*x;let M=b+x;const U=2**a.level*Re.I_;a.wrap&&b<0&&(b=0),a.wrap&&M>U&&(M=U);const G=C/Re.I_,Q=M/Re.I_,ee=(C-x)/Re.I_;return[a.getXForColumn(b/Re.I_),a.getYForRow(G),a.getXForColumn(Q),a.getYForRow(ee)]}_getGeohash(a,c,_){const m={geohashX:0,geohashY:0};return ls(m,c,a,_),m}_getGeohashBounds(a,c){const _=this._getGeohashLevel(a.key.level);if(this._spatialReference.isWebMercator){const[K,ie,le,ne]=c,de={x:K,y:ie},oe={x:le,y:ne};let ge=0,me=0,pe=0,Ae=0;{const Se=qt(de.x/bt.sv.radius);ge=Se-360*Math.floor((Se+180)/360),me=qt(Math.PI/2-2*Math.atan(Math.exp(-de.y/bt.sv.radius)))}{const Se=qt(oe.x/bt.sv.radius);pe=Se-360*Math.floor((Se+180)/360),Ae=qt(Math.PI/2-2*Math.atan(Math.exp(-oe.y/bt.sv.radius)))}const Ee={geohashX:0,geohashY:0},_e={geohashX:0,geohashY:0};return ls(Ee,me,ge,_),ls(_e,Ae,pe,_),{bounds:[K,ie,le,ne],geohashBounds:{xLL:Ee.geohashX,yLL:Ee.geohashY,xTR:_e.geohashX,yTR:_e.geohashY},level:_}}const m=Gs.Z.fromExtent(ks.Z.fromBounds(c,this._spatialReference)),x=(0,St.iV)(m,this._spatialReference,xt.Z.WGS84,{densificationStep:64*a.resolution});if(!x)return null;const b=(0,P.Uy)(new we.Z,x,!1,!1),C=b.coords.filter((K,ie)=>!(ie%2)),M=b.coords.filter((K,ie)=>ie%2),F=Math.min(...C),U=Math.min(...M),D=Math.max(...C),G=Math.max(...M),Q=this._getGeohash(F,U,_),ee=this._getGeohash(D,G,_);return{bounds:c,geohashBounds:{xLL:Q.geohashX,yLL:Q.geohashY,xTR:ee.geohashX,yTR:ee.geohashY},level:_}}_lookupCluster(a,c,_,m,x,b){const C=this._getClusterId(_,m,x),M=this._clusters.get(C),F=this._getClusterBounds(c,m,x),U=this._getGeohashBounds(b,F);if((0,w.Wi)(U))return null;const D=this._tree.getRegionStatistics(U),{count:G,xTotal:Q,yTotal:ee,referenceId:K}=D,ie=G?Q/G:0,le=G?ee/G:0;if(0===G)return this._clusters.set(C,null),null;const ne={cluster_count:G,...D.attributes},de=(0,w.pC)(M)?M.update(ie,le,_,ne,U,K):Ts.create(a,C,ie,le,_,ne,U,K);if(0===G){const[oe,ge,me,pe]=F;de.geometry.coords[0]=(oe+me)/2,de.geometry.coords[1]=(ge+pe)/2}return this._clusters.set(C,de),this._updateAggregateValueRangeForCluster(de,de.tileLevel),de}_updateAggregateValueRangeForCluster(a,c){const _=this._aggregateValueRanges[c]||{minValue:1/0,maxValue:0},m=_.minValue,x=_.maxValue;_.minValue=Math.min(m,a.count),_.maxValue=Math.max(x,a.count),this._aggregateValueRanges[c]=_,m===_.minValue&&x===_.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(a,c){const _=2*c,m=Math.ceil(Re.I_/_),{row:x,col:b}=a.key,M=x*Re.I_,F=Math.floor(b*Re.I_/_),U=Math.floor(M/_);for(let D=F;D<F+m;D++)for(let G=U;G<U+m;G++)this._markForDeletion(a.key.level,D,G)}}class yr{constructor(){this._freeIds=[],this._idCounter=1}createId(a=!1){return(0,ve.QS)(this._getFreeId(),a)}releaseId(a){this._freeIds.push(a)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}var Ir=O(42797);function cs(v,a,c){if(!(v.length>a))for(;v.length<=a;)v.push(c)}class vr{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new yr,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const a=this._bitsets.length;return this._bitsets.push(Ir.p.create(this._allocatedSize,ve._I)),a+1}getBitset(a){return this._bitsets[a-1]}_expand(){this._allocatedSize<<=1;for(const a of this._bitsets)a.resize(this._allocatedSize)}_ensureNumeric(a,c){this._numerics[a]||(this._numerics[a]=[]),cs(this._numerics[a],c,0)}_ensureInstanceId(a){cs(this._instanceIds,a,0)}_ensureString(a,c){this._strings[a]||(this._strings[a]=[]),cs(this._strings[a],c,null)}createDisplayId(a=!1){const c=this._idGenerator.createId();return c>this._allocatedSize&&this._expand(),(0,ve.QS)(c,a)}releaseDisplayId(a){for(const c of this._bitsets)c.unset(a);return this._idGenerator.releaseId(a&ve._I)}getComputedNumeric(a,c){return this.getComputedNumericAtIndex(a&ve._I,0)}setComputedNumeric(a,c,_){return this.setComputedNumericAtIndex(a&ve._I,_,0)}getComputedString(a,c){return this.getComputedStringAtIndex(a&ve._I,0)}setComputedString(a,c,_){return this.setComputedStringAtIndex(a&ve._I,0,_)}getComputedNumericAtIndex(a,c){const _=a&ve._I;return this._ensureNumeric(c,_),this._numerics[c][_]}setComputedNumericAtIndex(a,c,_){const m=a&ve._I;this._ensureNumeric(c,m),this._numerics[c][m]=_}getInstanceId(a){const c=a&ve._I;return this._ensureInstanceId(c),this._instanceIds[c]}setInstanceId(a,c){const _=a&ve._I;this._ensureInstanceId(_),this._instanceIds[_]=c}getComputedStringAtIndex(a,c){const _=a&ve._I;return this._ensureString(c,_),this._strings[c][_]}setComputedStringAtIndex(a,c,_){const m=a&ve._I;this._ensureString(c,m),this._strings[c][m]=_}getXMin(a){return this._bounds[4*(a&ve._I)]}getYMin(a){return this._bounds[4*(a&ve._I)+1]}getXMax(a){return this._bounds[4*(a&ve._I)+2]}getYMax(a){return this._bounds[4*(a&ve._I)+3]}setBounds(a,c){const _=c.readHydratedGeometry();if(!_||!_.coords.length)return!1;let m=1/0,x=1/0,b=-1/0,C=-1/0;_.forEachVertex((F,U)=>{m=Math.min(m,F),x=Math.min(x,U),b=Math.max(b,F),C=Math.max(C,U)});const M=a&ve._I;return cs(this._bounds,4*M+4,0),this._bounds[4*M]=m,this._bounds[4*M+1]=x,this._bounds[4*M+2]=b,this._bounds[4*M+3]=C,!0}}function Ct(v){if(!(0,j.D_)(v)&&!function Tr(v){return"worker:port-closed"===v.name}(v))throw v}function Ys(v){return"feature"===v.type&&"snapshot"===v.mode}let Xe=class extends X.r{constructor(){super(...arguments),this._storage=new vr,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this._updateVersion=1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initStores(),this._initSource(),this._updateQueue=new Qt.e({concurrency:"geoevent"===this._source.type?1:4,process:(v,a)=>this._onTileMessage(v,{signal:a})}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),(0,q.gx)(()=>!this.updating,()=>this.onIdle())]),this._checkUpdating=setInterval(()=>this.notifyChange("updating"),300)}_initSource(){this._source=function Yt(v,a,c,_,m,x){const b=function qs(v,a,c,_,m,x){switch(v.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,w.Pt)(v.featureCount,0),serviceInfo:v,onMessage:_,outSR:a,tileInfoView:c,canAcceptRequest:m,store:x};case"stream":return{type:"geoevent",serviceInfo:v,onMessage:_,outSR:a,canAcceptRequest:m};case"memory":case"on-demand":return{type:"feature",serviceInfo:v,onMessage:_,outSR:a,origin:function b(C){return Array.isArray(C)?"local":"path"in C&&(0,N.M8)(C.path)?"hosted":"unknown"}(v.source),tileInfoView:c,canAcceptRequest:m}}}(v,a,c,_,m,x);switch(b.type){case"feature":switch(b.origin){case"hosted":case"local":return new es(b);case"snapshot":return new Is(b);case"unknown":return new ps(b)}case"geoevent":return new It(b)}}(this.service,this.spatialReference,this.tileStore.tileScheme,(_,m)=>(this._invalidated=!0,this._patchTile(_,m)),()=>this._updateQueue.length<50,this.featureStore),this._proxyEvents()}_proxyEvents(){if("geoevent"===this._source.type){const v=this._source.events;this.handles.add([v.on("connectionStatus",a=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:a}).catch(Ct)),v.on("errorString",a=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:a}).catch(Ct)),v.on("data-received",a=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry}}).catch(Ct)),v.on("updateRate",a=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:{...a}}).catch(Ct))])}}_initAttributeStore(v){this.attributeStore||(this.attributeStore=new ar({type:"remote",initialize:(a,c)=>(0,j.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",a,{signal:c}).catch(Ct)),update:(a,c)=>(0,j.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",a,{signal:c}).catch(Ct)),render:a=>(0,j.R8)(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:a}).catch(Ct))},v,()=>this.notifyChange("updating")))}_initStores(){this.featureStore=new E.p({geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this._storage,"snapshot"===this.service.type?"snapshot":"on-demand")}_initQueryEngine(v){const a=this;this.featureQueryEngine?.destroy(),this.featureQueryEngine=new W.q({definitionExpression:v.schema.source.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:c=>(0,w.Wi)(a.aggregateStore)?[]:a.aggregateStore.getFeatureDisplayIdsForAggregate(c).map(_=>a.getObjectId(_))},timeInfo:this.service.timeInfo})}_initAggregateQueryEngine(v,a){if(this.aggregateQueryEngine?.destroy(),(0,w.Wi)(v))return;const c=a.targets.aggregate.params.fields.slice();this.aggregateQueryEngine=new W.q({definitionExpression:null,fields:c,geometryType:v.geometryInfo.geometryType,objectIdField:v.objectIdField,hasM:v.geometryInfo.hasM,hasZ:v.geometryInfo.hasZ,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!1,featureStore:v,aggregateAdapter:{getFeatureObjectIds:_=>[]}})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.featureQueryEngine?.destroy(),this.aggregateQueryEngine?.destroy(),this.attributeStore?.destroy();for(const v of this.tileStore.tiles)this._source.unsubscribe(v);clearInterval(this._checkUpdating)}get fieldsIndex(){return new A.Z(this.service.fields)}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){const v=this._source.updating,a=!!this._updateQueue.length,c=!this.attributeStore||this.attributeStore.isUpdating(),_=v||a||c;return(0,R.Z)("esri-2d-log-updating")&&console.log(`Updating FeatureController2D: ${_}\n  -> updatingSource ${v}\n  -> updateQueue ${a}\n  -> updatingAttributeStore ${c}\n`),_}enableEvent(v){this._source.enableEvent(v.name,v.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}resume(){this._updateQueue.resume()}pauseStream(){"geoevent"===this._source.type&&this._source.pauseStream()}resumeStream(){"geoevent"===this._source.type&&this._source.resumeStream()}_initAggregateStore(v){const a=v.schema.targets?.aggregate?.type;if((0,w.yw)(this.config,_=>_.schema.targets?.aggregate?.type)!==a&&((0,w.pC)(this.aggregateStore)&&(this.handles.remove("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),a)){switch(a){case"cluster":this.aggregateStore=new mr({geometryInfo:{geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this.spatialReference,this._storage,this.service),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",m=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:m.valueRanges}}).catch(Ct)}),"valueRangesChanged");break;case"bin":this.aggregateStore=new pr({geometryInfo:{geometryType:"esriGeometryPolygon",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this.spatialReference,this._storage,this.service)}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}update(v,a){var c=this;return(0,Z.Z)(function*(){c._updateVersion++,c._initQueryEngine(a),c._initAttributeStore(a),c.pause(),yield Promise.all([c._source.update(v,a.schema.source),c.featureStore.updateSchema(v,a.schema.targets.feature),c.attributeStore.update(v,a),c.attributeStore.updateFilters(v,a,c)]),c._initAggregateStore(a),(0,w.pC)(c.aggregateStore)&&(yield c.aggregateStore.updateSchema(v,a.schema.targets.aggregate)),c._initAggregateQueryEngine(c.aggregateStore,a.schema),(0,R.Z)("esri-2d-update-debug")&&v.describe(),c._set("config",a)})()}applyUpdate(v){var a=this;return(0,Z.Z)(function*(){v.version=a._updateVersion,(0,R.Z)("esri-2d-update-debug")&&console.debug(`Applying update ${v.version}`),v.mesh&&a.clearTiles(),a._updateQueue.resume(),yield a._source.applyUpdate(v),a.notifyChange("updating"),yield(0,q.N1)(()=>!a.updating),(0,w.pC)(a.aggregateStore)&&(yield(0,j.e4)(10),yield(0,q.N1)(()=>!a.updating))})()}onEdits({edits:v}){var a=this;return(0,Z.Z)(function*(){(0,R.Z)("esri-2d-update-debug")&&console.debug("Applying Edit:",v),a._didEdit=!0;try{const c=v.removed.map(m=>m.objectId&&-1!==m.objectId?m.objectId:a._lookupObjectIdByGlobalId(m.globalId)),_=v.addOrModified.map(({objectId:m})=>m);a.featureStore.invalidate(),yield a._source.edit(_,c),a.clearTiles(),a.notifyChange("updating"),(0,w.pC)(a.aggregateStore)&&a.aggregateStore.clear(),yield a._source.resend(),yield(0,q.N1)(()=>!a.updating)}catch{}})()}refresh(v){var a=this;return(0,Z.Z)(function*(){if(!v.dataChanged){const c=Me.empty();return c.storage.filters=!0,a.applyUpdate(c)}a.featureStore.invalidate(),a.clearTiles(),a._source.refresh(a._updateVersion,v),a._cleanupNeeded=!0,a.notifyChange("updating"),yield(0,q.N1)(()=>!a.updating)})()}clearTiles(){for(const v of this.tileStore.tiles)this.processor.onTileClear(v)}onTileUpdate(v){(0,w.pC)(this.aggregateStore)&&this.aggregateStore.onTileUpdate(v);for(const a of v.added)this._source.subscribe(a,this._updateVersion),this._level=a.level;for(const a of v.removed)this._source.unsubscribe(a),this._cleanupNeeded=!0,this._tileToResolver.has(a.id)&&(this._tileToResolver.get(a.id).resolve(),this._tileToResolver.delete(a.id));this.notifyChange("updating")}onIdle(){var v=this;return(0,Z.Z)(function*(){v._invalidated&&(v._invalidated=!1,((0,w.pC)(v.aggregateStore)||"heatmap"===v.processor.type)&&(yield v._repushCurrentLevelTiles())),v._markAndSweep()})()}querySummaryStatistics({query:v,params:a}){var c=this;return(0,Z.Z)(function*(){return c.featureQueryEngine.executeQueryForSummaryStatistics(v,a)})()}queryAggregateSummaryStatistics({query:v,params:a}){var c=this;return(0,Z.Z)(function*(){return c.aggregateQueryEngine.executeQueryForSummaryStatistics(v,a)})()}queryUniqueValues({query:v,params:a}){var c=this;return(0,Z.Z)(function*(){return c.featureQueryEngine.executeQueryForUniqueValues(v,a)})()}queryAggregateUniqueValues({query:v,params:a}){var c=this;return(0,Z.Z)(function*(){return c.aggregateQueryEngine.executeQueryForUniqueValues(v,a)})()}queryClassBreaks({query:v,params:a}){var c=this;return(0,Z.Z)(function*(){return c.featureQueryEngine.executeQueryForClassBreaks(v,a)})()}queryAggregateClassBreaks({query:v,params:a}){var c=this;return(0,Z.Z)(function*(){return c.aggregateQueryEngine.executeQueryForClassBreaks(v,a)})()}queryHistogram({query:v,params:a}){var c=this;return(0,Z.Z)(function*(){return c.featureQueryEngine.executeQueryForHistogram(v,a)})()}queryAggregateHistogram({query:v,params:a}){var c=this;return(0,Z.Z)(function*(){return c.aggregateQueryEngine.executeQueryForHistogram(v,a)})()}queryExtent(v){return this.featureQueryEngine.executeQueryForExtent(v)}queryAggregates(v){return this.aggregateQueryEngine.executeQuery(v)}queryAggregateCount(v){return this.aggregateQueryEngine.executeQueryForCount(v)}queryAggregateIds(v){return this.aggregateQueryEngine.executeQueryForIds(v)}queryFeatures(v){return this.featureQueryEngine.executeQuery(v)}queryVisibleFeatures(v){var a=this;return(0,Z.Z)(function*(){const c=yield a.featureQueryEngine.executeQuery(v),_=c.objectIdFieldName;return c.features=c.features.filter(m=>{const b=a.getDisplayId(m.attributes[_]);return(0,w.yw)(b,C=>a.attributeStore.isVisible(C))}),c})()}queryFeatureCount(v){return this.featureQueryEngine.executeQueryForCount(v)}queryLatestObservations(v){return this.featureQueryEngine.executeQueryForLatestObservations(v)}queryObjectIds(v){return this.featureQueryEngine.executeQueryForIds(v)}queryStatistics(){var v=this;return(0,Z.Z)(function*(){return v.featureStore.storeStatistics})()}getObjectId(v){return this.featureStore.lookupObjectId(v,this._storage)}getDisplayId(v){if((0,w.pC)(this.aggregateStore)){const a=this.aggregateStore.getDisplayId(v);if((0,w.Wi)(a)){const c=this.featureStore.lookupDisplayId(v);return this.aggregateStore.getDisplayIdForReferenceId(c)}return a}return this.featureStore.lookupDisplayId(v)}getFeatures(v){const a=[],c=[];for(const _ of v){const m=(0,w.pC)(this.aggregateStore)?this.getAggregate(_):null;if((0,w.pC)(m))if((0,w.pC)(m.attributes.referenceId)){const x=this.getFeature(m.attributes.referenceId);(0,w.pC)(x)&&a.push(x)}else c.push(m);else{const x=this.getFeature(_);(0,w.pC)(x)&&a.push(x)}}return{features:a,aggregates:c}}getFeature(v){const a=this.featureStore.lookupFeatureByDisplayId(v,this._storage);if((0,w.Wi)(a))return null;const c=a.readHydratedGeometry(),_=(0,P.di)(c,a.geometryType,a.hasZ,a.hasM);return{attributes:a.readAttributes(),geometry:_}}getAggregate(v){return(0,w.Wi)(this.aggregateStore)?null:this.aggregateStore.getAggregate(v)}getAggregates(){return(0,w.Wi)(this.aggregateStore)?[]:this.aggregateStore.getAggregates()}setHighlight(v){var a=this;return(0,Z.Z)(function*(){const c=(0,w.lV)(v.map(_=>a.getDisplayId(_)));return a.attributeStore.setHighlight(v,c)})()}_lookupObjectIdByGlobalId(v){const a=this.service.globalIdField;if((0,w.Wi)(a))throw new Error("Expected globalIdField to be defined");let c=null;if(this.featureStore.forEach(_=>{v===_.readAttribute(a)&&(c=_.getObjectId())}),(0,w.Wi)(c))throw new Error(`Expected to find a feature with globalId ${v}`);return c}_repushCurrentLevelTiles(){var v=this;return(0,Z.Z)(function*(){const a=v.tileStore.tiles.filter(_=>_.level===v._level);a.map(function(){var _=(0,Z.Z)(function*(m){return v._patchTile({type:"append",id:m.key.id,clear:!0,addOrUpdate:null,end:!1})});return function(m){return _.apply(this,arguments)}}());const c=a.map(function(){var _=(0,Z.Z)(function*(m){return v._patchTile({type:"append",id:m.key.id,addOrUpdate:Te.fromOptimizedFeatures([],v.service),remove:[],end:!0,isRepush:!0,status:Me.empty()})});return function(m){return _.apply(this,arguments)}}());yield Promise.all(c)})()}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(v,a){const c=this._updateQueue.push(v,a).then(()=>{this.notifyChange("updating")}).catch(_=>{this.notifyChange("updating")});return this.notifyChange("updating"),c}_onTileMessage(v,a){var c=this;return(0,Z.Z)(function*(){if((0,j.k_)(a),(0,R.Z)("esri-2d-update-debug")){const b=(0,w.yw)(v.addOrUpdate,C=>C.hasFeatures);console.debug(v.id,`FeatureController:onTileMessage: [clear:${v.clear}, end:${v.end}, features: ${b}]`)}const _=c.tileStore.get(v.id);if(!_)return;if(v.clear)return c.processor.onTileClear(_);const m=v.status;c._cleanupNeeded=!0;const x=[];for(const b of v.remove){const C=c.featureStore.lookupDisplayId(b);C&&x.push(C)}v.remove=x;try{if((0,w.Wi)(v.addOrUpdate))return void c.processor.onTileMessage(_,{...v,addOrUpdate:null},(0,w.pC)(c.aggregateStore),a).catch(j.H9);if(v.addOrUpdate.setArcadeSpatialReference(c.spatialReference),c.featureStore.hasInstance(v.addOrUpdate.instance)&&m.targets.feature||(m.targets.feature=!0,c.featureStore.onTileData(_,v)),(!m.storage.data||!m.storage.filters)&&(m.storage.data=!0,m.storage.filters=!0,c.attributeStore.onTileData(_,v),"geoevent"===c._source.type||c._didEdit?(yield c.attributeStore.sendUpdates(),(0,j.k_)(a)):c.attributeStore.sendUpdates()),(0,w.pC)(c.aggregateStore)&&!m.targets.aggregate){m.targets.aggregate=!0;const b=Ys(c._source)&&c._source.loading,C=!Ys(c._source)||b||v.end;if(c.aggregateStore.onTileData(_,v,c._storage,c.attributeStore,C),!C)return;m.mesh||(c.attributeStore.onTileData(_,v),yield c.attributeStore.sendUpdates())}if(!m.mesh){m.mesh=!0;const b=(0,w.pC)(c.aggregateStore)&&"cluster"===c.aggregateStore.type;yield c.processor.onTileMessage(_,v,b,a),(0,j.k_)(a)}c._maybeForceCleanup()}catch(b){(0,j.H9)(b)}})()}_mark(v,a,c){const _=(4294901760&this._storage.getInstanceId(v))>>>16;v&&(a.add(_),c.set(v))}_markAndSweep(){if(this._lastCleanup=performance.now(),"feature"===this._source.type&&"snapshot"===this._source.mode||"geoevent"!==this._source.type&&!this._cleanupNeeded)return;this._cleanupNeeded=!1;const v=this._storage.getBitset(this._markedIdsBufId),a=new Set;v.clear();for(const c of this.tileStore.tiles)for(const _ of this._source.readers(c.id)){const m=_.getCursor();for(;m.next();){let x=m.getDisplayId();if(!x){const b=m.getObjectId();x=this.featureStore.lookupDisplayId(b)}this._mark(x,a,v)}}"symbol"===this.processor.type&&this.processor.forEachBufferId(c=>{this._mark(c,a,v)}),this._updateQueue.forEach(c=>{for(const _ of c.remove){const m=this.featureStore.lookupDisplayId(_);this._mark(m,a,v)}}),(0,w.pC)(this.aggregateStore)&&(this.aggregateStore.sweepFeatures(v,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(v,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(a)}};(0,ae._)([(0,$.Cb)({constructOnly:!0})],Xe.prototype,"tileStore",void 0),(0,ae._)([(0,$.Cb)()],Xe.prototype,"config",void 0),(0,ae._)([(0,$.Cb)({readOnly:!0})],Xe.prototype,"fieldsIndex",null),(0,ae._)([(0,$.Cb)()],Xe.prototype,"processor",void 0),(0,ae._)([(0,$.Cb)({constructOnly:!0})],Xe.prototype,"remoteClient",void 0),(0,ae._)([(0,$.Cb)({constructOnly:!0})],Xe.prototype,"service",void 0),(0,ae._)([(0,$.Cb)()],Xe.prototype,"spatialReference",null),(0,ae._)([(0,$.Cb)()],Xe.prototype,"updating",null),Xe=(0,ae._)([(0,se.j)("esri.views.2d.layers.features.controllers.FeatureController2D")],Xe);const Fr=Xe;var Xs=O(81340),Ar=O(84378),Er=O(58098);const zt={added:[],removed:[]},Fs=new Set,Mr=new Er.Z(0,0,0,0);class wr extends Pt.Z{constructor(a){super(),this._tiles=new Map,this._index=(0,as.r)(9,(0,R.Z)("esri-csp-restrictions")?c=>({minX:c.bounds[0],minY:c.bounds[1],maxX:c.bounds[2],maxY:c.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=a}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(a){return this._tiles.has(a)}get(a){return this._tiles.get(a)}boundsIntersections(a){return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})}updateTiles(a){const c={added:[],removed:[]};for(const _ of a.added)if(!this.has(_)){const m=new Xs.n(this.tileScheme,_);this._tiles.set(_,m),this._index.insert(m),c.added.push(m)}for(const _ of a.removed)if(this.has(_)){const m=this.get(_);this._tiles.delete(_),this._index.remove(m),c.removed.push(m)}this.tiles.length=0,this._tiles.forEach(_=>this.tiles.push(_)),(c.added.length||c.removed.length)&&this.emit("update",c)}setViewState(a){const c=this.tileScheme.getTileCoverage(a,0);if(!c)return;const{spans:_,lodInfo:m}=c,{level:x}=m;if(_.length>0)for(const{row:b,colFrom:C,colTo:M}of _)for(let F=C;F<=M;F++){const U=Mr.set(x,b,m.normalizeCol(F),m.getWorldForColumn(F)).id;if(Fs.add(U),!this.has(U)){const D=new Xs.n(this.tileScheme,U);this._tiles.set(U,D),this._index.insert(D),this.tiles.push(D),zt.added.push(D)}}for(let b=this.tiles.length-1;b>=0;b--){const C=this.tiles[b];Fs.has(C.id)||(this._tiles.delete(C.id),this.tiles.splice(b,1),this._index.remove(C),zt.removed.push(C))}(zt.added.length||zt.removed.length)&&this.emit("update",zt),Ar.Z.pool.release(c),Fs.clear(),zt.added.length=0,zt.removed.length=0}}var Dr=O(9598);let Gt=class extends X.r{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null,this._paused=!1,this._pendingTileUpdates=[]}initialize(){this.handles.add((0,q.YP)(()=>this.updating,v=>{this.remoteClient.invoke("setUpdating",v).catch(a=>{})}))}destroy(){this.stop(),this.controller?.destroy(),this.processor?.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}stop(){this._paused=!0,Array.isArray(this.service?.source)&&(this.service.source.forEach(v=>v.close()),this.service.source.length=0),this.tileStore?.updateTiles({added:[],removed:this.tileStore.tiles.map(v=>v.id)}),this.tileStore?.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}startup({service:v,config:a,tileInfo:c,tiles:_}){var m=this;return(0,Z.Z)(function*(){if(m._paused=!0,Array.isArray(m.service?.source)&&(m.service.source.forEach(x=>x.close()),m.service.source.length=0),m.service=v,!m.tileStore||!(0,ce.fS)(m.tileStore.tileScheme.spatialReference,c.spatialReference)){const x=new Dr.Z(V.Z.fromJSON(c));_.added.length=_.removed.length=0,m.tileStore?.updateTiles({added:[],removed:m.tileStore.tiles.map(b=>b.id)}),m.tileStore?.destroy(),m.tileStore=new wr(x),m._pendingTileUpdates.length=0}for(yield m._createProcessorAndController(a),yield m.update({config:a}),m.controller.resume(),m.tileStore.clear(),m.tileStore.updateTiles(_),m._paused=!1;m._pendingTileUpdates.length;)m.tileStore.updateTiles(m._pendingTileUpdates.pop())})()}updateTiles(v){var a=this;return(0,Z.Z)(function*(){a._paused?a._pendingTileUpdates.push(v):a.tileStore.updateTiles(v)})()}update({config:v}){var a=this;return(0,Z.Z)(function*(){const c=Me.empty();return yield Promise.all([a.processor.update(c,v),a.controller.update(c,v)]),c.toJSON()})()}applyUpdate(v){var a=this;return(0,Z.Z)(function*(){return a.controller.applyUpdate(Me.create(v))})()}_createProcessorAndController(v){var a=this;return(0,Z.Z)(function*(){yield Promise.all([a._handleControllerConfig(v),a._handleProcessorConfig(v)]),a.controller.processor=a.processor})()}_handleControllerConfig(v){var a=this;return(0,Z.Z)(function*(){return a._createController(a.service,v)})()}_handleProcessorConfig(v){var a=this;return(0,Z.Z)(function*(){return a._createProcessor(a.service,v)})()}_createController(v,a){var c=this;return(0,Z.Z)(function*(){c.controller&&c.controller.destroy();const{tileStore:_,remoteClient:m}=c,x=new Fr({service:v,tileStore:_,remoteClient:m});return c.controller=x,x})()}_createProcessor(v,a){var c=this;return(0,Z.Z)(function*(){const _=a.schema.processors[0].type,m=(yield function k(v){return"heatmap"===v?Promise.all([O.e(8592),O.e(7434)]).then(O.bind(O,67434)):Promise.all([O.e(3751),O.e(3678),O.e(4522),O.e(8592),O.e(8460)]).then(O.bind(O,28460))}(_)).default,{remoteClient:x,tileStore:b}=c,C=new m({service:v,config:a,tileStore:b,remoteClient:x});return c.processor&&c.processor.destroy(),c.processor=C,C})()}};(0,ae._)([(0,$.Cb)()],Gt.prototype,"controller",void 0),(0,ae._)([(0,$.Cb)()],Gt.prototype,"processor",void 0),(0,ae._)([(0,$.Cb)()],Gt.prototype,"updating",null),(0,ae._)([(0,$.Cb)()],Gt.prototype,"viewState",void 0),Gt=(0,ae._)([(0,se.j)("esri.views.2d.layers.features.Pipeline")],Gt);const Rr=Gt},16669:(Ne,xe,O)=>{O.d(xe,{J:()=>se});var Z=O(15861),ae=O(8314),X=O(62208),R=O(84682),q=O(46679),$=O(63290);const Y=Promise.resolve().then(O.bind(O,22445));class se{constructor(V,k){this._canCacheExpressionValue=!1,this._sourceInfo=V,this._storage=k,this._bitsets={computed:k.getBitset(k.createBitset())}}get storage(){return this._storage}invalidate(){this._bitsets.computed.clear()}updateSchema(V,k){var w=this;return(0,Z.Z)(function*(){const j=(0,R.Hg)(w._schema,k);if(w._schema=k,!k||(0,X.Wi)(j)||!(0,R.uD)(j,"attributes"))return;(0,ae.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",j),w._bitsets.computed.clear(),V.targets[k.name]=!0;const P=k.attributes,W=[],A=[];for(const E in P){const N=P[E];switch(N.type){case"field":break;case"expression":W.push(w._createArcadeComputedField(N));break;case"label-expression":W.push(w._createLabelArcadeComputedField(N));break;case"statistic":A.push(N)}}w._computedFields=yield Promise.all(W),w._canCacheExpressionValue=!w._computedFields.some(E=>"expression"===E.type&&(0,X.pC)(E.expression)&&E.expression.referencesScale()),w._statisticFields=A})()}setComputedAttributes(V,k,w,j){const P=this._bitsets.computed;if(!this._canCacheExpressionValue||!P.has(w)){P.set(w);for(const W of this._computedFields){const A=this._evaluateField(k,W,j);switch(W.resultType){case"numeric":V.setComputedNumericAtIndex(w,W.fieldIndex,A);break;case"string":V.setComputedStringAtIndex(w,W.fieldIndex,A)}}}}_createArcadeComputedField(V){var k=this;return(0,Z.Z)(function*(){const w=k._sourceInfo.spatialReference,j=k._sourceInfo.fieldsIndex;return{...V,expression:yield(0,q.Yi)(V.valueExpression,w,j)}})()}_createLabelArcadeComputedField(V){var k=this;return(0,Z.Z)(function*(){const w=k._sourceInfo.spatialReference,j=k._sourceInfo.fieldsIndex,{createLabelFunction:P}=yield Y,W=yield P(V.label,j,w);return{...V,builder:W}})()}_evaluateField(V,k,w){switch(k.type){case"label-expression":{const j=V.readArcadeFeature();return k.builder.evaluate(j)||""}case"expression":{const{expression:j}=k;return function Ie(ce,V,k){if((0,X.Wi)(ce))return null;const w=V.readArcadeFeature();try{return ce.evaluate({...k,$feature:w})}catch(j){return $.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",j),null}}(j,V,{$view:{scale:w}})}}}}},25208:(Ne,xe,O)=>{O.d(xe,{s:()=>H}),O(29132);var ae=O(8314),X=O(62208),R=O(77044),q=O(82054),$=O(88071),Ie=O(42797),Y=O(91179);let se=0;const ce=(0,ae.Z)("featurelayer-simplify-thresholds")??[.5,.5,.5,.5],V=ce[0],k=ce[1],w=ce[2],j=ce[3],P=(0,ae.Z)("featurelayer-simplify-payload-size-factors")??[1,2,4],W=P[0],A=P[1],E=P[2],N=(0,ae.Z)("featurelayer-simplify-mobile-factor")??2,z=(0,ae.Z)("esri-mobile");class H{constructor(L,J){this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this.instance=L,this._layerSchema=J}static createInstance(){return se++,se=se>65535?0:se,se}get isEmpty(){return(0,X.pC)(this._deleted)&&this._deleted.countSet()===this.getSize()}set level(L){this._level=L}getAreaSimplificationThreshold(L,J){let te=1;const ue=z?N:1;J>4e6?te=E*ue:J>1e6?te=A*ue:J>5e5?te=W*ue:J>1e5&&(te=ue);let he=0;L>4e3?he=j*te:L>2e3?he=w*te:L>100?he=k:L>15&&(he=V);let Ce=8;return this._level<4?Ce=1:this._level<5?Ce=2:this._level<6&&(Ce=4),he*Ce}createQuantizedExtrudedQuad(L,J){return new $.Z([5],[L-1,J,1,-1,1,1,-1,1,-1,-1])}setArcadeSpatialReference(L){this._arcadeSpatialReference=L}attachStorage(L){this._storage=L}getQuantizationTransform(){throw new Error("Unable to find transform for featureSet")}getStorage(){return this._storage}getComputedNumeric(L){return this.getComputedNumericAtIndex(0)}setComputedNumeric(L,J){return this.setComputedNumericAtIndex(J,0)}getComputedString(L){return this.getComputedStringAtIndex(0)}setComputedString(L,J){return this.setComputedStringAtIndex(0,J)}getComputedNumericAtIndex(L){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),L)}setComputedNumericAtIndex(L,J){this._storage.setComputedNumericAtIndex(this.getDisplayId(),L,J)}getComputedStringAtIndex(L){return this._storage.getComputedStringAtIndex(this.getDisplayId(),L)}setComputedStringAtIndex(L,J){return this._storage.setComputedStringAtIndex(this.getDisplayId(),L,J)}transform(L,J,te,ue){const he=this.copy();return he._tx+=L,he._ty+=J,he._sx*=te,he._sy*=ue,he}readAttribute(L,J=!1){const te=this._readAttribute(L,J);if(void 0!==te)return te;for(const ue of this._joined){ue.setIndex(this.getIndex());const he=ue._readAttribute(L,J);if(void 0!==he)return he}}readAttributes(){const L=this._readAttributes();for(const J of this._joined){J.setIndex(this.getIndex());const te=J._readAttributes();for(const ue of Object.keys(te))L[ue]=te[ue]}return L}joinAttributes(L){this._joined.push(L)}readArcadeFeature(){return this}geometry(){const L=this.readHydratedGeometry(),J=(0,q.di)(L,this.geometryType,this.hasZ,this.hasM),te=(0,Y.im)(J);return te&&(te.spatialReference=this._arcadeSpatialReference),te}field(L){if(this.hasField(L))return this.readAttribute(L,!0);for(const J of this._joined)if(J.setIndex(this.getIndex()),J.hasField(L))return J._readAttribute(L,!0);throw new Error(`Field ${L} does not exist`)}setField(L,J){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.getFieldNames()}castToText(L=!1){if(!L)return JSON.stringify(this.readLegacyFeature());const J=this.readLegacyFeature();if(!J)return JSON.stringify(null);const te={geometry:J.geometry,attributes:{...J.attributes?J.attributes:{}}};for(const ue in te.attributes){const he=te.attributes[ue];he instanceof Date&&(te.attributes[ue]=he.getTime())}return JSON.stringify(te)}gdbVersion(){return null}fullSchema(){return this._layerSchema}castAsJson(L=null){return{attributes:this._readAttributes(),geometry:!0===L?.keepGeometryType?this.geometry():this.geometry().toJSON()}}castAsJsonAsync(L=null,J=null){return Promise.resolve(this.castAsJson(J))}removeIds(L){if((0,X.Wi)(this._objectIdToIndex)){const te=new Map,ue=this.getCursor();for(;ue.next();){const he=(0,X.s3)(ue.getObjectId());te.set(he,ue.getIndex())}this._objectIdToIndex=te}const J=this._objectIdToIndex;for(const te of L)J.has(te)&&this.removeAtIndex(J.get(te))}removeAtIndex(L){(0,X.Wi)(this._deleted)&&(this._deleted=Ie.p.create(this.getSize())),this._deleted.set(L)}readGeometryForDisplay(){return this.readUnquantizedGeometry(!0)}readLegacyGeometryForDisplay(){return this.readLegacyGeometry(!0)}*features(){const L=this.getCursor();for(;L.next();)yield L.readOptimizedFeature()}_getExists(){return(0,X.Wi)(this._deleted)||!this._deleted.has(this.getIndex())}_computeCentroid(){if("esriGeometryPolygon"!==this.geometryType)return null;const L=this.readUnquantizedGeometry();if(!L||L.hasIndeterminateRingOrder)return null;const J=(0,X.Pt)(this.getQuantizationTransform(),null);return(0,R.Y)(new $.Z,L,this.hasM,this.hasZ,J)}copyInto(L){L.seen=this.seen,L._storage=this._storage,L._arcadeSpatialReference=this._arcadeSpatialReference,L._joined=this._joined,L._tx=this._tx,L._ty=this._ty,L._sx=this._sx,L._sy=this._sy,L._deleted=this._deleted,L._objectIdToIndex=this._objectIdToIndex}}},52397:(Ne,xe,O)=>{O.d(xe,{t:()=>ae});var Z=O(25208);class ae extends Z.s{constructor(R,q){super(Z.s.createInstance(),R.fullSchema()),this._currentIndex=-1,this._reader=R,this._indices=q}static from(R,q){return new ae(R.copy(),q)}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const R=new ae(this._reader.copy(),this._indices);return R._currentIndex=this._currentIndex,R}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}setArcadeSpatialReference(R){this._reader.setArcadeSpatialReference(R)}attachStorage(R){this._reader.attachStorage(R)}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}getStorage(){return this._reader.getStorage()}getComputedNumeric(R){return this._reader.getComputedNumericAtIndex(0)}setComputedNumeric(R,q){return this._reader.setComputedNumericAtIndex(q,0)}getComputedString(R){return this._reader.getComputedStringAtIndex(0)}setComputedString(R,q){return this._reader.setComputedStringAtIndex(0,q)}getComputedNumericAtIndex(R){return this._reader.getComputedNumericAtIndex(R)}setComputedNumericAtIndex(R,q){this._reader.setComputedNumericAtIndex(R,q)}getComputedStringAtIndex(R){return this._reader.getComputedStringAtIndex(R)}setComputedStringAtIndex(R,q){return this._reader.setComputedStringAtIndex(R,q)}transform(R,q,$,Ie){const Y=this.copy();return Y._reader=this._reader.transform(R,q,$,Ie),Y}readAttribute(R,q=!1){return this._reader.readAttribute(R,q)}readAttributes(){return this._reader.readAttributes()}joinAttributes(R){return this._reader.joinAttributes(R)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(R){return this.readAttribute(R,!0)}hasField(R){return this._reader.hasField(R)}setField(R,q){return this._reader.setField(R,q)}keys(){return this._reader.keys()}castToText(R=!1){return this._reader.castToText(R)}getQuantizationTransform(){return this._reader.getQuantizationTransform()}getFieldNames(){return this._reader.getFieldNames()}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(R){return this._reader.setDisplayId(R)}getGroupId(){return this._reader.getGroupId()}setGroupId(R){return this._reader.setGroupId(R)}getXHydrated(){return this._reader.getXHydrated()}getYHydrated(){return this._reader.getYHydrated()}getX(){return this._reader.getX()}getY(){return this._reader.getY()}setIndex(R){return this._reader.setIndex(R)}getIndex(){return this._reader.getIndex()}readLegacyFeature(){return this._reader.readLegacyFeature()}readOptimizedFeature(){return this._reader.readOptimizedFeature()}readLegacyPointGeometry(){return this._reader.readLegacyPointGeometry()}readLegacyGeometry(){return this._reader.readLegacyGeometry()}readLegacyCentroid(){return this._reader.readLegacyCentroid()}readGeometryArea(){return this._reader.readGeometryArea()}readUnquantizedGeometry(){return this._reader.readUnquantizedGeometry()}readHydratedGeometry(){return this._reader.readHydratedGeometry()}readGeometry(){return this._reader.readGeometry()}readCentroid(){return this._reader.readCentroid()}_readAttribute(R,q){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}},42797:(Ne,xe,O)=>{O.d(xe,{p:()=>Z});class Z{constructor(X,R){this._mask=0,this._buf=X,this._mask=R}static fromBuffer(X,R){return new Z(X,R)}static create(X,R=4294967295){const q=new Uint32Array(Math.ceil(X/32));return new Z(q,R)}_getIndex(X){return Math.floor(X/32)}has(X){const R=this._mask&X;return!!(this._buf[this._getIndex(R)]&1<<R%32)}hasRange(X,R){let q=X,$=R;for(;q%32&&q!==$;){if(this.has(q))return!0;q++}for(;$%32&&q!==$;){if(this.has(q))return!0;$--}if(q===$)return!1;for(let Ie=q/32;Ie!==$/32;Ie++)if(this._buf[Ie])return!0;return!1}set(X){const R=this._mask&X,q=this._getIndex(R);this._buf[q]|=1<<R%32}setRange(X,R){let q=X,$=R;for(;q%32&&q!==$;)this.set(q++);for(;$%32&&q!==$;)this.set($--);if(q!==$)for(let Ie=q/32;Ie!==$/32;Ie++)this._buf[Ie]=4294967295}unset(X){const R=this._mask&X,q=this._getIndex(R);this._buf[q]&=4294967295^1<<R%32}resize(X){const R=this._buf,q=new Uint32Array(Math.ceil(X/32));q.set(R),this._buf=q}or(X){for(let R=0;R<this._buf.length;R++)this._buf[R]|=X._buf[R];return this}and(X){for(let R=0;R<this._buf.length;R++)this._buf[R]&=X._buf[R];return this}xor(X){for(let R=0;R<this._buf.length;R++)this._buf[R]^=X._buf[R];return this}ior(X){for(let R=0;R<this._buf.length;R++)this._buf[R]|=~X._buf[R];return this}iand(X){for(let R=0;R<this._buf.length;R++)this._buf[R]&=~X._buf[R];return this}ixor(X){for(let R=0;R<this._buf.length;R++)this._buf[R]^=~X._buf[R];return this}any(){for(let X=0;X<this._buf.length;X++)if(this._buf[X])return!0;return!1}copy(X){for(let R=0;R<this._buf.length;R++)this._buf[R]=X._buf[R];return this}clone(){return new Z(this._buf.slice(),this._mask)}clear(){for(let X=0;X<this._buf.length;X++)this._buf[X]=0}forEachSet(X){for(let R=0;R<this._buf.length;R++){let q=this._buf[R],$=32*R;if(q)for(;q;)1&q&&X($),q>>>=1,$++}}countSet(){let X=0;return this.forEachSet(R=>{X++}),X}}},81340:(Ne,xe,O)=>{O.d(xe,{n:()=>$});var Z=O(35575),ae=O(2004),X=O(65401),R=O(89621),q=O(58098);class ${constructor(Y,se){this.key=new q.Z(0,0,0,0),this.bounds=(0,X.Ue)(),this.objectIds=new Set,this.key.set(se);const ce=Y.getLODInfoAt(this.key);this.tileInfoView=Y,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=ce.resolution,this.scale=ce.scale,this.level=ce.level}get id(){return this.key.id}get extent(){return ae.Z.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const Y=this.key.getChildKeys(),se=Z.Z.acquire();for(let ce=0;ce<Y.length;ce++)se[ce]=new $(this.tileInfoView,Y[ce]);return se}getQuantizationParameters(){return R.Z.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}},71251:(Ne,xe,O)=>{O.d(xe,{e:()=>$});var Z=O(62208),ae=O(10699),X=O(35133),R=O(50618);class q{constructor(Y,se){this.item=Y,this.controller=se,this.promise=null}}class ${constructor(Y){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,Y.concurrency&&(this.concurrency=Y.concurrency),this._queue=new X.Z(Y.peeker),this.process=Y.process;const se=Y.scheduler;Y.priority&&(0,Z.pC)(se)&&(this._task=se.registerTask(Y.priority,this))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(Y){const se=this._controllers.get(Y);se&&se.abort()}clear(){this._queue.clear();const Y=[];this._controllers.forEach(se=>Y.push(se)),this._controllers.clear(),Y.forEach(se=>se.abort()),this._processingItems.clear(),this._cancelNext()}forEach(Y){this._deferreds.forEach((se,ce)=>Y(ce))}get(Y){const se=this._deferreds.get(Y);return se?se.promise:void 0}isOngoing(Y){return this._processingItems.has(Y)}has(Y){return this._deferreds.has(Y)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(Y,se){const ce=this.get(Y);if(ce)return ce;const V=new AbortController;let k=null;se&&(k=(0,ae.fu)(se,()=>V.abort()));const j=()=>{P.remove(),(0,Z.pC)(k)&&k.remove(),this._deferreds.delete(Y),this._controllers.delete(Y),this._queue.remove(Y),this._processingItems.delete(Y),this._scheduleNext()},P=(0,ae.$F)(V.signal,()=>{const A=this._processingItems.get(Y);A&&A.controller.abort(),j(),W.reject((0,ae.zE)())}),W=(0,ae.dD)();return this._deferreds.set(Y,W),this._controllers.set(Y,V),W.promise.then(j,j),this._queue.push(Y),this._scheduleNext(),W.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const Y=[];this._processingItems.forEach(se=>Y.push(se)),this._processingItems.clear();for(const se of Y)this._queue.push(se.item),se.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const Y=[];for(;this._queue.length;)Y.push(this._queue.pop());return this.clear(),Y}get running(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(Y){for(;!Y.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),Y.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=(0,R.Os)(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(Y,se){this._canProcessFulfillment(Y)&&(this._scheduleNext(),this._deferreds.get(Y.item).resolve(se))}_processError(Y,se){this._canProcessFulfillment(Y)&&(this._scheduleNext(),this._deferreds.get(Y.item).reject(se))}_canProcessFulfillment(Y){return!!this._deferreds.get(Y.item)&&this._processingItems.get(Y.item)===Y}_process(Y){if((0,Z.Wi)(Y))return;let se;const ce=new AbortController,V=new q(Y,ce);this._processingItems.set(Y,V);try{se=this.process(Y,ce.signal)}catch(k){this._processError(V,k)}(0,ae.y8)(se)?(V.promise=se,se.then(k=>this._processResult(V,k),k=>this._processError(V,k))):this._processResult(V,se)}get test(){return{update:Y=>this.runTask(Y)}}}}}]);