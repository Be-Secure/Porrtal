"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[5895],{65389:(j,x,i)=>{i.d(x,{Z:()=>w});var _=i(62208);class w{constructor(y){this.size=0,this._start=0,this.maxSize=y,this._buffer=new Array(y)}get entries(){return this._buffer}enqueue(y){if(this.size===this.maxSize){const a=this._buffer[this._start];return this._buffer[this._start]=y,this._start=(this._start+1)%this.maxSize,a}return this._buffer[(this._start+this.size++)%this.maxSize]=y,null}dequeue(){if(0===this.size)return null;const y=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,y}peek(){return 0===this.size?null:this._buffer[this._start]}find(y){if(0===this.size)return null;for(const a of this._buffer)if((0,_.pC)(a)&&y(a))return a;return null}clear(y){let a=this.dequeue();for(;(0,_.pC)(a);)y&&y(a),a=this.dequeue()}}},5075:(j,x,i)=>{i.d(x,{Qo:()=>l});var _=i(65389),w=i(21286),m=i(62208);const a="__esri_timestamp__";class l{constructor(o,c,d,h,S=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=d,this._purgeOptions=h,this.store=o,this.objectIdField=c,this.purgeInterval=S,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}add(o){if(this._useGeneratedIds){const h=this._nextId();o.attributes[this.objectIdField]=h,o.objectId=h}else o.objectId=o.attributes[this.objectIdField];if(this._addOrUpdated.set(o.objectId,o),this._maxAge=Math.max(this._maxAge,o.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return(0,m.Wi)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new _.Z(1e5)),void this._trackIdLessObservations.enqueue(o.objectId);const c=o.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(c)){const h=(0,m.pC)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,S=(0,w.uZ)(h,0,1e3);this._trackIdToObservations.set(c,new _.Z(S))}const d=this._trackIdToObservations.get(c).enqueue(o.objectId);(0,m.pC)(d)&&(this._addOrUpdated.has(d)?this._addOrUpdated.delete(d):this._removed.push(d))}checkForUpdates(){const o=this._getToAdd(),c=this._getToRemove(),d=performance.now();d-this._lastPurge>=this.purgeInterval&&(this._purge(d),this._lastPurge=d);const h=[];if((0,m.pC)(c))for(const S of c){const O=this.store.removeById(S);(0,m.pC)(O)&&h.push(O)}if((0,m.pC)(o))for(const S of o)S.attributes[a]=d,this.store.add(S);(o||h)&&this.store.update(o,h)}_getToAdd(){if(!this._addOrUpdated.size)return null;const o=new Array(this._addOrUpdated.size);let c=0;return this._addOrUpdated.forEach(d=>o[c++]=d),this._addOrUpdated.clear(),o}_getToRemove(){const o=this._removed;return this._removed.length?(this._removed=[],o):null}_nextId(){const o=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,o}_purge(o){const c=this._purgeOptions;(0,m.pC)(c)&&(this._purgeSomeByDisplayCount(c),this._purgeByAge(c),this._purgeByAgeReceived(o,c),this._purgeTracks())}_purgeSomeByDisplayCount(o){if(!o.displayCount)return;let c=this.store.size;if(c>o.displayCount){if(this._timeInfo.trackIdField)for(const d of this._trackIdToObservations.values())if(c>o.displayCount&&d.size){const h=(0,m.Wg)(d.dequeue());this._removed.push(h),c--}if((0,m.pC)(this._trackIdLessObservations)){let d=c-o.displayCount;for(;d-- >0;){const h=this._trackIdLessObservations.dequeue();(0,m.pC)(h)&&this._removed.push(h)}}}}_purgeByAge(o){if(!o.age||!this._timeInfo?.startTimeField)return;const d=this._maxAge-60*o.age*1e3;this.store.forEach(h=>{h.attributes[this._timeInfo.startTimeField]<d&&this._removed.push(h.objectId)})}_purgeByAgeReceived(o,c){if(!c.ageReceived)return;const d=o-60*c.ageReceived*1e3;this.store.forEach(h=>{h.attributes[a]<d&&this._removed.push(h.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((o,c)=>{0===o.size&&this._trackIdToObservations.delete(c)})}}},16147:(j,x,i)=>{i.d(x,{I:()=>J});var _=i(15861),w=i(17626),y=(i(29132),i(84792)),a=i(26584),E=i(63290),l=i(62208),Z=i(10699),o=i(21726),O=(i(90912),i(85931),i(8314),i(82255),i(76898)),W=i(77712),U=i(33696),A=i(61885),N=i(80542);let R=class extends(A.Z.EventedMixin(N.r)){onFeature(e){this.emit("feature",e)}};R=(0,w._)([(0,O.j)("esri.layers.graphics.sources.connections.StreamConnection")],R);const D=R,b=E.Z.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");var I,e;(e=I||(I={}))[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED";let F=class extends D{constructor(e){super(),this.errorString=null;const{geometryType:t,spatialReference:s,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=(0,U.k)(t,r,s),this._open()}_open(){var e=this;return(0,_.Z)(function*(){yield e._tryCreateWebSocket(),e.destroyed||(yield e._handshake())})()}destroy(){(0,l.pC)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if((0,l.Wi)(this._websocket))return"disconnected";switch(this._websocket.readyState){case I.CONNECTING:case I.OPEN:return"connected";case I.CLOSING:case I.CLOSED:return"disconnected"}}_tryCreateWebSocket(e=this._config.source.path,t=1e3,s=0){var r=this;return(0,_.Z)(function*(){try{if(r.destroyed)return;const n=(0,o.fl)(e,r._config.customParameters);r._websocket=yield r._createWebSocket(n),r.notifyChange("connectionStatus")}catch(n){const u=t/1e3;return r._config.maxReconnectionAttempts&&s>=r._config.maxReconnectionAttempts?(b.error(new a.Z("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void r.destroy()):(b.error(new a.Z("websocket-connection",`Failed to connect. Attempting to reconnect in ${u}s`,n)),yield(0,Z.e4)(t),r._tryCreateWebSocket(e,Math.min(1.5*t,1e3*r._config.maxReconnectionInterval),s+1))}})()}_createWebSocket(e){return new Promise((t,s)=>{const r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=n=>this._onClose(n),r.onerror=n=>this._onError(n),r.onmessage=n=>this._onMessage(n),t(r)},r.onclose=n=>{r.onopen=r.onclose=null,s(n)}})}_handshake(e=1e4){var t=this;return(0,_.Z)(function*(){const s=t._websocket;if((0,l.Wi)(s))return;const r=(0,Z.hh)(),n=s.onmessage,{filter:u,outFields:f,spatialReference:C}=t._config;return r.timeout(e),s.onmessage=v=>{let g=null;try{g=JSON.parse(v.data)}catch{}g&&"object"==typeof g||(b.error(new a.Z("websocket-connection","Protocol violation. Handshake failed - malformed message",v.data)),r.reject(),t.destroy()),g.spatialReference?.wkid!==C?.wkid&&(b.error(new a.Z("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${C.wkid}`,v.data)),r.reject(),t.destroy()),"json"!==g.format&&(b.error(new a.Z("websocket-connection","Protocol violation. Handshake failed - format is not set",v.data)),r.reject(),t.destroy()),u&&g.filter!==u&&b.error(new a.Z("websocket-connection","Tried to set filter, but server doesn't support it")),f&&g.outFields!==f&&b.error(new a.Z("websocket-connection","Tried to set outFields, but server doesn't support it")),s.onmessage=n,r.resolve()},s.send(JSON.stringify({filter:u,outFields:f,format:"json",spatialReference:{wkid:C.wkid}})),r.promise})()}_onMessage(e){try{const t=JSON.parse(e.data);if("featureResult"!==t.type)throw new a.Z("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);for(const s of t.features)(0,l.pC)(this._featureZScaler)&&this._featureZScaler(s.geometry),this.onFeature(s)}catch(t){return b.error(new a.Z("websocket-connection","Failed to parse message",t)),void this.destroy()}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),b.error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&b.error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};(0,w._)([(0,W.Cb)()],F.prototype,"connectionStatus",null),(0,w._)([(0,W.Cb)()],F.prototype,"errorString",void 0),F=(0,w._)([(0,O.j)("esri.layers.graphics.sources.connections.WebSocketConnection")],F);var P=i(20477),L=i(84952),z=i(91179),M=i(65234);const k=E.Z.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),G={maxQueryDepth:5,maxRecordCountFactor:3};let T=class extends F{constructor(e){super({...G,...e})}_open(){var e=this;return(0,_.Z)(function*(){const t=yield e._fetchServiceDefinition(e._config.source);t.timeInfo.trackIdField||k.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const s=e._fetchWebSocketUrl(t.streamUrls,e._config.spatialReference);e._buddyServicesQuery||(e._buddyServicesQuery=e._queryBuddyServices()),yield e._buddyServicesQuery,yield e._tryCreateWebSocket(s);const{filter:r,outFields:n}=e._config;e.destroyed||e._setFilter(r,n)})()}_onMessage(e){let t;try{t=this._enrich(JSON.parse(e.data)),(0,l.pC)(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(s){return void k.error(new a.Z("geoevent-connection","Failed to parse message",s))}this.onFeature(t)}_fetchServiceDefinition(e){var t=this;return(0,_.Z)(function*(){const s={f:"json",...t._config.customParameters},r=(0,y.default)(e.path,{query:s,responseType:"json"}),n=(yield r).data;return t._serviceDefinition=n,n})()}_fetchWebSocketUrl(e,t){const s=e[0],{urls:r,token:n}=s,u=this._inferWebSocketBaseUrl(r);return(0,o.fl)(`${u}/subscribe`,{outSR:""+t.wkid,token:n})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return k.error(new a.Z("geoevent-connection","Unable to infer WebSocket url",e)),null}_setFilter(e,t){var s=this;return(0,_.Z)(function*(){const r=s._websocket;if((0,l.Wi)(r)||(0,l.Wi)(e)&&(0,l.Wi)(t))return;const n=JSON.stringify({filter:s._serializeFilter(e,t)});let u=!1;const f=(0,Z.hh)();return r.onmessage=g=>{const p=JSON.parse(g.data);p.filter&&(p.error&&(k.error(new a.Z("geoevent-connection","Failed to set service filter",p.error)),s._set("errorString",`Could not set service filter - ${p.error}`),f.reject(p.error)),r.onmessage=s._onMessage.bind(s),u=!0,f.resolve())},r.send(n),setTimeout(()=>{u||(s.destroyed||s._websocket!==r||k.error(new a.Z("geoevent-connection","Server timed out when setting filter")),f.reject())},1e4),f.promise})()}_serializeFilter(e,t){const s={};if((0,l.Wi)(e)&&(0,l.Wi)(t))return s;if((0,l.pC)(e)&&e.geometry)try{const r=(0,z.im)(e.geometry);if("extent"!==r.type)throw new a.Z(`Expected extent but found type ${r.type}`);s.geometry=JSON.stringify(r.shiftCentralMeridian())}catch(r){k.error(new a.Z("geoevent-connection","Encountered an error when setting connection geometryDefinition",r))}return(0,l.pC)(e)&&e.where&&"1 = 1"!==e.where&&(s.where=e.where),(0,l.pC)(t)&&(s.outFields=t.join(",")),s}_enrich(e){if(!this._relatedFeatures)return e;const s=e.attributes[this._serviceDefinition.relatedFeatures.joinField];if(!this._relatedFeatures.has(s))return k.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:r,geometry:n}=this._relatedFeatures.get(s);for(const u in r)e.attributes[u]=r[u];return n&&(e.geometry=n),e.geometry||e.centroid||k.error(new a.Z("geoevent-connection","Found malformed feature - no geometry found",e)),e}_queryBuddyServices(){var e=this;return(0,_.Z)(function*(){try{const{relatedFeatures:t,keepLatestArchive:s}=e._serviceDefinition,r=e._queryRelatedFeatures(t),n=e._queryArchive(s);yield r;const u=yield n;if(!u)return;for(const f of u.features)e.onFeature(e._enrich(f))}catch(t){k.error(new a.Z("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}})()}_queryRelatedFeatures(e){var t=this;return(0,_.Z)(function*(){if(!e)return;const s=yield t._queryBuddy(e.featuresUrl);t._addRelatedFeatures(s)})()}_queryArchive(e){var t=this;return(0,_.Z)(function*(){if(e)return t._queryBuddy(e.featuresUrl)})()}_queryBuddy(e){var t=this;return(0,_.Z)(function*(){const s=new((yield Promise.resolve().then(i.bind(i,32258))).default)({url:e}),{capabilities:r}=yield s.load(),n=r.query.supportsMaxRecordCountFactor,u=r.query.supportsPagination,f=r.query.supportsCentroid,C=t._config.maxRecordCountFactor,v=s.capabilities.query.maxRecordCount,g=n?v*C:v,p=new L.Z;if(p.outFields=(0,l.Pt)(t._config.outFields,["*"]),p.where=(0,l.Pt)((0,l.U2)(t._config.filter,"where"),"1=1"),p.returnGeometry=!0,p.returnExceededLimitFeatures=!0,p.outSpatialReference=M.Z.fromJSON(t._config.spatialReference),f&&(p.returnCentroid=!0),n&&(p.maxRecordCountFactor=C),u)return p.num=g,s.destroy(),t._queryPages(e,p);const $=yield(0,P.executeQuery)(e,p,t._config.sourceSpatialReference);return s.destroy(),$.data})()}_queryPages(e,t,s=[],r=0){var n=this;return(0,_.Z)(function*(){t.start=(0,l.pC)(t.num)?r*t.num:null;const{data:u}=yield(0,P.executeQuery)(e,t,n._config.sourceSpatialReference);return u.exceededTransferLimit&&r<n._config.maxQueryDepth?(u.features.forEach(f=>s.push(f)),n._queryPages(e,t,s,r+1)):(s.forEach(f=>u.features.push(f)),u)})()}_addRelatedFeatures(e){const t=new Map,s=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(const n of s)t.set(n.attributes[r],n);this._relatedFeatures=t}};T=(0,w._)([(0,O.j)("esri.layers.graphics.sources.connections.GeoEventConnection")],T);const Q=T;function J(e,t,s,r,n,u,f,C){const v=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),g={source:e,sourceSpatialReference:t,spatialReference:s,geometryType:r,filter:n,maxReconnectionAttempts:u,maxReconnectionInterval:f,customParameters:C};return v?new F(g):new Q(g)}}}]);